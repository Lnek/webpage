<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>framebuffer驱动 - zy_11162311的专栏 - 博客频道 - CSDN.NET</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="FrameBuffer代码分析&#160;&#160; +--------+&#160;&#160; |&#160;&#160; app&#160; |&#160;&#160; +--------+&#160;&#160; |&#160;&#160; vfs&#160; |&#160;&#160; +--------+&#160;&#160; |&#160; fbmem |&#160;&#160; +--------+&#160;&#160; | driver |&#160;&#160; +--------+先看drivers/video/fbmem.c一般作为builtin编入内核，看下模" />
<script src="http://static.blog.csdn.net/scripts/jquery.js" type="text/javascript"></script>
<script type="text/javascript" src="http://static.blog.csdn.net/scripts/ad.js?v=1.1"></script>
<link rel="Stylesheet" type="text/css" href="http://static.blog.csdn.net/skin/dark1/css/style.css?v=1.1" />
<link id="RSSLink" title="RSS" type="application/rss+xml" rel="alternate" href="/zy_11162311/rss/list" />
<link rel="shortcut icon" href="/favicon.ico" />
<link type="text/css" rel="stylesheet" href="http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/default.css" />
</head>
<body>
<script src="http://csdnimg.cn/pubnav/js/pub_topnav_2011.js"type="text/javascript"></script>

<div id="container">
<div id="header">
    <div class="header">
        <div id="blog_title">
            <h1><a href="/zy_11162311">zy_11162311的专栏</a></h1>
            <h2></h2>
            <div class="clear"></div>
        </div>
        <div class="clear"></div>
    </div>
</div>
<div id="navigator">
    <div class="navigator_bg"></div>
    <div class="navigator">
        <ul>
            <li id="btnContents"><a href="/zy_11162311?viewmode=contents"><span><img src="http://static.blog.csdn.net/images/ico_list.gif">目录视图</span></a></li>
            <li id="btnView"><a href="/zy_11162311?viewmode=list"><span><img src="http://static.blog.csdn.net/images/ico_summary.gif">摘要视图</span></a></li>
            <li id="btnRss"><a href="/zy_11162311/rss/list"><span><img src="http://static.blog.csdn.net/images/ico_rss.gif">订阅</span></a></li>
</ul>
    </div>
</div>
<script type="text/javascript">
    var username = "zy_11162311";
    var _blogger = username;
    var blog_address = "http://blog.csdn.net/zy_11162311";
    var static_host = "http://static.blog.csdn.net";
    var currentUserName = "";
</script>

<div id="body">
<div id="main">
<div class="main">
<div class="notice"> 

<a href="http://blog.csdn.net/blogdevteam/article/details/8899926" target="_blank">
<font color=red>有奖征集活动系列——【HTML5游戏编程之旅】 
   </font></a>



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://www.csdn.net/article/2013-05-21/2815371" target="_blank"><font color=blue>专访许雪松：深入理解嵌入式开发
</font></a>

&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://events.csdn.net/wy/APC/invite.html
"target="_blank">
<font color=red>探究云计算数据中心节能增效之道


 </font></a>

&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://blog.csdn.net/blogdevteam/article/details/8900468 "target="_blank">
<font color=red>CSDN博客第一期云计算最佳博主评选
 </font></a>


&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://blog.csdn.net/blogdevteam/article/details/8853291"target="_blank">
<font color=blue>CSDN博客第二期最佳移动开发博主评选
 </font></a>




</div>
<div id="article_details" class="details">
    <div class="article_title">
    <span class="ico ico_type_Repost"></span>
    <h3>
        <span class="link_title"><a href="/zy_11162311/article/details/7086952">
        framebuffer驱动
        </a></span>
    </h3>
</div>

        
    <div class="article_manage">
        <span class="link_categories">
        分类：
            <a href="/zy_11162311/article/category/942764">LCD</a> 
        </span>
    <span class="link_postdate">2011-12-20 11:11</span>
    <span class="link_view" title="阅读次数">432人阅读</span>
    <span class="link_comments" title="评论次数"><a href="#comments">评论</a>(0)</span>
    <span class="link_collect"><a href="javascript:void(0);" onclick="javascript:collectArticle('framebuffer驱动','7086952');return false;" title="收藏">收藏</a></span>
    <span class="link_report"><a href="#report"  onclick="javascript:report(7086952,2);return false;" title="举报">举报</a></span>
    
</div>
<div class="tag2box"><a href='http://blog.csdn.net/tag/details.html?tag=struct' target=_blank>struct</a><a href='http://blog.csdn.net/tag/details.html?tag=file' target=_blank>file</a><a href='http://blog.csdn.net/tag/details.html?tag=null' target=_blank>null</a><a href='http://blog.csdn.net/tag/details.html?tag=module' target=_blank>module</a><a href='http://blog.csdn.net/tag/details.html?tag=video' target=_blank>video</a><a href='http://blog.csdn.net/tag/details.html?tag=%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90' target=_blank>代码分析</a></div>


    
<div id="article_content" class="article_content">

<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">FrameBuffer代码分析</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp; &#43;--------&#43;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp; |&nbsp;&nbsp; app&nbsp; |</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp; &#43;--------&#43;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp; |&nbsp;&nbsp; vfs&nbsp; |</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp; &#43;--------&#43;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp; |&nbsp; fbmem |</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp; &#43;--------&#43;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp; | driver |</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp; &#43;--------&#43;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">先看drivers/video/fbmem.c</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">一般作为builtin编入内核，看下模块入口</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//-------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">#ifdef MODULE</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">module_init(fbmem_init);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">#else</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">subsys_initcall(fbmem_init);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">#endif</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">从而可知入口是fbmem_init函数</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static int __init</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">fbmem_init(void)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">{</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //创建/proc/fb文件，提供给用户查询驱动部分信息的接口</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; proc_create(&quot;fb&quot;, 0, NULL, &amp;fb_proc_fops);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //注册一个字符设备驱动，占用主设备号 FB_MAJOR,应用程序对所有fb驱动的操作就在这里的fb_fops</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">register_chrdev(FB_MAJOR,&quot;fb&quot;,&amp;fb_fops)</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printk(&quot;unable to get major %d for fb devs\n&quot;, FB_MAJOR);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //创建一个设备类目录/sys/class/graphics</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fb_class = class_create(THIS_MODULE, &quot;graphics&quot;);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ... &nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; return 0;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">}</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">我们来看下fb_fops的定义</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static const struct file_operations fb_fops = {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .owner =&nbsp;&nbsp;&nbsp; THIS_MODULE,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .read =&nbsp;&nbsp;&nbsp;&nbsp; fb_read,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .write =&nbsp;&nbsp;&nbsp; fb_write,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .unlocked_ioctl = fb_ioctl,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">#ifdef CONFIG_COMPAT</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .compat_ioctl = fb_compat_ioctl,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">#endif</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .mmap =&nbsp;&nbsp;&nbsp;&nbsp; fb_mmap,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .open =&nbsp;&nbsp;&nbsp;&nbsp; fb_open,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .release =&nbsp; fb_release,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">#ifdef HAVE_ARCH_FB_UNMAPPED_AREA</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .get_unmapped_area = get_fb_unmapped_area,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">#endif</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">#ifdef CONFIG_FB_DEFERRED_IO</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fsync =&nbsp;&nbsp;&nbsp; fb_deferred_io_fsync,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">#endif</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">};</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">针对我们应用经常进行的操作，主要的重点是open/close/read/write/mmap/ioctl,首先我们看open操作</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">fb_open(struct inode *inode, struct file *file)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">__acquires(&amp;info-&gt;lock)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">__releases(&amp;info-&gt;lock)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">{</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //获取次设备号，作为全局数组registered_fb的下表</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; int fbidx = iminor(inode);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct fb_info *info;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; int res = 0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (fbidx &gt;= FB_MAX)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return -ENODEV;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; info = registered_fb[fbidx];&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp; &nbsp; //如果没有加载驱动，请求加载驱动&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (!info)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; request_module(&quot;fb%d&quot;, fbidx);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; info = registered_fb[fbidx];&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ... &nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; mutex_lock(&amp;info-&gt;lock);&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; file-&gt;private_data = info;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (info-&gt;fbops-&gt;fb_open) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; res =&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">info-&gt;fbops-&gt;fb_open</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">(info,1);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; }&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">}</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">从代码看出，真实的操作是推迟到具体的设备驱动来实现，而找到正确的设备驱动是通过次设备号作为下标在registered_fb的全局数组中找到跟具体设备驱动相关的数据(sturct fb_info，这个在后面描述)，然后调用对应的fb_open函数来进行打开操作</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">可以看出来fbmem是将vfs的操作转换城具体驱动的实现，从而达到给上层应用对所有fb的一致操作接口，但又能使用具体不同的设备。这个目的是通过registered_fb数组和fb_ops这2个数据来达到的。</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">通过其他的几个文件操作实现代码也可以验证这一点。</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">fb_mmap(struct file *file, struct vm_area_struct * vma)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">__acquires(&amp;info-&gt;lock)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">__releases(&amp;info-&gt;lock)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">{</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; int fbidx = iminor(file-&gt;f_path.dentry-&gt;d_inode);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct fb_info *info = registered_fb[fbidx];</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct fb_ops *fb = info-&gt;fbops;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (fb-&gt;fb_mmap) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int res;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mutex_lock(&amp;info-&gt;lock);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; res =&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">fb-&gt;fb_mmap</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">(info,
 vma);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mutex_unlock(&amp;info-&gt;lock);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return res;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">}</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">read操作</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static ssize_t</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">fb_read(struct file *file, char __user *buf, size_t count, loff_t *ppos)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">{</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; unsigned long p = *ppos;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct inode *inode = file-&gt;f_path.dentry-&gt;d_inode;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; int fbidx = iminor(inode);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct fb_info *info = registered_fb[fbidx];</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (info-&gt;fbops-&gt;fb_read)&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return info-&gt;fbops-&gt;fb_read(info, buf, count, ppos);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //如果没有对应的fb_write函数，则通过info中的screen_base来直接进行内存操作</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">}</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">write操作</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static ssize_t</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">fb_write(struct file *file, const char __user *buf, size_t count, loff_t *ppos)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">{</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; unsigned long p = *ppos;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct inode *inode = file-&gt;f_path.dentry-&gt;d_inode;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; int fbidx = iminor(inode);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct fb_info *info = registered_fb[fbidx];</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (info-&gt;fbops-&gt;fb_write)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return info-&gt;fbops-&gt;fb_write(info, buf, count, ppos);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //如果没有对应的fb_write函数，则通过info中的screen_base来直接进行内存操作</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">}</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">ioctl操作&nbsp; fb_ioctl---&gt;do_fb_ioctl</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">至于registered_fb数组中的&#20540;从哪来的，就牵扯到下面要说的具体设备驱动，这里以iMx515的framebuffer驱动为例&lt;drivers/video/mxc/mxc_ipuv3_fb.c&gt;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">看下驱动模块入口</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">module_init(mxcfb_init);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static struct platform_driver mxcfb_driver = {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .driver = {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .name = MXCFB_NAME,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .probe = mxcfb_probe,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .remove = mxcfb_remove,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .suspend = mxcfb_suspend,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .resume = mxcfb_resume,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">};</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">int __init mxcfb_init(void)&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ret = platform_driver_register(&amp;mxcfb_driver);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">}</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">这里注册platform_driver_register函数，如果找到匹配的设备，在iMx515中匹配设备的声明在</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&lt;arch/arm/mach-mx51/mx51_3stack.c&gt;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static struct mxc_fb_platform_data fb_data[] = {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .interface_pix_fmt = IPU_PIX_FMT_RGB666,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; },&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .interface_pix_fmt = IPU_PIX_FMT_YUV444,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; },&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">};</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static struct platform_device mxc_fb_device[] = {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .name = &quot;mxc_sdc_fb&quot;,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .id = 0,&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .dev = {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .release = mxc_nop_release,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .coherent_dma_mask = 0xFFFFFFFF,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .platform_data = &amp;fb_data[0],</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; },&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .name = &quot;mxc_sdc_fb&quot;,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .id = 1,&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .dev = {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .release = mxc_nop_release,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .coherent_dma_mask = 0xFFFFFFFF,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .platform_data = &amp;fb_data[1],</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; },&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; {&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .name = &quot;mxc_sdc_fb&quot;,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .id = 2,&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; .dev = {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .release = mxc_nop_release,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; .coherent_dma_mask = 0xFFFFFFFF,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; },</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; },</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">};</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">则进入probe函数</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">//驱动具体实现的文件操作函数</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static struct fb_ops mxcfb_ops = {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .owner = THIS_MODULE,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_set_par = mxcfb_set_par,&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_check_var = mxcfb_check_var,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_setcolreg = mxcfb_setcolreg,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_pan_display = mxcfb_pan_display,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_ioctl = mxcfb_ioctl,&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_mmap = mxcfb_mmap,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_fillrect = cfb_fillrect,&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_copyarea = cfb_copyarea,&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_imageblit = cfb_imageblit,&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; .fb_blank = mxcfb_blank,&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">};</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static int mxcfb_probe(struct platform_device *pdev)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">{</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct fb_info *</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">fbi</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct mxcfb_info *mxcfbi;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct mxc_fb_platform_data *plat_data = pdev-&gt;dev.platform_data;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct resource *res;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; int ret = 0;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; /*</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; * Initialize FB structures</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp; */</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //通过framebuffer_alloc来分配空间，给info的fb_ops的参数为mxcfb_ops</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fbi = mxcfb_init_fbinfo(&amp;pdev-&gt;dev, &amp;mxcfb_ops);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (!fbi) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = -ENOMEM;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto err0;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; mxcfbi = (struct mxcfb_info *)fbi-&gt;par;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //第一次进这里</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (!g_dp_in_use) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;ipu_ch_irq = IPU_IRQ_BG_SYNC_EOF;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;ipu_ch = MEM_BG_SYNC;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;blank = FB_BLANK_UNBLANK;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; } else {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;ipu_ch_irq = IPU_IRQ_DC_SYNC_EOF;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;ipu_ch = MEM_DC_SYNC;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;blank = FB_BLANK_POWERDOWN;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //fb的索引号</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; mxcfbi-&gt;ipu_di = pdev-&gt;id;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (pdev-&gt;id == 0) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ipu_disp_set_global_alpha(mxcfbi-&gt;ipu_ch, true, 0x80);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ipu_disp_set_color_key(mxcfbi-&gt;ipu_ch, false, 0);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strcpy(fbi-&gt;fix.id, &quot;DISP3 BG&quot;);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!g_dp_in_use)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ipu_request_irq(IPU_IRQ_BG_ALPHA_SYNC_EOF,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfb_alpha_irq_handler, 0,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MXCFB_NAME, fbi) != 0) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dev_err(&amp;pdev-&gt;dev, &quot;Error registering BG &quot;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;alpha irq handler.\n&quot;);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = -EBUSY;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto err1;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; g_dp_in_use = true;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; } else if (pdev-&gt;id == 1) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strcpy(fbi-&gt;fix.id, &quot;DISP3 BG - DI1&quot;);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!g_dp_in_use)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ipu_request_irq(IPU_IRQ_BG_ALPHA_SYNC_EOF,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfb_alpha_irq_handler, 0,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MXCFB_NAME, fbi) != 0) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dev_err(&amp;pdev-&gt;dev, &quot;Error registering BG &quot;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;alpha irq handler.\n&quot;);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = -EBUSY;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto err1;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; g_dp_in_use = true;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; } else if (pdev-&gt;id == 2) { /* Overlay */</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;ipu_ch_irq = IPU_IRQ_FG_SYNC_EOF;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;ipu_ch = MEM_FG_SYNC;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;ipu_di = -1;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;overlay = true;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;blank = FB_BLANK_POWERDOWN;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; strcpy(fbi-&gt;fix.id, &quot;DISP3 FG&quot;);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ipu_request_irq(IPU_IRQ_FG_ALPHA_SYNC_EOF,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfb_alpha_irq_handler, 0,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MXCFB_NAME, fbi) != 0) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dev_err(&amp;pdev-&gt;dev, &quot;Error registering FG alpha irq &quot;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &quot;handler.\n&quot;);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = -EBUSY;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto err1;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //在驱动内部保存fb_info的消息，并对应pdev-&gt;id的索引</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; mxcfb_info[pdev-&gt;id] = fbi;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //申请相应的中断</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (ipu_request_irq(mxcfbi-&gt;ipu_ch_irq, mxcfb_irq_handler, 0,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MXCFB_NAME, fbi) != 0) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dev_err(&amp;pdev-&gt;dev, &quot;Error registering BG irq handler.\n&quot;);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ret = -EBUSY;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto err1;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ipu_disable_irq(mxcfbi-&gt;ipu_ch_irq);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //映射显存空间，但从上面的代码块可以看出没有IORESOURCE_MEM资源，显存地址由后面的代码分配</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; res = platform_get_resource(pdev, IORESOURCE_MEM, 0);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (res) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fbi-&gt;fix.smem_len = res-&gt;end - res-&gt;start &#43; 1;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fbi-&gt;fix.smem_start = res-&gt;start;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fbi-&gt;screen_base = ioremap(fbi-&gt;fix.smem_start, fbi-&gt;fix.smem_len);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; /* Need dummy values until real panel is configured */</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fbi-&gt;var.xres = 240;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fbi-&gt;var.yres = 320;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //具体的LCD相关参数在下面3个步骤里发现</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //1. 从上面那个代码块的定义可知，plat_data-&gt;mode_str为空</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (!fb_mode &amp;&amp; plat_data &amp;&amp; plat_data-&gt;mode_str)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">fb_find_mode</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">(&amp;fbi-&gt;var,
 fbi, plat_data-&gt;mode_str, NULL, 0, NULL,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default_bpp);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //2. fb_mode由内核命令行参数传入</span><span style="font-size:13px; line-height:1.5; font-family:宋体,Arial; background-color:rgb(245,247,248)"><span style="font-size:13px; line-height:1.5"><span style="font-size:13px; line-height:1.5"><span style="font-size:13px; line-height:1.5"><em>video=mxcfb:1024x768M-16@60</em></span></span></span></span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (fb_mode)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">fb_find_mode</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">(&amp;fbi-&gt;var,
 fbi, fb_mode, NULL, 0, NULL,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; default_bpp);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //3. 进入这里</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (plat_data) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; mxcfbi-&gt;ipu_di_pix_fmt = plat_data-&gt;interface_pix_fmt;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">//但下面的plat_data-&gt;mode不满足</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!fb_mode &amp;&amp; plat_data-&gt;mode)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">fb_videomode_to_var</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">(&amp;fbi-&gt;var,
 plat_data-&gt;mode);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; /* Default Y virtual size is 2x panel size */</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fbi-&gt;var.yres_virtual = fbi-&gt;var.yres * 2;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; mxcfb_check_var(&amp;fbi-&gt;var, fbi);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">//通过上面的查找和检测过程 fb_info的var部分的&#20540;被确定下</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; /* Default Y virtual size is 2x panel size */</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fbi-&gt;var.yres_virtual = fbi-&gt;var.yres * 2;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; mxcfb_set_fix(fbi);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //这里分配显存空间，见后面的实现代码块</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; /* alocate fb first */</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (!res)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (mxcfb_map_video_memory(fbi) &lt; 0)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return -ENOMEM;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">//执行到这里fb_info的fix部分成员&#20540;被确定下来</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //这里将具体驱动里的fb_info注册到fb_mem中的registered_fb数组中去</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ret =&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">register_framebuffer</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">(fbi);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (ret &lt; 0)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; goto err2;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; platform_set_drvdata(pdev, fbi);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ret = device_create_file(fbi-&gt;dev, &amp;dev_attr_fsl_disp_property);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (ret)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; dev_err(&amp;pdev-&gt;dev, &quot;Error %d on creating file\n&quot;, ret);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; return 0;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">err2:</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ipu_free_irq(mxcfbi-&gt;ipu_ch_irq, fbi);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">err1:</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fb_dealloc_cmap(&amp;fbi-&gt;cmap);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; framebuffer_release(fbi);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">err0:</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; return ret;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">}</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">上面的显存物理地址分配由如下函数实现</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">static int mxcfb_map_video_memory(struct fb_info *fbi)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">{</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (fbi-&gt;fix.smem_len &lt; fbi-&gt;var.yres_virtual * fbi-&gt;fix.line_length)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fbi-&gt;fix.smem_len = fbi-&gt;var.yres_virtual *</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fbi-&gt;fix.line_length;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fbi-&gt;screen_base = dma_alloc_writecombine(fbi-&gt;device,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fbi-&gt;fix.smem_len,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; (dma_addr_t *)&amp;fbi-&gt;fix.smem_start,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; GFP_DMA);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; ...</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp; &nbsp; fbi-&gt;screen_size = fbi-&gt;fix.smem_len;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; /* Clear the screen */&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; memset((char *)fbi-&gt;screen_base, 0, fbi-&gt;fix.smem_len);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; return 0;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">}</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//--------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">在fb video mode的查找中，对模式的指定字符串&#26684;式如下：</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&lt;xres&gt;x&lt;yres&gt;[M][R][-&lt;bpp&gt;][@&lt;refresh&gt;][i][m] or &lt;name&gt;[-&lt;bpp&gt;][@&lt;refresh&gt;]</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">例子：1024x768MR-8@60m - Reduced blank with margins at 60Hz</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">在上面函数的最后部分的</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">register_framebuffer<span style="line-height:1.5; color:rgb(0,1,2)">函数即将具体驱动里面的fb_info注册到fb_mem框架中去，这样对具体硬件的操作就有了者落点</span></span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//---------------------------------------start</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">int</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">register_framebuffer(struct fb_info *fb_info)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">{</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; int i;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct fb_event event;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; struct fb_videomode mode;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //判断注册数组是否已满</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (num_registered_fb == FB_MAX)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return -ENXIO;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (fb_check_foreignness(fb_info))</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return -ENOSYS;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //增加已注册计数</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; num_registered_fb&#43;&#43;;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //从注册数组中寻找一个空&#26684;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; for (i = 0 ; i &lt; FB_MAX; i&#43;&#43;)&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!registered_fb[i])</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //将空&#26684;索引保存在fb_info中，在下面作为设备驱动的次设备号</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fb_info-&gt;node = i;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; mutex_init(&amp;fb_info-&gt;lock);&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //创建设备节点/dev/fbn&nbsp; n即为索引&#20540;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fb_info-&gt;dev = device_create(fb_class, fb_info-&gt;device,</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(0,1,255)">MKDEV(FB_MAJOR,
 i)</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">, NULL,&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(0,1,255)">&quot;fb%d&quot;</span><span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">,
 i);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (IS_ERR(fb_info-&gt;dev)) {&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /* Not fatal */</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; printk(KERN_WARNING &quot;Unable to create device for framebuffer %d; errno = %ld\n&quot;, i, PTR_ERR(fb_info-&gt;dev));</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_info-&gt;dev = NULL;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; } else</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_init_device(fb_info);&nbsp; //创建设备文件属性文件，使得用户从sys文件系统能查询或控制对应的驱动 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">//下面应该是硬件部分，还不清楚，有待再看下？？？？</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (fb_info-&gt;pixmap.addr == NULL) {</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_info-&gt;pixmap.addr = kmalloc(FBPIXMAPSIZE, GFP_KERNEL);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (fb_info-&gt;pixmap.addr) {&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_info-&gt;pixmap.size = FBPIXMAPSIZE;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_info-&gt;pixmap.buf_align = 1;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_info-&gt;pixmap.scan_align = 1;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_info-&gt;pixmap.access_align = 32;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_info-&gt;pixmap.flags = FB_PIXMAP_DEFAULT;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; }</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fb_info-&gt;pixmap.offset = 0;&nbsp;&nbsp;&nbsp;&nbsp;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (!fb_info-&gt;pixmap.blit_x)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_info-&gt;pixmap.blit_x = ~(u32)0;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (!fb_info-&gt;pixmap.blit_y)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fb_info-&gt;pixmap.blit_y = ~(u32)0;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; if (!fb_info-&gt;modelist.prev || !fb_info-&gt;modelist.next)</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; INIT_LIST_HEAD(&amp;fb_info-&gt;modelist);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fb_var_to_videomode(&amp;mode, &amp;fb_info-&gt;var);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fb_add_videomode(&amp;mode, &amp;fb_info-&gt;modelist);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="line-height:21px; font-family:宋体,Arial; font-size:14px; background-color:rgb(245,247,248); color:rgb(255,1,2)">//将fb_info放在前面寻找到的数组空&#26684;位置上，到这里，fbmem框架就能根据操作的<br>
&nbsp;&nbsp;&nbsp; //设备得到次设备号从而在这个数组里得到具体驱动的相应操作实现</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; registered_fb[i] = fb_info;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; //下面这2句是给关注framebuffer驱动事件的部分发送通知消息</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; event.info = fb_info;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; fb_notifier_call_chain(FB_EVENT_FB_REGISTERED, &amp;event);</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">&nbsp;&nbsp;&nbsp; return 0;</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">}</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">//---------------------------------------end</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">到这里，设备驱动的注册过程就完成了，fbmem框架能够实现具体硬件相关的操作了</span><br style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">
<span style="font-family:宋体,Arial; font-size:14px; line-height:21px; background-color:rgb(245,247,248)">接写来描述具体驱动中，应用程序常见的ioctl操作在底层是怎么实现的。</span>

</div>

<div class="share_buttons" id="sharePanel"></div>
<!--192.168.1.237-->
<div class="article_next_prev">
    <li class="prev_article"><span>上一篇：</span><a href="/zy_11162311/article/details/7085484">framebuffer learning</a></li>
    <li class="next_article"><span>下一篇：</span><a href="/zy_11162311/article/details/7096054">framebuffer_2</a></li>
</div>


    
</div>
<div id="ad_cen">
<script type="text/javascript" >BAIDU_CLB_SLOT_ID = "117306";</script>
<script type="text/javascript" src="http://cbjs.baidu.com/js/o.js"></script>
</div>
<script type="text/javascript">
    //new Ad(4, 'ad_cen');
</script>
<div id="comment_title" class="panel_head">查看评论<a name="comments"></a></div>
<div id="comment_list"></div>
<div id="comment_bar"></div>
<div id="comment_form"></div>
<div class="announce">* 以上用户言论只代表其个人观点，不代表CSDN网站的观点或立场<a name="reply"></a><a name="quote"></a></div>
<script type="text/javascript">
    var fileName = '7086952';
    var commentscount = 0;
    var islock = false
</script>
<script type="text/javascript" src="http://static.blog.csdn.net/scripts/comment.js"></script>
<div id="ad_bot"></div>
<script type="text/javascript">
    new Ad(5, 'ad_bot');
</script>
<div id="report_dialog"></div>

<div id="d-top" style="display:none;">
<a id="d-top-a" href="#" title="回到顶部">
<img src="http://static.blog.csdn.net/images/top.png" alt="TOP" /></a>
</div>
<script type="text/javascript">
    $(function(){
        var d_top=$('#d-top');
        document.onscroll=function(){
            var scrTop=(document.body.scrollTop||document.documentElement.scrollTop);
            if(scrTop>500){
                d_top.show();
            }else{
                d_top.hide();
            }
        }
        $('#d-top-a').click(function(){
            scrollTo(0,0);
            this.blur();
            return false;
        });
    });
</script>

<div class="clear"></div>
</div>
</div>

<div id="side">
<div class="side">
<div id="panel_Profile" class="panel">
<ul class="panel_head"><span>个人资料</span></ul>
<ul class="panel_body profile">
<div id="blog_userface">
    <a href="http://my.csdn.net/zy_11162311" target="_blank">
    <img src="http://avatar.csdn.net/C/4/5/1_zy_11162311.jpg" title="访问我的空间" style="max-width:90%"/>
    </a>
    <br />
    <span><a href="http://my.csdn.net/zy_11162311" class="user_name" target="_blank">zy_11162311</a></span>
</div>
<div class="interact">
<a href="javascript:void(0);" class="attent" id="span_add_follow" title="[加关注]"></a>
<a href="javascript:void(0);" class="letter" onclick="loginto(1)" title="[发私信]"></a>
</div>
<div id="blog_medal">
</div>
<ul id="blog_rank">
    <li>访问：<span>4822次</span></li>
    <li>积分：<span>102分</span></li>
    <li>排名：<span>千里之外</span></li>
</ul>
<ul id="blog_statistics">
    <li>原创：<span>1篇</span></li>
    <li>转载：<span>20篇</span></li>
    <li>译文：<span>2篇</span></li>
    <li>评论：<span>2条</span></li>
</ul>
</ul>
</div>



<div class="panel" id="panel_Search">
    <ul class="panel_head"><span>文章搜索</span></ul>
    <ul class="panel_body">
        <form id="frmSearch" action="http://so.csdn.net/search" class="form_search" target="_blank">
        <span><input id="inputSearch" type="text" class="blogsearch" title="请输入关键字" /></span>
        <input id="btnSubmit" type="submit" value="搜索" title="search in blog" />
        <input type="hidden" name="q" id="inputQ" />
        <input type="hidden" name="t" value="blog" />
        <a id="btnSearchBlog" target="_blank"></a>
        </form>
    </ul>
</div><div id="panel_Category" class="panel">
<ul class="panel_head"><span>文章分类</span></ul>
<ul class="panel_body">
<li>
<a href="http://blog.csdn.net/zy_11162311/article/category/942764">LCD</a><span>(11)</span>
</li>
<li>
<a href="http://blog.csdn.net/zy_11162311/article/category/948240">Filesystem</a><span>(4)</span>
</li>
<li>
<a href="http://blog.csdn.net/zy_11162311/article/category/952059">热插拔</a><span>(1)</span>
</li>
<li>
<a href="http://blog.csdn.net/zy_11162311/article/category/1292684">zhi</a><span>(0)</span>
</li>
<li>
<a href="http://blog.csdn.net/zy_11162311/article/category/1292685">指针</a><span>(1)</span>
</li>
</ul>
</div><div id="panel_Archive" class="panel">
<ul class="panel_head"><span>文章存档</span></ul>
<ul class="panel_body">
<div id="archive_list">
<!--归档统计-->
<li><a href="http://blog.csdn.net/zy_11162311/article/month/2012/11">2012年11月</a><span>(1)</span></li><li><a href="http://blog.csdn.net/zy_11162311/article/month/2011/12">2011年12月</a><span>(22)</span></li>
</div>
</ul>
</div>
<div id="hotarticls" class="panel">
<ul class="panel_head"><span>阅读排行</span></ul>
<ul class="panel_body itemlist">
<li>
<a href="/zy_11162311/article/details/7053605" title="LCD驱动中pixclock的计算">LCD驱动中pixclock的计算</a><span>(611)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7086952" title="framebuffer驱动">framebuffer驱动</a><span>(431)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7071137" title="linux 热插拔">linux 热插拔</a><span>(391)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7103468" title="wpa_cli 连接 wifi">wpa_cli 连接 wifi</a><span>(335)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7052899" title="linux LCD驱动中的LCD参数">linux LCD驱动中的LCD参数</a><span>(244)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7052081" title="编写基于Linux的lcd驱动">编写基于Linux的lcd驱动</a><span>(217)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7050571" title="LCD原理和驱动">LCD原理和驱动</a><span>(208)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7057701" title="Filesystem Hierarchy Standard">Filesystem Hierarchy Standard</a><span>(179)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7052720" title="PWM, LED, BACKLIGHT, VIBRATOR调试笔记(未完待续) .">PWM, LED, BACKLIGHT, VIBRATOR调试笔记(未完待续) .</a><span>(177)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7050522" title="LCD 原理和移植总结">LCD 原理和移植总结</a><span>(168)</span>
</li>
</ul>
</div>
<div id="hotarticls2" class="panel">
<ul class="panel_head"><span>评论排行</span></ul>
<ul class="panel_body itemlist">
<li>
<a href="/zy_11162311/article/details/7053605" title="LCD驱动中pixclock的计算">LCD驱动中pixclock的计算</a><span>(1)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7055752" title="Linux--根文件系统的挂载过程分析">Linux--根文件系统的挂载过程分析</a><span>(1)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7057335" title="Linux 文件系统">Linux 文件系统</a><span>(0)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7057367" title="构建基本的嵌入式Linux根文件系统">构建基本的嵌入式Linux根文件系统</a><span>(0)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7057701" title="Filesystem Hierarchy Standard">Filesystem Hierarchy Standard</a><span>(0)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7071137" title="linux 热插拔">linux 热插拔</a><span>(0)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7085484" title="framebuffer learning">framebuffer learning</a><span>(0)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7086952" title="framebuffer驱动">framebuffer驱动</a><span>(0)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7096054" title="framebuffer_2">framebuffer_2</a><span>(0)</span>
</li>
<li>
<a href="/zy_11162311/article/details/7103468" title="wpa_cli 连接 wifi">wpa_cli 连接 wifi</a><span>(0)</span>
</li>
</ul>
</div>
<div id="homepageArticles" class="panel">
<ul class="panel_head"><span>推荐文章</span></ul>
<ul class="panel_body" id="ad_commend"></ul>
</div>
<script type="text/javascript">
 new Ad(12, 'ad_commend');
</script><div id="newcomments" class="panel">
<ul class="panel_head"><span>最新评论</span></ul>
<ul class="panel_body itemlist">
    <li>
    <a href="/zy_11162311/article/details/7055752#comments">Linux--根文件系统的挂载过程分析</a>
    <p style="margin:0px;"><a href="/jackylongchen" class="user_name">jackylongchen</a>:
不错
    </p>
    </li>
    <li>
    <a href="/zy_11162311/article/details/7053605#comments">LCD驱动中pixclock的计算</a>
    <p style="margin:0px;"><a href="/jackylongchen" class="user_name">jackylongchen</a>:
学习了
    </p>
    </li>
</ul>
</div>
</div>
<div class="clear"></div>
</div>

<div class="clear"></div>
</div>

<script type="text/javascript" src="http://static.blog.csdn.net/scripts/newblog.min.js?v=1.1"></script>
<script type="text/javascript" src="http://medal.blog.csdn.net/showblogmedal.ashx?blogid=1185563"></script>

<script type="text/javascript">
document.write('<script type="text/javascript" src="http://csdnimg.cn/pubfooter/js/publib_footer.js?' + Math.floor(new Date()/120000).toString(36) + '="></'+'script>');
</script>

<script type="text/javascript" src="http://passport.csdn.net/content/loginbox/login.js"></script>
<script type="text/javascript">document.write("<img src=http://counter.csdn.net/pv.aspx?id=24 border=0 width=0 height=0>");</script>
<script type="text/javascript" src="http://www.csdn.net/ui/scripts/Csdn/counter.js?v=1"></script>


<script type="text/javascript" src="http://ad.csdn.net/scripts/ad-blog.js"></script>

</div>
</body>
</html>