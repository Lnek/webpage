<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="keywords" content="WinQXL" />
<link rel="shortcut icon" href="/favicon.ico" />
		<title>WinQXL - Spice</title>
		<link rel="icon" type="image/png" href="/wiki/skins/spice/favicon.png"/>
		<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "/wiki/skins/spice/main.css?7"; /*]]>*/</style>
		<link rel="stylesheet" type="text/css" media="print" href="/wiki/skins/common/commonPrint.css" />
		<!--[if lt IE 5.5000]><style type="text/css">@import "/wiki/skins/spice/IE50Fixes.css";</style><![endif]-->
		<!--[if IE 5.5000]><style type="text/css">@import "/wiki/skins/spice/IE55Fixes.css";</style><![endif]-->
		<!--[if IE 6]><style type="text/css">@import "/wiki/skins/spice/IE60Fixes.css";</style><![endif]-->
		<!--[if IE 7]><style type="text/css">@import "/wiki/skins/spice/IE70Fixes.css?1";</style><![endif]-->
		<!--[if lt IE 7]><script type="text/javascript" src="/wiki/skins/common/IEFixes.js"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->
		<script type="text/javascript">var skin = 'spice';var stylepath = '/wiki/skins';</script>
		<script type="text/javascript" src="/wiki/skins/common/wikibits.js"><!-- wikibits js --></script>
		<script type="text/javascript" src="/wiki/index.php?title=-&amp;action=raw&amp;gen=js"><!-- site js --></script>
		<style type="text/css">/*<![CDATA[*/
@import "/wiki/index.php?title=MediaWiki:Common.css&action=raw&ctype=text/css&smaxage=18000";
@import "/wiki/index.php?title=MediaWiki:Spice.css&action=raw&ctype=text/css&smaxage=18000";
@import "/wiki/index.php?title=-&action=raw&gen=css&maxage=18000";
/*]]>*/</style>
		<!-- Head Scripts -->
		
<script>

function GetEventTarget(event)
{
  if (!event) {
    event = window.event;
  }

  if (event.target) {
    object = event.target;
  } else {
    object = event.srcElement;
  }
  return object;
}

function OnEnterMenuItem(event)
{
  var object = GetEventTarget(event);
  object.style.backgroundColor = "#666666";
  object.style.borderColor = "#c8c4b7";
}

function OnLeaveMenuItem(event)
{
  var object = GetEventTarget(event);
  object.style.backgroundColor = "transparent";
  object.style.borderColor = "transparent";
}

function OnMenuItemClick(event, url)
{  
  var object = GetEventTarget(event);
  object.style.backgroundColor = "transparent";
  object.style.borderColor = "transparent";
  window.location = url;  
}

function GetIEVersion()
{
  var version = -1;

  if (window.navigator.appName == "Microsoft Internet Explorer") {
    var user_agent = navigator.userAgent;
    var reg_expresion = new RegExp("MSIE ([0-9]{1,}[\.0-9]{0,})");
    if (reg_expresion.exec(user_agent) != null) {
      version = parseFloat(RegExp.$1);
    }
  }
  return version;
}

function TestIE()
{
  var ie_version = GetIEVersion();
  if (ie_version == -1) {
    return;
  }
  if (ie_version < 7) {
    window.location = "ie_version.html" 
  }
}


</script>


	</head>
<body  class="ns-0 ltr">

	<div id="header" width="100%" style="background-image: url('/wiki/skins/spice/plasma.jpg'); background-repeat:no-repeat;">

	<table width="100%" style="background: transparent;">
	<tr>
    		<td><img alt="logo" src="/wiki/skins/spice/spice_wiki_logo.png" style="padding-left:40px; padding-top:10px" /></td>
    		<td align="right" valign="top">
        	<div id="search-area">
        		<form action="http://www.google.com/search" method="get">
        			Search:<input class="search-box" id="q" name="q" type="text"/>
				<input type="hidden" name="sitesearch" value="spice-space.org"/> <!--************************* -->
        		</form> 
        	</div>
    		</td>
	</tr>
	</table>


	<table>
	<tr id="menu-bar">

			
			<td class="menu-item" onmouseover="OnEnterMenuItem(event)" onmouseout="OnLeaveMenuItem(event)"
       				onclick='OnMenuItemClick(event, "/page/Main_Page" )'>
								Main Page</td>

		
			<td class="menu-item" onmouseover="OnEnterMenuItem(event)" onmouseout="OnLeaveMenuItem(event)"
       				onclick='OnMenuItemClick(event, "/page/Todo" )'>
								Todo</td>

		
			<td class="menu-item" onmouseover="OnEnterMenuItem(event)" onmouseout="OnLeaveMenuItem(event)"
       				onclick='OnMenuItemClick(event, "/page/Howtos" )'>
								Howtos</td>

		
			<td class="menu-item" onmouseover="OnEnterMenuItem(event)" onmouseout="OnLeaveMenuItem(event)"
       				onclick='OnMenuItemClick(event, "/page/Repositories" )'>
								Repositories</td>

		
			<td class="menu-item" onmouseover="OnEnterMenuItem(event)" onmouseout="OnLeaveMenuItem(event)"
       				onclick='OnMenuItemClick(event, "/page/Testing" )'>
								Testing</td>

		
			<td class="menu-item" onmouseover="OnEnterMenuItem(event)" onmouseout="OnLeaveMenuItem(event)"
       				onclick='OnMenuItemClick(event, "/page/In_progress" )'>
								In progress</td>

		
			<td class="menu-item" onmouseover="OnEnterMenuItem(event)" onmouseout="OnLeaveMenuItem(event)"
       				onclick='OnMenuItemClick(event, "/page/Ideas" )'>
								Ideas</td>

		
			<td class="menu-item" onmouseover="OnEnterMenuItem(event)" onmouseout="OnLeaveMenuItem(event)"
       				onclick='OnMenuItemClick(event, "/page/Your_space" )'>
								Your space</td>

		
			<td class="menu-item" onmouseover="OnEnterMenuItem(event)" onmouseout="OnLeaveMenuItem(event)"
       				onclick='OnMenuItemClick(event, "/page/Links" )'>
								Links</td>

			
	</tr>
	</table>



	</div>
<div>
<table width="100%" border="0" style="margin-top: 20px;" cellspacing=0 cellpadding=0>
<tr>
  <td valign="top" style="padding-right: 50px;">
       <!--div style="background-image: url('/wiki/skins/spice/plasma.jpg'); background-repeat:no-repeat; background-position: 0px -190px; height: 48px; "-->
       <div style="background-color: #000; background-repeat:no-repeat; background-position: 0px -190px; height: 48px;">

	<div style="padding-top:12px; padding-left:15px; font-size: 18px; float:left; font-weight: bold; color: #f0f0f0;">WinQXL </div>
      </div>
      <div id="content">
<!-- ************************************************************************************************************************************************** -->

	<div id="globalWrapper">
		<div id="column-content">
	<div id="content">
	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
	
		<a name="top" id="top"></a>
		   <!--h1 class="firstHeading">WinQXL</h1-->
		<div id="bodyContent">
			<h3 id="siteSub">From Spice</h3>
			<div id="contentSub"></div>
									<div id="jump-to-nav">Jump to: <a href="#column-one">navigation</a>,<a href="#searchInput">search</a></div>
			<!-- start content -->
			
			<!-- this is where the search blob was before -->

			<p>TODO: merge / update from <a href="http://www.linux-kvm.org/page/WindowsGuestDrivers/UpdatedGuestDebugging" class='external free' title="http://www.linux-kvm.org/page/WindowsGuestDrivers/UpdatedGuestDebugging" rel="nofollow">http://www.linux-kvm.org/page/WindowsGuestDrivers/UpdatedGuestDebugging</a>
</p>
<table id="toc" class="toc" summary="Contents"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class='toclevel-1'><a href="#How_to_build_the_driver"><span class="tocnumber">1</span> <span class="toctext">How to build the driver</span></a></li>
<li class='toclevel-1'><a href="#Detailed_Instructions:_Build_QXL_on_Windows_7_64_bit"><span class="tocnumber">2</span> <span class="toctext">Detailed Instructions: Build QXL on Windows 7 64 bit</span></a>
<ul>
<li class='toclevel-2'><a href="#Prerequisites"><span class="tocnumber">2.1</span> <span class="toctext">Prerequisites</span></a></li>
<li class='toclevel-2'><a href="#Build"><span class="tocnumber">2.2</span> <span class="toctext">Build</span></a></li>
<li class='toclevel-2'><a href="#Signing"><span class="tocnumber">2.3</span> <span class="toctext">Signing</span></a></li>
<li class='toclevel-2'><a href="#Installing"><span class="tocnumber">2.4</span> <span class="toctext">Installing</span></a></li>
</ul>
</li>
<li class='toclevel-1'><a href="#Troubleshooting_Installation"><span class="tocnumber">3</span> <span class="toctext">Troubleshooting Installation</span></a>
<ul>
<li class='toclevel-2'><a href="#Code_52"><span class="tocnumber">3.1</span> <span class="toctext">Code 52</span></a></li>
<li class='toclevel-2'><a href="#Generic_Advice"><span class="tocnumber">3.2</span> <span class="toctext">Generic Advice</span></a></li>
</ul>
</li>
<li class='toclevel-1'><a href="#Debugging"><span class="tocnumber">4</span> <span class="toctext">Debugging</span></a>
<ul>
<li class='toclevel-2'><a href="#Nice_to_have_rant"><span class="tocnumber">4.1</span> <span class="toctext">Nice to have rant</span></a></li>
<li class='toclevel-2'><a href="#qemu_options_to_turn_on"><span class="tocnumber">4.2</span> <span class="toctext">qemu options to turn on</span></a>
<ul>
<li class='toclevel-3'><a href="#guestdebug"><span class="tocnumber">4.2.1</span> <span class="toctext">guestdebug</span></a></li>
<li class='toclevel-3'><a href="#cmdlog"><span class="tocnumber">4.2.2</span> <span class="toctext">cmdlog</span></a></li>
</ul>
</li>
</ul>
</li>
<li class='toclevel-1'><a href="#Random_notes"><span class="tocnumber">5</span> <span class="toctext">Random notes</span></a></li>
<li class='toclevel-1'><a href="#Debug_Cycle"><span class="tocnumber">6</span> <span class="toctext">Debug Cycle</span></a></li>
<li class='toclevel-1'><a href="#Running_WinDBG"><span class="tocnumber">7</span> <span class="toctext">Running WinDBG</span></a></li>
<li class='toclevel-1'><a href="#WDDM_debugging"><span class="tocnumber">8</span> <span class="toctext">WDDM debugging</span></a>
<ul>
<li class='toclevel-2'><a href="#Debugging_user_mode_dll"><span class="tocnumber">8.1</span> <span class="toctext">Debugging user mode dll</span></a></li>
</ul>
</li>
<li class='toclevel-1'><a href="#HCK"><span class="tocnumber">9</span> <span class="toctext">HCK</span></a></li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=1" title="Edit section: How to build the driver">edit</a>]</div><a name="How_to_build_the_driver"></a><h1> How to build the driver </h1>
<p>Repository or sources available from the <a href="http://www.spice-space.org/page/Repositories" class='external text' title="http://www.spice-space.org/page/Repositories" rel="nofollow">repositories</a>
</p><p>You need spice-protocol checked out under directory common, and to set an environment variable (can be done globally or just in the build shell):
</p>
<pre>set SPICE_COMMON_DIR=c:\common\spice-protocol
mkdir c:\common
cd common
git clone git://anongit.freedesktop.org/spice/spice-protocol
git clone git://anongit.freedesktop.org/spice/win32/qxl
rem install the winddk 7600.16385.0
rem start the checked environment (or the free one) - this is the contents of
rem the relevant shortcut that winddk creates (for a specific instance, i.e.
rem x86 WXP checked).
rem C:\WINDOWS\system32\cmd.exe /k C:\WinDDK\7600.16385.0\bin\setenv.bat C:\WinDDK\7600.16385.0\ chk x86 WXP
</pre>
<pre>cd qxl
build -cZg

</pre>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=2" title="Edit section: Detailed Instructions: Build QXL on Windows 7 64 bit">edit</a>]</div><a name="Detailed_Instructions:_Build_QXL_on_Windows_7_64_bit"></a><h1> Detailed Instructions: Build QXL on Windows 7 64 bit </h1>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=3" title="Edit section: Prerequisites">edit</a>]</div><a name="Prerequisites"></a><h2> Prerequisites </h2>
<p>Checkout QXL drivers.  The latest include 64-bit although it says "32-bit"
</p>
<ul><li> git clone git://git.freedesktop.org/git/spice/win32/qxl
</li></ul>
<p>You should have 3 directories inside qxl directory:
Display, Miniport and Include.
</p>
<ul><li> Download Spice Protocol from  <a href="http://spice-space.org" class='external free' title="http://spice-space.org" rel="nofollow">http://spice-space.org</a>
</li></ul>
<pre>Bunzip2 --> spice-protocol-0.6.4.tar.bz2 --> copy "spice" folder where qxl_dev.h located to  Display, Miniport folders.
     qxl expect headers to be in "spice" folder.
</pre>
<ul><li> Download latest version of WinDDK that support Windows 7. 
</li></ul>
<p><a href="http://msdn.microsoft.com/en-us/windows/hardware/gg487428" class='external free' title="http://msdn.microsoft.com/en-us/windows/hardware/gg487428" rel="nofollow">http://msdn.microsoft.com/en-us/windows/hardware/gg487428</a>
</p><p>After installing the Winddk you will have to create new environment variable:
Variable name: SPICE_COMMON_DIR
with C:\qxl
</p><p><a href="http://www.itechtalk.com/thread3595.html" class='external free' title="http://www.itechtalk.com/thread3595.html" rel="nofollow">http://www.itechtalk.com/thread3595.html</a>
</p><p>OR:
</p><p>Open a Free Build x64 command prompt from the WinDDK
</p><p>Type:
</p><p>set SPICE_COMMON_DIR=c:\path\to\spice-protocol
</p><p>Next:
</p><p>Start --> All Programs --> Windows Driver Kits --> WDK 7600.16385.1 --> Build environment (pick your choice after this step)
Windows 7 -> x64 Free Build Environment
It will open a new DOS prompt for you to start building.
(Make sure to use the "Free" and not "Checked", the "checked" is debug version)
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=4" title="Edit section: Build">edit</a>]</div><a name="Build"></a><h2> Build </h2>
<pre>c:\WinDDK\7600.16385.1>cd \
c:\>cd qxl
c:\qxl>build -cZg
</pre>
<p>It should create 2 new files for QXL driver: qxldd.dll and  qxl.sys
</p><p>The 3rd file: qxl.inf which is originated from QXL driver folder.
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=5" title="Edit section: Signing">edit</a>]</div><a name="Signing"></a><h2> Signing </h2>
<p>Follow the steps here on how to sign the driver with a test certificate:
</p><p>1. MakeCert -r -pe -ss SpiceTestCertStore -n "CN=spice-space.org(Test)" SpiceTestCert.cer
</p><p>2. CertMgr /add SpiceTestCert.cer /s /r localMachine root
</p><p>3. SignTool sign /v /s SpiceTestCertStore /n spice-space.org(Test) /t <a href="http://timestamp.verisign.com/scripts/timestamp.dll" class='external free' title="http://timestamp.verisign.com/scripts/timestamp.dll" rel="nofollow">http://timestamp.verisign.com/scripts/timestamp.dll</a> qxl.sys qxldd.dll
</p><p>Before installing the driver on the guest, call:
</p><p>bcdedit.exe -set TESTSIGNING ON
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=6" title="Edit section: Installing">edit</a>]</div><a name="Installing"></a><h2> Installing </h2>
<pre>I) Copying files ( assuming [3] below )
</pre>
<p>1. Open elevated command prompt
</p><p>2. bcdedit.exe -set loadoptions DDISABLE_INTEGRITY_CHECKS
</p><p>3. bcdedit.exe -set TESTSIGNING ON
</p><p>4. Copy qxldd.dll to c:\windows\system32\
</p><p>5. Copy qxl.sys to c:\windows\system32\drivers\
</p><p>6. Reboot
</p>
<pre>II) Using Device Manager
</pre>
<p>1.Putting the signed drivers &amp; inf file in a local (temp) folder.
</p><p>2. Install it from Device Manager:
</p>
<pre>     -> Display Adapters
     -> QXL/VGA
     -> Right-Click -> Update Driver Software
     -> Browse my computer for driver software (bottom)
     -> Let me pick from a list ... (bottom)
     -> Have Disk... (button)
     -> Browse (button)
     -> path-to-qxl-driver.inf -> OK
     -> Next
     -> Close
     -> Want to reboot&nbsp;?  Yes
 - must reboot after qxl driver installation. 
</pre>
<pre>III) using <a href="http://technet.microsoft.com/en-us/library/ff800798%28WS.10%29.aspx" class='external text' title="http://technet.microsoft.com/en-us/library/ff800798%28WS.10%29.aspx" rel="nofollow">pnputil.exe</a>
</pre>
<p>pnputil is built in to win7 and newer (it's in the default path).
</p><p>pnputil -i -a qxl.inf
</p>
<ul><li> if the driver is unsigned you still get the popup red bordered dialog requiring confirmation of installing an unsigned driver.
</li></ul>
<pre>IV) Using nsis - see <a href="http://nsis.sourceforge.net/Driver_installation_and_update" class='external free' title="http://nsis.sourceforge.net/Driver_installation_and_update" rel="nofollow">http://nsis.sourceforge.net/Driver_installation_and_update</a>
</pre>
<p>Also TODO.
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=7" title="Edit section: Troubleshooting Installation">edit</a>]</div><a name="Troubleshooting_Installation"></a><h1> Troubleshooting Installation </h1>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=8" title="Edit section: Code 52">edit</a>]</div><a name="Code_52"></a><h2> Code 52 </h2>
<p>Windows cannot verify the digital signature for the drivers required for this device.
</p><p>The driver certificate chain isn't rooted in a trusted certificate. This is expected since these drivers have not passed WHQL. You need to answer "yes" to the big red dialog that says you should not say yes.
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=9" title="Edit section: Generic Advice">edit</a>]</div><a name="Generic_Advice"></a><h2> Generic Advice </h2>
<p>(How is this different then debugging? this is for installation errors)
</p><p>Installation can fail for many reasons:
</p>
<ul><li> signature lacking
</li><li> newer version driver and you didn't force usage of your driver
</li></ul>
<p>Writing detailed procedure is ToDo, but for information collection purposes you should look for setupapi logs:
</p><p>windows xp:
</p>
<ul><li> c:\Windows\setupapi.log
</li></ul>
<p>windows 7:
</p>
<ul><li> c:\Windows\inf\setupapi.dev.log
</li></ul>
<p>In both cases it is helpful to:
</p>
<ul><li> delete / rename the current log file
</li><li> do the install/update again (which fails)
</li><li> send as attachment / fpaste and put on irc the resulting log file
</li></ul>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=10" title="Edit section: Debugging">edit</a>]</div><a name="Debugging"></a><h1> Debugging </h1>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=11" title="Edit section: Nice to have rant">edit</a>]</div><a name="Nice_to_have_rant"></a><h2> Nice to have rant </h2>
<p>Unlike the nice virtio drivers we don't have an option to enable logging in the guest from device properties (yet). (what we do have is the option to log to the host via an io port, QXL_IO_LOG, which is neat too).
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=12" title="Edit section: qemu options to turn on">edit</a>]</div><a name="qemu_options_to_turn_on"></a><h2> qemu options to turn on </h2>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=13" title="Edit section: guestdebug">edit</a>]</div><a name="guestdebug"></a><h3> guestdebug </h3>
<p>The driver reads a guestdebug parameter from the rom, that is settable during the creation of the machine (we used to have a monitor command but it was dropped during upstream, yet another todo). This uses the QXL_IO_DEBUG io out, so each debug print will cause a vmexit (in practice it's still way faster then a debugger. probably slower then having a logging mechanism in the guest like the nice to have rant above).
</p>
<pre>-global qxl-vga.guestdebug=3
</pre>
<p>And for any secondary cards either use:
</p>
<pre>-global qxl.guestdebug=3
</pre>
<p>Or set it via the device:
</p>
<pre>-device qxl,guestdebug=3
</pre>
<p>You can go up to 12 (or more, look for DEBUG_PRINT in the driver), you get really a lot of debug information. Interesting values are:
</p>
<ul><li> 3 - will give you all the highlevel commands (DrvCopyBits, DrvBitBlt, etc.)
</li><li> 6 - will also show QXLGetBitMap
</li><li> 11 - will show caching of images (this is a driver cache, not to be confused with the server&lt;-&gt;client shared cache).
</li></ul>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=14" title="Edit section: cmdlog">edit</a>]</div><a name="cmdlog"></a><h3> cmdlog </h3>
<p>This will dump all the commands passing through the ringbuffer on the device side. It is driver and hence guest agnostic. Defaults to 0. Just two values, 1 to enable, 0 to disable.
</p>
<pre>-global qxl-vga.cmdlog=1
</pre>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=15" title="Edit section: Random notes">edit</a>]</div><a name="Random_notes"></a><h1> Random notes </h1>
<p>Notice that sometimes the driver gets uninstalled when you kill a vm uncleanly (not a shutdown), via the restore mechanisem of windows 7 in the next reboot (it returns to a last known working configuration).
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=16" title="Edit section: Debug Cycle">edit</a>]</div><a name="Debug_Cycle"></a><h1> Debug Cycle </h1>
<p>This is the way I debug the driver right now:
</p><p>Setup:
</p>
<ul><li> have a build vm with ddk installed. (update: winddk works with wine, except for makecert, so all of this can be done from linux with wine).
</li><li> have a checkout of the source on my linux development machine (which also hosts the vms and runs the clients)
</li><li> have a samba share with the sources.
</li><li> have that share visible to the build vm.
</li></ul>
<p>You can install the drivers from a running vm, but since they tend to give you bluescreens during development, and since you need a reboot to get the new ones anyway, the following flow works for me:
</p><p>Update driver work flow
</p>
<ul><li> host: (using \$EDITOR): update driver code
</li><li> host: update revision of driver (see [1] below)
</li><li> buildvm: build vm (I use [4] script)
</li><li> while not build successfull:
<ul><li> host: update driver code
</li><li> buildvm: build driver
</li></ul>
</li><li> host: take down test vm
</li><li> host: update test vm drivers (see [2] below, and note [3])
</li><li> host: start test vm
</li><li> testvm: test your new code
</li></ul>
<p>[1] - update revision scriptlet
</p>
<pre>#!/bin/bash
TAG=`date +%Y%m%d_%H%M%S`
for f in miniport/qxl.inf miniport/qxl.rc display/driver.rc; do
    sed -i -e "s/alon\..*/alon.$TAG\"/" $f
done
</pre>
<p>[2] - update driver scriptlet
</p>
<pre>#!/bin/bash
guestfish &lt;&lt;_EOF_
add /store/images/win7x86_qxl_tests.img
lcd /store/images
run
mount /dev/vda2 /
upload /store/shared_win/spice_upstream/qxl/install_win7/qxldd.dll /Windows/System32/qxldd.dll
upload /store/shared_win/spice_upstream/qxl/install_win7/qxl.sys /Windows/System32/drivers/qxl.sys
checksum md5 /Windows/System32/qxldd.dll
checksum md5 /Windows/System32/drivers/qxl.sys
_EOF_
md5sum /store/shared_win/spice_upstream/qxl/install_win7/qxldd.dll
md5sum /store/shared_win/spice_upstream/qxl/install_win7/qxl.sys
</pre>
<p>[3] This assumes you have installed a version of the drivers using the normal installation procedure first. because that script doesn't do anything except replace the existing qxldd.dll and qxl.sys, so it doesn't touch the registry.
</p><p>[4] build script on the build vm (this one builds the win7 checked drivers) (it goes with [2] above which reads the new drivers from that directory)
</p>
<pre>cd miniport
</pre>
<pre>build -cZg
</pre>
<pre>cd ../display
</pre>
<pre>build -cZg
</pre>
<pre>cd ../
</pre>
<pre>copy display\objchk_win7_x86\i386\qxldd.dll install_win7
</pre>
<pre>copy miniport\objchk_win7_x86\i386\qxl.sys install_win7
</pre>
<pre>copy miniport\qxl.inf install_win7
</pre>
<pre>copy display\objchk_win7_x86\i386\qxldd.pdb install_win7
</pre>
<pre>copy miniport\objchk_win7_x86\i386\qxl.pdb install_win7
</pre>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=17" title="Edit section: Running WinDBG">edit</a>]</div><a name="Running_WinDBG"></a><h1> Running WinDBG </h1>
<p>setup:
</p>
<ul><li> target vm: running windows and the driver under development, setup for kernel debug
</li><li> windbg vm: running any windows version with windbg
</li></ul>
<p>connection via emulated serial port over 
</p>
<ul><li> target vm qemu command line: (it will open the windbg vm's tcp port, i.e. be a tcp client)
<ul><li> qemu... -serial tcp:0.0.0.0:4442
</li></ul>
</li><li> To debug boot process start it in suspended mode with a stdio monitor interface (you could also automate this with qmp, left as an exercise for the reader) and wait until you connect with windbg before executing 'cont' on the monitor.
</li></ul>
<ul><li> windbg vm qemu command line:
<ul><li> qemu ... -chardev socket,id=test,host=localhost,port=4442,server,nowait -monitor stdio -device isa-serial,chardev=test
</li></ul>
</li></ul>
<p>If the target is winxp:
</p>
<ul><li> edit c:\boot.ini, place the following contents:
</li></ul>
<pre>multi(0)disk(0)rdisk(0)partition(1)\WINDOWS="Windows XP Professional (Debug COM1)" /noexecute=optin /fastdetect /debug /debugport=COM1 /baudrate=115200
</pre>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=18" title="Edit section: WDDM debugging">edit</a>]</div><a name="WDDM_debugging"></a><h1> WDDM debugging </h1>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=19" title="Edit section: Debugging user mode dll">edit</a>]</div><a name="Debugging_user_mode_dll"></a><h2> Debugging user mode dll </h2>
<p>using windbg, attach / run tester
</p><p>help
</p>
<ul><li> .hh xxx
</li></ul>
<p>load symbols
</p>
<ul><li> symsrv*symsrv.dll*c:\symbols*<a href="http://msdl.microsoft.com/download/symbols" class='external free' title="http://msdl.microsoft.com/download/symbols" rel="nofollow">http://msdl.microsoft.com/download/symbols</a>
</li><li> .reload /f /d
</li></ul>
<p>list loaded modules
</p>
<ul><li> lm t n
</li></ul>
<p>go
</p>
<ul><li> g
</li></ul>
<p>restart
</p>
<ul><li>.restart /f
</li></ul>
<p>stack backtrace
</p>
<ul><li> kb
</li></ul>
<p>registers
</p>
<ul><li> r
</li></ul>
<p>display ascii
</p>
<ul><li> da
</li></ul>
<p>unassamble
</p>
<ul><li> u
</li><li> uf CreateDXGIFactory
</li></ul>
<p>breakpoints
</p>
<ul><li> bp qxlum.dll!OpenAdapter10
</li></ul>
<p>break on loading of user mode dll:
</p>
<ul><li> sxe ld:qxlum.dll
</li></ul>
<ul><li> step until next call: pc
</li><li> step over: p
</li><li> step into: t
</li><li> step out: gu
</li></ul>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=WinQXL&amp;action=edit&amp;section=20" title="Edit section: HCK">edit</a>]</div><a name="HCK"></a><h1> HCK </h1>
<p>Microsoft has a test suite for drivers, actually passing the tests is mandatory. Installing the whole test suite takes a lot of time/space but there is an alternative of running the tests from the command line.
</p>
<ul><li> [<a href="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265574%28v=vs.85%29.aspx" class='external free' title="http://msdn.microsoft.com/en-us/library/windows/hardware/dn265574%28v=vs.85%29.aspx" rel="nofollow">http://msdn.microsoft.com/en-us/library/windows/hardware/dn265574%28v=vs.85%29.aspx</a> How to run the HCK Test Suites in WDK 8.1}
</li><li> <a href="http://msdn.microsoft.com/en-us/library/windows/hardware/jj674802%28v=vs.85%29.aspx" class='external text' title="http://msdn.microsoft.com/en-us/library/windows/hardware/jj674802%28v=vs.85%29.aspx" rel="nofollow">How to test a driver at runtime from a Command Prompt</a>
</li></ul>

<!-- Saved in parser cache with key spice:pcache:idhash:1459-0!1!0!0!!en!2 and timestamp 20130826150341 -->
<div class="printfooter">
Retrieved from "<a href="http://spice-space.org/page/WinQXL">http://spice-space.org/page/WinQXL</a>"</div>
			 			<!-- end content -->
			<div class="visualClear"></div>
		</div>
	</div>
		</div>
		<div id="column-one">
		</div><!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>

	<script type="text/javascript"> if (window.runOnloadHook) runOnloadHook();</script>
</div>


<!-- ************************************************************************************************************************************************** -->
	</div>
  </td>
    <td width="160" valign="top">
      <div class="banner" style="height: 49px;">
        <div style="margin-top: 12px;">
          <a style="color: #ffffff; font-size:18px; font-weight: bold;" href="/">{ main_site(); }</a>
        </div>
      </div>
      <!-- div class="banner" style="height: 212px;">
        <img style="margin-top: 10px;" src="/wiki/skins/spice/join_us_plasma.png" />
        <div style="margin-top: 5px; color: #ffffff; font-size:18px; font-weight: bold;">Join us!</div>
      </div -->
    </td>
  
   </tr>
   </table>
</div>


<div id="new_footer"">

<table width="100%">
<tr>
<td width="180px">
<a href="http://et.redhat.com"> <img alt="et" src="/wiki/skins/spice/et-banner.png" style="padding-left:15px; padding-top:12px; border: 0px;" /> </a>
</td>
<td align="left">
	<div id="p-cactions" class="portlet">
		<table><tr>
		<td><strong>Views</strong>:&nbsp;</td>
				 <td id="ca-nstab-main" class="selected"><a href="/page/WinQXL">Article</a></td>
				 <td id="ca-talk" class="new"><a href="/wiki/index.php?title=Talk:WinQXL&amp;action=edit">Discussion</a></td>
				 <td id="ca-edit"><a href="/wiki/index.php?title=WinQXL&amp;action=edit">Edit</a></td>
				 <td id="ca-history"><a href="/wiki/index.php?title=WinQXL&amp;action=history">History</a></td>
		</tr></table>
	</div>

	<div class="portlet" id="p-personal">
			<table><tr>
		<td><strong>Personal tools:&nbsp;</strong></td>
				<td id="pt-login"><a href="/wiki/index.php?title=Special:Userlogin&amp;returnto=WinQXL">Log in / create account</a></td>
			</tr></table>
	</div>

	<div class="portlet" id="p-tb">
		<div class="pBody">
		<table><tr>
		<td><strong>Toolbox</strong>:&nbsp;</td>
				<td id="t-whatlinkshere"><a href="/page/Special:Whatlinkshere/WinQXL">What links here</a></td>
				<td id="t-recentchangeslinked"><a href="/page/Special:Recentchangeslinked/WinQXL">Related changes</a></td>
<td id="t-upload"><a href="/page/Special:Upload">Upload file</a></td>
<td id="t-specialpages"><a href="/page/Special:Specialpages">Special pages</a></td>
				<td id="t-print"><a href="/wiki/index.php?title=WinQXL&amp;printable=yes">Printable version</a></td>				<td id="t-permalink"><a href="/wiki/index.php?title=WinQXL&amp;oldid=2769">Permanent link</a></td>		    </tr></table>
		</div>
	</div>
</td>
<td width="10px">
                                <div id="f-poweredbyico" style="padding-right:15px;border: 0px;"  ><a href="http://www.mediawiki.org/"><img src="/wiki/skins/common/images/poweredby_mediawiki_88x31.png" alt="MediaWiki" /></a></div>

</td>
</tr>
</table>
</div> <!--my footer -->

<!-- Served by et.redhat.com in 0.24 secs. -->

</body></html>
