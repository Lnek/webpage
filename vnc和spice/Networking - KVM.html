<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="keywords" content="Networking,Networking Performance" />
<link rel="shortcut icon" href="/favicon.ico" />
		<title>Networking - KVM</title>
		<style type="text/css" media="screen,projection">/*<![CDATA[*/ @import "/wiki/skins/kvm/main.css?7"; /*]]>*/</style>
		<link rel="stylesheet" type="text/css" media="print" href="/wiki/skins/common/commonPrint.css" />
		<!--[if lt IE 5.5000]><style type="text/css">@import "/wiki/skins/kvm/IE50Fixes.css";</style><![endif]-->
		<!--[if IE 5.5000]><style type="text/css">@import "/wiki/skins/kvm/IE55Fixes.css";</style><![endif]-->
		<!--[if IE 6]><style type="text/css">@import "/wiki/skins/kvm/IE60Fixes.css";</style><![endif]-->
		<!--[if IE 7]><style type="text/css">@import "/wiki/skins/kvm/IE70Fixes.css?1";</style><![endif]-->
		<!--[if lt IE 7]><script type="text/javascript" src="/wiki/skins/common/IEFixes.js"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->
		<script type="text/javascript">var skin = 'kvm';var stylepath = '/wiki/skins';</script>
		<script type="text/javascript" src="/wiki/skins/common/wikibits.js"><!-- wikibits js --></script>
		<script type="text/javascript" src="/wiki/index.php?title=-&amp;action=raw&amp;gen=js"><!-- site js --></script>
		<style type="text/css">/*<![CDATA[*/
@import "/wiki/index.php?title=MediaWiki:Common.css&action=raw&ctype=text/css&smaxage=18000";
@import "/wiki/index.php?title=MediaWiki:Kvm.css&action=raw&ctype=text/css&smaxage=18000";
@import "/wiki/index.php?title=-&action=raw&gen=css&maxage=18000";
/*]]>*/</style>
		<!-- Head Scripts -->
			</head>
<body  class="ns-0 ltr">
<div id="topBanner">
 	<div id="p-search" class="portlet">
		<!--<h5><label for="searchInput">Search</label></h5>-->
		<div id="searchBody" class="pBody">
			<form action="/page/Special:Search" id="searchform"><div>
				<input id="searchInput" name="search" type="text" accesskey="f" value="" />
					<br/>
			        <input type='submit' name="go" class="searchButton" id="searchGoButton"	value="Go" />&nbsp;
				<input type='submit' name="fulltext" class="searchButton" value="Search" />
			</div></form>
		</div>
	</div>
	<div id="bannerImage"> 
   <a href="/page/Main_Page" title="Main Page">
   <img src="/wiki/skins/kvm/kvmbanner-logo2.png" alt="KVM" />
   </a>
   </div>
   
</div>
	<div id="globalWrapper">

		<div id="column-content">
	<div id="content">

	<script type="text/javascript"> if (window.isMSIE55) fixalpha(); </script>
		<div class='portlet' id='p-navigation'>
		<h5>Navigation</h5>
		<div class='pBody'>
			<ul>
				<li id="n-mainpage"><a href="/page/Main_Page">Main Page</a></li>
				<li id="n-Status"><a href="/page/Status">Status</a></li>
				<li id="n-Guest-Support-Status"><a href="/page/Guest_Support_Status">Guest Support Status</a></li>
				<li id="n-KVM-Autotest"><a href="/page/KVM-Autotest">KVM-Autotest</a></li>
				<li id="n-HOWTO"><a href="/page/HOWTO">HOWTO</a></li>
				<li id="n-Migration"><a href="/page/Migration">Migration</a></li>
				<li id="n-Lists,-IRC"><a href="/page/Lists%2C_IRC">Lists, IRC</a></li>
				<li id="n-Documents"><a href="/page/Documents">Documents</a></li>
				<li id="n-Downloads"><a href="/page/Downloads">Downloads</a></li>
				<li id="n-Bugs"><a href="/page/Bugs">Bugs</a></li>
				<li id="n-Code"><a href="/page/Code">Code</a></li>
				<li id="n-TODO"><a href="/page/TODO">TODO</a></li>
				<li id="n-FAQ"><a href="/page/FAQ">FAQ</a></li>
			</ul>
		</div>
	<div id="p-banners" class="portlet">
		<h5>banners</h5>
			<a href="http://et.redhat.com"><img src="/wiki/skins/kvm/et-banner.png"></a>
	</div>
	</div>

	
		<a name="top" id="top"></a>
		   <!--<h1 class="firstHeading">Networking</h1>-->
		<div id="bodyContent">
			<h3 id="siteSub">From KVM</h3>
			<div id="contentSub"></div>
									<div id="jump-to-nav">Jump to: <a href="#column-one">navigation</a>,<a href="#searchInput">search</a></div>
			<!-- start content -->
			
			<!-- this is where the search blob was before -->

			<table id="toc" class="toc" summary="Contents"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class='toclevel-1'><a href="#Setting_guest_network"><span class="tocnumber">1</span> <span class="toctext">Setting guest network</span></a>
<ul>
<li class='toclevel-2'><a href="#User_Networking"><span class="tocnumber">1.1</span> <span class="toctext">User Networking</span></a></li>
<li class='toclevel-2'><a href="#private_virtual_bridge"><span class="tocnumber">1.2</span> <span class="toctext">private virtual bridge</span></a></li>
<li class='toclevel-2'><a href="#public_bridge"><span class="tocnumber">1.3</span> <span class="toctext">public bridge</span></a></li>
<li class='toclevel-2'><a href="#iptables.2Frouting"><span class="tocnumber">1.4</span> <span class="toctext">iptables/routing</span></a></li>
<li class='toclevel-2'><a href="#vde"><span class="tocnumber">1.5</span> <span class="toctext">vde</span></a></li>
<li class='toclevel-2'><a href="#performance"><span class="tocnumber">1.6</span> <span class="toctext">performance</span></a></li>
<li class='toclevel-2'><a href="#Compatibility"><span class="tocnumber">1.7</span> <span class="toctext">Compatibility</span></a></li>
</ul>
</li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=Networking&amp;action=edit&amp;section=1" title="Edit section: Setting guest network">edit</a>]</div><a name="Setting_guest_network"></a><h1> Setting guest network </h1>
<p>Guest (VM) networking in kvm is the same as in qemu, so it is possible to refer to other documentations about networking for qemu. This page will try to explain how to configure the most frequent types of network needed.
</p><p><br />
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=Networking&amp;action=edit&amp;section=2" title="Edit section: User Networking">edit</a>]</div><a name="User_Networking"></a><h2> User Networking </h2>
<p><b>Use case:</b>
</p>
<ul><li> You want a simple way for your virtual machine to access to the host, to the internet or to resources available on your local network.
</li><li> You don't need to access your guest from the network or from another guest.
</li><li> You are ready to take a huge performance hit.
</li><li> Warning: User networking does not support a number of networking features like ICMP.  Certain applications (like ping) may not function properly.
</li></ul>
<p><b>Prerequisites:</b>
</p>
<ul><li> You need kvm up and running
</li><li> If you don't want to run as root, the user you want to use needs to have rw access to /dev/kvm
</li><li> If you want to be able to access the internet or a local network, your host system must be able to access the internet or the local network
</li></ul>
<p><b>Solution:</b>
</p>
<ul><li> simply run your guest without specifying network parameters, which by default will create user-lever (a.k.a slirp) networking:
</li></ul>
<pre>qemu-system-x86_64 -hda /path/to/hda.img
</pre>
<p><b>Notes:</b>
</p>
<ul><li> The IP address can be automatically assigned to the guest thanks to the DHCP service integrated in QEMU
</li><li> If you run multiple guests on the host, you don't need to specify a different MAC address for each guest
</li><li> The default is equivalent to this explicit setup:
</li></ul>
<pre>qemu-system-x86_64 -hda /path/to/hda.img -netdev user,id=user.0 -device e1000,netdev=user.0
</pre>
<ul><li> user.0 identifier above is just to connect the two halves into one, you may use any identifier you wish, such as "n" or "net0".
</li><li> Use rtl8139 instead of e1000 to get 8139-series NIC.
</li><li> You can still access one specific port on the guest using the "hostfwd" option. This means e.g. if you want to transport a file with scp from host to guest, start the guest with "-device e1000,netdev=user.0 -netdev user,id=user.0,hostfwd=tcp::5555-:22". Now you are forwarding the host port 5555 to the guest port 22. After starting up the guest, you can transport a file with e.g. "scp -P 5555 file.txt root@localhost:/tmp" from host to guest. Or you can also use other address of the host to connect to.
</li></ul>
<p><br />
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=Networking&amp;action=edit&amp;section=3" title="Edit section: private virtual bridge">edit</a>]</div><a name="private_virtual_bridge"></a><h2> private virtual bridge </h2>
<p><b>Use case:</b>
</p>
<ul><li> You want to set up a private network between 2 or more virtual machines. This network won't be seen from the other virtual machines nor from the real network.
</li></ul>
<p><b>Prerequisites:</b>
</p>
<ul><li> You need kvm up and running
</li><li> If you don't want to run as root, the user you want to use needs to have rw access to /dev/kvm
</li><li> You need the following commands installed on your system, and if you don't want to run as root, the user you want to use needs to be able to sudo the following command:
</li></ul>
<pre>/sbin/ip
/usr/sbin/brctl
/usr/sbin/tunctl
</pre>
<p><b>Solution:</b>
</p>
<ul><li> You need to create a bridge, e-g:
</li></ul>
<pre>sudo /usr/sbin/brctl addbr br0
</pre>
<ul><li> You need a qemu-ifup script containing the following:
</li></ul>
<pre>#!/bin/sh
set -x

switch=br0

if [ -n "$1" ];then
        /usr/bin/sudo /usr/sbin/tunctl -u `whoami` -t $1
        /usr/bin/sudo /sbin/ip link set $1 up
        sleep 0.5s
        /usr/bin/sudo /usr/sbin/brctl addif $switch $1
        exit 0
else
        echo "Error: no interface specified"
        exit 1
fi
</pre>
<ul><li> Generate a MAC address, either manually or using:
</li></ul>
<pre>#!/bin/bash
# generate a random mac address for the qemu nic
printf 'DE:AD:BE:EF:%02X:%02X\n' $((RANDOM%256)) $((RANDOM%256))
</pre>
<ul><li> Run each guest with the following, replacing $macaddress with the value from the previous step
</li></ul>
<pre>qemu-system-x86_64 -hda /path/to/hda.img -device e1000,netdev=net0,mac=$macaddress -netdev tap,id=net0
</pre>
<p><b>Notes:</b>
</p>
<ul><li> If you don't want to run as root, the qemu-ifup must be executable by the user you want to use
</li><li> You can either create a system-wide qemu-ifup in /etc/qemu-ifup or use another one. In the latter case, run
</li></ul>
<pre>qemu-system-x86_64 -hda /path/to/hda.img -device e1000,netdev=net0,mac=$macaddress -netdev tap,id=net0,script=/path/to/qemu-ifup
</pre>
<ul><li> Each guest on the private virtual network must have a different MAC address
</li></ul>
<p><br />
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=Networking&amp;action=edit&amp;section=4" title="Edit section: public bridge">edit</a>]</div><a name="public_bridge"></a><h2> public bridge </h2>
<p><b>WARNING:</b> The here shown method, will not work with most(all?) wireless drivers, as these do not support bridging.
</p><p><b>Use case:</b>
</p>
<ul><li> You want to assign an IP address to your virtual machines and make them accessible from your local network
</li><li> You also want performance out of your virtual machine.
</li></ul>
<p><b>Prerequisites:</b>
</p>
<ul><li> You need kvm up and running
</li><li> If you don't want to run as root, the user you want to use needs to have rw access to /dev/kvm
</li><li> You need the following commands installed on your system, and if you don't want to run as root, the user you want to use needs to be able to sudo the following command:
</li></ul>
<pre>/sbin/ip
/usr/sbin/brctl
/usr/sbin/tunctl
</pre>
<ul><li> Your host system must be able to access the internet or the local network
</li></ul>
<p><b>Solution 1: using distro sysconfig script</b>
</p>
<table border="1">
<tr>
<th>RedHat's way
</th><th>Debian's way
</th><th>SuSE's way
</th></tr>
<tr>
<td>
<ul><li> Edit /etc/sysconfig/network-scripts/ifcfg-eth0
<ul><li> comment out BOOTPROTO
</li><li> Add BRIDGE=br0
</li></ul>
</li><li> Create /etc/sysconfig/network-scripts/ifcfg-br0
<ul><li> The content should be:
</li></ul>
</li></ul>
<pre>DEVICE=br0
BOOTPROTO=dhcp
ONBOOT=yes
TYPE=Bridge
</pre>
</td><td>
<p>/etc/network/interfaces
</p>
<pre># Replace old eth0 config with br0
auto <strike>eth0</strike> br0
</pre>
<pre># Use old eth0 config for br0, plus bridge stuff
iface br0 inet dhcp
    bridge_ports    eth0
    bridge_stp      off
    bridge_maxwait  0
    bridge_fd       0
</pre>
</td><td>
<ul><li> Start YaST
</li><li> Go to Network Configuration
</li><li> Add new device -&gt; Bridge
</li><li> Tick your existing network device
</li><li> done
</li></ul>
</td></tr></table>
<ul><li> /etc/init.d/networking restart
</li><li> The bridge br0 should get the ip address (either static/dhcp) while the physical eth0 is left without ip address.
</li></ul>
<p><b>VLANs</b>
</p><p>Please note that the rtl8139 virtual network interface driver does not support VLANs. If you want to use VLANs with your virtual machine, you must use another virtual network interface like virtio. 
</p><p>When using VLANs on a setup like this and no traffic is getting through to your guest(s), you might want to do:
</p>
<pre># cd /proc/sys/net/bridge
# ls
bridge-nf-call-arptables  bridge-nf-call-iptables
bridge-nf-call-ip6tables  bridge-nf-filter-vlan-tagged
# for f in bridge-nf-*; do echo 0 &gt; $f; done
</pre>
<p><br />
<b>Solution 2: manual</b>
</p>
<ul><li> You need to create a bridge, e-g:
</li></ul>
<pre>sudo /usr/sbin/brctl addbr br0
</pre>
<ul><li> Add one of your physical interface to the bridge, e-g for eth0:
</li></ul>
<pre>sudo /usr/sbin/brctl  addif br0 eth0
</pre>
<ul><li> You need a qemu-ifup script containing the following:
</li></ul>
<pre>#!/bin/sh
set -x

switch=br0

if [ -n "$1" ];then
        /usr/bin/sudo /usr/sbin/tunctl -u `whoami` -t $1
        /usr/bin/sudo /sbin/ip link set $1 up
        sleep 0.5s
        /usr/bin/sudo /usr/sbin/brctl addif $switch $1
        exit 0
else
        echo "Error: no interface specified"
        exit 1
fi
</pre>
<ul><li> Generate a MAC address, either manually or using:
</li></ul>
<pre>#!/bin/sh
# generate a random mac address for the qemu nic
printf 'DE:AD:BE:EF:%02X:%02X\n' $((RANDOM%256)) $((RANDOM%256))
</pre>
<ul><li> Run each guest with the following, replacing $macaddress with the value from the previous step
</li></ul>
<pre>qemu-system-x86_64 -hda /path/to/hda.img -device e1000,netdev=net0,mac=$macaddress -netdev tap,id=net0
</pre>
<p><b>Notes:</b>
</p>
<ul><li> If you don't want to run as root, the qemu-ifup must be executable by the user you want to use
</li><li> You can either create a system-wide qemu-ifup in /etc/qemu-ifup or use another one. In the latter case, run
</li></ul>
<pre>qemu-system-x86_64 -hda /path/to/hda.img -device e1000,netdev=net0,mac=$macaddress -netdev tap,id=net0,script=/path/to/qemu-ifup
</pre>
<ul><li> Each guest on the network must have a different MAC address
</li></ul>
<p><br />
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=Networking&amp;action=edit&amp;section=5" title="Edit section: iptables/routing">edit</a>]</div><a name="iptables.2Frouting"></a><h2> iptables/routing </h2>
<p>you can also connect your guest vm to a tap in your host. then setting iptables rules in your host to become a router + firewall for your vm.
</p><p>Routing would be done simply by creating the default route on the client to the IP of the host (and allowing IP forwarding) and setting a route to the tap? device of the client on the host.
</p><p>Test the setup beforehand:
</p>
<ul><li>Hostside: Allow IPv4 forwarding and add route to client (could be put in a script - route has to be added after the client has started):
</li></ul>
<pre>sysctl -w net.ipv4.ip_forward=1                 # allow forwarding of IPv4
route add -host &lt;ip-of-client&gt; dev &lt;tap-device&gt; # add route to the client
</pre>
<ul><li>Clientside: Default GW of the client is of course then the host (&lt;ip-of-host&gt; has to be in same subnet as &lt;ip-of-client&gt; ...):
</li></ul>
<pre>route add default gw &lt;ip-of-host&gt;
</pre>
<ul><li>Clientside v2: If you host IP is not on the same subnet as &lt;ip-of-client&gt;, then you must manually add the route to host before you create default route:
</li></ul>
<pre>route add -host &lt;ip-of-host&gt; dev &lt;network-interface&gt;
route add default gw &lt;ip-of-host&gt;
</pre>
<p><br />
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=Networking&amp;action=edit&amp;section=6" title="Edit section: vde">edit</a>]</div><a name="vde"></a><h2> vde </h2>
<p>Another option is using vde (virtual distributed ethernet).
</p><p><br />
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=Networking&amp;action=edit&amp;section=7" title="Edit section: performance">edit</a>]</div><a name="performance"></a><h2> performance </h2>
<p>Data on benchmarking results should go in here.
There's now a page dedicated to ideas for improving
<a href="/page/Networking_Performance" title="Networking Performance">Networking Performance</a>.
</p>
<div class="editsection" style="float:right;margin-left:5px;">[<a href="/wiki/index.php?title=Networking&amp;action=edit&amp;section=8" title="Edit section: Compatibility">edit</a>]</div><a name="Compatibility"></a><h2> Compatibility </h2>
<p>There's another, old and obsolete syntax of specifying network for virtual machines.  Above examples uses -netdev..-device model, old way used -net..-net pairs.  For example,
</p>
<pre>-netdev tap,id=net0 -device e1000,netdev=net0,mac=52:54:00:12:34:56
</pre>
<p>is about the same as old
</p>
<pre>-net tap,vlan=0 -net nic,vlan=0,model=e1000,macaddr=52:54:00:12:34:56
</pre>
<p>(note mac =&gt; macaddr parameter change as well; vlan=0 is the default).
</p><p>Old way used the notion of "VLANs" - these are QEMU VLANS, which has nothing to do with 802.1q VLANs. Qemu VLANs are numbered starting with 0, and it's possible to connect one or more devices (either host side, like -net tap, or guest side, like -net nic) to each VLAN, and, in particular, it's possible to connect more than 2 devices to a VLAN.  Each device in a VLAN gets all traffic received by every device in it.  This model was very confusing for the user (especially when a guest has more than one NIC).
</p><p>In new model, each host side correspond to just one guest side, forming a pair of devices based on -netdev id=  and -device netdev= parameters.  It is less confusing, it is faster (because it's always 1:1 pair), and it supports more parameters than old -net..-net way.
</p><p>However, -net..-net is still supported, used widely, and mentioned in lots of various HOWTOs and guides around the world.  It is also a bit shorter and so faster to type.
</p>
<!-- Saved in parser cache with key kvmwiki:pcache:idhash:1444-0!1!0!0!!en!2 and timestamp 20130826112736 -->
<div class="printfooter">
Retrieved from "<a href="http://www.linux-kvm.org/page/Networking">http://www.linux-kvm.org/page/Networking</a>"</div>
			 			<!-- end content -->
			<div class="visualClear"></div>
		</div>
	</div>
		</div>
		<div id="column-one">
		</div><!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>

	<script type="text/javascript"> if (window.runOnloadHook) runOnloadHook();</script>
</div>

	<div id="p-cactions" class="portlet">
		<table><tr>
		<td><strong>Views</strong>:&nbsp;</td>
				 <td id="ca-nstab-main" class="selected"><a href="/page/Networking">Article</a></td>
				 <td id="ca-talk"><a href="/page/Talk:Networking">Discussion</a></td>
				 <td id="ca-edit"><a href="/wiki/index.php?title=Networking&amp;action=edit">Edit</a></td>
				 <td id="ca-history"><a href="/wiki/index.php?title=Networking&amp;action=history">History</a></td>
		</tr></table>
	</div>

	<div class="portlet" id="p-personal">
			<table><tr>
		<td><strong>Personal tools:&nbsp;</strong></td>
				<td id="pt-login"><a href="/wiki/index.php?title=Special:Userlogin&amp;returnto=Networking">Log in / create account</a></td>
			</tr></table>
	</div>

	<div class="portlet" id="p-tb">
		<div class="pBody">
		<table><tr>
		<td><strong>Toolbox</strong>:&nbsp;</td>
				<td id="t-whatlinkshere"><a href="/page/Special:Whatlinkshere/Networking">What links here</a></td>
				<td id="t-recentchangeslinked"><a href="/page/Special:Recentchangeslinked/Networking">Related changes</a></td>
<td id="t-upload"><a href="/page/Special:Upload">Upload file</a></td>
<td id="t-specialpages"><a href="/page/Special:Specialpages">Special pages</a></td>
				<td id="t-print"><a href="/wiki/index.php?title=Networking&amp;printable=yes">Printable version</a></td>				<td id="t-permalink"><a href="/wiki/index.php?title=Networking&amp;oldid=4742">Permanent link</a></td>		    </tr></table>
		</div>
	</div>

			<div id="footer">
				<div id="f-poweredbyico"><a href="http://www.mediawiki.org/"><img src="/wiki/skins/common/images/poweredby_mediawiki_88x31.png" alt="MediaWiki" /></a></div>
		</div>

<!-- Served by et.redhat.com in 0.18 secs. -->

</body></html>
