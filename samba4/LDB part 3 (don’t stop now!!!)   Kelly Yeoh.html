<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html dir="ltr" lang="en-US" xmlns="http://www.w3.org/1999/xhtml">
<head profile="http://gmpg.org/xfn/1">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<link rel="stylesheet" type="text/css" href="http://somewoman.com/wp-content/themes/scrapbook/style.css" media="screen" />
<link rel="stylesheet" type="text/css" href="http://somewoman.com/wp-content/themes/scrapbook/print.css" media="print" />

<!--[if IE]>
<link rel="stylesheet" href="http://somewoman.com/wp-content/themes/scrapbook/ie.css" media="screen" type="text/css" />
<script src="http://somewoman.com/wp-content/themes/scrapbook/library/focus.js" type="text/javascript"></script>
<![endif]-->
<!--[if lte IE 7]>
<link rel="stylesheet" href="http://somewoman.com/wp-content/themes/scrapbook/ie7.css" media="screen" type="text/css" />
<![endif]-->


<link rel="pingback" href="http://somewoman.com/xmlrpc.php" />

	<link rel='archives' title='January 2013' href='http://somewoman.com/?m=201301' />
	<link rel='archives' title='December 2012' href='http://somewoman.com/?m=201212' />
	<link rel='archives' title='November 2012' href='http://somewoman.com/?m=201211' />
	<link rel='archives' title='December 2011' href='http://somewoman.com/?m=201112' />
	<link rel='archives' title='November 2011' href='http://somewoman.com/?m=201111' />
	<link rel='archives' title='October 2011' href='http://somewoman.com/?m=201110' />
	<link rel='archives' title='September 2011' href='http://somewoman.com/?m=201109' />

<title>LDB part 3 (don&#8217;t stop now!!!) : Kelly Yeoh</title>

<link rel="alternate" type="application/rss+xml" title="Kelly Yeoh &raquo; Feed" href="http://somewoman.com/?feed=rss2" />
<link rel="alternate" type="application/rss+xml" title="Kelly Yeoh &raquo; Comments Feed" href="http://somewoman.com/?feed=comments-rss2" />
<link rel="alternate" type="application/rss+xml" title="Kelly Yeoh &raquo; LDB part 3 (don&#8217;t stop now!!!) Comments Feed" href="http://somewoman.com/?feed=rss2&amp;p=261" />
<link rel='stylesheet' id='custom-thickbox-css'  href='http://somewoman.com/wp-content/themes/scrapbook/custom-thickbox.css?ver=3.2.1' type='text/css' media='screen' />
<script type='text/javascript' src='http://somewoman.com/wp-includes/js/l10n.js?ver=20101110'></script>
<script type='text/javascript' src='http://somewoman.com/wp-includes/js/jquery/jquery.js?ver=1.6.1'></script>
<script type='text/javascript' src='http://somewoman.com/wp-content/themes/scrapbook/library/accordian-menu.js?ver=3.0.2'></script>
<script type='text/javascript' src='http://somewoman.com/wp-includes/js/comment-reply.js?ver=20090102'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://somewoman.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://somewoman.com/wp-includes/wlwmanifest.xml" /> 
<link rel='index' title='Kelly Yeoh' href='http://somewoman.com' />
<link rel='start' title='Repurposed' href='http://somewoman.com/?p=3' />
<link rel='prev' title='Anchors' href='http://somewoman.com/?p=437' />
<link rel='next' title='LDB part 4' href='http://somewoman.com/?p=383' />
<meta name="generator" content="WordPress 3.2.1" />
<link rel='canonical' href='http://somewoman.com/?p=261' />
<style type="text/css" media="screen,print">
#blogtitle {background-image:url(http://somewoman.com/wp-content/uploads/2011/09/logo1.png);}#blogtitle h1,#blogtitle h1 a {color:#776963;}
</style>

<style type="text/css">
body { background-color: #fff; }
</style>

</head>

<body id="top" class="single single-post postid-261 single-format-standard">
<div id="container">

<ul class="jumplinks">
<li><a href="#sidebar">Jump to sidebar</a></li>
<li><a href="#content">Jump to page content</a></li>
<li><a href="#footer">Jump to footer</a></li>
</ul>

<div id="blogtitle">
<h1><a href="http://somewoman.com/"><span>Kelly Yeoh</span></a></h1>
</div>

<!-- start wrapper-top -->
<div id="wrapper-top">
<div id="wrapper-top-left"></div>
<div id="wrapper-top-right"></div>
</div>
<!-- end wrapper-top -->

<div id="wrapper">

<div id="innerwrap">

<div id="content">

<div class="tagline">bit of this, bit of that, voila!!</div>


<div class="post-261 post type-post status-publish format-standard hentry category-uncategorized">

<h2 class="post-title" id="post-261"><a href="http://somewoman.com/?p=261" rel="bookmark" title="Permanent Link: LDB part 3 (don&#8217;t stop now!!!)">LDB part 3 (don&#8217;t stop now!!!)</a></h2>
<ul class="meta">
<li>November 22, 2012 3:13 pm</li>
<li></li>
</ul>

<h2><strong>LDB Posts</strong></h2>
<ul>
<li><a title="LDB part 1 (of god only knows how many!!!) – Introduction" href="http://somewoman.com/?p=212">LDB part 1 (of god only knows how many!!!) – Introduction</a></li>
<li><a title="LDB part 2 (it just keeps goin') - Tools and things" href="http://somewoman.com/?p=276">LDB part 2 (it just keeps goin&#8217;) &#8211; Tools and things</a></li>
<li>LDB part 3 (don&#8217;t stop now!!!)</li>
</ul>
<p>Note: this was written quite some time ago, and has been sitting in my drafts for some time. There was a query over the correctness of linked attributes, in particular the difference between one and two way links. I&#8217;m pretty certain that what is below is correct, although add this disclaimer anyways. Apologies for any other incompleteness. I&#8217;m just not able to deal with this anymore. There is still some useful information here and it deserves to be shared. </p>
<h2><strong>LDB Controls</strong></h2>
<p>Controls within LDB are much the same as controls within LDAP. They are a blob of information that modifies a request. A request may contain none, one or more controls to modify the default behaviour in different ways.</p>
<p>Arbitrary controls can be used by adding &#8211;controls=&#8217;control1, control2, control3&#8242; to the end of an ldbquery, most commonly to ldbsearch. The most frequently used controls have shortcuts that can be added directly on to the end of the query, and some of these are listed below:</p>
<h3>Common Controls</h3>
<h4>&#8211;extended-dn</h4>
<p>returns additional information with the dn where available. This includes guid, sid, etc.</p>
<p>So, whereas a typical search on users, returning only dn and name, might look like this:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory># bin/ldbsearch -H private/sam.ldb 'objectclass=user' name<br />
# record 1<br />
dn: CN=SHINY,OU=Domain Controllers,DC=samba,DC=somewoman,DC=com<br />
name: SHINY</code></p>
<p><code># record 2<br />
dn: CN=Administrator,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: Administrator</code></p></blockquote>
<p>the &#8211;extended-dn version would look like this:</p>
<blockquote><p><code><username>@s<machinename>:<samba-directory># bin/ldbsearch -H private/sam.ldb 'objectclass=user' name --extended-dn<br />
# record 1<br />
dn: <GUID=33f7bca4-ad03-479c-9dc2-77a65d54506c>;<SID=S-1-5-21-3792582380-2211794622-3826066998-1000>;CN=SHINY,OU=Domain Controllers,DC=samba,DC=somewoman,DC=com<br />
name: SHINY</code></p>
<p><code># record 2<br />
dn: <GUID=a32fda1e-7b19-4a86-8623-85cdfefe3b5f>;<SID=S-1-5-21-3792582380-2211794622-3826066998-500>;CN=Administrator,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: Administrator</code></p></blockquote>
<h4>&#8211;cross-ncs</h4>
<p>Allows a search to cross over a naming context boundary or partition within the database. For example, a basic search may return a set of results for the current level of an hierarchical data structure and its children, but adding the &#8211;cross-ncs control will allow us to return results for all structures across the current level of the hierarchy. This is also known as the &#8220;phantom root&#8221; option as it effectively sets the root of the search to be at a higher level within the data hierarchy.</p>
<p>removing the actual records returned in the interest of expediency and space saving, an example of running a query without &#8211;cross-ncs:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory># bin/ldbsearch -H private/sam.ldb</code></p>
<p><code># returned 211 records<br />
# 208 entries<br />
# 3 referrals</code></p></blockquote>
<p>And with &#8211;cross-ncs:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory># bin/ldbsearch -H private/sam.ldb --cross-ncs</code></p>
<p><code># returned 3425 records<br />
# 3425 entries<br />
# 0 referrals</code></p></blockquote>
<h4>&#8211;show-binary</h4>
<p>Displays binary data in a readable format. This was demonstrated within an earlier post: <a title="LDB part 2 (it just keeps goin’) – Tools and things" href="http://somewoman.com/?p=276">LDB Part 2 &#8211; Tools and things</a></p>
<h4>&#8211;paged</h4>
<p>This is often used where too many results are returned. By default, LDB returns a maximum of something like 1000 results at a time. The &#8211;paged control separates the result sets into a new search for each &#8220;page&#8221; of results returned, where a page contains the maximum number of returnable results. When each search is complete, the next search is performed until all required records have been returned.</p>
<h4>&#8211;show-deleted</h4>
<p>LDB has a two stage deletion process which allows for recovering of records within a given period, or viewing information about (but not being able to recover) a record for a given period past the recovery period. This will be explained in further detail at a later stage. The &#8211;show-deleted control is required for undeleting and renaming of records.</p>
<p>Using an ldif file named kelly.ldif containing:</p>
<blockquote><p><code>dn: CN=kelly,DC=samba,DC=somewoman,DC=com<br />
objectclass: user<br />
samaccountname: kelly</code></p></blockquote>
<p>the user kelly was added with the following command: <code>bin/ldbadd -H private/sam.ldb kelly.ldif</code></p>
<p>Resulting in:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory># bin/ldbsearch -H private/sam.ldb 'objectclass=user' name<br />
# record 1<br />
dn: CN=SHINY,OU=Domain Controllers,DC=samba,DC=somewoman,DC=com<br />
name: SHINY</code></p>
<p><code># record 2<br />
dn: CN=Administrator,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: Administrator</code></p>
<p><code># record 3<br />
dn: CN=dns-shiny,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: dns-shiny</code></p>
<p><code># record 4<br />
dn: CN=krbtgt,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: krbtgt</code></p>
<p><code># record 5<br />
dn: CN=Guest,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: Guest</code></p>
<p><code># record 6<br />
dn: CN=kelly,DC=samba,DC=somewoman,DC=com<br />
name: kelly</code></p>
<p><code># Referral<br />
ref: ldap://samba.somewoman.com/CN=Configuration,DC=samba,DC=somewoman,DC=com</code></p>
<p><code># Referral<br />
ref: ldap://samba.somewoman.com/DC=DomainDnsZones,DC=samba,DC=somewoman,DC=com</code></p>
<p><code># Referral<br />
ref: ldap://samba.somewoman.com/DC=ForestDnsZones,DC=samba,DC=somewoman,DC=com</code></p>
<p><code># returned 9 records<br />
# 6 entries<br />
# 3 referrals</code></p></blockquote>
<p>Then this record was deleted using: <code>bin/ldbdel -H private/sam/ldb 'CN=kelly,DC=samba,DC=somewoman,DC=com'</code></p>
<p>Resulting in:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory># bin/ldbsearch -H private/sam.ldb 'objectclass=user' name --show-deleted<br />
# record 1<br />
dn: CN=kelly\0ADEL:655e6455-e5ef-495b-8b85-ea9b63b7ffea,CN=Deleted Objects,DC=samba,DC=somewoman,DC=com<br />
name:: a2VsbHkKREVMOjY1NWU2NDU1LWU1ZWYtNDk1Yi04Yjg1LWVhOWI2M2I3ZmZlYQ==</code></p>
<p><code># record 2<br />
dn: CN=SHINY,OU=Domain Controllers,DC=samba,DC=somewoman,DC=com<br />
name: SHINY</code></p>
<p><code># record 3<br />
dn: CN=Administrator,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: Administrator</code></p>
<p><code># record 4<br />
dn: CN=dns-shiny,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: dns-shiny</code></p>
<p><code># record 5<br />
dn: CN=krbtgt,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: krbtgt</code></p>
<p><code># record 6<br />
dn: CN=Guest,CN=Users,DC=samba,DC=somewoman,DC=com<br />
name: Guest</code></p>
<p><code># Referral<br />
ref: ldap://samba.somewoman.com/CN=Configuration,DC=samba,DC=somewoman,DC=com</code></p>
<p><code># Referral<br />
ref: ldap://samba.somewoman.com/DC=DomainDnsZones,DC=samba,DC=somewoman,DC=com</code></p>
<p><code># Referral<br />
ref: ldap://samba.somewoman.com/DC=ForestDnsZones,DC=samba,DC=somewoman,DC=com</code></p>
<p><code># returned 9 records<br />
# 6 entries<br />
# 3 referrals</code></p></blockquote>
<h4>&#8211;reveal</h4>
<p>The &#8211;reveal control is a Samba only control, used for internal bookkeeping by Samba. This extends information displayed differently, depending on the query.  For example, it will display deleted linked objects (more on linked objects later). In the following demonstration, I have removed the user &#8216;kelly&#8217; from the group &#8216;guests&#8217;</p>
<p>without &#8211;reveal:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbsearch -H private/sam.ldb 'name=guests' member<br />
# record 1<br />
dn: CN=Guests,CN=Builtin,DC=samba,DC=somewoman,DC=com<br />
member: CN=Domain Guests,CN=Users,DC=samba,DC=somewoman,DC=com<br />
member: CN=Guest,CN=Users,DC=samba,DC=somewoman,DC=com</code></p></blockquote>
<p>with &#8211;reveal:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbsearch -H private/sam.ldb 'name=guests' member --reveal<br />
# record 1<br />
dn: CN=Guests,CN=Builtin,DC=samba,DC=somewoman,DC=com<br />
member: CN=Domain Guests,CN=Users,DC=samba,DC=somewoman,DC=com<br />
member: CN=Guest,CN=Users,DC=samba,DC=somewoman,DC=com<br />
member: CN=kelly,DC=samba,DC=somewoman,DC=com</code></p></blockquote>
<h4>&#8211;relax</h4>
<p>This is the &#8220;don&#8217;t worry, be happy&#8221; of controls. It tells the database to ignore warnings, and perform this action anyway. This is useful for database cleanups and reconfigurations. For most actions, this can only be used by the system user.</p>
<h2><strong>LDB Credentials</strong></h2>
<p>LDAP has fairly complex authentication protocols, with several available. Most commonly used are SASL and Kerberos.</p>
<h3>SASL &#8211; Simple Authentication and Security Layer</h3>
<p>SASL is a challenge/response type authentication where the client needs to know a password. Using wireshark to view a connection in progress, we can see the two ends negotiating as to whether they will allow a connection. This passes through several layers within SASL:</p>
<p><a href="http://somewoman.com/wp-content/uploads/2012/02/SASL.jpg"><img class="aligncenter size-full wp-image-317" title="SASL Authentication" src="http://somewoman.com/wp-content/uploads/2012/02/SASL.jpg" alt="SASL Authentication" width="597" height="296" /></a></p>
<p>SASL -> SPNEGO (Simple Protected Negotiation) -> NTLM (NT LAN Manager authentication) -> NTLMSSP (an extension on NTLM &#8211; Secure Service Provider)</p>
<p>Layers upon layers upon layers of authentication. This occurs with each and every SASL based communication.</p>
<h3></h3>
<h3>Kerberos</h3>
<p>Kerberos uses SASL to create an initial connection, and then uses this secure connection to generate a &#8220;ticket&#8221; based on authentication level, and send the client this ticket which can then be used for a much faster authentication. Each communication contains the ticket, and the server responds according to the previous authentication level associated with that ticket. This saves on several calls to determine authentication that would otherwise be required with each request.</p>
<p><a href="http://somewoman.com/wp-content/uploads/2012/02/kerberos.jpg"><img class="aligncenter size-full wp-image-318" title="kerberos authentication" src="http://somewoman.com/wp-content/uploads/2012/02/kerberos.jpg" alt="kerberos authentication" width="600" height="479" /></a></p>
<p>Kerberos requires a hostname, and cannot authenticate to localhost.</p>
<p>Kerberos is extremely important to Active Directory, and will be discussed in much further detail in a later post.</p>
<h3>Active Directory Credentials</h3>
<p>The core of Active Directory credentials is called a &#8220;token&#8221;. This token is similar to the unix idea of user ids (viewable if you type &#8220;id&#8221; at your command prompt), although it is a much larger id. Whereas a unix user id is unique to the current machine (16 or 32 bit), the AD token is a much larger identifier comprising two parts (a randomly generated SID for the domain, and a further randomly generated SID for the user within the domain). The two SIDs together are expected to be globally unique, and this is one of the reasons why Active Directory is so popular within really large organisations; unix identifiers really don&#8217;t scale.</p>
<p>Tokens also link in to Access Control Lists (ACLs). AD uses lists of tokens throughout to determine if you are allowed to perform certain actions. EVERY record within AD uses ACLs to determine who can do what, and it uses tokens to determine access against the ACLs on that object.</p>
<p>An example of what ACLs look like is displayed below</p>
<p><a href="http://somewoman.com/wp-content/uploads/2012/02/acl_gentest.jpg"><img class="aligncenter size-full wp-image-315" title="ACLs" src="http://somewoman.com/wp-content/uploads/2012/02/acl_gentest.jpg" alt="ACLs" width="600" height="739" /></a></p>
<p>ACLs will be further discussed within a later post.</p>
<h2><strong>Module Chaining</strong></h2>
<p>Modules are used to perform single or small tasks, with many modules being used to perform complex tasks. Each module receives a request and decides what to do with it (modify the request, reply to a request, etc), and then passes the request to the next module. This happens through a hierarchy to the last module listed, which then parses it to a TDB request which is then forwarded to perform the required task. LDB without modules is a very basic, dumb database with no schema, no authentication, no anything. The use of modules is what makes LDB useful.</p>
<p>Modules are stored within <code><samba-directory>/source4/dsdb/samdb/ldb_modules/</code> and each of the *.c files within that directory is an LDB module.</p>
<p>Ordering of modules is often imperative, and as such there is a hierarchy of modules to determine order of evaluation.  There is a separate module that is used to determine module order of evaluation, and order is different according to which backend is in use.  The file <code><samba-directory>/source4/dsdb/samdb/ldb_modules/samba_dsdb.c</code> contains a list of modules, and it registers these modules in a particular order, altering it according to the backend in use. Most commonly used is TDB</p>
<p>The reason that ordering is important is because modules are used to modify a request. For example, there are constraints that say you may only create a user object within certain containers or objectClass. In order to check that constraint you must first check what the object type is and what the parent class is, then we can test if the parent class is able to contain a child of the type being created. eg, if we attempt to add a user to the root object, we would expect an error along the lines of &#8220;Naming violation. Structural object class user is not a valid child class.&#8221;. Likewise, if an object is created without an objectsid, then a module needs to be called to check for existence of the objectsid, passing to a module that will create and attach the objectsid if required, and all of this needs to be completed before being passed to the module that checks that the attached objectsid is valid.</p>
<h3>An Example</h3>
<p>Going forward, we will use <code><samba-directory>/source4/dsdb/samdb/ldb_modules/objectguid.c</code> as an example.</p>
<p>Each module contains a section that tells the LDB infrastructure what its name is, and what operations it is interested in intercepting such as on add, rename, modify, reinitialisation, delete, etc. Within objectguid this is using the ldb_objectguid_module_init function, and this registers the module as being named &#8220;objectguid&#8221; and being interested in add and modify operations.</p>
<blockquote><p><code>static const struct ldb_module_ops ldb_objectguid_module_ops = {<br />
.name          = "objectguid",<br />
.add           = objectguid_add,<br />
.modify        = objectguid_modify<br />
};</code></p>
<p><code>int ldb_objectguid_module_init(const char *version)<br />
{<br />
LDB_MODULE_CHECK_VERSION(version);<br />
return ldb_register_module(&#038;ldb_objectguid_module_ops);<br />
}</code></p></blockquote>
<h4>Add</h4>
<p>If an add is called, the module calls objectguid_add(), which does a series of operations:</p>
<p>Firstly, it checks to see if the dn of the object flags it as a &#8220;special&#8221; or &#8220;magic&#8221; record (more on this later). The ldb_dn_is_special() function checks for the existence of an @ at the beginning of the dn, and returns true or false. If true, objectguid.c calls the ldb_next_request() function to call the next module in the hierarchy, performing no further action.</p>
<blockquote><p><code>/* do not manipulate our control entries */<br />
if (ldb_dn_is_special(req->op.add.message->dn)) {<br />
return ldb_next_request(module, req);<br />
}</code></p></blockquote>
<p>Then checks to see if an objectguid already exists. An object cannot be created with a predefined objectguid, and the add will be refused if one exists.</p>
<blockquote><p><code>el = ldb_msg_find_element(req->op.add.message, "objectGUID");<br />
if (el != NULL) {<br />
ldb_set_errstring(ldb, "objectguid: objectGUID must not be specified!");<br />
return LDB_ERR_UNWILLING_TO_PERFORM;<br />
}</code></p></blockquote>
<p>It then performs a couple of other checks before finally creating a new objectguid (which uses devurandom or whatever source of randomness is available on the machine), and adding it to the object</p>
<blockquote><p><code>/* a new GUID */<br />
guid = GUID_random();</code></p>
<p><code>ret = dsdb_msg_add_guid(msg, &#038;guid, "objectGUID");<br />
if (ret != LDB_SUCCESS) {<br />
return ret;<br />
}</code></p></blockquote>
<p>It inserts the whenCreated and whenChanged attributes</p>
<blockquote><p><code>if (add_time_element(msg, "whenCreated", t) != LDB_SUCCESS ||add_time_element(msg, "whenChanged", t) != LDB_SUCCESS) {<br />
return ldb_operr(ldb);<br />
}</code></p></blockquote>
<p>And the universal sequence number created and changed attributes (the uSN tracks how many changes have EVER been made to the database, we can reconstruct order of events based on these numbers)</p>
<blockquote><p><code>/* Get a sequence number from the backend */<br />
ret = ldb_sequence_number(ldb, LDB_SEQ_NEXT, &#038;seq_num);<br />
if (ret == LDB_SUCCESS) {<br />
if (add_uint64_element(ldb, msg, "uSNCreated", seq_num) != LDB_SUCCESS || add_uint64_element(ldb, msg, "uSNChanged", seq_num) != LDB_SUCCESS) {<br />
return ldb_operr(ldb);<br />
}<br />
}</code></p></blockquote>
<p>modifies or generates the add request using the new information</p>
<blockquote><p><code>ret = ldb_build_add_req(&#038;down_req, ldb, ac, msg, req->controls, req, dsdb_next_callback, req);<br />
LDB_REQ_SET_LOCATION(down_req);<br />
if (ret != LDB_SUCCESS) {<br />
return ret;<br />
}</code></p></blockquote>
<p>and then passes it along to the next module</p>
<blockquote><p><code>/* go on with the call chain */<br />
return ldb_next_request(module, down_req);</code></p></blockquote>
<h4>Modify</h4>
<p>If a modify is called, it similarly checks to see if it contains a special dn to determine if any further work is required before passing it along to the next module. If it is not a special dn, some other checks are performed, and the whenChanged and uSNChanged attributes are modified before generating the new version of the request and passing it along to the next module.</p>
<h2><strong>Special/Magic @ records</strong></h2>
<p>Samba uses special/magic records for book keeping. The reason that they start with an @ is because it is otherwise illegal within the LDAP namespace for a dn, and therefore were completely unused, so we could name objects starting with @ and know that they were not going to interfere with any other objects. Records beginning with @ are used in many, many places throughout Samba, and are treated differently, such as in our objectguid example above where we check for special records and do nothing to it, just move on, if it is a special record.</p>
<h3>@INDEXLIST</h3>
<p>Lists which attributes are indexed on by @IDXATTR</p>
<blockquote><p><code>root@shiny:/home/kelly/work/samba/prefix.s4# bin/ldbsearch -H private/sam.ldb -s base -b @INDEXLIST<br />
# record 1<br />
dn: @INDEXLIST<br />
@IDXATTR: objectClass<br />
@IDXATTR: nETBIOSName<br />
@IDXATTR: msFVE-RecoveryGuid<br />
@IDXATTR: msTSProperty01<br />
@IDXATTR: primaryGroupID<br />
@IDXATTR: fromServer<br />
@IDXATTR: serviceClassName<br />
@IDXATTR: msSFU30Domains<br />
@IDXATTR: lastLogonTimestamp<br />
@IDXATTR: requiredCategories<br />
@IDXATTR: mail<br />
@IDXATTR: dNSTombstoned<br />
@IDXATTR: USNIntersite<br />
@IDXATTR: userPrincipalName<br />
@IDXATTR: msTSLSProperty01<br />
<-- snip --><br />
@IDXATTR: msTSExpireDate4<br />
@IDXATTR: msSFU30NetgroupUserAtDomain<br />
@IDXATTR: trustPartner<br />
@IDXONE: 1<br />
@IDXVERSION: 2<br />
distinguishedName: @INDEXLIST</code></p>
<p><code># returned 1 records<br />
# 1 entries<br />
# 0 referrals</code></p></blockquote>
<h3>@ATTRIBUTES</h3>
<p>Displays a list of all attributes and their datatype</p>
<blockquote><p><code>root@shiny:/home/kelly/work/samba/prefix.s4# bin/ldbsearch -H private/sam.ldb -s base -b @ATTRIBUTES<br />
# record 1<br />
dn: @ATTRIBUTES<br />
accountExpires: INTEGER<br />
accountNameHistory: CASE_INSENSITIVE<br />
aCSAggregateTokenRatePerUser: INTEGER<br />
aCSAllocableRSVPBandwidth: INTEGER<br />
aCSIdentityName: CASE_INSENSITIVE<br />
aCSMaxAggregatePeakRatePerUser: INTEGER<br />
aCSMaximumSDUSize: INTEGER<br />
aCSMaxPeakBandwidth: INTEGER<br />
aCSMaxPeakBandwidthPerFlow: INTEGER<br />
<-- snip --><br />
uSNChanged: INTEGER<br />
uSNCreated: INTEGER<br />
uSNDSALastObjRemoved: INTEGER<br />
uSNLastObjRem: INTEGER<br />
uSNSource: INTEGER<br />
vendor: CASE_INSENSITIVE<br />
wbemPath: CASE_INSENSITIVE<br />
wWWHomePage: CASE_INSENSITIVE<br />
x121Address: CASE_INSENSITIVE<br />
distinguishedName: @ATTRIBUTES</code></p>
<p><code># returned 1 records<br />
# 1 entries<br />
# 0 referrals</code></p></blockquote>
<h3>@SUBCLASSES</h3>
<h3>@MODULES</h3>
<p>Contains @LIST attributes that list all modules affecting current database. In the demonstration below, it calls the main module that determines the order of execution of all further modules.</p>
<blockquote><p><code>root@shiny:/home/kelly/work/samba/prefix.s4# bin/ldbsearch -H private/sam.ldb -s base -b @MODULES<br />
# record 1<br />
dn: @MODULES<br />
@LIST: samba_dsdb<br />
distinguishedName: @MODULES</code></p>
<p><code># returned 1 records<br />
# 1 entries<br />
# 0 referrals</code></p></blockquote>
<h3>@BASEINFO</h3>
<p>Fundamental to all of ldb &#8211; when the db last changed ,etc</p>
<blockquote><p><code>root@shiny:/home/kelly/work/samba/prefix.s4# bin/ldbsearch -H private/sam.ldb -s base -b @BASEINFO<br />
# record 1<br />
dn: @BASEINFO<br />
sequenceNumber: 16<br />
whenChanged: 20120104031707.0Z<br />
distinguishedName: @BASEINFO</code></p>
<p><code># returned 1 records<br />
# 1 entries<br />
# 0 referrals</code></p></blockquote>
<h3>@PARTITION</h3>
<p>List partitions on current database. This also states that attributes, indexes and options are to be replicated across each partition.</p>
<blockquote><p><code>root@shiny:/home/kelly/work/samba/prefix.s4# bin/ldbsearch -H private/sam.ldb -s base -b @PARTITION<br />
# record 1<br />
dn: @PARTITION<br />
replicateEntries: @ATTRIBUTES<br />
replicateEntries: @INDEXLIST<br />
replicateEntries: @OPTIONS<br />
partition: DC=SAMBA,DC=SOMEWOMAN,DC=COM:sam.ldb.d/DC=SAMBA,DC=SOMEWOMAN,DC=COM<br />
.ldb<br />
partition: CN=CONFIGURATION,DC=SAMBA,DC=SOMEWOMAN,DC=COM:sam.ldb.d/CN=CONFIGUR<br />
ATION,DC=SAMBA,DC=SOMEWOMAN,DC=COM.ldb<br />
partition: CN=SCHEMA,CN=CONFIGURATION,DC=SAMBA,DC=SOMEWOMAN,DC=COM:sam.ldb.d/C<br />
N=SCHEMA,CN=CONFIGURATION,DC=SAMBA,DC=SOMEWOMAN,DC=COM.ldb<br />
partition: DC=DOMAINDNSZONES,DC=SAMBA,DC=SOMEWOMAN,DC=COM:sam.ldb.d/DC=DOMAIND<br />
NSZONES,DC=SAMBA,DC=SOMEWOMAN,DC=COM.ldb<br />
partition: DC=FORESTDNSZONES,DC=SAMBA,DC=SOMEWOMAN,DC=COM:sam.ldb.d/DC=FORESTD<br />
NSZONES,DC=SAMBA,DC=SOMEWOMAN,DC=COM.ldb<br />
distinguishedName: @PARTITION</code></p>
<p><code># returned 1 records<br />
# 1 entries<br />
# 0 referrals</code></p></blockquote>
<h3>@OPTIONS</h3>
<blockquote><p><code>root@shiny:/home/kelly/work/samba/prefix.s4# bin/ldbsearch -H private/sam.ldb -s base -b @OPTIONS<br />
# record 1<br />
dn: @OPTIONS<br />
checkBaseOnSearch: TRUE<br />
distinguishedName: @OPTIONS</code></p>
<p><code># returned 1 records<br />
# 1 entries<br />
# 0 referrals</code></p></blockquote>
<h2><strong>LDAP Protocol Server</strong></h2>
<p>The LDAP Protocol Server is a very thin layer that sits between the LDAP protocol and the LDB layer, and listens on port 389 (the LDAP port) to IPv6 and IPv4 requests on all interfaces on the machine. When a request is received, it is parsed using the LDAP libraries and converted to an LDB request which can then be processed.</p>
<p>The server code is in <code><samba-directory>/source4/ldap_server/ldap_server.c</code></p>
<p>the function ldapsrv_call_read_done() reads a blob of data, retrieves the asn1 data (LDAP protocol specification) and parses it via ldap_decode(). Multiple failure checks are performed that will terminate the connection upon fail. If all is ok with the data blob, asn1, decoding, etc, it will add the resultant LDAP call into the global queue using ldapsrv_process_call_send()</p>
<p>At present, Samba performs a manual parse of LDAP requests. There are compilers available that are capable of compiling ASN1 files, and given the time over again Samba would likely have used a compiler rather than the current hand-written and very complicated parser.</p>
<p>It also serves the function of encoding requests and adding further data to them to create a format understandable by Active Directory, which can then be sent.</p>
<h2><strong>Linked Attributes</strong></h2>
<p>A lot of time has been spent within Samba on linked attributes, and they are surprisingly complex.</p>
<p>Many links are bi-directional, for example the adminstrator user is a member of the administrators group. The administrator user has a memberOf attribute pointing to the administrators group (the forward link), and the administrators group has a member attribute pointing to the administrator user (the back link). In this particular case, each can have multiple links, so the administrator may be a member of many groups, and the administrators group may have many members.</p>
<p>When an object gets renamed or deleted, we need to be able to update all of the links. So if we remove a user who is a member of multiple groups, we need to remove all of the back links pointing to that user. If we rename a user, we need to ensure that all of the back links refer to the correct name. A user is physically only able to modify forward links, and LDB controls modification of all of the back links according to any modifications made affecting the forward link. The direction of the link is specified by the linkID, where anything even is a forward link and anything odd is a back link.</p>
<p>In the following example, I have added the user &#8216;kelly&#8217; to the &#8216;guests&#8217; group using samba-tool (more information on samba-tool in a later post): <code><username>@<machinename>:<samba-directory>$ bin/samba-tool group addmembers guests kelly</code></p>
<p>Viewing all members of the &#8216;guests&#8217; group:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbsearch -H private/sam.ldb 'name=guests' member<br />
# record 1<br />
dn: CN=Guests,CN=Builtin,DC=samba,DC=somewoman,DC=com<br />
member: CN=Domain Guests,CN=Users,DC=samba,DC=somewoman,DC=com<br />
member: CN=Guest,CN=Users,DC=samba,DC=somewoman,DC=com<br />
member: CN=kelly,DC=samba,DC=somewoman,DC=com</code></p></blockquote>
<p>Viewing which groups &#8216;kelly&#8217; is a member of (automatically updated when adding member to group):</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbsearch -H private/sam.ldb 'name=kelly' memberof<br />
# record 1<br />
dn: CN=kelly,DC=samba,DC=somewoman,DC=com<br />
memberOf: CN=Administrators,CN=Builtin,DC=samba,DC=somewoman,DC=com<br />
memberOf: CN=Users,CN=Builtin,DC=samba,DC=somewoman,DC=com<br />
memberOf: CN=Guests,CN=Builtin,DC=samba,DC=somewoman,DC=com</code></p></blockquote>
<p>Attempt to remove the group &#8216;guests&#8217; from the user &#8216;kelly&#8217; (modification of back link not allowed):</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbmodify -H private/sam.ldb modifykelly.ldif<br />
ERR: (Unwilling to perform) "objectclass_attrs: attribute 'memberof' on entry 'CN=kelly,DC=samba,DC=somewoman,DC=com' must not be modified directly, it is a linked attribute" on DN CN=kelly,DC=samba,DC=somewoman,DC=com<br />
Modified 0 records with 1 failures</code></p></blockquote>
<p>where modifykelly.ldif contains:</p>
<blockquote><p><code>dn: CN=kelly,DC=samba,DC=somewoman,DC=com<br />
changetype: modify<br />
delete: memberof<br />
memberOf: CN=Guests,CN=Builtin,DC=samba,DC=somewoman,DC=com </code></p></blockquote>
<p>Attempt to remove the user &#8216;kelly&#8217; from the group &#8216;guests&#8217; (modification of forward link allowed):</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbmodify -H private/sam.ldb modifyguests.ldif<br />
# 0 adds  1 modifies  0 deletes</code></p></blockquote>
<p>Where modifyguests.ldif contains:</p>
<blockquote><p><code>dn: CN=Guests,CN=Builtin,DC=samba,DC=somewoman,DC=com<br />
changetype: modify<br />
delete: member<br />
member: CN=kelly,DC=samba,DC=somewoman,DC=com </code></p></blockquote>
<p>Viewing all members of the &#8216;guests&#8217; group:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbsearch -H private/sam.ldb 'name=guests' member<br />
# record 1<br />
dn: CN=Guests,CN=Builtin,DC=samba,DC=somewoman,DC=com<br />
member: CN=Domain Guests,CN=Users,DC=samba,DC=somewoman,DC=com<br />
member: CN=Guest,CN=Users,DC=samba,DC=somewoman,DC=com</code></p></blockquote>
<p>Viewing which groups &#8216;kelly&#8217; is a member of (note automatically updated by removal of &#8216;member&#8217; from &#8216;guests&#8217;:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbsearch -H private/sam.ldb 'name=kelly' memberof<br />
# record 1<br />
dn: CN=kelly,DC=samba,DC=somewoman,DC=com<br />
memberOf: CN=Administrators,CN=Builtin,DC=samba,DC=somewoman,DC=com<br />
memberOf: CN=Users,CN=Builtin,DC=samba,DC=somewoman,DC=com</code></p></blockquote>
<p>To further demonstrate how links are automatically updated, the following demonstration has re-added &#8216;kelly&#8217; to the &#8216;guests&#8217; group, and then &#8216;kelly&#8217; was renamed to &#8216;newuser&#8217; as follows:</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbrename -H private/sam.ldb 'CN=kelly,DC=samba,DC=somewoman,DC=com' 'CN=newuser,DC=samba,DC=somewoman,DC=com'<br />
Renamed 1 record</code></p></blockquote>
<p>viewing the members of the &#8216;guests&#8217; group (note &#8216;newuser&#8217; is there now instead of &#8216;kelly&#8217;, although no manual editing of the link has been done):</p>
<blockquote><p><code><username>@<machinename>:<samba-directory>$ bin/ldbsearch -H private/sam.ldb 'name=guests' member<br />
# record 1<br />
dn: CN=Guests,CN=Builtin,DC=samba,DC=somewoman,DC=com<br />
member: CN=Domain Guests,CN=Users,DC=samba,DC=somewoman,DC=com<br />
member: CN=Guest,CN=Users,DC=samba,DC=somewoman,DC=com<br />
member: CN=newuser,DC=samba,DC=somewoman,DC=com</code></p></blockquote>
<p>To add further to the complication, there are some attributes within Active Directory that contain only a forward link, no back link. This can get tricky because if someone renames or deletes a forward link object we have no way of finding related objects. We handle this by knowing that forward link only objects may not be up to date, and we may need to search with GUI information to re-find its full name as it may have changed. At startup, we build a list of all links in the schema. We can determine if a link is forward only VERY fast, and these are very rare so it doesn&#8217;t create a massive performance hit.</p>


<ul class="meta postfoot">
<li>Filed under <ul><li><a href="http://somewoman.com/?cat=1" title="View all posts in Uncategorized" rel="category">Uncategorized</a></li></ul></li>


<li class="add-comment icon"><a href="#respond">Add your comment</a></li>
<li class="trackback icon inline"><a href="http://somewoman.com/wp-trackback.php?p=261" rel="trackback">TrackBack <abbr title="Uniform Resource Identifier">URI</abbr></a></li>
<li class="comments-feed icon inline"><a href="http://somewoman.com/?feed=rss2&amp;p=261">Comments feed</a></li>

</ul>

</div>



								<div id="respond">
				<h3 id="reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="/?p=261#respond" style="display:none;">Cancel reply</a></small></h3>
									<form action="http://somewoman.com/wp-comments-post.php" method="post" id="commentform">
																			<p class="comment-notes"><label for="email"> Required fields are marked <span class="required">*</span><br />Your details will be stored in a non-tracking cookie but your email address will <em>never</em> be published or shared.</label></p>							<p class="comment-form-author"><label class="text" for="author">Name<span class="required">*</span></label><input id="author" name="author" type="text" value="" size="30" /></p>
<p class="comment-form-email"><label class="text" for="email">Email<span class="required">*</span></label><input id="email" name="email" type="text" value="" size="30" /></p>
<p class="comment-form-url"><label class="text" for="url">Website</label><input id="url" name="url" type="text" value="" size="30" /></p>
												<p class="comment-form-comment"><label for="comment">Comment</label><textarea id="comment" name="comment" cols="45" rows="8"></textarea></p>												<p class="form-submit">
							<input name="submit" type="submit" id="submit" value="Submit Reply" />
							<input type='hidden' name='comment_post_ID' value='261' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
						</p>
						<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="8c7d74ef0d" /></p>					</form>
							</div><!-- #respond -->
						

</div>
<!-- end content -->

<div class="sidebar accordian" id="scrapbook-main">

<h2 id="navbar">Navigation Menu</h2>

<div id="archives-3" class="widget-container widget_archive"><h3 class="widgettitle">Archives</h3>		<ul>
			<li><a href='http://somewoman.com/?m=201301' title='January 2013'>January 2013</a></li>
	<li><a href='http://somewoman.com/?m=201212' title='December 2012'>December 2012</a></li>
	<li><a href='http://somewoman.com/?m=201211' title='November 2012'>November 2012</a></li>
	<li><a href='http://somewoman.com/?m=201112' title='December 2011'>December 2011</a></li>
	<li><a href='http://somewoman.com/?m=201111' title='November 2011'>November 2011</a></li>
	<li><a href='http://somewoman.com/?m=201110' title='October 2011'>October 2011</a></li>
	<li><a href='http://somewoman.com/?m=201109' title='September 2011'>September 2011</a></li>
		</ul>
</div><div id="categories-3" class="widget-container widget_categories"><h3 class="widgettitle">Categories</h3><select name='cat' id='cat' class='postform' >
	<option value='-1'>Select Category</option>
	<option class="level-0" value="8">#killme&nbsp;&nbsp;(8)</option>
	<option class="level-0" value="11">Adelaide&nbsp;&nbsp;(7)</option>
	<option class="level-0" value="6">Alyssa&nbsp;&nbsp;(9)</option>
	<option class="level-0" value="9">cookin&#8217; baby!!&nbsp;&nbsp;(1)</option>
	<option class="level-0" value="15">Debian&nbsp;&nbsp;(1)</option>
	<option class="level-0" value="16">LDB&nbsp;&nbsp;(2)</option>
	<option class="level-0" value="19">lenovo&nbsp;&nbsp;(1)</option>
	<option class="level-0" value="7">Life in general&nbsp;&nbsp;(12)</option>
	<option class="level-0" value="13">Linux&nbsp;&nbsp;(2)</option>
	<option class="level-0" value="4">Miscellaneous&nbsp;&nbsp;(5)</option>
	<option class="level-0" value="20">personal&nbsp;&nbsp;(7)</option>
	<option class="level-0" value="5">Samba&nbsp;&nbsp;(5)</option>
	<option class="level-0" value="14">Ubuntu&nbsp;&nbsp;(3)</option>
	<option class="level-0" value="1">Uncategorized&nbsp;&nbsp;(10)</option>
	<option class="level-0" value="17">Virtual Machines&nbsp;&nbsp;(1)</option>
</select>

<script type='text/javascript'>
/* <![CDATA[ */
	var dropdown = document.getElementById("cat");
	function onCatChange() {
		if ( dropdown.options[dropdown.selectedIndex].value > 0 ) {
			location.href = "http://somewoman.com/?cat="+dropdown.options[dropdown.selectedIndex].value;
		}
	}
	dropdown.onchange = onCatChange;
/* ]]> */
</script>

</div><div id="search-3" class="widget-container widget_search"><form method="get" id="searchform" action="http://somewoman.com/">
<div>
<label for="s">Keyword(s): </label><input class="text" type="text" value=" " name="s" id="s" />
<input type="submit" class="submit" name="submit" value="Search" />
</div>
</form>
</div>
<h3 class="home"><a href="http://somewoman.com/">Home</a></h3>
<div id="linkcat-2" class="widget-container widget_links"><h3 class="widgettitle">Blogroll</h3>
	<ul class='xoxo blogroll'>
<li><a href="http://alyssa.yeoh.info" rel="me" title="My beautiful little person" target="_blank">Alyssa Pei Ping Yeoh</a></li>
<li><a href="http://kattekrab.net/" title="Someone who I admire above and beyond almost all others &#8211; one of the most awesome gals on the planet!" target="_blank">Donna Benjamin</a></li>
<li><a href="http://house.yeoh.info" rel="me" title="The house that I no longer live in" target="_blank">House</a></li>
<li><a href="http://samba.org" rel="co-worker" title="The official web page for Samba software" target="_blank">Samba</a></li>

	</ul>
</div>

<div id="meta-3" class="widget-container widget_meta"><h3 class="widgettitle">Meta</h3>			<ul>
						<li><a href="http://somewoman.com/wp-login.php">Log in</a></li>
			<li><a href="http://somewoman.com/?feed=rss2" title="Syndicate this site using RSS 2.0">Entries <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://somewoman.com/?feed=comments-rss2" title="The latest comments to all posts in RSS">Comments <abbr title="Really Simple Syndication">RSS</abbr></a></li>
			<li><a href="http://wordpress.org/" title="Powered by WordPress, state-of-the-art semantic personal publishing platform.">WordPress.org</a></li>
						</ul>
</div>
<a class="rss" href="http://somewoman.com/?feed=rss2" title="Subscribe to my RSS news feed"><img src="http://somewoman.com/wp-content/themes/scrapbook/images/rss.gif" width="24" height="24" alt="RSS" /></a>

</div>

</div>
<span class="clear"></span>
<!-- end innerwrap -->

</div>
<!-- end wrapper -->

<!-- start footer -->
<div id="footer">
<div id="footer-left"></div>
<div id="footer-right"></div>

<a class="top" href="#top" title="Go to top of page"><img src="http://somewoman.com/wp-content/themes/scrapbook/images/up.gif" width="16" height="16" alt="Go to top of page" /></a><br />

&copy; 2013 Kelly Yeoh<br />


Powered by the <a href="http://quirm.net/scrapbook">Scrapbook Theme </a>


<script type="text/javascript">tb_pathToImage = "http://somewoman.com/wp-includes/js/thickbox/loadingAnimation.gif";tb_closeImage = "http://somewoman.com/wp-includes/js/thickbox/tb-close.png";</script>
</div>
<!-- end footer -->


</div>
<!-- end container -->

</body>
</html>