<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="/css/default/style.css" />
<link rel="stylesheet" type="text/css" href="/css/qqface/qqFace.css" />
<link rel="stylesheet" type="text/css" href="/css/asyncbox/skins/Chrome/asyncbox.css" />
<link rel="stylesheet" type="text/css" href="/assets/6d60aeb8/pager.css" />
<script type="text/javascript" src="/js/jquery.min.js"></script>
<script type="text/javascript" src="/js/jquery.cookies.min.js"></script>
<script type="text/javascript" src="/js/AsyncBox.v1.4.5.js"></script>
<title>FlashCache初探-remimin-ChinaUnix博客</title>
<meta name="description" content='Flashcache-doc.txt翻译=================================1. 介绍===========Flashcache是linux内核模块的write back缓存。这个文档描述了flashcache'/>
<script language="javascript">
//用户是否在线
var isOnLine = '';
$(document).ready(function(){
	var blog = {'name': '', 'name_url': '', 'brief': ''};
	//消息通知显示和隐藏控制
	$('#show_message_slide_button').hover(
		function(){
			$('#message_slide_div').slideDown(100);											   
		},
		function(){
			
		}
	);

	$('#message_slide_div').hover(
		function(){
			
		},
		function(){
			$('#message_slide_div').slideUp(100);
		}
	);
	
	//编辑博客名
	$('#editbna').click(function(){
		blog.name = $('#bnaspan a').text();
		var val = '<input id="bnainput" type="text" style="float:left" value="" rel="' +$(this).attr('rel') + '" /><input id="bnasub" type="button" style="float:left" class="btn1"><input id="bnacanl" type="button" style="float:left" class="btn2"><div class="clear"></div>';
		$('#bnaspan').html(val);
		$('#bnainput').val(blog.name);
		$(this).parent().hide();
	});
	
	$('#bnasub').live('click', function(){
	    var rel = eval('({' + $('#bnainput').attr('rel') + '})');
		var name = $('#bnainput').val();
		if(name != blog.name){
	        $.ajax({
			    type: "POST",
			    url: rel.url,	
			    data: {
				    'name' : name
			    },
			    success:function(data){
				    if(data == 0){
						$('#bnaspan').html(blog.name);
						$('#bnaspan').html('<a href="' + rel.href + '">' + $('#bnaspan').html() + '</a>');
				    }else{
						$('#bnaspan').html(data);
						$('#bnaspan').html('<a href="' + rel.href + '">' + $('#bnaspan').html() + '</a>');
				    }
					$('#editbna').parent().show();
				}
			});
		}else{
		    $('#bnaspan').text(blog.name).html();
			$('#bnaspan').html('<a href="' + rel.href + '">' + $('#bnaspan').html() + '</a>');
			$('#editbna').parent().show();
		}
	});
	
	$('#bnacanl').live('click', function(){
		var rel = eval('({' + $('#bnainput').attr('rel') + '})');
		$('#bnaspan').html('<a href="' + rel.href + '">' + blog.name + '</a>');
		$('#editbna').parent().show();
	});
	
	//编辑签名
	$('#editbrief').click(function(){
	    blog.brief = $('#briefem').text();
		var val = '<input id="brfinput" type="text" style="float:left" value="" rel="' + $(this).attr('rel') + '" /><input id="brfsub" style="float:left"  type="button" class="btn1"><input style="float:left"  id="brfcanl" type="button" class="btn2"><div class="clear"></div>';
		$('#briefem').html(val);
		$('#brfinput').val(blog.brief);
		$(this).parent().hide();
	});
	
	$('#brfsub').live('click', function(){
	    var url = $('#brfinput').attr('rel');
		var brief = $('#brfinput').val();
		if(brief != blog.brief){
	        $.ajax({
			    type: "POST",
			    url: url,	
			    data: {
				    'brief' : brief
			    },
			    success:function(data){
				    if(data == 0){
				        $('#briefem').html(blog.brief);
				    }else{
						$('#briefem').html(data);
				    }
					$('#editbrief').parent().show();
				}
			});
		}else{
		    $('#briefem').text(blog.brief).html();
			$('#editbrief').parent().show();
		}
	});
	
	$('#brfcanl').live('click', function(){
		$('#briefem').html(blog.brief);
		$('#editbrief').parent().show();
	});

});
</script>
</head>
<body>
<div class="box">
  <!-- 一级导航 -->
  <div class="Blog_nav1">
    <div class="Blog_nav1_2"><a href="/"><img src="/image/default/1.png"></a><a href="http://www.chinaunix.net" class="Blog_a1">Chinaunix首页</a>　| 　<a href="http://bbs.chinaunix.net" target="_blank">论坛</a>　| 　<a href="http://blog.chinaunix.net" target="_blank">博客</a><span class="Blog_span1"></span>
            <a href="/site/login.html" class="Blog_a1">登录</a> | <a href="http://sso.chinaunix.net/Register?return_url=http%3A%2F%2Ft.cublog.com%2F" class="Blog_a1">注册</a>
          </div>
	<!--自动提示层-->
	<style>
	.bor13221{border:1px #bbb solid;width:206px;position:absolute;top:34px;left:0;background:#fff; z-index:9999;display:none}
	.bor13221 li{height:26px;line-height:26px;padding-left:6px;color:#555;font-size:14px;cursor:pointer;}
	.here{background:#f3f3f3;}
    </style>

	<!--自动提示层-->
    <div class="Blog_nav1_3" style="position:relative; z-index:9999;">
	 <div class="bor13221">
      <ul>
      </ul>
    </div>
	  <form action='/site/search.html' method='post'>
		<input type="text"  autocomplete="off"  class="Blog_txt1" id='search_input_id' name='keywords'>
		<select class="Bolg_sel1" name='type' id='search_type_blog'>
		  <option value='blog'>博文</option>
		  <option value='author'>博主</option>
		</select>
		<input type="submit" value='' name='submit' class="Blog_btn1">
	 </form>
    </div>
    <div class="clear"></div>
    <div class="Blog_nav1_layer1" id="message_slide_div" style="display:none;">
	    <ul>
	    	<li><a href="/message/private.html">私人消息()</a></li>
	    	<li><a href="/message/system.html">系统消息()</a></li>
	    	<li><a href="/member/request.html">好友请求()</a></li>
	    	<li><a href="/member/notification.html">通知管理()</a></li>
	    </ul>
    </div>
  </div>
   <script type="text/javascript">
  	$(function(){
		//点击添加进文本框
		$(".bor13221 li").live( 'click' , function(e){
			if ( e && e.stopPropagation )
			{
				//因此它支持W3C的stopPropagation()方法
				e.stopPropagation();
			}
			else
			{
				//否则，我们需要使用IE的方式来取消事件冒泡
				window.event.cancelBubble = true; 
			}
			$('#search_input_id').val($(this).text());
			$(".bor13221 ul").html('');
			$(".bor13221").hide();
		});
		$(".bor13221 ul li").live({
			mouseenter:
			function()
			{
				$(".bor13221 ul li").removeClass("here");
				$(this).addClass('here');
			},
			mouseleave:
			function()
			{
				$(".bor13221 ul li").removeClass("here");
				$(this).removeClass('here');
			}
		});
		//自动提示
		$('#search_input_id').keyup(function(event){
			//取消博主的提示
			var search_type_blog = $('#search_type_blog').val();
			if(search_type_blog == 'author') return false;

			var key = $(this).val();
			//获取键值
			var keycode = event.which; //38 上 40 下
			var count = $('.bor13221 ul li').length;
			if(key != '' && keycode != 38 && keycode != 40)
			{
				$.getJSON("http://api.sou.it168.com/autoWenKuCloud?jsoncallback=?",{"ty":"json","offset":"0","limit":"10","q":key}, function(result)
					{
						var arr = result.data;

						var html ='';
						for (i=0;i<arr.length ;i++ )   
						{   
							html += '<li>'+arr[i]+'</li>';
						} 
						
						$('.bor13221 ul').html(html);
						(arr.length > 1) ?  $(".bor13221").show() : $(".bor13221").hide();
					}
				);
			}
			else if(keycode == 38)
			{
				if(count > 0)
				{
					//遍历li
					var curr_li_num;
					$('.bor13221 ul li').each(function(index , dom){
						if($(dom).attr('class') == 'here')
						{
							curr_li_num = index;
							return false;
						}
					}); 
					var next_li_num;
					if(typeof(curr_li_num) == 'undefined')
					{
						next_li_num = count - 1;
					}
					else
					{
						if(curr_li_num == 0)
						{
							next_li_num = count - 1;
						}
						else
						{
							next_li_num = curr_li_num - 1;
						}
					}
					$(".bor13221 ul li").removeClass("here");
					$(".bor13221 ul li:eq(" + next_li_num + ")").addClass("here");
					$('#search_input_id').val($(".bor13221 ul li:eq(" + next_li_num + ")").text());
				}
			}
			else if(keycode == 40)
			{
				if(count > 0)
				{
					//遍历li
					var curr_li_num;
					$('.bor13221 ul li').each(function(index , dom){
						if($(dom).attr('class') == 'here')
						{
							curr_li_num = index;
							return false;
						}
					}); 
					var next_li_num;
					if(typeof(curr_li_num) == 'undefined')
					{
						next_li_num = 0;
					}
					else
					{
						if(curr_li_num == count - 1)
						{
							next_li_num = 0;
						}
						else
						{
							next_li_num = curr_li_num + 1;
						}
					}
					$(".bor13221 ul li").removeClass("here");
					$(".bor13221 ul li:eq(" + next_li_num + ")").addClass("here");
					$('#search_input_id').val($(".bor13221 ul li:eq(" + next_li_num + ")").text());
				}
			}
		});
		$(document).click(function(e){
			$(".bor13221").hide();
		});

	});
  </script>
  <!-- 头 -->
  <!-- 推荐博客-->
  <div class="Blog_header1">
	<div class="img1"></div>    <div class="Blog_header1_1">
      <p class="Blog_p1" ><em><a href="/uid/22400280.html">remimin</a></em><!--<a href="#">gaoke.blog.chinaunix.net</a>--></p>
      <p class="Blog_p2" style="color:#125A94">从跌倒到爬起来</p>
    </div>
        <div class="Blog_header1_2" id="hide_div1">
    	<span class="Blog_span3"></span>
    	<div class="float_div1" style="white-space:nowrap;" onmouseover="javascript:isMove=false" onmouseout="javascript:isMove=true">
	    <ul id="noticev2">  
		    		    <li><a href="http://blog.chinaunix.net/uid-24789255-id-3485443.html" target="_blank">【公布获奖】2-3月原创博文评选</a></li>
		    		    <li><a href="http://blog.chinaunix.net/uid-24789255-id-3559246.html" target="_blank">2013第一季度“ChinaUnix博客之星”评选活动</a></li>
		    		    <li><a href="http://blog.chinaunix.net/uid-24789255-id-3557856.html" target="_blank">【原创评选】2013年4-5月原创博文评选开始啦！</a></li>
		    	    </ul>
	    </div>
    </div>
            <div class="Blog_header1_3"><a href="/uid/22400280.html">首页</a>　| 　<a href="/uid/22400280/abstract/1.html">博文目录</a>　| 　<a href="/member/profile/uid/22400280.html">关于我</a></div>
  </div>
    
  <!-- 内容部分 -->
  	<script type="text/javascript" src="/highlight/scripts/XRegExp.js"></script> <!-- XRegExp is bundled with the final shCore.js during build -->
<script type="text/javascript" src="/highlight/scripts/shCore.js"></script>
<script type="text/javascript" src="/highlight/scripts/shAutoloader.js"></script>
<link type="text/css" rel="stylesheet" href="/highlight/styles/shCore.css"/>
<link type="text/css" rel="Stylesheet" href="/highlight/styles/shThemeDefault.css" />
<link href="/code/css/fck_editorarea.css" rel="stylesheet" type="text/css" />
  <div class="Blog_contain"> 
    <!-- 左 -->
	<script language="javascript">
$(document).ready(function(){
	$('#ConcernBtn').bind('click',function(){
			var cuid = '22400280';
			var url =  '/member/concern.html';
			var type = $(this).attr('rel');
		
			if(type == 'addConcern'){
				$.ajax({
					type : 'get',
					url  : url,
					data : {'op' : 'ajaxadd' , 'cuid' : cuid, 'random' : Math.random()},
					success : function(msg){	
					   if(msg == -1){
						   showErrorMsg('参数错误！');
					   } else if (msg == 0){
						   showErrorMsg('关注失败，没有该用户！');
					   } else if (msg == 1){
						   showErrorMsg('关注失败，您已经关注了该用户！');
					   } else if (msg == 2){
						   $('#ConcernBtn').val('已关注');
						   $('#ConcernBtn').attr('rel','delConcern');
						   showSucceedMsg('关注成功!');
					   } else if (msg == 3){
						   showErrorMsg('未知错误');
					   }
					}
				});	
			} else if ( type == 'delConcern'){
				$.ajax({
					type : 'get',
					url  : url,
					data : {'op' : 'ajaxdel' , 'cuid' : cuid, 'random' : Math.random()},
					success : function(msg){
					   if(msg == 0){
						   showErrorMsg('参数错误！','消息提示');
					   } else if (msg == 1){
						   showErrorMsg('操作失败，请尝试刷新页面重试！','消息提示');
					   } else if (msg == 2){
						   $('#ConcernBtn').val('加关注');
						   $('#ConcernBtn').attr('rel','addConcern');
						   showSucceedMsg('成功取消关注！','消息提示');
					   } else if (msg == 3){
						   showErrorMsg('未知错误！','消息提示'); 
					   }
					}
				});	
			}
	});					   
});

//加好友
function addFriend(fuid, url){
	if(fuid == '' || fuid.length == 0){
		showErrorMsg('缺少参数！','信息提示');
		return false;
	}
	$.ajax({
		   type : 'get',
		   url : url,
		   data : {'op' : 'add', 'fuid' : fuid , 'random' : Math.random()},
		   success : function(msg){
				if(msg == -1){
					showErrorMsg('参数错误！','消息提示');
				} else if (msg == -2){
					showErrorMsg('添加好友失败,没有该用户的信息！','消息提示');
				} else if (msg == -3){
					showErrorMsg('添加好友失败,你不能添加自己为好友！','消息提示');
				} else if (msg == -4){
					showErrorMsg('添加好友未知错误,该错误已被记录！','消息提示');
				} else if (msg == -5){
					showErrorMsg('添加好友失败,你之前已经发送过好友请求,请耐心等待对方同意申请！','消息提示');
				} else if (msg == -6){
					showErrorMsg('添加好友失败,你们已经是好友了！','消息提示');
				} else {
					$.cover(true);
					asyncbox.open({
						id : 'addFriend',
						title : '添加好友',
						url : url,
						data : {'op' : 'add', 'fuid' : fuid , 'random' : Math.random()},
						width : 490,
						height : 180,
						scroll : 'no',
						callback : function(action) {
							if (action == 'close'){
								$.cover(false);
							}	
						}
					});	
				}
		   }
	});	
	
}

//发送短消息
function postMessage(msguid, url){
	if(msguid == '' || msguid.length == 0){
		showErrorMsg('缺少参数！','信息提示');
		return false;
	}
	
	$.ajax({
		   type : 'post',
		   url : url,
		   data : {'op' : 'ajaxpost', 'msguid' : msguid , 'random' : Math.random()},
		   success : function(msg){
				if(msg == -1){
					showErrorMsg('发送失败，缺少收件人对象！','消息提示');
				} else if(msg == -2){
					showErrorMsg('发送失败，自己不能给自己发送短消息！','消息提示');
				} else {
					$.cover(true);
					asyncbox.open({
						id : 'postMessage',
						title : '发送短消息',
						url : url,
						data : {'op' : 'ajaxpost', 'msguid' : msguid , 'random' : Math.random()},
						width : 510,
						height : 255,
						scroll : 'no',
						callback : function(action) {
							if (action == 'close'){
								$.cover(false);
							}	
						}
					});	
				}
		   }
	});	
}

</script>
<div class="Blog_left">
      <div class="Blog_left1 Blog_bg1">
        <div class="Blog_left1_1">
			<!-- 专家博客-->
			<a href="/uid/22400280.html"><img src="http://passport.ixpub.net/data/avatar/022/40/02/80_avatar_middle.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_middle.gif'" /></a>
            <p><a href="/uid/22400280.html">remimin</a></p>
        </div>
        <ul class="Blog_ul1 Blog_noline1">
          <li>博客访问： 58001 </li>
          <li>博文数量： 88 </li>
          <li>博客积分： 2622 </li>
          <!--<li>专家积分： 180</li>-->
          <li>博客等级： 少校 </li>
		  <li>技术积分： 1125 </li>
          <li>用  户  组：  普通用户</li>
          <li>注册时间： 2010-03-17 08:59 </li>
          <li></li>
        </ul>  
        
                <div class="HT_line3 HT_line3_1"></div>
        <ul class="Blog_ul2">
          <li><input type="button" value="加关注" id="ConcernBtn" onclick="showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html')"></li>
          <li><input type="button" value="短消息" id="postMessageBtn" onclick="showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html')"></li>
          <li><input type="button" value="论坛" onclick="location.href='http://bbs.chinaunix.net'"></li>
          <li><input type="button" value="加好友" id="addFriendBtn" onclick="showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html')"></li>
        </ul>
              </div>
        
         
      <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">文章分类</div>
        <div class="Blog_left2_1">
          <p class="Blog_p4"><a href="/uid/22400280/list/1.html">全部博文</a>（88）</p>
          <ul id="blogCla">
                            <li><a href="/uid/22400280/cid-174390-list-1.html" title="KVM">KVM</a>（1）
                                </li>
                            <li><a href="/uid/22400280/cid-174228-list-1.html" title="openstack">openstack</a>（1）
                                </li>
                            <li><a href="/uid/22400280/cid-167057-list-1.html" title="算法与数据结构">算法与数据结构</a>（4）
                                </li>
                            <li><a href="/uid/22400280/cid-162374-list-1.html" title="swift">swift</a>（4）
                                </li>
                            <li><a href="/uid/22400280/cid-161517-list-1.html" title="python">python</a>（5）
                                </li>
                            <li><a href="/uid/22400280/cid-160615-list-1.html" title="分级存储">分级存储</a>（1）
                                </li>
                            <li><a href="/uid/22400280/cid-159766-list-1.html" title="C/C++语言学习">C/C++语言学习</a>（9）
                                </li>
                            <li><a href="/uid/22400280/cid-159493-list-1.html" title="Linux工具使用">Linux工具使用</a>（4）
                                </li>
                            <li><a href="/uid/22400280/cid-157667-list-1.html" title="Nginx学习">Nginx学习</a>（15）
                                </li>
                            <li><a href="/uid/22400280/cid-24765-list-1.html" title="job controller">job controller</a>（8）
                                </li>
                            <li><span class="Blog_jia1"></span><a href="/uid/22400280/cid-24764-list-1.html" title="iphone初探">iphone初探</a>（16）
                                    <div style="display:none;" class="zk">
					                        <p><a href="/uid/22400280/sid-151424-list-1.html" title="CFNetwork">CFNetwork</a>（2）</p>
                                        </div>
                                </li>
                            <li><a href="/uid/22400280/cid-24763-list-1.html" title="windows编程">windows编程</a>（2）
                                </li>
                            <li><a href="/uid/22400280/cid--1-list-1.html" title="未分配的博文">未分配的博文</a>（18）
                                </li>
                      </ul>
        </div>
      </div>
                  <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">文章存档</div>
        <div class="Blog_left2_1" id="blogdtr">
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/22400280/year-2013-list-1.html">2013年</a>（2）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/22400280/year-201303-list-1.html">2013年03月</a>（2）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/22400280/year-2012-list-1.html">2012年</a>（60）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/22400280/year-201211-list-1.html">2012年11月</a>（1）</li>
                        <li><a href="/uid/22400280/year-201210-list-1.html">2012年10月</a>（8）</li>
                        <li><a href="/uid/22400280/year-201209-list-1.html">2012年09月</a>（4）</li>
                        <li><a href="/uid/22400280/year-201208-list-1.html">2012年08月</a>（5）</li>
                        <li><a href="/uid/22400280/year-201207-list-1.html">2012年07月</a>（8）</li>
                        <li><a href="/uid/22400280/year-201206-list-1.html">2012年06月</a>（8）</li>
                        <li><a href="/uid/22400280/year-201205-list-1.html">2012年05月</a>（16）</li>
                        <li><a href="/uid/22400280/year-201204-list-1.html">2012年04月</a>（3）</li>
                        <li><a href="/uid/22400280/year-201203-list-1.html">2012年03月</a>（4）</li>
                        <li><a href="/uid/22400280/year-201202-list-1.html">2012年02月</a>（1）</li>
                        <li><a href="/uid/22400280/year-201201-list-1.html">2012年01月</a>（2）</li>
                      </ul>
                    <p class="Blog_p4"><span class="Blog_jia1"></span><a href="/uid/22400280/year-2010-list-1.html">2010年</a>（26）</p>
          <ul style="display:none;" class="Blog_ul3 zk">
                        <li><a href="/uid/22400280/year-201009-list-1.html">2010年09月</a>（14）</li>
                        <li><a href="/uid/22400280/year-201008-list-1.html">2010年08月</a>（8）</li>
                        <li><a href="/uid/22400280/year-201006-list-1.html">2010年06月</a>（3）</li>
                        <li><a href="/uid/22400280/year-201005-list-1.html">2010年05月</a>（1）</li>
                      </ul>
                  </div>
      </div>
            <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">我的朋友</div>
        <ul class="Blog_ul4">
                    <li><a href="/uid/28032128.html"><img src="http://passport.ixpub.net/data/avatar/028/03/21/28_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/28032128.html" title="lmnos">lmnos</a></p>
          </li>
                    <li><a href="/uid/26185912.html"><img src="http://passport.ixpub.net/data/avatar/026/18/59/12_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/26185912.html" title="无赖皮肤">无赖皮肤</a></p>
          </li>
                    <li><a href="/uid/22859753.html"><img src="http://passport.ixpub.net/data/avatar/022/85/97/53_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/22859753.html" title="athxy">athxy</a></p>
          </li>
                  </ul>
      </div>
      <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">最近访客</div>
        <ul class="Blog_ul4">
                    <li><a href="/uid/20767124.html"><img src="http://passport.ixpub.net/data/avatar/020/76/71/24_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/20767124.html" title="linuxty">linuxty</a></p>
          </li>
                    <li><a href="/uid/23069658.html"><img src="http://passport.ixpub.net/data/avatar/023/06/96/58_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/23069658.html" title="wjlkoorey258">wjlkoore</a></p>
          </li>
                    <li><a href="/uid/28629722.html"><img src="http://passport.ixpub.net/data/avatar/028/62/97/22_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/28629722.html" title="lazy_mouse">lazy_mou</a></p>
          </li>
                    <li><a href="/uid/20537627.html"><img src="http://passport.ixpub.net/data/avatar/020/53/76/27_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/20537627.html" title="ayl001">ayl001</a></p>
          </li>
                    <li><a href="/uid/28725306.html"><img src="http://passport.ixpub.net/data/avatar/028/72/53/06_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/28725306.html" title="struggling_fish">struggli</a></p>
          </li>
                    <li><a href="/uid/26198877.html"><img src="http://passport.ixpub.net/data/avatar/026/19/88/77_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/26198877.html" title="cenzhutang">cenzhuta</a></p>
          </li>
                    <li><a href="/uid/20885327.html"><img src="http://passport.ixpub.net/data/avatar/020/88/53/27_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/20885327.html" title="nwl586">nwl586</a></p>
          </li>
                    <li><a href="/uid/28753072.html"><img src="http://passport.ixpub.net/data/avatar/028/75/30/72_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/28753072.html" title="songjoey819">songjoey</a></p>
          </li>
                    <li><a href="/uid/26548237.html"><img src="http://passport.ixpub.net/data/avatar/026/54/82/37_avatar_small.jpg" onerror="this.onerror=null;this.src='http://passport.ixpub.net/images/noavatar_small.gif'" /></a>
            <p><a href="/uid/26548237.html" title="梦醒潇湘love">梦醒潇湘</a></p>
          </li>
                  </ul>
      </div>
      <div class="Blog_left2 Blog_bg1">
        <div class="Blog_tit1">订阅</div>
        <ul class="Blog_ul5">
          <li><a href="/blog/rss/uid/22400280.html" class="Blog_a4"></a></li>
          <li><a href="http://www.google.com/ig/add?feedurl=http%3A%2F%2Fblog.chinaunix.net%2Fuid%2F22400280.html" class="Blog_a5"></a></li>
        </ul>
      </div>
      <div class="Blog_left2 Blog_left3 Blog_bg1">
        <div class="Blog_tit1">推荐博文</div>
        <ul class="Blog_ul6">
				  			<li>·<a href="/uid-25057421-id-3590958.html" title="shell下用户初始化配置文件">shell下用户初始化配置文件...</a></li>
		  			<li>·<a href="/uid-26364035-id-3588349.html" title="使用mysqltuner定位一个Aborted_connects问题">使用mysqltuner定位一个Abort...</a></li>
		  			<li>·<a href="/uid-26364035-id-3588524.html" title="从库延迟调查&导致延迟动作的定位">从库延迟调查&导致延迟动作的...</a></li>
		  			<li>·<a href="/uid-26364035-id-3588551.html" title="MySQL数据目录磁盘满了，导致的错误 Errcode 28">MySQL数据目录磁盘满了，导致...</a></li>
		  			<li>·<a href="/uid-26364035-id-3588540.html" title="MySQL一些常用安全的习惯">MySQL一些常用安全的习惯...</a></li>
		  		        </ul>
      </div>
      <div class="Blog_left2 Blog_left3 Blog_bg1">
        <div class="Blog_tit1">热词专题</div>
        <ul class="Blog_ul6">
                        <li >·<a href="http://blog.chinaunix.net/zhuanti/101153/nbustatus96mhvtl_1011520262.shtml" target='blank' title='nbu status 96 mhvtl'>nbu status 96 mhvtl</a></li>
                        <li >·<a href="http://blog.chinaunix.net/zhuanti/101164/squidmms_1011638961.shtml" target='blank' title='squid mms'>squid mms</a></li>
                        <li >·<a href="http://blog.chinaunix.net/zhuanti/101152/linuxyouxiaoyonghuid_1011519605.shtml" target='blank' title='linux 有效用户id'>linux 有效用户id</a></li>
                        <li >·<a href="http://blog.chinaunix.net/zhuanti/101152/javascriptbiaodantijiaocgi_1011518978.shtml" target='blank' title='javascript 表单提交cgi'>javascript 表单提交cgi</a></li>
                        <li class="no_line1">·<a href="http://blog.chinaunix.net/zhuanti/101164/memmap_1011631030.shtml" target='blank' title='memmap'>memmap</a></li>
                  </ul>
      </div>

      <div class="Blog_left2 Blog_left3 Blog_bg1">
        <div class="Blog_tit1">友情链接</div>
        <ul class="Blog_ul6">
                  </ul>
      </div>


	</div>
<script language="javascript">
$(document).ready(function(){
    /*目录树JS效果*/
	$('#blogCla li > span').click(function(){
		var cla = $(this).attr('class');
		if(cla == 'Blog_jia1'){
			//$('#blogCla li > span').removeClass('Blog_jian1').addClass('Blog_jia1');
			//$('#blogCla li > .zk').css('display', 'none');
				
			$(this).removeClass('Blog_jia1').addClass('Blog_jian1');
            $(this).parent().children('.zk').css('display', 'block');
		}else{
			$(this).removeClass('Blog_jian1').addClass('Blog_jia1');
            $(this).parent().children('.zk').css('display', 'none');
		}
	});
		
	$('#blogdtr > p > span').click(function(){
		var cla = $(this).attr('class');
		if(cla == 'Blog_jia1'){
			//$('#blogdtr > .Blog_p4 > span').removeClass('Blog_jian1').addClass('Blog_jia1');
			//$('#blogdtr ul').css('display', 'none');
				
			$(this).removeClass('Blog_jia1').addClass('Blog_jian1');
            $(this).parent().next().css('display', 'block');
		}else{
			$(this).removeClass('Blog_jian1').addClass('Blog_jia1');
            $(this).parent().next().css('display', 'none');
		}
	});
});
</script>    <!-- 右 -->
    <div class="Blog_right1">
      <div class="Blog_right1_1 Blog_right1_11">
        <div class="Blog_right1_2 ">
			<!--推荐博文-->
          <div class="Blog_tit4 Blog_tit5">
                        <b class="Blog_b1"></b>
            <a href="/uid-22400280-id-3255989.html">FlashCache初探</a>
            <em>2012-06-27 11:03:52</em>
          </div>
          <div class="Blog_con2">
            <div class="Blog_con3">
              <p>分类： <span>Mysql/postgreSQL</span></p>
			                </p>
            </div>
           <div class="Blog_wz1" style='word-wrap: break-word;'>
			<a href="https://github.com/facebook/flashcache/blob/master/doc/flashcache-doc.txt" target="_blank" style="margin: 0px; padding: 0px; text-decoration: none; color: rgb(0, 0, 0); border-bottom-width: 1px; border-bottom-style: dotted; border-bottom-color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); " target="_blank">Flashcache-doc.txt翻译</a><div><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">=================================</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); "><b>1. 介绍</b></p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); "><b>===========</b></p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">Flashcache是linux内核模块的write back缓存。这个文档描述了flashcache的设计、未来的idea、配置和调优，以及flashcache提供的可覆盖测试钩子和我们所做的测试。Flashcache目前主要作为InnoDB的块缓存，但是其是通用设计可以用于其他的应用。</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">========================================</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); "><b>2. Flashcache设计</b></p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); "><b>==========</b></p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">flashcache使用了Linux Device Mapper(DM)，是Linux 存储栈架构中的一部分，在创建SW-raid和其他组件的时候经常会涉及到，例如，LVM使用的就是DM。</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">cache的结构使用了一系列的哈希，cache划分成多个固定大小的sets(buckets),在set内部使用线性探测照抄blocks。这一系列<span style="font-size: 14px; ">哈希使用的好处很多（后面的部分将会介绍）并且能够很好的发挥使用。</span></p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">block size,set size和cache size都是可以配置的参数，在cache创建需要。默认的设置：set size为 512（个block），几乎没有什么理由需要修改这个值。（思：意思是推荐使用512）</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">在以下的内容中，dbn意思是"disk block number"，在扇区内的逻辑设备块号。</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">计算一个给定的dbn所属于的target set的方法：</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">target set=(dbn/block size/set size)mod(number of sets)</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">确认了集合后，在集合内部线性查找block。一个顺寻范围的disk block全部映射在一个指定的集合内。</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">DM layer在IO发送到cache layer之前将所有的IO操作转化为对block的操作（思：即对其转换等操作）。默认地，flashcache缓存所有的blosksize IO，但是可以配置为之缓存随机IO忽略顺序IO。</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">Cache &nbsp;set内部的替换策略是FIFO或者LRU。默认是FIFO但是策略可以在运行期间任何一个点进行切换同时sysctl（see the configuration and tuning section）。</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">处理缓存的读操作，计算目标集合（根据dbn）现行查找到block。当缓存命中时，就从flash中奖数据读取出来；若未命中，数据则从磁盘中读取数据，将数据写入到flash中,然后返回数据。</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">由于flashcache采用的写回策略，写操作仅仅写入到flash中，同步更新cache的metadata(标记cache block是脏块)，则完成写操作，当block再次被写入事，metadata就不用再更新了。（因为已经标记为脏块了）。</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">必须注意的是，in the first cut，cache写入不是原子的，例如会有"Torn Page Problem"存在。一旦遇上断电或者写错误，那么有可能部分块以纪念馆写入成功。我们已经有了idea去fix这个问题，并提供原子的cache写入操作（看the Futures section）。</p><p style="margin: 5px auto; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">对于每一个缓存块都有一个on-flash metadata为了cache的持久化（是这个意思么？</p><div id="LC67" class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">Each cache block has on-flash metadata associated with it for cache</div><div id="LC68" class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">persistence.），每个block的metadata包含了dbn和flags(disk block cached in this slot)and flags(Dirty,VALID,INVALID).</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">cache metadata只有在写操作或者一个cache block被清除的时候需要更新。执行写操作时，将flag标记为dirty；被清除时标记为~dirty。为了最小化flash写操作，cache block metadata在读的时候不需要更新。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">另外，我们还有一个on-flash cache superblock，包含cache的参数（在cache重启时读取），也包含cache关闭是否是clean的（顺序关闭或者节点宕机，断电等等）。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">当cache是clean shutdown时，所有cache blocks的metadat都会被写入到flash中。在顺序关机以后，VALID和DIRTY的块已经持久化，那么当cache重启时，会加载VALID和DIRTY的块。当节点宕机或者断电时，只有dirty cache blocks会重启。节点宕机或者断电不会导致数据丢失，但是有可能导致cache丢失valid和non-dirty的cached blocks（为什么？）。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">cache 的metadata在可能的时候再批量进行更新。所以如果我们有多个待更新的metadata位于同一个metadata sector中，可以集中一次更新，当一个文件顺序写入时，我们通常将多个metadata一起更新。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">脏的缓存块会在后台写入到disk中。flashcache的延迟写入是由可配置的参数dirty threshold控制的（请查看configuration and tunings section）。Flashcache维持每个set中的dirty block的百分比在dirty threshold之下，当set中脏块百分比超过了脏块阈值之后，set将被清理（即写入到disk中并把metadata清空）。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">DIRTY blocks的清理选择基于置换策略（FIFO Vs LRU）。当我们选择一个目标set清理时，对这些block进行排序，将块进行合并成大的IO，写入到disk中。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">&nbsp;</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">之前提到过，在IO操作发送到flashcache之前，DM将IO分裂为blocksize的块操作。对于小IO或者一个IO操作跨两个cache blocks，直接将IO发送到disk中。但是在这之前，我们将cacheblocks中对应这些io的都标记为invalidate。如果覆盖的cacheblock为DIRTY，将数据写入到cacheblock中，并clean。将IO所在的cacheblocks置为invalidate非常容易，使用set相关的哈希算法计算io所在set。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); "><br></div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">Flashcache支持块校验，在cache上计算，并且在每次cache读取时有效。块校验是可以编译选择的，由于“Torn page”的问题，默认是关闭的。如果cache写失败，有的block已经成功提交到flash中，那么block checksum出现错误的block以及之后的所有的block写入都认为是失败的。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">&nbsp;</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">那么cache metadata的开销有多大呢？每个cache block有24字节的内存状态（64位架构）和16字节on-flash metadata state。对于一个300GB的cache有16KB的blocks，有将近20 Million(300GB/16KB~20,000,000) cacheblocks，内存元数据消耗是480MB(20,000,000*24B = 480MB)，如果我们配置300GB的cache使用4KB的block时，内存消耗为1.8GB。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">&nbsp;</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">允许进程标记为不cache不可用的，只要通过flashcache ioctl，如果进程是顺序的便利一个大的table（例如备份操作），可以标记为不是用cache的。当不使用cache的进程执行读操作时，命中率cache时，则从cache中读取，未命中时，则直接从硬盘中读取，但是并不加载至cache中；当执行写操作时，命中cache时，则将cache中的标记为invalidate（如果需要的话，首先将数据clean），然后直接写入到磁盘中去。</div><div class="line" style="margin: 0px; padding: 0px; background-color: rgb(255, 255, 255); "><font color="#333333" face="verdana, Arial, Helvetica, sans-serif"><span style="line-height: 27px;">A few things to note about tagging pids non-cacheable. First, this only really works reliably with Direct IO. For buffered IO, writes will almost always happen from kernel threads (eg pdflush). So writes will continue to be cached. For most filesystems, these ioctls will make buffered reads uncached - readaheads will be kicked off the filemap code, so the readaheads will be kicked off from the same context as the reads.</span></font></div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">如果一个进程标记他为不是用缓存，当进程退出时flashcache没有办法执行clean操作，（因为Linuxkernel没有at_exit()钩子）。因此，应用程序必须解决这个问题（见下文配置）。关于清理问题的解决方法是，使用缓存控制flashcache伪文件系统，在一个进程退出时最后一个关闭的fd负责清理工作。（see Futures for more details）。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); ">尽管目前对于进程标记为不使用cache存在这些限制，我们仍然认为进程使用直接IO是有价值的，尤其是对于备份这种类型的操作。</div><div class="line" style="margin: 0px; padding: 0px; color: rgb(51, 51, 51); font-family: verdana, Arial, Helvetica, sans-serif; font-size: 14px; line-height: 27px; background-color: rgb(255, 255, 255); "><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">另外一种不使用缓存的情况时，用户自己可以使用系统调用‘skip_seq_thresh_kb'，自主决定接下来的顺序IO不使用缓存，通过一个可配置的阈值进行判断，什么时候的请求时顺序的，如果是顺序的则不执行缓存操作。判断是否是顺序IO的算法应该是能够区分不同的IO流的，例如，两个IO流是顺序的读写，但是第三个IO流是随机的需要使用缓存。在这里值得注意的一点是，可能存在这样的情况，多个小文件顺序写入到连续的块中，flashcache是无法判断这种情况的，因为flashcache是在块级别的而不是文件级别，因此这种情况下，将仍会被作为顺序读写，跳过缓存进行读写处理。</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">（更多的管理caching controls的细节，可以查看SA Guide手册）</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">=============================</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">Futures and Features：</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">==============</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">Cache Mirroring</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">------------------------</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">将两个物理的flash设备镜像，但是不需要更改任何代码。因为cache设备是块设备，我们能够在块设备中构建RAID-1，即可以在两个物理flash设备上构建然后使用我们的cache device。（这里并没有进行过测试）</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">Cache Resizing：</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">-------------------</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">最简单的扩充cache的方法就是离线的方法，在线进行cache扩展的方法是非常复杂而且容易出错的</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; "><br></div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">Intergartion With ATA TRIM Command：</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">--------------------------------------------</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">The ATA TRIM命令作为以文件系统的方式访问SSD设备。Flashcache可以利用这一特点。</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; "><div class="line" id="LC200" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">The ATA TRIM command was introduced as a way for the filesystem to</div><div class="line" id="LC201" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">inform the ssd that certain blocks were no longer in use to faciliate</div><div class="line" id="LC202" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">improved wear levelling algorithms in the ssd controller. Flashcache</div><div class="line" id="LC203" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">can leverage this as well. We can simply discard all blocks falling</div><div class="line" id="LC204" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">within a TRIM block range from the cache regardless of the state,</div><div class="line" id="LC205" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">since they are no longer needed.</div></div><div id="LC164" class="line" style="margin: 0px; padding: 0px; "><br></div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">Deeper integration with filesystems：</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">---------------------------------------</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">将flashcache与文件系统进行更深一步的结合，使得文件系统能够轻松的标记IO是否使用缓存。</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">Fixing the "Torn Page Problem"（make Cache Write Atomic）：</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">------------------------------------------------------------------</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">之前提到的，cache block的写入不是原子的写入，所以可能引起“Torn Page Problem”，即一部分写完成造成的不一致状态。当发生突然断电或者宕机时，可能产生这种写错误。</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; ">我们解决的思想是使用shadow paging techniques实现原子cache block写入。Mark C说我们能够通过原子cache block写避免doublebuffer writes。</div><div id="LC164" class="line" style="margin: 0px; padding: 0px; "><div class="line" id="LC220" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">We have ideas on how to fix this and achieve atomic cache block writes</div><div class="line" id="LC221" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">using shadow paging techniques. Mark C. says that we could avoid</div><div class="line" id="LC222" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">doublebuffer writes if we have atomic cache block writes. However,</div><div class="line" id="LC223" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">with flashcache, doublebuffer writes will all be absorbed by the flash</div><div class="line" id="LC224" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">(and we should get excellent write hits/overwrites for doublebuffer</div><div class="line" id="LC225" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">blocks so they would never hit disk). So it is not clear how much of a</div><div class="line" id="LC226" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">win atomic cache block writes will be.</div><div class="line" id="LC227" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; "><br></div><div class="line" id="LC228" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">It is however a handy feature to provide. If we have atomic block</div><div class="line" id="LC229" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">writes we could also enable cache block checksums.</div><div class="line" id="LC230" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; "><br></div><div class="line" id="LC231" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">There are broadly 3 ways to fix this.</div><div class="line" id="LC232" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">1) If the flash device offers configurable sector sizes, configure it</div><div class="line" id="LC233" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">to match the cache block size (FusionIO offers upto a 4KB configurable</div><div class="line" id="LC234" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">sector size).</div><div class="line" id="LC235" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">2) If we choose a shadow page that falls in the same metadata sector</div><div class="line" id="LC236" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">as the page being overwritten, we can do the shadow page write and</div><div class="line" id="LC237" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">switch the metadata atomically.</div><div class="line" id="LC238" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">3) If we don't want the restriction that the shadow page and the page</div><div class="line" id="LC239" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">overwritten are part of the same metadata sector, to allow us to pick</div><div class="line" id="LC240" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">a shadow page more freely across the cache set, we would need to</div><div class="line" id="LC241" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">introduce a monotonically increasing timestamp per write in the cache</div><div class="line" id="LC242" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">metadata that will allow us to disambiguate dirty blocks in the event</div><div class="line" id="LC243" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">of a crash.</div><div class="line" id="LC243" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">
<div class="line" id="LC245" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; "><br class="Apple-interchange-newline">Breaking up the cache spinlock :</div><div class="line" id="LC246" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">------------------------------</div><div class="line" id="LC246" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">所有的cache状态都是由单独的自旋锁进行保护，所以当前的CPU利用非常低，目前没有精力用于自旋锁部分，将来可能会更改。</div><div class="line" id="LC250" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; "><br></div><div class="line" id="LC251" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">Make non-cacheability more robust（更强大的非缓存能力） :</div><div class="line" id="LC252" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">---------------------------------</div><div class="line" id="LC252" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">当进程死亡时，需要定期的清理非缓存。可能最好的解决方法是采用伪文件系统的方式。</div><div class="line" id="LC253" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">The non-cacheability aspect need fixing in terms of cleanup when a</div><div class="line" id="LC254" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">process dies. Probably the best way to approach this is to approach</div><div class="line" id="LC255" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">this in a pseudo filesystemish way.</div><div class="line" id="LC256" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; "><br></div><div class="line" id="LC257" style="margin: 0px; padding: 0px 0px 0px 10px; border: 0px; background-color: transparent; ">Several other implementation TODOs/Futures are documented in the code.</div><br></div></div></div></div>           </div>
            <!-- <div class="Blog_con3_1">管理员在2009年8月13日编辑了该文章文章。</div> -->
            <div class="Blog_con2_1 Blog_con3_2">
              <div>
			  <!--<img src="/image/default/tu_8.png">-->
			  <!-- JiaThis Button BEGIN -->
				<DIV class="bshare-custom icon-medium-plus"><A class=bshare-qzone title=分享到QQ空间></A><A class=bshare-sinaminiblog title=分享到新浪微博></A><A class=bshare-renren title=分享到人人网></A><A class=bshare-qqmb title=分享到腾讯微博></A><A class=bshare-douban title=分享到豆瓣></A><A class="bshare-more bshare-more-icon more-style-addthis" title=更多平台></A></DIV>
				<SCRIPT type=text/javascript charset=utf-8 src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=3&amp;lang=zh"></SCRIPT>

				<SCRIPT type=text/javascript charset=utf-8 src="http://static.bshare.cn/b/bshareC0.js"></SCRIPT>
				<!-- JiaThis Button END -->
			  </div>
              阅读(1084) | 评论(0) | 转发(0) |
			                <div class="HT_line3"></div>
            </div>
            <div class="Blog_con3_3">
              <div><span id='digg_num'>0</span><a href="javascript:void(0)" id='digg' bid='3255989' url='/blog/digg.html' ></a></div>
              <p>上一篇：<a href="/uid-22400280-id-3253853.html">C++ 对象的内存布局(下)</a></p>
              <p>下一篇：<a href="/uid-22400280-id-3259804.html">C++编程思想学习笔记（一）</a></p>
            </div>
          </div>
          <div class="Blog_con3_4">
            <div class="Blog_tit2 Blog_tit6">相关热门文章</div>
			            <ul class="Blog_ul7">
						  <li><span class="Blog_span6"></span><a href="http://blog.chinaunix.net/uid-22334392-id-3586824.html" title='System Management Facilities 初探' target='blank' >System Management Facilities...</a></li>
						  <li><span class="Blog_span6"></span><a href="http://blog.chinaunix.net/uid-28530005-id-3582581.html" title='Linux-USB-规范' target='blank' >Linux-USB-规范</a></li>
						  <li><span class="Blog_span6"></span><a href="http://blog.chinaunix.net/uid-28492246-id-3560571.html" title='mysql-binlog备份初探' target='blank' >mysql-binlog备份初探</a></li>
						  <li><span class="Blog_span6"></span><a href="http://blog.chinaunix.net/uid-25498312-id-3555375.html" title='.net多线程引入初探' target='blank' >.net多线程引入初探</a></li>
						  <li><span class="Blog_span6"></span><a href="http://blog.chinaunix.net/uid-12845622-id-3554772.html" title='Gstreamer应用::初探' target='blank' >Gstreamer应用::初探</a></li>
			            </ul>
			            <ul class="Blog_ul7">
						  <li><span class="Blog_span7"></span><a href="/uid-20393955-id-3084628.html" title='python 多进程之管道实例（模板）' target='blank' >python 多进程之管道实例（模...</a></li>
						  <li><span class="Blog_span7"></span><a href="/uid-474889-id-2397011.html" title='解决mysql“Access denied for user 'root'@'localhost'”' target='blank' >解决mysql“Access denied for...</a></li>
						  <li><span class="Blog_span7"></span><a href="/uid-233938-id-162625.html" title='新做的mysql5.1中文手册' target='blank' >新做的mysql5.1中文手册...</a></li>
						  <li><span class="Blog_span7"></span><a href="/uid-25046147-id-3048892.html" title='安装Oracle出现的故障以及解决方法' target='blank' >安装Oracle出现的故障以及解决...</a></li>
						  <li><span class="Blog_span7"></span><a href="/uid-20443214-id-1678473.html" title='mysql中连接字符串操作' target='blank' >mysql中连接字符串操作...</a></li>
			            </ul>
            <ul class="Blog_ul7">
						  <li><span class="Blog_span6"></span><a href="/uid-26364035-id-3588349.html" title='使用mysqltuner定位一个Aborted_connects问题' target='blank'  >使用mysqltuner定位一个Aborte...</a></li>
						  <li><span class="Blog_span6"></span><a href="/uid-26364035-id-3588524.html" title='从库延迟调查&导致延迟动作的定位' target='blank'  >从库延迟调查&导致延迟动作的...</a></li>
						  <li><span class="Blog_span6"></span><a href="/uid-26364035-id-3588551.html" title='MySQL数据目录磁盘满了，导致的错误 Errcode 28' target='blank'  >MySQL数据目录磁盘满了，导致...</a></li>
						  <li><span class="Blog_span6"></span><a href="/uid-26364035-id-3588540.html" title='MySQL一些常用安全的习惯' target='blank'  >MySQL一些常用安全的习惯...</a></li>
						  <li><span class="Blog_span6"></span><a href="/uid-26642180-id-3589689.html" title='PostgreSQL数据迁移案例：迁移整个Drupal站点与PostgreSQL数据库' target='blank'  >PostgreSQL数据迁移案例：迁移...</a></li>
			            </ul>
            <div class="clear"></div>
          </div>
		  <!--
          <div class="Blog_con3_4 Blog_con3_5">
            <div class="Blog_tit2 Blog_tit7">热门推荐</div>
            <ul>
			              <li><a href="" title="" target='blank' ></a></li>
			            </ul>
          </div>
		  -->
        </div>
      </div>
      <div class="Blog_right1_7" id='replyList'>
		<div class="Blog_tit3">给主人留下些什么吧！~~</div>
				<!--暂无内容-->
				<!-- 评论分页-->
		<div class="Blog_right1_6 Blog_right1_12">
        		</div>
		<!-- 评论分页-->
        <div class="Blog_right1_10">
          <div class="Blog_tit3">评论热议</div>
		  		 <!--未登录 -->
        <div class="Blog_right1_8">
          <div class="nologin_con1"> 请登录后评论。
            <p><a href="/site/login.html">登录</a> <a href="http://sso.chinaunix.net/Register?return_url=http%3A%2F%2Ft.cublog.com%2F">注册</a></p>
          </div>
        </div>
		
        </div>
      </div>
    </div>
  </div>
  <input type='hidden' id='report_url' value='/blog/ViewReport.html' />

<script type="text/javascript">
  	//测试字符串的长度 一个汉字算2个字节
	function mb_strlen(str)
	{
		var len=str.length;
		var totalCount=0;
		for(var i=0;i<len;i++)
		{
			var c = str.charCodeAt(i);
			if ((c >= 0x0001 && c <= 0x007e) || (0xff60<=c && c<=0xff9f)) {
				totalCount++;
			}else{
				totalCount+=2;
			}
		}
		return totalCount;
	}
	/*
	var Util = {};
	Util.calWbText = function (text, max){
		if(max === undefined)
			max = 500;
		var cLen=0;
		var matcher = text.match(/[^\x00-\xff]/g),
			wlen  = (matcher && matcher.length) || 0;
		//匹配url链接正则 http://***
		var pattern = /http:\/\/([\w-]+\.)+[\w-]+(\/*[\w-\.\/\?%&=][^\s^\u4e00-\u9fa5]*)?/gi;
		//匹配的数据存入数组
		var arrPt = new Array();
		var i = 0;
		while((result = pattern.exec(text)) != null){
			arrPt[i] = result[0];
			i++;
		}
		//替换掉原文本中的链接
		for(var j = 0;j<arrPt.length;j++){
			text = text.replace(arrPt[j],"");
		}
		//减掉链接所占的长度
		return Math.floor((max*2 - text.length - wlen)/2 - 12*i);
	};
	*/
	var allowComment = '0';
	
	//举报弹出层
	function showJuBao(url, cid){
		
			$.cover(false);
			asyncbox.open({
				id  : 'report_thickbox',
				url : url,
				title : '举报违规',
				width : 378,
				height : 240,
				scroll : 'no',
				data : {
					'cid'	 : cid,
					'idtype' : 2 
				},
				callback : function(action){
					if(action == 'close'){
						$.cover(false);
					}
				}
			});
	}

	$(function(){
		//顶  js中暂未添加&过滤 
		$('#digg').live('click' , function(){

			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html');
				return false;
			}

			var bid = $('#digg').attr('bid');
			var url = $('#digg').attr('url');

			var digg_str = $.cookie('digg_id');
			if(digg_str != null)
			{
				var arr= new Array(); //定义一数组

				arr = digg_str.split(","); //字符分割     
				for( i=0 ; i < arr.length ; i++ )   
				{   
					if(bid == arr[i])
					{
						showErrorMsg('已经赞过该文章', '消息提示'); 
						return false;
					}
				} 
			}
			$.ajax({
				type:"POST",
				url:url,	
				data: {
					'bid' : bid 
				},
				dataType: 'json',
				success:function(msg){
					if(msg.error == 0)
					{
						var num = parseInt($('#digg_num').html(),10);
						num += 1;
						$('#digg_num').html(num);
						$('#digg').die();

						if(digg_str == null)
						{
							$.cookie('digg_id', bid, {expires: 30 , path: '/'});
						}
						else
						{
							$.cookie('digg_id', digg_str + ',' + bid, {expires: 30 , path: '/'});
						}
						showSucceedMsg('谢谢' , '消息提示');
					}
					else if(msg.error == 1)
					{
						//showErrorMsg(msg.error_content , '消息提示'); 
						showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html');
					}
					else if(msg.error == 2)
					{
						showErrorMsg(msg.error_content , '消息提示'); 
					}
				}
			});
		});
		//举报弹出层
		/*$('.box_report').live('click' , function(){
			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html');
				return false;
			}
			var url = $('#report_url').val();
			var cid = $(this).attr('cid');
			$.cover(false);
			asyncbox.open({
				id  : 'report_thickbox',
				url : url,
				title : '举报违规',
				width : 378,
				height : 240,
				scroll : 'no',
				data : {
					'cid'	 : cid,
					'idtype' : 2 
				},
				callback : function(action){
					if(action == 'close'){
						$.cover(false);
					}
				}
			});
		});*/


		//评论相关代码
		
		//点击回复显示评论框
		$('.Blog_a10').live('click' , function(){
			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html');
				return false;
			}

			if(allowComment == 1)
			{
				showErrorMsg('该博文不允许评论' , '消息提示'); 
				return false;
			}
			var tid = $(this).attr('toid');//留言作者id
			var bid = $(this).attr('bid');//blogid
			var cid = $(this).attr('cid');//留言id
			var tname = $(this).attr('tname');
			var tpl  = '<div class="Blog_right1_9">';
				tpl +=	 '<div class="div2">';
				tpl +=     '<textarea name="" cols="" rows="" class="Blog_ar1_1" id="rmsg">文明上网，理性发言...</textarea>';
				tpl +=	 '</div>';
				tpl +=   '<div class="div3">';
				tpl +=		'<div class="div3_2"><a href="javascript:void(0);" class="Blog_a11" id="quota_sbumit" url="/Comment/PostComment.html" tid="'+tid+'" bid="'+bid+'" cid="'+cid+'" tname="'+tname+'" ></a><a href="javascript:void(0)" id="qx_comment" class="Blog_a12"></a></div>';
				tpl +=		'<div class="div3_1"><a href="javascript:void(0);" id="mface"><span></span>表情</a></div>';
				tpl +=		'<div class="clear"></div>';
				tpl +=	 '</div>';
				tpl +=  '</div>';
			$('.z_move_comment').html('');
			$(this).parents('.Blog_right1_8').find('.z_move_comment').html(tpl).show();
		});
		//引用的评论提交
		$('#quota_sbumit').live('click' , function(){

			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html');
				return false;
			}

			var bid   = $(this).attr('bid');
			var tid   = $(this).attr('tid');//被引用人的id
			var qid   = $(this).attr('cid');//引用的id
			var url = $(this).attr('url');
			var text = $('#rmsg').val();
			var tname = $(this).attr('tname');
			if(text == '' || text=='文明上网，理性发言...')
			{
				showErrorMsg('评论内容不能为空！' , '消息提示'); 
				return false;
			}
			else
			{
				if(mb_strlen(text) > 1000){
					showErrorMsg('评论内容不能超过500个汉字' , '消息提示'); 
					return false;
				}
			}
		    $.ajax({
		        type: "post",
			    url: url ,
			    data: {'bid': bid , 'to' : tid , 'qid' : qid , 'text': text , 'tname' : tname },
				dataType: 'json',
			    success: function(data){
				    if(data.code == 1){
						var tpl =  '<div class="Blog_right1_8">';
							tpl+=     '<div class="Blog_right_img1"><a href="' +data.info.url+ '" >' + data.info.header + '</a></div>';
							tpl+=     '<div class="Blog_right_font1">';
							tpl+=         '<p class="Blog_p5"><span><a href="' +data.info.url+ '" >' + data.info.username + '</a></span>' + data.info.dateline + '</p>';
							tpl+=         '<p class="Blog_p7"><a href="' + data.info.quota.url + '">' + data.info.quota.username + '</a>：'+ data.info.quota.content + '</p>';
							tpl+=         '<p class="Blog_p8">' + data.info.content + '</p><span class="span_text1"><a href="javascript:void(0);" class="Blog_a10" toid=' + data.info.fuid + ' bid=' + data.info.bid + ' cid=' + data.info.cid + '  tname = ' + data.info.username + ' >回复</a> | 　<a href="' + data.info.delurl + '" >删除</a>　| 　<a href="javascript:showJuBao(\'/blog/ViewReport.html\','+data.info.cid+')" class="box_report" cid="' + data.info.cid + '" >举报</a></span></div>';
							tpl+=         '<div class="z_move_comment" style="display:none"></div>';
							tpl+=	      '<div class="Blog_line1"></div></div>';
							$('#replyList .Blog_right1_8:first').before(tpl);
							$('.z_move_comment').html('').hide();
				    }
					else if(data.code == -1){
						//showErrorMsg(data.info , '消息提示'); 
						showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html');
			        }
                },
			    error: function(){//请求出错处理
                        
                }
			});
		});
		//底部发表评论
		$('#submitmsg').click(function(){
			if(allowComment == 1)
			{
				showErrorMsg('该博文不允许评论' , '消息提示'); 
				return false;
			}
			var bid   = $(this).attr('bid');
			var toid  = $(this).attr('toid');
			var text = $('#reply').val();
			var url = $(this).attr('url');
			if(text == '' || text=='文明上网，理性发言...')
			{
				showErrorMsg('评论内容不能为空！' , '消息提示'); 
				return false;
			}
			else
			{
				if(mb_strlen(text) > 1000){
					showErrorMsg('评论内容不能超过500个汉字' , '消息提示'); 
					return false;
				}
			}
		    $.ajax({
		        type: "post",
			    url: url ,
			    data: {'bid': bid , 'to' : toid ,'text': text},
				dataType: 'json',
			    success: function(data){
				    if(data.code == 1)
					{
						var tpl   = '<div class="Blog_right1_8">';
							tpl  +=   '<div class="Blog_right_img1"><a href="' +data.info.url+ '" >' + data.info.header + '</a></div>';
							tpl  +=	  '<div class="Blog_right_font1">';
							tpl  +=       '<p class="Blog_p5"><span><a href="' +data.info.url+ '" >' + data.info.username + '</a></span>' + data.info.dateline + '</p>';
							tpl  +=       '<p class="Blog_p6">' + data.info.content + '</p>';
							tpl  +=		  '<div class="div1"><a href="javascript:void(0);" class="Blog_a10"  toid=' + data.info.fuid + ' bid=' + data.info.bid + ' cid=' + data.info.cid + '>回复</a> | 　<a href="' + data.info.delurl + '">删除</a>　| 　<a href="javascript:showJuBao(\'/blog/ViewReport.html\','+data.info.cid+')" class="box_report" cid="' + data.info.cid + '">举报</a></div>';
							tpl  +=		  '<div class="z_move_comment" style="display:none"></div>';
							tpl  +=    '</div><div class="Blog_line1"></div></div>';
							$('.Blog_tit3:first').after(tpl);
							$('#reply').val('文明上网，理性发言...');
					}
					else if(data.code == -1)
					{
						showErrorMsg(data.info , '消息提示'); 
			        }
                },
			    error: function(){//请求出错处理
                        
                }
		    });
			
		});
		//底部评论重置
		$('#reset_comment').click(function(){
			$('#reply').val('文明上网，理性发言...');
		});
		//取消回复
		$('#qx_comment').live('click' , function(){
			$('.z_move_comment').html('').hide();
		});


		$('#rmsg, #reply').live({
		    focus:function(){
			    if($(this).val() == '文明上网，理性发言...'){
			        $(this).val('');
			    }
			},
			blur:function(){
		        if($(this).val() == ''){
			        $(this).val('文明上网，理性发言...');
			    }
			}
		});
		/*
		//字数限制
		$('#rmsg, #reply').live('keyup', function(){
			var id = $(this).attr('id');
			var left = Util.calWbText($(this).val(), 500);
			var eid = '#errmsg';
			
			if(id == 'reply') eid =  '#rerrmsg';
			if (left >= 0)
		        $(eid).html('您还可以输入<span>' + left + '</span>字');
		    else
		        $(eid).html('<font color="red">您已超出<span>' + Math.abs(left) + '</span>字 </font>');
		});
		*/
		//加载表情
	    $('#face').qqFace({id : 'facebox1', assign : 'reply', path : '/image/qqface/'});
	    $('#mface').qqFace({id : 'facebox', assign : 'rmsg', path:'/image/qqface/'});
	    
	    //转发文章
	    $('#repost_bar').live('click' , function(){
			if(isOnLine == '' )
			{
				//showErrorMsg('登录之后才能进行此操作' , '消息提示');
				showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html');
				return false;
			}
	    	var bid  = $(this).attr('bid');
	    	var url  = $(this).attr('url');
	    	asyncbox.confirm('转发文章','确认', function(action){
	    	  if(action == 'ok'){
	    	    $.ajax({
				type:"POST",
				url:url,	
				data: {
					'bid' : bid 
				},
				dataType: 'json',
				success:function(msg){
				  if(msg.error == 0){
				    showSucceedMsg('转发成功！', '消息提示');
				  }else if(msg.error == 1){
				    //location.href = '/index.php?r=site/login';
					showErrorMsg('操作失败,您需要先登录!', '消息提示', '/site/login.html');
				  }else{
				    showErrorMsg(msg.error_content, '消息提示');
			      }
				}
			  });
	    	  }
	    	});

		});

	});
</script>
<!--该部分应该放在输出代码块的后面才起作用 -->
<script type="text/javascript">

SyntaxHighlighter.autoloader(
	'applescript			/highlight/scripts/shBrushAppleScript.js',
	'actionscript3 as3		/highlight/scripts/shBrushAS3.js',
	'bash shell				/highlight/scripts/shBrushBash.js',
	'coldfusion cf			/highlight/scripts/shBrushColdFusion.js',
	'cpp c					/highlight/scripts/shBrushCpp.js',
	'c# c-sharp csharp		/highlight/scripts/shBrushCSharp.js',
	'css					/highlight/scripts/shBrushCss.js',
	'delphi pascal			/highlight/scripts/shBrushDelphi.js',
	'diff patch pas			/highlight/scripts/shBrushDiff.js',
	'erl erlang				/highlight/scripts/shBrushErlang.js',
	'groovy					/highlight/scripts/shBrushGroovy.js',
	'java					/highlight/scripts/shBrushJava.js',
	'jfx javafx				/highlight/scripts/shBrushJavaFX.js',
	'js jscript javascript	/highlight/scripts/shBrushJScript.js',
	'perl pl				/highlight/scripts/shBrushPerl.js',
	'php					/highlight/scripts/shBrushPhp.js',
	'text plain				/highlight/scripts/shBrushPlain.js',
	'py python				/highlight/scripts/shBrushPython.js',
	'ruby rails ror rb		/highlight/scripts/shBrushRuby.js',
	'scala					/highlight/scripts/shBrushScala.js',
	'sql					/highlight/scripts/shBrushSql.js',
	'vb vbnet				/highlight/scripts/shBrushVb.js',
	'xml xhtml xslt html	/highlight/scripts/shBrushXml.js'
);
SyntaxHighlighter.all();


function code_hide(id){
	var code = document.getElementById(id).style.display;
	if(code == 'none'){
		document.getElementById(id).style.display = 'block';
	}else{
		document.getElementById(id).style.display = 'none';
	}
}
</script>
  <!-- footer -->
  <div class="Blog_footer" style='clear:both'>
    <div><a href="http://www.chinaunix.net/about/index.shtml" target="_blank" rel="nofollow">关于我们</a> | <a href="http://www.it168.com/bottomfile/it168.shtml" target="_blank" rel="nofollow">关于IT168</a> | <a href="http://www.chinaunix.net/about/connect.html" target="_blank" rel="nofollow">联系方式</a> | <a href="http://www.chinaunix.net/about/service.html" target="_blank" rel="nofollow">广告合作</a> | <a href="http://www.it168.com//bottomfile/flgw/fl.htm" target="_blank" rel="nofollow">法律声明</a> | <a href="http://sso.chinaunix.net/Register?return_url=http%3A%2F%2Fblog.chinaunix.net%2F
" target="_blank" rel="nofollow">免费注册</a>
      <p>Copyright  2001-2010 ChinaUnix.net All Rights Reserved 北京皓辰网域网络信息技术有限公司. 版权所有 </p>
      <div>感谢所有关心和支持过ChinaUnix的朋友们
        <p>京ICP证041476号 京ICP证060528号</p>
      </div>
    </div>
  </div>
</div>
<script language="javascript">

//全局错误提示弹出框
function showErrorMsg(content, title, url){
	var url = url || '';
	var title = title || '消息提示';
	var html = '';
	html += '<div class="HT_layer3_1 HT_layer3_2"><ul><li><p><span class="login_span1"></span>' + content + '</p></li>';
	if(url == '' || url.length == 0){
		html += '<li class="HT_li1"><input type="button" class="HT_btn2"  onclick=\'close_windows("error_msg")\'></li>';	
	} else {
		html += '<li class="HT_li1"><input type="button" class="login_btn1" onclick="location.href=\'' + url + '\'"></li>';
	}
	html += '</ul></div>';
	$.cover(true);
	   asyncbox.open({
		 id: 'error_msg',
		 title : title,
		 html : html,
		 'callback' : function(action){
			 if(action == 'close'){
				 $.cover(false);
			 }
		 }
	});
}

//全局正确提示
function showSucceedMsg(content, title , url ){
	var url = url || '';
	var title = title || '消息提示';
	var html = '';
	html += '<div class="HT_layer3_1 HT_layer3_2"><ul><li><p><span class="login_span2"></span>' + content + '</p></li>';
	if(url == '' || url.length == 0){
		html += '<li class="HT_li1"><input type="button" class="HT_btn2"  onclick=\'close_windows("error_msg")\'></li>';	
	} else {
		html += '<li class="HT_li1"><input type="button" class="login_btn1" onclick="location.href=\'' + url + '\'"></li>';
	}
	html += '</ul></div>';
	$.cover(true);
	asyncbox.open({
		 id: 'error_msg',
		 title : title,
		 html : html,
		 'callback' : function(action){
			 if(action == 'close'){
				 $.cover(false);
			 }
		 }
	});
}

//关闭指定id的窗口
function close_windows(id){
	$.cover(false);
	$.close(id);
}


//公告
var tID;
var tn;                        // 高度
var nStopTime = 5000;        // 不同行间滚动时间隔的时间，值越小，移动越快
var nSpeed = 50;            // 滚动时，向上移动一像素间隔的时间，值越小，移动越快
var isMove = true;
var nHeight = 25;
var nS = 0;
var nNewsCount = 3;

/**
 * n 用于表示是否为第一次运行
 **/
function moveT(n)
{
    clearTimeout(tID)
    var noticev2 = document.getElementById("noticev2")
    nS = nSpeed;
    
    // 只在第一次调用时运行，初始化环境（有没有参数）
    if (n)
    {
        // 设置行高
        noticev2.style.lineHeight = nHeight + "px";
        // 初始化显示位置
        tn = 0;
        // 刚进入时在第一行停止时间
        nS = nStopTime;
    }
    
    // 判断鼠标是否指向层
    if (isMove)
    {
        // 向上移动一像素
        tn--;
        // 如果移动到最下面一行了，则移到顶行
        if (Math.abs(tn) == nNewsCount * nHeight)
        {
            tn = 0;
        }
        // 设置位置
        noticev2.style.marginTop = tn + "px";
        // 完整显示一行时，停止一段时间
        if (tn % nHeight == 0)
        {
            nS = nStopTime;
        }
    }

    tID = setTimeout("moveT()", nS);
}
moveT(1);    // 此处可以传入任何参数
</script>
<script language="javascript" src="http://stat.it168.com/pv.js"></script>
<script>
function sendPV(){
    var pvTrack = new PvTrack();
    pvTrack.type = 35; // 频道类别ID
    pvTrack.channel = 189; // 频道ID
    pvTrack.pageType = 0;
    pvTrack.track();
}
window.setTimeout("sendPV()", 1000);
</script>
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-20237423-2']);
  _gaq.push(['_setDomainName', '.chinaunix.net']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>
<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F0ee5e8cdc4d43389b3d1bfd76e83216b' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript" src="/js/jquery.qqFace.js"></script>
</body>
</html>
