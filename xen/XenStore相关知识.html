<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>XenStore相关知识（转） - 憩园幽幽的专栏 - 博客频道 - CSDN.NET</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="XenStore是一个类似于数据库的文件系统, 包含了domain间的共享信息. 有domain配置和状态信息.XenStore提供了一种发现设备信息的简便方法. 它作为数据库在 /var/lib/xenstore/tdb, 在用户空间的 daemon 称为xenstored.这个逻辑文件树有三个主要的路径:/vm - /vm/uuid 存储配置信息,例如虚拟CPU数和" />
<script src="http://static.blog.csdn.net/scripts/jquery.js" type="text/javascript"></script>
<script type="text/javascript" src="http://static.blog.csdn.net/scripts/ad.js?v=1.1"></script>
<link rel="Stylesheet" type="text/css" href="http://static.blog.csdn.net/skin/default/css/style.css?v=1.1" />
<link id="RSSLink" title="RSS" type="application/rss+xml" rel="alternate" href="/zhengtingt108/rss/list" />
<link rel="shortcut icon" href="/favicon.ico" />
<link type="text/css" rel="stylesheet" href="http://static.blog.csdn.net/scripts/SyntaxHighlighter/styles/default.css" />
</head>
<body>
<script src="http://csdnimg.cn/pubnav/js/pub_topnav_2011.js?v=1.1" type="text/javascript"></script>
<div id="container">
<div id="header">
    <div class="header">
        <div id="blog_title">
            <h1><a href="/zhengtingt108">憩园幽幽的专栏</a></h1>
            <h2></h2>
            <div class="clear"></div>
        </div>
        <div class="clear"></div>
    </div>
</div>
<div id="navigator">
    <div class="navigator_bg"></div>
    <div class="navigator">
        <ul>
            <li id="btnContents"><a href="/zhengtingt108?viewmode=contents"><span><img src="http://static.blog.csdn.net/images/ico_list.gif">目录视图</span></a></li>
            <li id="btnView"><a href="/zhengtingt108?viewmode=list"><span><img src="http://static.blog.csdn.net/images/ico_summary.gif">摘要视图</span></a></li>
            <li id="btnRss"><a href="/zhengtingt108/rss/list"><span><img src="http://static.blog.csdn.net/images/ico_rss.gif">订阅</span></a></li>
</ul>
    </div>
</div>
<script type="text/javascript">
    var username = "zhengtingt108";
    var blog_address = "http://blog.csdn.net/zhengtingt108";
    var static_host = "http://static.blog.csdn.net";
    var currentUserName = "";
</script>
        
<div id="body">
<div id="main">
<div class="main">
<div class="notice"> 

<a href="http://blog.csdn.net/blogdevteam/article/details/8687376
" target="_blank">
<font color=blue>2013年7月微软MVP申请开始啦！ 
   </font></a>



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://blog.csdn.net/blogdevteam/article/details/8664620" target="_blank"><font color=blue>CSDN博客移动开发排行榜 
</font></a>

&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://blog.csdn.net/blogdevteam/article/details/8699892" target="_blank"><font color=blue>参与活动送签名技术书籍 


</font></a>

<br />





<a href="http://bbs.csdn.net/topics/390397409
"target="_blank">
<font color=red>【有奖提问】CSDN论坛第1期专家问答开始


 </font></a>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://blog.csdn.net/blogdevteam/article/details/8717564"target="_blank">
<font color=red>来极客头条，赢下载积分
 </font></a>



&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;

<a href="http://bbs.csdn.net/topics/390393217"target="_blank">
<font color=red>下载频道3月领任务~赚下载分！ 
  </font></a>


</div><div id="article_details" class="details">
    <div class="article_title">
    <span class="ico ico_type_Repost"></span>
    <h3>
        <span class="link_title"><a href="/zhengtingt108/article/details/5409820">
        XenStore相关知识（转）
        </a></span>
    </h3>
</div>

        
    <div class="article_manage">
        <span class="link_categories">
        分类：
            <a href="/zhengtingt108/article/category/584362">XEN</a> 
        </span>
    <span class="link_postdate">2010-03-23 22:00</span>
    <span class="link_view" title="阅读次数">1575人阅读</span>
    <span class="link_comments" title="评论次数"><a href="#comments">评论</a>(1)</span>
    <span class="link_collect"><a href="javascript:void(0);" onclick="javascript:collectArticle('XenStore相关知识（转）','5409820');return false;" title="收藏">收藏</a></span>
    <span class="link_report"><a href="#report"  onclick="javascript:report(5409820,2);return false;" title="举报">举报</a></span>
    
</div>
<div class="tag2box"><a href='http://blog.csdn.net/tag/details.html?tag=domain' target=_blank>domain</a><a href='http://blog.csdn.net/tag/details.html?tag=path' target=_blank>path</a><a href='http://blog.csdn.net/tag/details.html?tag=null' target=_blank>null</a><a href='http://blog.csdn.net/tag/details.html?tag=xen' target=_blank>xen</a><a href='http://blog.csdn.net/tag/details.html?tag=%e6%95%b0%e6%8d%ae%e5%ba%93' target=_blank>数据库</a><a href='http://blog.csdn.net/tag/details.html?tag=socket' target=_blank>socket</a></div>


    
<div id="article_content" class="article_content">
<p><span style="font-size: small;"><span style="font-family: Arial;">XenStore
是一个类似于数据库的文件系统, 包含了domain间的共享信息. 有domain配置和状态信息.XenStore
提供了一种发现设备信息的简便方法. 它作为数据库在 /var/lib/xenstore/tdb, 在用户空间的 daemon 称为
&quot;xenstored&quot;.这个逻辑文件树有三个主要的路径:</span>
</span>
</p>
<p><span style="font-size: small;"><span style="font-family: Arial;">/vm - /vm/uuid 存储配置信息,例如虚拟CPU数和内存分配数.</span>
</span>
</p>
<p><span style="font-size: small;">/local/domain - 包含了正在运行的domain信息, 由domid标识.</span>
</p>
<p><span style="font-size: small;">/tool - 存储多种工具信息.</span>
</p>
<p><span style="font-family: Arial;">应用程序向这个数据库的 key 写信息, 配置驱动; 驱动在key上设置watch并对改变做出回应.</span>
</p>
<p><span style="font-size: small;">详细介绍请参考:<a href="http://wiki.xensource.com/xenwiki/XenStoreReference"> http://wiki.xensource.com/xenwiki/XenStoreReference</a>
</span>

</p>
<h3><span style="font-size: small;"><span style="font-family: Arial;">访问xenstore</span>
</span>

</h3>
<p><span style="font-size: small;"><span style="font-family: Arial;">在guest
kernel启动时xenstore经过start_info页而被访问到, 作为共享页的机器页帧号和event
channel使用.Dom0工具使用UNIX domain socket /var/run/xenstored/socket 或
/var/run/xenstoed/socket_ro; Dom0工具使用proce接口/proc/xen/xenbus,
内核代码使用xenbus API.</span>
</span>
</p>
<h3><span style="font-size: small;">命令</span>
</h3>
<div><span style="font-size: small;"><span style="font-family: Arial;">xenstore-read, xenstore-exists, xenstore-list, xenstor-, xsls, 用于和xenstored daemon数据库通信.
</span>
</span>
</div>
<div> <span style="font-size: small;"><span style="font-family: Arial;">e.g. - #xenstore-list /local/domain/0
</span>
</span>
</div>
<h3><span style="font-size: small;"><span style="font-family: Arial;"><strong>Domain 标识</strong>
<br />
</span>
</span>
</h3>
<p><span style="font-size: small;"><span style="font-family: Arial;">1) </span>
通用唯一标识符(UUID)是标识domain的数字, 即使guest<span class="dct-tt">迁移也保持相同.</span>
</span>
</p>
<p><span style="font-size: small;"><span style="font-family: Arial;">2) domain 标识(DOMID) 标识一个正在运行的实例, 当guest</span>
<span class="dct-tt">迁移到另一台机器后DOMID改变.</span>
</span>
</p>
<h3><span style="font-size: small;"><strong><span style="font-family: Arial;">什么是Xenbus<br />

</span>
</strong>
</span>
</h3>
<div><span style="font-size: small;"><span style="font-family: Arial;">Xenbus是Xenstore的一个接口, 它也是在Xenstore之上写的设备驱动的连接协议.</span>
Xenbus是一个虚拟设备的mgmt bus. Xen PV &quot;backend&quot; 设备出现在xenbus上, 而且能被DomU使用PV
&quot;fronted&quot;设备驱动访问到. 这些虚拟后端设备的状态由xenbus管理. 这些状态被存储到xenstore,
并且一直被Dom0和DomU的xenbus驱动程序监测.XenStore 指供了一个domain如何将前端设备与后端提供的服务联系起来的方法,
(实际这部分是由XenBus<span class="dct-tt">承载的,</span>
一种建立在XenStore顶层的协议). 后端与前端通信使用共享event channel 和 ring buffer通信.</span>
<span style="font-size: small;">所有规范的xen虚拟设备驱动在初始化时向XenBus注册自己. 这是通过传递xenbus_driver 结构体给 </span>
</div>
<div><span style="font-size: small;">xenbus_register_devide()函数.<br />
</span>
</div>
<h3><span style="font-size: small;">代码</span>
</h3>
<p align="left"><span style="font-size: small;">以下代码创建两个可执行的, xenstore-read 和 xenstore-write 程序.</span>
</p>
<p align="left"><span style="font-size: small;">在一个Dom中运行xenstore-read - 从 /loca/doman/X/memory/target 读取Domx的memory/target值.依赖于你运行这个程序所在的Dom.</span>
</p>
<p align="left"><span style="font-size: small;">在一个Dom中运行xenstore-wirte - 写一个memory/target值到这个程序所运行的Dom.</span>
</p>
<p align="left"><span style="font-size: small;">
<div class="dp-highlighter">
<div class="bar">
<div class="tools"><a onclick="dp.sh.Toolbar.Command('ViewSource',this);return false;" href="http://blog.csdn.net/zouzhongyu/archive/2010/02/02/5279697.aspx">view plain</a>
<a onclick="dp.sh.Toolbar.Command('CopyToClipboard',this);return false;" href="http://blog.csdn.net/zouzhongyu/archive/2010/02/02/5279697.aspx">copy to clipboard</a>
<a onclick="dp.sh.Toolbar.Command('PrintSource',this);return false;" href="http://blog.csdn.net/zouzhongyu/archive/2010/02/02/5279697.aspx">print</a>
<a onclick="dp.sh.Toolbar.Command('About',this);return false;" href="http://blog.csdn.net/zouzhongyu/archive/2010/02/02/5279697.aspx">?</a>
</div>
</div>
<ol class="dp-cpp">
<li class="alt"><span><span class="comment">//&nbsp;Example&nbsp;taken&nbsp;from&nbsp;wiki.xensource.com/xenwiki/XenStoreReference&nbsp;and&nbsp;some&nbsp;code&nbsp;added</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="comment">//</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="comment">//&nbsp;Compiled&nbsp;using</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gcc&nbsp;-g&nbsp;xenstore.c&nbsp;-DREAD=1&nbsp;-lxenstore&nbsp;-o&nbsp;xenstore-read</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gcc&nbsp;-g&nbsp;xenstore.c&nbsp;-DWRITE=1&nbsp;-lxenstore&nbsp;-o&nbsp;xenstore-write</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="comment">//</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="comment">//&nbsp;To&nbsp;change&nbsp;permissions&nbsp;on&nbsp;/local/domain/0,&nbsp;use</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="comment">//&nbsp;xenstore-chod&nbsp;-r&nbsp;/local/domain/0&nbsp;b&nbsp;&nbsp;-&nbsp;for&nbsp;r&nbsp;and&nbsp;w</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="comment">//&nbsp;xenstore-chod&nbsp;-r&nbsp;/local/domain/0&nbsp;w&nbsp;&nbsp;-&nbsp;for&nbsp;w</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="comment">//</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="preprocessor">#include&nbsp;&lt;sys/types.h&gt;</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="preprocessor">#include&nbsp;&lt;xs.h&gt;</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="preprocessor">#include&nbsp;&lt;stdio.h&gt;</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="preprocessor">#include&nbsp;&lt;string.h&gt;</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="preprocessor">#include&nbsp;&lt;malloc.h&gt;</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="preprocessor">#include&nbsp;&lt;sys/stat.h&gt;&nbsp;//&nbsp;for&nbsp;lstat()</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="preprocessor">#include&nbsp;&lt;stdlib.h&gt;&nbsp;//&nbsp;for&nbsp;exit()</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="preprocessor">#define&nbsp;DOM0&nbsp;0</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="preprocessor">#define&nbsp;DOMU&nbsp;1</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="datatypes">int</span>
<span>&nbsp;dom&nbsp;=&nbsp;999;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="comment">//&nbsp;This&nbsp;function&nbsp;checks&nbsp;if&nbsp;the&nbsp;app&nbsp;is&nbsp;in&nbsp;domU&nbsp;or&nbsp;dom0.&nbsp;The&nbsp;/proc/xen/capabilities</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="comment">//&nbsp;contains&nbsp;the&nbsp;string&nbsp;&quot;control_d&quot;&nbsp;if&nbsp;the&nbsp;app&nbsp;is&nbsp;in&nbsp;a&nbsp;dom0</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="comment">//</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span><span class="comment">//&nbsp;/sys/hypervisor/type&nbsp;can&nbsp;be&nbsp;checked&nbsp;too,&nbsp;to&nbsp;see&nbsp;if&nbsp;we&nbsp;are&nbsp;running&nbsp;on&nbsp;a&nbsp;xen</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="comment">//&nbsp;hyervisor</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>check_dom()&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>{&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">FILE</span>
<span>&nbsp;*file&nbsp;=&nbsp;NULL;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">char</span>
<span>&nbsp;*filePath;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">struct</span>
<span>&nbsp;stat&nbsp;linkAttrs;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">char</span>
<span>&nbsp;buf[100]&nbsp;=&nbsp;</span>
<span class="string">&quot;&quot;</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;filePath&nbsp;=&nbsp;<span class="string">&quot;/proc/xen/capabilities&quot;</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;((lstat(filePath,&nbsp;&amp;linkAttrs))&nbsp;!=&nbsp;0)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perror(<span class="string">&quot;lstat&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;((file&nbsp;=&nbsp;fopen(</span>
<span class="string">&quot;/proc/xen/capabilities&quot;</span>
<span>,&nbsp;</span>
<span class="string">&quot;r&quot;</span>
<span>))&nbsp;==&nbsp;NULL)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;perror(<span class="string">&quot;fopen&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(!fgets(buf,&nbsp;</span>
<span class="keyword">sizeof</span>
<span>(buf),&nbsp;file))&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;we&nbsp;are&nbsp;in&nbsp;DomU,&nbsp;since&nbsp;the&nbsp;buffer&nbsp;is&nbsp;empty</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Surely&nbsp;in&nbsp;DOMU,&nbsp;since&nbsp;capabilities&nbsp;is&nbsp;empty&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dom&nbsp;=&nbsp;DOMU;&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">else</span>
<span>&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;we&nbsp;are&nbsp;probably&nbsp;in&nbsp;Dom0</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Probably&nbsp;in&nbsp;DOM0,&nbsp;since&nbsp;capabilities&nbsp;has&nbsp;some&nbsp;data&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dom&nbsp;=&nbsp;DOM0;&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;the&nbsp;following&nbsp;is&nbsp;in&nbsp;case&nbsp;they&nbsp;change&nbsp;the&nbsp;capabilities&nbsp;to&nbsp;have&nbsp;some</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;data&nbsp;in&nbsp;a&nbsp;DomU</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;((strstr(buf,&nbsp;</span>
<span class="string">&quot;control_d&quot;</span>
<span>))&nbsp;==&nbsp;NULL)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;we&nbsp;are&nbsp;in&nbsp;DomU</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;We&nbsp;are&nbsp;in&nbsp;DOMU&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dom&nbsp;=&nbsp;DOMU;&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">else</span>
<span>&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;we&nbsp;are&nbsp;in&nbsp;Dom0</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;We&nbsp;are&nbsp;in&nbsp;DOM0&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dom&nbsp;=&nbsp;DOM0;&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>}&nbsp;&nbsp;</span>
</li>
<li><span><span class="comment">//&nbsp;xs_write&nbsp;is&nbsp;written&nbsp;outside&nbsp;a&nbsp;transaction.&nbsp;Else&nbsp;it&nbsp;does&nbsp;not&nbsp;work&nbsp;for&nbsp;me.&nbsp;Pass</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="comment">//&nbsp;a&nbsp;XBT_NULL&nbsp;as&nbsp;a&nbsp;2nd&nbsp;param&nbsp;to&nbsp;xs_write().</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>write_to_xenstore&nbsp;(<span class="keyword">struct</span>
<span>&nbsp;xs_handle&nbsp;*xs,&nbsp;</span>
<span class="datatypes">char</span>
<span>*&nbsp;path)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">char</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;somedata[8]&nbsp;=&nbsp;{</span>
<span class="string">&quot;2200000&quot;</span>
<span>};&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;xs_transaction_t&nbsp;&nbsp;&nbsp;&nbsp;trans;&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">bool</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/nWriting&nbsp;data&nbsp;%s&nbsp;of&nbsp;len&nbsp;%d&nbsp;to&nbsp;%s&quot;</span>
<span>,&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;somedata,&nbsp;strlen(somedata),&nbsp;path);&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;xs_write()&nbsp;-&gt;&nbsp;xs_talkv()</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;-&gt;&nbsp;xs_write_all()&nbsp;-&gt;&nbsp;write()&nbsp;-&nbsp;sys_write()</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;&nbsp;&nbsp;&nbsp;-&gt;&nbsp;xs_read_reply()</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;xs_write(xs,&nbsp;XBT_NULL,&nbsp;path,&nbsp;&amp;somedata[0],&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strlen(somedata));&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(!err)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Could'nt&nbsp;write&nbsp;var&nbsp;in&nbsp;xenstore&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;xs_daemon_close(xs);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;free(path);&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;exit(0);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>}&nbsp;&nbsp;</span>
</li>
<li><span><span class="datatypes">int</span>
<span>&nbsp;main(</span>
<span class="datatypes">int</span>
<span>&nbsp;argc,&nbsp;</span>
<span class="datatypes">char</span>
<span>&nbsp;*argv[])&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">struct</span>
<span>&nbsp;xs_handle&nbsp;&nbsp;&nbsp;&nbsp;*xs;&nbsp;&nbsp;&nbsp;&nbsp;</span>
<span class="comment">//&nbsp;handle&nbsp;to&nbsp;xenstore</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;xs_transaction_t&nbsp;&nbsp;&nbsp;&nbsp;trans;&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">char</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*path;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">int</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;fd_set&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;set;&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">bool</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;err;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">struct</span>
<span>&nbsp;timeval&nbsp;tv&nbsp;=&nbsp;{.tv_sec&nbsp;=&nbsp;0,&nbsp;.tv_usec&nbsp;=&nbsp;0};&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">char</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**vec;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;<span class="datatypes">int</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;num;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">char</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*buf;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="datatypes">char</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;**buf2;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;<span class="datatypes">int</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len,&nbsp;i;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;<span class="datatypes">int</span>
<span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;domid;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;check&nbsp;if&nbsp;we&nbsp;are&nbsp;in&nbsp;Dom0&nbsp;or&nbsp;DomU</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;check_dom();&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Connect&nbsp;to&nbsp;XenStore.&nbsp;From&nbsp;Dom0&nbsp;we&nbsp;call&nbsp;xs_daemon_open,</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;and&nbsp;from&nbsp;DomU,&nbsp;we&nbsp;call&nbsp;xs_domain_open().&nbsp;</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;xs_daemon_open()&nbsp;-&gt;&nbsp;get_handle(xs_daemon_socket()).</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;xs_daemon_socket()-&gt;xs_daemon_path()&nbsp;which&nbsp;returns</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;XENSTORED_PATH/socket.&nbsp;A&nbsp;get_handle()&nbsp;on&nbsp;the&nbsp;above&nbsp;path&nbsp;generates</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;a&nbsp;socket&nbsp;(PF_UNIX,&nbsp;SOCK_STREAM,&nbsp;0)&nbsp;and&nbsp;connects&nbsp;to&nbsp;above&nbsp;socket.</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;For&nbsp;domU,&nbsp;connect&nbsp;to&nbsp;XenStore&nbsp;via&nbsp;xs_domain_open().</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;xs_domain_dev()&nbsp;returns&nbsp;path&nbsp;to&nbsp;/proc/xen/xenbus,&nbsp;and&nbsp;a</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;get_handle()&nbsp;on&nbsp;this&nbsp;returns&nbsp;a&nbsp;'fd'&nbsp;to&nbsp;this&nbsp;file.</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(dom&nbsp;==&nbsp;DOMU)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xs&nbsp;=&nbsp;xs_domain_open();&nbsp;<span class="comment">//&nbsp;DomU</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(xs&nbsp;==&nbsp;NULL)&nbsp;error();&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf&nbsp;=&nbsp;xs_read(xs,&nbsp;XBT_NULL,&nbsp;<span class="string">&quot;domid&quot;</span>
<span>,&nbsp;&amp;len);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(!buf)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Could&nbsp;not&nbsp;read&nbsp;domid&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;domid&nbsp;=&nbsp;atoi(buf);&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Retrieved&nbsp;Dom&nbsp;ID&nbsp;=&nbsp;%d/n&quot;</span>
<span>,&nbsp;domid);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">else</span>
<span>&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xs&nbsp;=&nbsp;xs_daemon_open();&nbsp;&nbsp;<span class="comment">//&nbsp;Dom0</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(xs&nbsp;==&nbsp;NULL)&nbsp;error();&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trans&nbsp;=&nbsp;xs_transaction_start(xs);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(trans&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Could&nbsp;not&nbsp;start&nbsp;xaction&nbsp;with&nbsp;XS&quot;</span>
<span>);&nbsp;</span>
<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;contents&nbsp;of&nbsp;a&nbsp;directory.&nbsp;Need&nbsp;to&nbsp;call&nbsp;free&nbsp;after&nbsp;use,</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;since&nbsp;the&nbsp;API&nbsp;mallocs&nbsp;memory</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf2&nbsp;=&nbsp;xs_directory(xs,&nbsp;trans,&nbsp;<span class="string">&quot;/local/domain&quot;</span>
<span>,&nbsp;&amp;len);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(!buf2)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Could&nbsp;not&nbsp;read&nbsp;XS&nbsp;dir&nbsp;/local/domain&quot;</span>
<span>);&nbsp;</span>
<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xs_transaction_end(xs,&nbsp;trans,&nbsp;<span class="keyword">true</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(trans&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Could&nbsp;not&nbsp;end&nbsp;xaction&nbsp;with&nbsp;XS&quot;</span>
<span>);&nbsp;</span>
<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Len&nbsp;of&nbsp;Dir&nbsp;/local/domain&nbsp;is&nbsp;%d&quot;</span>
<span>,&nbsp;len);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Dir&nbsp;Contents:&nbsp;&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>
<span>&nbsp;(i=0;&nbsp;i&lt;len;i++)&nbsp;{&nbsp;printf(</span>
<span class="string">&quot;%s&nbsp;&quot;</span>
<span>,&nbsp;buf2[i]);&nbsp;}&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(len&nbsp;==&nbsp;1)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;we&nbsp;have&nbsp;only&nbsp;1&nbsp;Dom&nbsp;running,&nbsp;i.e.&nbsp;Dom0</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;domid&nbsp;=&nbsp;atoi(buf2[0]);&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">else</span>
<span>&nbsp;</span>
<span class="keyword">if</span>
<span>&nbsp;(len&nbsp;==&nbsp;2)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;domid&nbsp;=&nbsp;atoi(buf2[1]);&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Set&nbsp;domid&nbsp;to&nbsp;0,&nbsp;since&nbsp;Dom0&nbsp;is&nbsp;always&nbsp;id&nbsp;0</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;domid&nbsp;=&nbsp;0;&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Setting&nbsp;Dom&nbsp;ID&nbsp;=&nbsp;%d/n&quot;</span>
<span>,&nbsp;domid);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Get&nbsp;the&nbsp;local&nbsp;Domain&nbsp;path&nbsp;in&nbsp;xenstore</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;xs_get_domain_path(xs,&nbsp;domid);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(path&nbsp;==&nbsp;NULL)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Dom&nbsp;Path&nbsp;in&nbsp;Xenstore&nbsp;not&nbsp;found&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error();&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;xs_directory&nbsp;has&nbsp;an&nbsp;implicit&nbsp;root&nbsp;at&nbsp;/local/domain/&lt;domid&gt;&nbsp;in&nbsp;DomU</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;and&nbsp;thus&nbsp;need&nbsp;to&nbsp;just&nbsp;pass&nbsp;&quot;memory/target&quot;&nbsp;if&nbsp;we&nbsp;are&nbsp;running&nbsp;this</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;from&nbsp;a&nbsp;DomU&nbsp;to&nbsp;read&nbsp;the&nbsp;directory's&nbsp;contents</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(dom&nbsp;==&nbsp;DOM0)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;path&nbsp;=&nbsp;realloc(path,&nbsp;strlen(path)&nbsp;+&nbsp;strlen(<span class="string">&quot;/memory/target&quot;</span>
<span>)&nbsp;+&nbsp;1);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(path&nbsp;==&nbsp;NULL)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error();&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcat(path,&nbsp;<span class="string">&quot;/memory/target&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="keyword">else</span>
<span>&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy(path,&nbsp;<span class="string">&quot;memory/target&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/nPath&nbsp;=&nbsp;%s&quot;</span>
<span>,&nbsp;path);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;If&nbsp;we&nbsp;are&nbsp;doing&nbsp;a&nbsp;write&nbsp;to&nbsp;the&nbsp;xenstore,&nbsp;branch&nbsp;off&nbsp;here&nbsp;and</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;then&nbsp;exit&nbsp;from&nbsp;the&nbsp;program.&nbsp;Else&nbsp;for&nbsp;read,&nbsp;cary&nbsp;on,&nbsp;and&nbsp;do&nbsp;a</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;select()&nbsp;to&nbsp;wait&nbsp;for&nbsp;a&nbsp;change&nbsp;in&nbsp;watched&nbsp;values</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span><span class="preprocessor">#ifdef&nbsp;WRITE</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;write_to_xenstore(xs,&nbsp;path);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span><span class="preprocessor">#endif</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Create&nbsp;a&nbsp;watch&nbsp;on&nbsp;the&nbsp;path</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;err&nbsp;=&nbsp;xs_watch(xs,&nbsp;path,&nbsp;<span class="string">&quot;mytoken&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(err&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Error&nbsp;in&nbsp;setting&nbsp;watch&nbsp;on&nbsp;mytoken&nbsp;in&nbsp;%s&quot;</span>
<span>,&nbsp;path);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error();&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Watches&nbsp;are&nbsp;notified&nbsp;via&nbsp;a&nbsp;File&nbsp;Descriptor.&nbsp;We&nbsp;can&nbsp;POLL&nbsp;on&nbsp;this.</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;fd&nbsp;=&nbsp;xs_fileno(xs);&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">while</span>
<span>&nbsp;(1)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD_ZERO(&amp;set);&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD_SET(fd,&nbsp;&amp;set);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;!-&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fflush(stdout);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">struct</span>
<span>&nbsp;timeval&nbsp;tv&nbsp;=&nbsp;{.tv_sec&nbsp;=&nbsp;5,&nbsp;.tv_usec&nbsp;=&nbsp;0};&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(select(fd+1,&nbsp;&amp;set,&nbsp;NULL,&nbsp;NULL,&nbsp;&amp;tv)&nbsp;&gt;&nbsp;0&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;FD_ISSET(fd,&nbsp;&amp;set))&nbsp;{&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;@&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;This&nbsp;blocks&nbsp;is&nbsp;nothing&nbsp;is&nbsp;pending.&nbsp;Returns&nbsp;an&nbsp;array</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;containing&nbsp;path&nbsp;and&nbsp;token.&nbsp;Use&nbsp;Xs_WATCH_*&nbsp;to</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;access&nbsp;these&nbsp;elements.&nbsp;Call&nbsp;free&nbsp;after&nbsp;use.</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec&nbsp;=&nbsp;xs_read_watch(xs,&nbsp;&amp;num);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(!vec)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;Error&nbsp;on&nbsp;watch&nbsp;firing&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error();&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;In&nbsp;our&nbsp;example&nbsp;code,&nbsp;the&nbsp;following&nbsp;will&nbsp;print&nbsp;out</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;/local/domain/0/memory/target|mytoken</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/nvec&nbsp;contents:&nbsp;%s|%s/n&quot;</span>
<span>,&nbsp;vec[XS_WATCH_PATH],&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;vec[XS_WATCH_TOKEN]);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;Prepare&nbsp;a&nbsp;transacation&nbsp;to&nbsp;do&nbsp;a&nbsp;read</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;trans&nbsp;=&nbsp;xs_transaction_start(xs);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(trans&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Could'nt&nbsp;start&nbsp;xaction&nbsp;xenstore&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;buf&nbsp;=&nbsp;xs_read(xs,&nbsp;trans,&nbsp;vec[XS_WATCH_PATH],&nbsp;&amp;len);&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(!buf)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Could'nt&nbsp;read&nbsp;watch&nbsp;var&nbsp;in&nbsp;vec&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xs_transaction_end(xs,&nbsp;trans,&nbsp;<span class="keyword">true</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(trans&nbsp;==&nbsp;0)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;Could&nbsp;not&nbsp;end&nbsp;xaction&nbsp;xenstore&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">if</span>
<span>&nbsp;(buf)&nbsp;{&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&nbsp;buflen:&nbsp;%d,&nbsp;buf:&nbsp;%s&quot;</span>
<span>,&nbsp;len,&nbsp;buf);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="comment">//&nbsp;end&nbsp;of&nbsp;select</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;<span class="comment">//&nbsp;end&nbsp;while(1)</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;printf(<span class="string">&quot;/n&quot;</span>
<span>);&nbsp;&nbsp;</span>
</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">//&nbsp;cleanup</span>
<span>&nbsp;&nbsp;</span>
</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;close(fd);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;xs_daemon_close(xs);&nbsp;&nbsp;</span>
</li>
<li><span>&nbsp;&nbsp;&nbsp;&nbsp;free(path);&nbsp;&nbsp;</span>
</li>
<li class="alt"><span>&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">return</span>
<span>;&nbsp;&nbsp;</span>
</span>
</li>
<li><span>}&nbsp;&nbsp;</span>
</li>
</ol>
</div>
<br />
</span>
</p>
<p align="left">&nbsp;</p>
<p align="left"><span style="font-size: small;">参考:</span>
</p>
<p><span style="font-size: small;"><span style="font-family: Arial;">1] </span>
The <em>Definitive Guide</em>
 to the Xen Hypervisor <em>David Chisnall</em>
</span>
</p>
<p><span style="font-size: small;"><span style="font-family: Arial;">2] http://www.cs.uic.edu/~spopuri/minios.html</span>
</span>
</p>
<p><span style="font-size: small;"><span style="font-family: Arial;">3] http://wiki.xensource.com/xenwiki/XenStoreReference</span>
</span>
</p>
<p><span style="font-size: small;"><span style="font-family: Arial;">4] http://wiki.xensource.com/xenwiki/XenBus</span>
</span>
</p>
<p><span style="font-size: small;"><span style="font-family: Arial;">5] http://lists.xensource.com/archives/html/xen-devel/2005-12/msg00151.html</span>
</span>
</p>
<p><span style="font-size: small;"><span style="font-family: Arial;">6] http://wiki.xensource.com/xenwiki/XenBus</span>
</span>
</p>
<p><span style="font-size: small;"><span style="font-family: Arial;">7] http://knol.google.com/k/learning-xenstore</span>
</span>
</p>
</div>
<div class="share_buttons" id="sharePanel"></div>
<!--192.168.1.236-->
<div class="article_next_prev">
    <li class="prev_article"><span>上一篇：</span><a href="/zhengtingt108/article/details/5393568">linux添加网卡及驱动</a></li>
    <li class="next_article"><span>下一篇：</span><a href="/zhengtingt108/article/details/5515619">GCC编译inline函数</a></li>
</div>


    
</div>
<div id="ad_cen"></div>
<script type="text/javascript">
    new Ad(4, 'ad_cen');
</script>
<div id="comment_title" class="panel_head">查看评论<a name="comments"></a></div>
<div id="comment_list"></div>
<div id="comment_bar"></div>
<div id="comment_form"></div>
<div class="announce">* 以上用户言论只代表其个人观点，不代表CSDN网站的观点或立场<a name="reply"></a><a name="quote"></a></div>
<script type="text/javascript">
    var fileName = '5409820';
    var commentscount = 1;
    var islock = false
</script>
<script type="text/javascript" src="http://static.blog.csdn.net/scripts/comment.js?v=1.8"></script>
<div id="ad_bot"></div>
<script type="text/javascript">
    new Ad(5, 'ad_bot');
</script>
<div id="report_dialog"></div>

<div id="d-top" style="display:none;">
<a id="d-top-a" href="#" title="回到顶部">
<img src="http://static.blog.csdn.net/images/top.png" alt="TOP" /></a>
</div>
<script type="text/javascript">
    $(function(){
        var d_top=$('#d-top');
        document.onscroll=function(){
            var scrTop=(document.body.scrollTop||document.documentElement.scrollTop);
            if(scrTop>500){
                d_top.show();
            }else{
                d_top.hide();
            }
        }
        $('#d-top-a').click(function(){
            scrollTo(0,0);
            this.blur();
            return false;
        });
    });
</script>



<div class="clear"></div>
</div>
</div>

<div id="side">
<div class="side">
<div id="panel_Profile" class="panel">
    <ul class="panel_head"><span>个人资料</span></ul>
    <ul class="panel_body profile">
        <div id="blog_userface">
            <a href="http://my.csdn.net/zhengtingt108" target="_blank">
            <img src="http://avatar.csdn.net/5/A/6/1_zhengtingt108.jpg" title="访问我的空间" style="max-width:90%"/>
            </a>
            <br />
            <span><a href="http://my.csdn.net/zhengtingt108" class="user_name" target="_blank">zhengtingt108</a></span>
        </div>
<div class="interact">
<!--<a href="#" class="attented" title="已关注"></a>-->
<a href="javascript:void(0);" class="attent" id="span_add_follow" title="[加关注]"></a>
<a href="javascript:void(0);" class="letter" onclick="loginto(1)" title="[发私信]"></a>
</div>
        <div id="blog_medal">
        </div>
        <ul id="blog_rank">
            <li>访问：<span>24762次</span></li>
            <li>积分：<span>572分</span></li>
            <li>排名：<span>第19327名</span></li>
        </ul>
        <ul id="blog_statistics">
            <li>原创：<span>28篇</span></li>
            <li>转载：<span>21篇</span></li>
            <li>译文：<span>0篇</span></li>
            <li>评论：<span>14条</span></li>
        </ul>
    </ul>
</div>
<script type="text/javascript">
    var _blogger = 'zhengtingt108';
</script>



<div class="panel" id="panel_Search">
    <ul class="panel_head"><span>文章搜索</span></ul>
    <ul class="panel_body">
        <form id="frmSearch" action="http://so.csdn.net/search" class="form_search" target="_blank">
        <span><input id="inputSearch" type="text" class="blogsearch" title="请输入关键字" /></span>
        <input id="btnSubmit" type="submit" value="搜索" title="search in blog" />
        <input type="hidden" name="q" id="inputQ" />
        <input type="hidden" name="t" value="blog" />
        <a id="btnSearchBlog" target="_blank"></a>
        </form>
    </ul>
</div><div id="panel_Category" class="panel">
    <ul class="panel_head"><span>文章分类</span></ul>
    <ul class="panel_body">
        <li>
        <a href="http://blog.csdn.net/zhengtingt108/article/category/591656">C</a><span>(4)</span>
        </li>
        <li>
        <a href="http://blog.csdn.net/zhengtingt108/article/category/590036">C++</a><span>(2)</span>
        </li>
        <li>
        <a href="http://blog.csdn.net/zhengtingt108/article/category/565026">Java</a><span>(14)</span>
        </li>
        <li>
        <a href="http://blog.csdn.net/zhengtingt108/article/category/612834">Linux</a><span>(6)</span>
        </li>
        <li>
        <a href="http://blog.csdn.net/zhengtingt108/article/category/588712">Linux内核技术</a><span>(5)</span>
        </li>
        <li>
        <a href="http://blog.csdn.net/zhengtingt108/article/category/593151">Linux网络编程</a><span>(2)</span>
        </li>
        <li>
        <a href="http://blog.csdn.net/zhengtingt108/article/category/559244">Windows编程</a><span>(11)</span>
        </li>
        <li>
        <a href="http://blog.csdn.net/zhengtingt108/article/category/584362">XEN</a><span>(4)</span>
        </li>
        <li>
        <a href="http://blog.csdn.net/zhengtingt108/article/category/593479">网络安全</a><span>(1)</span>
        </li>
    </ul>
</div><div id="panel_Archive" class="panel">
    <ul class="panel_head"><span>文章存档</span></ul>
    <ul class="panel_body">
        <div id="archive_list">
        <!--归档统计-->
        <li><a href="http://blog.csdn.net/zhengtingt108/article/month/2010/05">2010年05月</a><span>(3)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2010/04">2010年04月</a><span>(1)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2010/03">2010年03月</a><span>(2)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2010/01">2010年01月</a><span>(1)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2009/12">2009年12月</a><span>(3)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2009/11">2009年11月</a><span>(2)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2009/10">2009年10月</a><span>(3)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2009/09">2009年09月</a><span>(8)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2009/08">2009年08月</a><span>(2)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2009/07">2009年07月</a><span>(15)</span></li><li><a href="http://blog.csdn.net/zhengtingt108/article/month/2009/06">2009年06月</a><span>(9)</span></li>
        </div>
    </ul>
</div>
<div id="hotarticls" class="panel">
    <ul class="panel_head"><span>阅读排行</span></ul>
    <ul class="panel_body itemlist">
        <li>
            <a href="/zhengtingt108/article/details/5393568" title="linux添加网卡及驱动">linux添加网卡及驱动</a><span>(2340)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4514411" title="Linux内核调试工具：Kdb的编译安装">Linux内核调试工具：Kdb的编译安装</a><span>(1823)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/5409820" title="XenStore相关知识（转）">XenStore相关知识（转）</a><span>(1575)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4478075" title="Xen的配置和xend服务器的相关命令">Xen的配置和xend服务器的相关命令</a><span>(1463)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4345233" title="Java常用包以及String类，函数的调用">Java常用包以及String类，函数的调用</a><span>(1328)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4478099" title="Xen 管理工具xm">Xen 管理工具xm</a><span>(1311)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/5565569" title="如何在xen blktap中添加自定义虚拟磁盘接口">如何在xen blktap中添加自定义虚拟磁盘接口</a><span>(965)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4359617" title="Java图形界面编程">Java图形界面编程</a><span>(957)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4555277" title="自修改代码浅析">自修改代码浅析</a><span>(939)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/5568113" title="LINUX安装网卡驱动时提示找不到.autoconf.h">LINUX安装网卡驱动时提示找不到.autoconf.h</a><span>(937)</span>
        </li>
    </ul>
</div>
<div id="hotarticls2" class="panel">
    <ul class="panel_head"><span>评论排行</span></ul>
    <ul class="panel_body itemlist">
        <li>
            <a href="/zhengtingt108/article/details/5565569" title="如何在xen blktap中添加自定义虚拟磁盘接口">如何在xen blktap中添加自定义虚拟磁盘接口</a><span>(3)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4514411" title="Linux内核调试工具：Kdb的编译安装">Linux内核调试工具：Kdb的编译安装</a><span>(2)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4359617" title="Java图形界面编程">Java图形界面编程</a><span>(2)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4539317" title=" c语言中的static和extern关键字"> c语言中的static和extern关键字</a><span>(1)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/5409820" title="XenStore相关知识（转）">XenStore相关知识（转）</a><span>(1)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4362306" title="Java中网络编程">Java中网络编程</a><span>(1)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4478099" title="Xen 管理工具xm">Xen 管理工具xm</a><span>(1)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4555332" title="VC中程序自修改实现">VC中程序自修改实现</a><span>(1)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4337683" title="Java中包的使用以及类、方法的说明符">Java中包的使用以及类、方法的说明符</a><span>(1)</span>
        </li>
        <li>
            <a href="/zhengtingt108/article/details/4337674" title="Java中异常处理">Java中异常处理</a><span>(1)</span>
        </li>
    </ul>
</div>
<div id="homepageArticles" class="panel">
    <ul class="panel_head"><span>推荐文章</span></ul>
    <ul class="panel_body" id="ad_commend">
    </ul>
</div>
<script type="text/javascript">
    new Ad(12, 'ad_commend');
</script><div id="newcomments" class="panel">
<ul class="panel_head"><span>最新评论</span></ul>
<ul class="panel_body itemlist">
    <li>
    <a href="/zhengtingt108/article/details/5565569#comments">如何在xen blktap中添加自定义虚拟磁盘接口</a>
    <p style="margin:0px;"><a href="/mouse1709" class="user_name">mouse1709</a>:
不知道你是否真的做过这个,很多重要步骤都没有
    </p>
    </li>
    <li>
    <a href="/zhengtingt108/article/details/4555332#comments">VC中程序自修改实现</a>
    <p style="margin:0px;"><a href="/wangeen" class="user_name">wangeen</a>:
试过吗？
    </p>
    </li>
    <li>
    <a href="/zhengtingt108/article/details/4539317#comments"> c语言中的static和extern关键字</a>
    <p style="margin:0px;"><a href="/q120742915" class="user_name">q120742915</a>:
没有说到常量的情况，如果定义一个只读变量，那么我如何声明其为外部的量呢，以便供外部使用。不知道有没有...
    </p>
    </li>
    <li>
    <a href="/zhengtingt108/article/details/5565569#comments">如何在xen blktap中添加自定义虚拟磁盘接口</a>
    <p style="margin:0px;"><a href="/Harryyu1018" class="user_name">Harryyu1018</a>:
你好。我是一名大三的学生，最近在研究Xen这个，尤其是虚拟机克隆这块感觉很“迷茫”。我看过你在计算机...
    </p>
    </li>
    <li>
    <a href="/zhengtingt108/article/details/5409820#comments">XenStore相关知识（转）</a>
    <p style="margin:0px;"><a href="/styshoo1986" class="user_name">styshoo1986</a>:
好文章，学到了。
    </p>
    </li>
    <li>
    <a href="/zhengtingt108/article/details/5565569#comments">如何在xen blktap中添加自定义虚拟磁盘接口</a>
    <p style="margin:0px;"><a href="/aifenghkebao" class="user_name">aifenghkebao</a>:
嗨，你好。我留个QQ：1047984536我正在学习XEN这块的东西。感觉有点难度，还希望可以向你学...
    </p>
    </li>
    <li>
    <a href="/zhengtingt108/article/details/4514411#comments">Linux内核调试工具：Kdb的编译安装</a>
    <p style="margin:0px;"><a href="/lovewchjsj" class="user_name">lovewchjsj</a>:
网上这个帖子很多，可是按照那个下载链接去下载，需要身份验证，无法下载。请问楼主下载过吗？请教下载之法...
    </p>
    </li>
    <li>
    <a href="/zhengtingt108/article/details/4514411#comments">Linux内核调试工具：Kdb的编译安装</a>
    <p style="margin:0px;"><a href="/Sunpy11" class="user_name">Sunpy11</a>:
patch -p1 &amp;lt; kdb....
    </p>
    </li>
    <li>
    <a href="/zhengtingt108/article/details/4359617#comments">Java图形界面编程</a>
    <p style="margin:0px;"><a href="/匿名用户" class="user_name">匿名用户</a>:

    </p>
    </li>
    <li>
    <a href="/zhengtingt108/article/details/4359617#comments">Java图形界面编程</a>
    <p style="margin:0px;"><a href="/taiks" class="user_name">taiks</a>:

    </p>
    </li>
</ul>
</div>
</div>
<div class="clear"></div>
</div>

<div class="clear"></div>
</div>

<script type="text/javascript" src="http://static.blog.csdn.net/scripts/newblog.min.js?v=1.1"></script>
<script type="text/javascript" src="http://medal.blog.csdn.net/showblogmedal.ashx?blogid=610984"></script>

<script type="text/javascript" src="http://static.csdn.net/rabbit/note/js/publib_footer.js"></script>

<script type="text/javascript" src="http://passport.csdn.net/content/loginbox/login.js"></script>
<script type="text/javascript">document.write("<img src=http://counter.csdn.net/pv.aspx?id=24 border=0 width=0 height=0>");</script>
<script type="text/javascript" src="http://www.csdn.net/ui/scripts/Csdn/counter.js"></script>


<script type="text/javascript" src="http://ad.csdn.net/scripts/ad-blog.js"></script>
</div>
</body>
</html>