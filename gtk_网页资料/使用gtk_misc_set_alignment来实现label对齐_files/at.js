loadResource("/mysohu/at/d/at.css");require("core::util::jQuery",function(j){var e={flag:"@"};var i=/[^\x00-\xff]/g,d=/[^\x00-\xff]/;function a(l){return l.replace(i,"lv").length}function k(l){return d.test(l)}function h(r,l,q,p){q=q||"";p=p||q.length;l-=p;if(a(r)<=l){return r}var o=r.split(""),t=0,m=[];for(var n=0;n<o.length;n+=1){if(t<l){m[m.length]=o[n]}if(k(o[n])){t+=2}else{t+=1}}return m.join("")+q}var b;var c={init:function(m){var p=j(window),o=this.data("at"),n=j.extend({},e,m||{});if(!o){var l=j.browser.msie?"propertychange":"input";this.bind(l+".at",c.change);this.bind("focus.at",c.change);this.bind("blur.at",c.hide);this.bind("keydown.at",c.change);this.bind("click.at",c.change);this.data("at",{target:this,settings:n})}},change:function(m){var p=j(this),n=p.data("at"),l=n.settings,q=j(window);if(j.browser.msie&&window.event&&window.event.propertyName&&window.event.propertyName!="value"){return false}if(n.show&&m.type=="keydown"){switch(m.keyCode){case 13:c.insertat.call(p,{nick:b.find("li.active").attr("data-nick")});m.preventDefault();return false;break;case 9:c.insertat.call(p,{nick:b.find("li.active").attr("data-nick")});m.preventDefault();return false;break;case 27:c.insertat.call(p,{nick:b.find("li.active").attr("data-nick")});m.preventDefault();return false;break;case 38:var o=b.find("li.active");if(o.prev("li").length){o.removeClass("active");o=o.prev("li");o.addClass("active")}else{o.removeClass("active");o=o.parent("").find("li:last");o.addClass("active")}m.preventDefault();return false;break;case 40:var o=b.find("li.active");if(o.next("li").length){o.removeClass("active");o=o.next("li");o.addClass("active")}else{o.removeClass("active");o=o.parent().find("li:first");o.addClass("active")}m.preventDefault();return false;break}}if(n.eventTimer){clearTimeout(n.eventTimer);n.eventTimer=null}n.eventTimer=setTimeout(function(){if(n.show){c.hide.call(p)}c.checkat.call(p,m)},200)},checkat:function(m){var x=j(this),u=x.data("at");if(!u){return false}var q=u.settings,o=j(window),z=x.get(0),s=0;if(z.selectionStart===undefined){var y=document.selection;var v,n;if(z.tagName.toLowerCase()!="textarea"){var p=x.val();v=y.createRange().duplicate();v.moveEnd("character",p.length);s=(v.text==""?p.length:p.lastIndexOf(v.text));v=y.createRange().duplicate();v.moveStart("character",-p.length)}else{v=y.createRange();n=v.duplicate();n.moveToElementText(z);n.setEndPoint("EndToEnd",v);s=n.text.length-v.text.length}}else{s=z.selectionStart}var A=x.val();var B=A.slice(0,s);u.eIndex=s;var l=B.match(new RegExp([q.flag,"([a-zA-Z0-9\u4e00-\u9fa5-_]{0,20})$"].join("")));if(l){var t=A.slice(0,l.index);var w=l[1];u.beforeText=t;u.keyword=w;c.getData.call(x)}else{if(u.show){c.hide.call(x)}}},getData:function(){var x=j(this),t=x.data("at"),p=t.settings,o=j(window);var r=j(".jquery-at-mirror");if(!r.length){r=j('<div class="jquery-at-mirror"></div>').appendTo(j("body"))}if(t.currentTextarea!=x.get(0)){var q={};j.each(["margin","padding","border"],function(y,z){j.each(["Top","Left","Bottom","Right"],function(A,B){if(z!="border"){q[z+B]=x.css(z+B);return}j.each(["Color","Style","Width"],function(C,D){q[z+B+D]=x.css(z+B+D)})})});q=j.extend(q,{fontSize:x.css("fontSize"),fontFamily:x.css("fontFamily"),lineHeight:x.css("lineHeight"),visibility:"hidden",position:"absolute","background-color":"#fff","word-wrap":"break-word",outline:"none","overflow-x":"hidden","overflow-y":"auto"});r.css(q);t.currentTextarea=x.get(0)}r.css({width:x.css("width"),height:x.css("height"),left:x.offset().left,top:x.offset().top-x.outerHeight("height")});r.html(g(t.beforeText)+'<span class="jquery-at-flag">@</span>');var v=j(".jquery-at-flag",r);var u=v.position();var s=x.offset();var n={left:s.left+u.left-x.prop("scrollLeft")+5,top:s.top+u.top-x.prop("scrollTop")+20};if(!b){b=j('<div class="jquery-at-tip"></div>');b.appendTo(j("body"));b.css({display:"none",position:"absolute",zIndex:212122001});b.data("cache",{});b.data("recentlycache",{});b.data("lastInput","");b.data("inputEle",x);b.bind("click.at",function(A){var y=j(A.target);if(y.closest("li").length){var z=y.closest("li");c.insertat.call(b.data("inputEle"),{nick:z.attr("data-nick")})}});b.bind("mouseover.at",function(B){var y=j(B.target);var A=j(B.relatedTarget);if(y.closest("li").length){var z=y.closest("li");f.call(z,B,function(){if(!z.hasClass("active")){z.parent().find("li").removeClass("active");z.addClass("active")}})}});b.hover(function(){b.data("inputEle").unbind("blur.at")},function(){b.data("inputEle").bind("blur.at",function(y){c.hide.call(b.data("inputEle"),y)})});j("body").bind("click.at",function(z){var y=j(z.target);if(!y.closest(".jquery-at-tip").length){var A=b.data("inputEle").data("at");if(A&&A.show){c.hide.call(b.data("inputEle"))}}})}b.data("inputEle",x);t.show=true;var m=b.data("cache");var l=b.data("recentlycache");var w=t.keyword;if(!t.keyword){if(l.dataFinish&&l.data){c.show.call(x,{keyword:w,data:l.data})}else{if(l!==false){if(l.gettingData){return false}else{l.gettingData=true}j.getJSON("/a/app/mblog/refer/list.htm",{_:new Date().getTime()},function(z){if(z&&!z.code){z=z.data;if(!z.refer.length){l.dataFinish=true;l.data=""}else{var y=[];y.push('<div class="title">最近@的好友</div><ul>');j.each(z.refer,function(B,A){y.push('<li data-nick="'+A.nick+'">','<img src="'+A.uavatar+'" />',h(A.nick,14),"</li>")});y.push("</ul>");y=y.join("");l.dataFinish=true;l.data=y;c.show.call(x,{keyword:w,data:y})}}else{l.dataFinish=true;l.data=""}})}}}else{if(m[w]&&m[w].dataFinish){c.show.call(x,{keyword:w,data:m[w].data})}else{if(m[w]&&m[w].gettingData){return false}else{m[w]={};m[w].gettingData=true}j.getJSON("/a/search/user/search/pinyin.do?_input_encode=UTF-8",{nick:w,_:new Date().getTime()},function(z){if(z&&!z.code){z=z.data;if(!z.accounts.length){m[w].dataFinish=true;m[w].data="";c.show.call(x,{keyword:w,data:""})}else{var y=[];y.push('<div class="title">想用@提到谁？</div><ul>');j.each(z.accounts,function(C,B){var A=h(B.nick,14);if(w){B.newnick=A.replace(w,"<strong>"+w+"</strong>")}y.push('<li data-nick="'+B.nick+'">','<img src="'+B.uavatar+'" />',B.newnick,"</li>")});y.push("</ul>");y=y.join("");m[w].dataFinish=true;m[w].data=y;c.show.call(x,{keyword:w,data:y})}}else{m[w].dataFinish=true;m[w].data=""}})}}b.css({left:n.left,top:n.top})},show:function(l){var o=j(this),n=o.data("at"),m=n.settings,p=j(window);if(n.show&&n.keyword==l.keyword){if(!l.data){l.data='<div class="title">想用@提到谁？</div><ul><li data-nick="'+n.keyword+'">'+n.keyword+"</li></ul>"}b.html(l.data).show();if(b.data("lastInput")){b.find("ul li[data-nick="+b.data("lastInput")+"]").prependTo(b.find("ul"))}b.find("ul li:first").addClass("active")}},hide:function(l){var m=j(this);data=m.data("at");data&&(data.show=false);if(b){b.hide()}},insertat:function(l){return this.each(function(){var r=j(this),q=r.data("at");var p=q.beforeText+"@"+l.nick+" ";var o=p+r.val().slice(q.eIndex);r.val(o);if(q.show){c.hide.call(r)}var s=p.length;var m=r.get(0);if(m.setSelectionRange){m.focus();m.setSelectionRange(s,s)}else{if(m.createTextRange){var n=m.createTextRange();n.collapse(true);n.moveEnd("character",s);n.moveStart("character",s);n.select()}}b.data("lastInput",l.nick)})},destroy:function(){return this.each(function(){var m=j(this),l=m.data("at"),n=j(window);n.unbind(".at");m.unbind(".at");m.removeData("at")})}};var g=(function(){var l="font-family:Tahoma,宋体;";var m={"<":"&lt;",">":"&gt;",'"':"&quot;","\\":"&#92;","&":"&amp;","'":"&#039;","\r":"","\n":"<br>"," ":(navigator.userAgent.match(/.+(?:ie) ([\d.]+)/i)||[8])[1]<8?['<pre style="overflow:hidden;display:inline;',l,'word-wrap:break-word;"> </pre>'].join(""):['<span style="white-space:pre-wrap;',l,'"> </span>'].join("")};return function(o){var n=o.replace(/(<|>|\"|\\|&|\'|\n|\r| )/g,function(p){return m[p]});return n}})();var f=function(n,q){var p=this;var m=n.relatedTarget;var l=p.get(0);try{while(m&&m!==l){m=m.parentNode}if(m!==l){q()}}catch(o){}};j.clearAtCache=function(){if(b){b.data("recentlycache",{});b.data("lastInput","")}};define("plugins::at",c)});