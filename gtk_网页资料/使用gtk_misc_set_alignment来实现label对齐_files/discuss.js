require("core::util::jQuery","core::timeUtil","core::util[ajax,beLogin,cookie,fx]","core::ui::TextBox","core::ui::Page","app::feed::common","app::discuss::template","core::stringUtil","core::ui::dialog[success,error]","plugins::hijacker","plugins::at",function(e,k,g,f,m,c,i,h,b,l,a){var d={listURL:"/a/app/discuss/indexList.htm?_input_encode=UTF-8&_output_encode=UTF-8",saveURL:"/a/app/discuss/save.htm",chars:300,pagesize:10,showDelete:true,otherDomain:document.domain=="pub.i.sohu.com"};function j(o){load("/d/common-remark.css");o=g.probe(d,o);o.dom.discuss=this;this.length=1;this[0]=g.parseHTML(i.layout(o,c))[0];this[0].wrapped=this;o.dom.appendChild(this[0]);this.$ul=this.find("ul");this.$msg=this.find(".show-total");this.$btn=this.find(".btn-submit .ui-btn");this.numLen=this.find(".txt-number-now");this.tf=new f(this.find("textarea")[0]);a.init.apply(this.tf);l.hijackthis(this);var n=this;this.init(o);this.emoteContext={target:n.find("div.emotion-list"),editor:n.tf,arrowLeft:100};this.data("EmoteHandler",{getEmoteContext:function(){return n.emoteContext},onEmote:function(v){var r=n.find("span.btn-emot");var u,t;var q=n[0].offsetParent,s=r[0];while(q){var p=q.currentStyle||document.defaultView.getComputedStyle(q,null);if(p.position!="static"){break}q=q.offsetParent}u=0;t=0;while(s&&s!=q){u+=s.offsetLeft;t+=s.offsetTop;s=s.offsetParent}v.css({left:u-98+"px",top:t+14+"px"});n.tf.focus()}})}j.prototype=j.funs=new e.fn.init();g.probe({init:function(o){var n=this;this.tf.onChange=function(q){var p=h.gbLength(q);n.numLen.html(p+"/"+o.chars).css("color",p>o.chars?"#c43737":"")};this.options&&this.options.reply&&(this.options.reply=null);o=this.options=g.probe(this.options,o);(o.reply||o.autoFocus)&&this.tf.setText(o.reply?"回复@"+o.reply.unick+"：":"").moveTo(-1);this.params={page:o.page||1,sz:o.pagesize||10,ids:[o.appId,o.parentid,o.appId=="photo"?7:o.appId=="album"?8:0,o.xpt].join("_")};o.load&&this.load();this.tf.onSend=function(){n.post()};o.extra&&o.extra.apply(this)},push:function(o){var s=this.options.xpt===g.cookie.xpt;if(o){!e.isArray(o)&&(o=[o]);k.setServerTime();for(var p=0,n=o.length,r=[];p<n;p++){var q=o[p];q.xpt=q.passport;q.time_ago=k.get_timeago(q.createtime);q.content=h.filter_all(q.content.replace(/<br\s*\/?>/ig,""));q.showDelete=this.options.showDelete&&(s||(q.xpt||q.passport)===g.cookie.xpt);r.push(i.content(q,c))}r=r.join("")}else{var r=""}if(this.$ul[0].hasChild&&/replaceme/.test(this.$ul[0].children[0].className)){this.$ul.html(r)}else{this.$ul.html(r+this.$ul.html())}if(this.$msg.noDiscuss){this.$msg.html("").hide().noDiscuss=false}},load:function(r){var n=this;r=g.probe(this.params,r);this.page||this.$msg.show().html("评论加载中");this.requesting&&this.requesting.abort();if(this.options.isSComment){var o="reply_"+this.options.replyid;var q=loadScript("http://comment4.news.sohu.com/dynamic/cmt_"+o+".json",function(x){n.requesting=false;var w={amp:"&",lt:"<",gt:">",quot:'"',"#039":"'","#040":"(","#041":")","#064":"@"};if(!x){p({commentcount:0});return}for(var z=0,u=x.replies.length,v=new Array(u);z<u;z++){var t=x.replies[z];var s=y(t.content);s=s.replace(/&(amp|lt|gt|quot|#039|#040|#041|#064);/g,function(A,B){return w[B]}).replace(/<br>/g,"\r\n");if(h.gbLength(s)>d.chars){s=h.gbCut(s,d.chars)+"..."}v[z]={content:s,passport:Base64.encode(y(t.passport)),id:t.replyId,createtime:t.createTime,unick:y(t.nickname),uavatar:y(t.authorimg),ulink:y(t.mylinks)}}p({commentcount:x.totalNumber,comments:v,url:"/p/"+n.options.xpt+"/scomment/person/single/"+n.options.replyid+"/"});function y(A){return JSON.parse('"'+A.replace(/%u([0-9a-z]{4})/ig,"\\u$1").replace(/%([0-9a-z]{2})/ig,"\\u00$1")+'"')}},true,o);this.requesting={js:q,abort:function(){this.js.parentNode&&q.parentNode.removeChild(this.js)}}}else{this.requesting=(this.options.otherDomain?g.ajax.jsonp:g.ajax.getJSON)((this.options.otherDomain?"http://i.sohu.com":"")+this.options.listURL+"&"+g.toQueryString(r),function(s){n.requesting=false;p(s[r.ids]||{code:1,msg:"没有找到条目"})})}function p(u){n.$ul.html("");if(u.code){n.$msg.html(u.msg);return}n.options.onSuccess&&n.options.onSuccess(u);n.push(u.comments);if(u.commentcount>n.options.pagesize){if(n.options.load.all){n.$msg.html(i.show_total({link:u.url,count:u.commentcount-10}))}else{if(n.options.load.page){var s=u.commentcount?Math.ceil(u.commentcount/r.sz):1;var t=n.page;if(!t){n.page=t=new m(s);t.handler=n;n.data("page",t);t.appendTo(n.$msg.html(""))}else{if(s!=t.pages){t.setPages(s)}}t.showPage(r.page)}}}else{if(!u.commentcount){n.$msg.html("暂时没有评论").noDiscuss=true}else{if(!u.comments||!u.comments.length){n.$ul.html(i.no_more)}else{n.$msg.hide()}}}}},setPage:function(o){this.params.page=o;if(this.options.auto_scroll){var n=this.position().top-30;if(n<g.wndTop()){window.scrollTo(0,n)}}this.load()},post:function(){if(this.posting||g.beLogin()){return}var o=this,p=this.options;var q=this.tf.getText();if(q==""||h.gbLength(q)>p.chars){o.tf.focus();o.numLen.html(q?"内容过长":"想说点什么？").css("color","#c43737");g.fx.highlight(o.tf,function(){this.onChange(this.getText())});return}if(this.options.isSComment){var t={topicId:p.parentid,content:q,replyToId:p.reply?p.reply.id:p.replyid,from:2,urlBack:""};this.tf.setText("");b.success("评论已提交，正在审核中，请耐心等待。");p.reply=null;g.ajax.postForm("http://comment4.news.sohu.com/post/comment/",t);return}var n=this.find("input");var t={type:0,discusstype:(n[0]&&n[0].checked?1:0)+((n[1]&&n[1].checked)?2:0),appid:p.appId,itemid:p.parentid,content:q};if(p.isForward){t.originalid=p.originalid}if(p.replytoid){t.replytocommentid=p.replytoid;t.replytopassport=p.replytopp}var s=p.appId;if(s==="album"||s==="photo"||s=="video"||s=="sentence"){t.orixpt=p.xpt;if(s=="photo"){t.type=7}if(s=="album"){t.type=8;var r=p.$data.attr("data-itemids");if(r){t.parentid=r}}}if(p.reply){t.replytodiscussid=p.reply.id;t.replytopassport=p.reply.xpt;p.reply=null}if(p.otherDomain){o.tf.setText("").focus();o.options.noPush||o.push({content:q,unick:g.cookie.unick,ulink:g.cookie.ulink,uavatar:g.cookie.photo,createtime:k.setServerTime()});g.ajax.postForm("http://i.sohu.com/"+p.saveURL+"?_input_encode=GBK",t)}else{this.setPosting(true);g.ajax.postJSON(p.saveURL+"?_input_encode=UTF-8",t,function(u){o.setPosting(false);if(u.code==0){o.tf.setText("").focus();if(u.comment){o.options.noPush||o.push(u.comment);if(p.onSuccess){(t.discusstype&1)&&(u.comment.spreadcount=undefined);p.onSuccess(u.comment)}}}else{if(u.code==4){b.error("请不要发表含有不适当内容的评论 。")}else{b.error("保存评论失败："+u.msg)}}},function(){o.setPosting(false);b.error("保存评论失败，请稍后重试")})}},setPosting:function(n){this.posting=n;this.$btn.attr("action",n?"":"app::discuss::discuss.post")[n?"addClass":"removeClass"]("ui-btn-disabled")},destroy:function(){this.requesting&&this.requesting.abort();l.free(this);a.destroy.apply(this.tf);this.tf.destroy();this.options.dom.removeChild(this[0]);this.options.dom.discuss=null},replyto:function(n){this.options.reply=n;var o=this.tf.getText();o=o.replace(/^((?:回复@.*?：)*)/,"回复@"+n.unick+"：");this.tf.setText(o).moveTo(o.length);var p=this.position().top;g.wndTop()-p>-24&&window.scrollTo(0,p-24)},focus:function(){var n=this.tf.offset();this.tf.focus();e(document).scrollTop(n.top+500)}},j.funs);define("app::discuss",j)});require("core::util[beLogin]","app::discuss","core::util::jQuery",function(a,c,b){define("app::discuss::discuss",function(g){if(a.beLogin()){return}var f=d(g.actionTarget,{load:{all:true,page:false},autoFocus:true});if(!f){return}new c(f)});define("plugins::hijacker::baby.comment",function(g){if(a.beLogin()){return}var f=d(g.actionTarget,{load:{page:true},autoFocus:true});if(!f){return}new c(f)});define("plugins::hijacker::comment.show",function(g){var f={load:{all:false,page:true},focus:false,pagesize:20,xpt:$space_config._xpt};if(g.onSuccess){f.onSuccess=g.onSuccess}f=d(g.actionTarget,f);if(!f){return}new c(f)});define("app::discuss::discuss.replyto",function(g){var h;if(a.beLogin()||!(h=a.getParentByClassName(g.actionTarget,"hijackdata"))){return}var f=b(h);a.getParentByClassName(h,"comment-box").wrapped.replyto({xpt:f.attr("data-xpt"),unick:f.attr("data-nick"),id:f.attr("data-replytodiscussid")})});define("app::discuss::discuss.post",function(f){if(a.beLogin()){return}a.getParentByClassName(f.actionTarget,"comment-box").wrapped.post()});function d(h,f){var j=a.getParentByClassName(h,"hijackdata"),g=j;var i=j&&j.getAttribute("comment-box");i&&(g=b(i)[0]);if(!g){return}if(g.discuss){g.discuss.destroy();g.discuss=null;return}var e=b(j);f=a.probe({$data:e,elem:h,usericon:a.cookie,appId:e.attr("data-appid")||e.attr("data-from")||$space_config._currentApp,xpt:e.attr("data-xpt"),parentid:e.attr("data-itemid"),type:e.attr("data-type"),dom:g,onSuccess:function(m){if(!m){return}var l=this.elem.parentNode.children;for(var p=0,k=l.length;p<k;p++){var o=l[p].getAttribute("action");if(!o){continue}if(/forward/.test(o)){a.refreshCount(l[p],m.spreadcount)}else{if(/comment|discuss/.test(o)){a.refreshCount(l[p],m.commentcount)}}}}},f);f.isSComment=f.appId=="scomment"||e.attr("data-from")==="comment";if(e.attr("data-from")==="forward"){f.isForward=true;e.attr("data-oriappid")!=="qingsohu"&&(f.origin={username:{tblog:e.attr("data-oriappid")=="tblog",xpt:e.attr("data-orixpt"),ulink:e.attr("data-oriulink"),unick:e.attr("data-oriunick")}});f.originalid=e.attr("data-oriid")}else{if(e.attr("data-from")==="tblog"){f.appId="tblog"}else{if(f.isSComment){f.showDelete=false;f.ulink=e.attr("data-ulink");f.replyid=e.attr("data-replyid");f.hideFwd=true}else{if(f.appId==="baby"){f.hideFwd=true}}}}f.auto_scroll=f.appId!="baby";return f}});