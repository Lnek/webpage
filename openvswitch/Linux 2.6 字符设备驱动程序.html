
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta http-equiv="Content-Type" content="text/html; charset=gb2312" />

<title>Linux 2.6 字符设备驱动程序 - 技术文档 - 程序开发 Linux时代 - 开源、自由、共享 - 中国最大的Linux技术社区</title>
<meta name="keywords" content="Linux 2.6 字符设备驱动程序 - 技术文档 - 程序开发 Linux时代 - 开源、自由、共享 - 中国最大的Linux技术社区">
<meta name="description" content="Linux 2.6 字符设备驱动程序 - 技术文档 - 程序开发  程序开发 Linux 技术文档">

<link href="/css/all.css" rel="stylesheet" type="text/css" />

<style type="text/css">

<!--

.STYLE1 {color: #FF0000}

.STYLE2 {font-size: 14px}

-->

</style>

</head>



<body>

<table width="950" border="0" align="center" cellpadding="0" cellspacing="0">

  <tr>

    <td height="27">	<table border="0" cellspacing="0" cellpadding="0" style="border-collapse: collapse" width="100%">
	<tr><FORM name="login" action="http://linux.chinaunix.net/bbs/logging.php?action=login"  method=post>
	<td><script language="javascript" src="http://linux.chinaunix.net/bbs/loginbox.php"></script></td>
	</form>
	<td align="right">
	・<a href="http://www.chinaunix.net" class="list1">ChinaUnix首页</a>

	・<a href="http://bbs.chinaunix.net" class="list1">论坛</a>
	・<a href="http://blog.chinaunix.net" class="list1">博客</a>&nbsp;
	</td>
	</tr>
	</table></td>

  </tr>

  <tr>

    <td height="1" bgcolor="#CCCCCC"></td>

  </tr>

  <tr>

    <td><table width="100%" border="0" cellpadding="0" cellspacing="0">

      <tr>

        <td height="84"><img src="/images/logo.jpg" /></td>

        <td align="right" ><IFRAME SRC="http://count.chinaunix.net/iframe.php?id=54" width="750" height="80" frameborder="0"  scrolling="no"></IFRAME>
</td>

      </tr>

    </table></td>

  </tr>

  <tr>

    <td><table width="100%" border="0" cellspacing="0" cellpadding="0">

      <tr>

        <td width="3"><img src="/images/bgtop1.jpg" width="3" height="26" /></td>

        <td width="944" background="/images/bgtop2.gif" class="whitetop">
<a href="http://linux.chinaunix.net/" target="_blank">Linux首页</a> |
<a href="http://linux.chinaunix.net/news/">Linux新闻</a> |
<a target="_blank" href="http://linux.chinaunix.net/bbs" style=color:red><b>Linux论坛</b></a> |
<a href="http://linux.chinaunix.net/techdoc/">Linux文档</a> |
<a target="_blank" href="http://download.chinaunix.net/disc/linux/">Linux下载</a> |
<a target="_blank" href="http://blog.chinaunix.net/techart.php?frmid=6">Linux博客</a> |
<a target="_blank" href="http://search.chinaunix.net/">Linux搜索</a> |
<a target="_blank" href="http://linux.chinaunix.net/bbs/index.php?gid=68">开源项目孵化平台</a>
 |
<a target="_blank" href="http://linux.chinaunix.net/ebook/"  style=color:red>《开源时代》</a></td>

        <td width="3" align="right"><img src="/images/bgtop3.jpg" width="3" height="26" /></td>

      </tr>

    </table></td>

  </tr>

</table>

<table width="950" border="0" align="center" cellpadding="0" cellspacing="0">

<tr>

    <td valign="bottom" class="BlkLightblue">
<a target="_blank" href="http://linux.chinaunix.net/techdoc/beginner/">
		新手入门</a> | <span lang="zh-cn">
		<a target="_blank" href="http://linux.chinaunix.net/techdoc/install/">
		安装启动</a> | </span>
		<a target="_blank" href="http://linux.chinaunix.net/techdoc/system/">
		管理员指南</a> | <a target="_blank" href="http://man.chinaunix.net/">开发手册</a> 
		| <a target="_blank" href="http://linux.chinaunix.net/techdoc/desktop/">
		桌面应用</a> |
		<a target="_blank" href="http://linux.chinaunix.net/techdoc/develop/">
		程序开发</a> |
		<a target="_blank" href="http://linux.chinaunix.net/techdoc/database/">
		数据库</a> | <span lang="zh-cn">
		<a target="_blank" href="http://linux.chinaunix.net/techdoc/net/">网络技术</a>|
<a target="_blank" href="http://linux.chinaunix.net/topics/2007-01-25/15/index.shtml">
CentOS</a></span> |
<a target="_blank" href="http://linux.chinaunix.net/search2.php?key=fedora&id=0">
Fedora</a> <span lang="zh-cn">| </span>
<a target="_blank" href="http://linux.chinaunix.net/search2.php?key=mysql&id=0">
MySQL</a>

<span lang="zh-cn">| </span>
<a target="_blank" href="http://linux.chinaunix.net/search2.php?key=apache&id=0">
Apache</a>

<span lang="zh-cn">| </span>
<a target="_blank" href="http://linux.chinaunix.net/search2.php?key=ubuntu&id=0">
<font color="#FF0000">Ubuntu</font></a>

<span lang="zh-cn">| </span>
<a target="_blank" href="http://linux.chinaunix.net/topics/2008-07-10/18/index.shtml">
<font color="#FF0000">Gentoo</font></a>| </span>
<b>
<a target="_blank" href="http://linux.chinaunix.net/topics/2008-07-30/19/index.shtml">
<font color="#FF0000">OSCON08</font></a></b>
</td>

</tr>
<tr><td>

</td></tr>
  <tr>

    <td height="30" valign="bottom">&nbsp;&nbsp;<a href="http://linux.chinaunix.net">Linux时代</a> &gt;&gt;  <a href="http://linux.chinaunix.net/techdoc/" class='list1'>技术文档</a> >> <a href="http://linux.chinaunix.net/techdoc/develop/" class='list1'>程序开发</a></td>

  </tr>

  <tr>

    <td height="1" bgcolor="#CCCCCC"></td>

  </tr>

  <tr>

    <td height="8"></td>

  </tr>

</table><table width="950" border="0" align="center" cellpadding="0" cellspacing="0">

  <tr>

    <td valign="top" class="BLKtext"><table width="660" border="0" align="center" cellpadding="0" cellspacing="0">

      <tr>

        <td height="8">&nbsp;</td>

      </tr>

      <tr>

        <td height="30" class="Ftext1">Linux 2.6 字符设备驱动程序</td>

      </tr>

      <tr>

        <td><table width="80%" border="0" align="center" cellpadding="0" cellspacing="0">

          <tr>

            <td height="1" bgcolor="#CCCCCC"></td>

          </tr>

        </table></td>

      </tr>

      <tr>

        <td height="40" align="center">来源: 
 ChinaUnix博客 　日期：
2007.11.16 10:36　(共有<span class="STYLE1" id ="postcount"></span>条评论)  <a href="http://linux.chinaunix.net/bbs/thread-972444-1-1.html" target="_blank">我要评论</a></td>

      </tr>

      <tr>

        <td>&nbsp;</td>

      </tr>

      <tr>

        <td class="F14">
<font color="&quot;#009900&quot;"><b></b></font><font color="&quot;#0000ff&quot;"><b>○、说明</b></font><br />
笔记适用于Linux的2.6.10以后的内核。<br />
笔记以Linux<br />
Device<br />
Driver3提供的scull程序(scull目录中的main.c和scull.h)为记录主线，并以该驱动程序中的各种系统调用和函数调用流程为记<br />
录顺序。比如，module_init( )和module_exit(<br />
)为相对应的一对系统调用，一般书籍中都会放在一起讨论，但是本笔记却不会这样，而是在需要调用的时候才会涉及，因此module_init(<br />
)会放在笔记开始时，也就是刚加载module时讨论，而module_exit( )则会放在笔记结束前，也就是要卸载module时再加以讨论。<br />
该笔记的的目的是为了对Linux Device Drvier3中提到的各个知识点作一下整理，理清一下头绪，从而能让我对Linux驱动程序加深整体或者全局上的理解。<br />
<font color="&quot;#009900&quot;">注：个人理解，有误难免！</font><br />
<font color="&quot;#009900&quot;">*******************************************</font><br />
<font color="&quot;#009900&quot;"><b>驱动程序module的工作流程主要分为四个部分：<br />
1、 用Linux提供的命令加载驱动module<br />
2、 驱动module的初始化（初始化结束后即进入“潜伏”状态，直到有系统调用）<br />
3、 当操作设备时，即有系统调用时，调用驱动module提供的各个服务函数<br />
4、 卸载驱动module</b></font><br />
<font color="&quot;#0000ff&quot;"><b>一、 驱动程序的加载</b></font><br />
Linux驱动程序分为两种形式：一种是直接编译进内核，另一种是编译成module形式，然后在需要该驱动module时手动加载。对于前者，还有待学习。<br />
Module形式的驱动，Linux提供了两个命令用来加载：modprobe和insmod。<br />
其<br />
中modprobe可以解决驱动module的依赖性，即假如正加载的驱动module若引用了其他module提供的内核符号或者其他资源，则<br />
modprobe就会自动加载那些module，不过，使用modprobe时，必须把要加载的驱动module放在当前模块搜索路径中。而insmod<br />
命令不会考虑驱动module的依赖性，但是它却可以加载任意目录下的驱动module。<br />
一般来说，在驱动开发阶段，使用/sbin/insmod比较方便，因为不用将module放入当前module搜索路径中。<br />
一旦使用insmod加载模块，则Linux内核就会调用module_init(scull_init_module)特殊宏，其中scull_init_module是驱动初始化函数，可自定义名称。<br />
在用insmod加载module时，还可以给module提供模块参数，但是这需要在驱动源代码中加入几条语句，让模块参数对insmod和驱动程序可见，如：<br />
static char *whom=”world”；<br />
static int&nbsp;&nbsp;howmany=10;<br />
module_param(howmany,int,S_IRUGO);<br />
module_param(whom,charp,S_IRUGO);<br />
这样，当使用/sbin/insmod scull.ko&nbsp;&nbsp;whom=”string”&nbsp;&nbsp;howmany=20这样的命令加载驱动时，whom和howmay的值就会传入scull驱动模块了。<br />
驱动程序module被加载后，若对设备进行操作（如open，read，write等），驱动module就会调用相应的函数响应该操作。<br />
那么，当对设备进行操作时，驱动module又怎么知道是自己应该有所响应，而不是其他的驱动module呢，也就是说，Linux内核怎么知道应该调用哪一个驱动module呢？<br />
目<br />
前我只知道有两种方式将设备与驱动module联系在一起（也许应该说提供访问设备的一种途径比较恰当）：其一是通过某些设备的ID（比如PCI设备和<br />
USB设备的Device ID和Product<br />
ID），Linux内核根据这些ID调用驱动module；其二是在/dev目录下根据设备的主次设备号创建对应的设备节点（即设备文件），这样当操作<br />
/dev目录下的设备文件时，就会调用相应的驱动module。<br />
<font color="&quot;#0000ff&quot;"><b>二、 驱动module的初始化</b></font><br />
使用insmod加载驱动module时，需要让驱动module为设备做一些初<br />
始化动作，主要目的是让Linux内核知道这个设备(或者说module?)，以及在以后对该设备进行操作（如open，read，write等等）时，<br />
让Linux内核知道，本module拥有哪些函数可以服务于系统调用。<br />
因此，scull_init_module函数中主要做了以下几件事情：<br />
a) 分配并注册主设备号和次设备号<br />
b) 初始化代表设备的struct结构体：scull_dev<br />
c) 初始化互斥体init_MUTEX（本笔记不整理）<br />
d) 初始化在内核中代表设备的cdev结构体，最主要是将该设备与file_operations结构体联系起来。<br />
<font color="&quot;#009900&quot;"><b>1、 分配并注册主次设备号</b><br />
设备号是在驱动module中分配并注册的，也就是说，驱动module拥有这个设备号（我的理解），而/dev目录下的设备文件却是根据这个设备号创建的，因此，当访问/dev目录下的设备文件时，驱动module就知道，自己该出场服务了（当然是由内核通知）。</font><br />
<font color="&quot;#009900&quot;">在Linux内核看来，主设备号标识设备对应的驱动程序，告诉Linux内核使用哪一个驱动程序为该设备(也就是/dev下的设备文件)服务；而次设备号则用来标识具体且唯一的某个设备。</font><br />
<font color="&quot;#009900&quot;">在内核中，用dev_t类型(其实就是一个32位的无符号整数)的变量来保存设备的主次设备号，其中高12位表示主设备号，弟20位表示次设备号。<br />
设备获得主次设备号有两种方式：一种是手动给定一个32位数，并将它与设备联系起来(即用某个函数注册)；另一种是调用系统函数给设备动态分配一个主次设备号。</font><br />
对于手动给定一个主次设备号，使用以下函数：<br />
int register_chrdev_region(dev_t first, unsigned int count, char *name)<br />
其中first是我们手动给定的设备号，count是所请求的连续设备号的个数，而name是和该设备号范围关联的设备名称，它将出现在/proc/devices和sysfs中。<br />
比<br />
如，若first为0x3FFFF0，count为0x5，那么该函数就会为5个设备注册设备号，分别是0x3FFFF0，0x3FFFF1，<br />
0x3FFFF2，0x3FFFF3，0x3FFFF4，其中0x3（高12位）为这5个设备所共有的主设备号（也就是说这5个设备都使用同一个驱动程<br />
序）。而0xFFFF0，0xFFFF1，0xFFFF2，0xFFFF3，0xFFFF4就分别是这5个设备的次设备号了。<br />
需要注意的是，若<br />
count的值太大了，那么所请求的设备号范围可能会和下一个主设备号重叠。比如若first还是为0x3FFFF0，而count为0x11，那么<br />
first+count=0x400001，也就是说为最后两个设备分配的主设备号已经不是0x3，而是0x4了！<br />
用这种方法注册设备号有一个缺点，那就是若该驱动module被其他人广泛使用，那么无法保证注册的设备号是其他人的Linux系统中未分配使用的设备号。<br />
对于动态分配设备号，使用以下函数：<br />
int alloc_chrdev_region(dev_t *dev, unsigned int firstminor, unsigned int count, char *name)<br />
该函数需要传递给它指定的第一个次设备号firstminor（一般为0）和要分配的设备数count，以及设备名，调用该函数后自动分配得到的设备号保存在dev中。<br />
动<br />
态分配设备号可以避免手动指定设备号时带来的缺点，但是它却也有自己的缺点，那就是无法预先在/dev下创建设备节点，因为动态分配设备号不能保证在每次<br />
加载驱动module时始终一致（其实若在两次加载同一个驱动module之间并没有加载其他的module，那么自动分配的设备号还是一致的，因为内核<br />
分配设备号并不是随机的，但是书上说某些内核开发人员预示不久的将来会用随机方式进行处理），不过，这个缺点可以避免，因为在加载驱动module后，我<br />
们可以读取/proc/devices文件以获得Linux内核分配给该设备的主设备号。<br />
Linux Device<br />
Driver3提供了一个脚本scull_load和scull_unload，可以在动态分配的情况下为设备创建和删除设备节点。其实它也是利用了<br />
awk工具从/proc/devices中获取了信息，然后才用mknod在/dev下创建设备节点。<br />
其实scull_load和scull_unload脚本同样可以适用于其他驱动程序，只要重新定义变量并调整mknod那几行语句就可以了。<br />
<font color="&quot;#009900&quot;">与主次设备号相关的3个宏：<br />
MAJOR(dev_t&nbsp;&nbsp;dev)：根据设备号dev获得主设备号；<br />
MINOR(dev_t&nbsp;&nbsp;dev)：根据设备号dev获得次设备号；<br />
MKDEV(int major,&nbsp;&nbsp;int minor)：根据主设备号major和次设备号minor构建设备号。</font><br />
<b>2、 初始化代表设备的scull_dev结构体</b><br />
scull源代码中定义了一个scull_dev结构体，包括qset，qutuam，信号量sem以及cdev等字段。其中qset和qutuam的初始化对于Linux驱动程序的知识点来说毫不相关，因此不加讨论。<br />
我<br />
只要知道，在加载module时所调用的module初始化函数中，可以初始化一些设备相关的变量。但是根据Linux Device<br />
Drvier3作者的意思，设备相关的变量或者一些资源最好应当在open函数中初始化，比如像中断号等，虽然在module初始化函数中注册也是允许<br />
的，但最好是在第一次打开设备，也就是open函数中再行分配。<br />
<font color="&quot;#009900&quot;"><b>3、 初始化互斥体init_MUTEX<br />
</b>互斥体MUTEX，也就是信号量的一个变种，与completion，自旋锁spinlock等等都与驱动中的并发和竞态相关，以后再说。</font><br />
<b>4、 初始化在内核中代表设备的cdev结构体</b><br />
其实在Linux内核中，cdev结构体才是真正代表了某个设备。在内核调用设备的open，read等操作之前，必须先分配并注册一个或者多个cdev结构。<br />
我<br />
想可以这么理解，主次设备号是涉外的，主要用来在与外部（指的是驱动module和Linux内核以外）交互时确定身份；而cdev结构体则是涉内的，当<br />
需要在module内部，或者与Linux内核之间传递一些变量，指针，buffer等东东，或者要调用驱动module中的某个服务函数时，就要用到<br />
cdev结构体了。<br />
<font color="&quot;#009900&quot;">在scull函数中，cdev结构体的分配，注册与初始化使用了一个自定义的scull_setup_cdev函数，在该函数中，主要由以下4条语句对cdev进行初始化：<br />
cdev_init(&amp;dev-&gt;cdev, &amp;scull_fops);<br />
dev-&gt;cdev.owner = THIS_MODULE;<br />
dev-&gt;cdev.ops = &amp;scull_fops;<br />
err = cdev_add (&amp;dev-&gt;cdev, devno, 1);<br />
（dev变量是scull程序定义的代表设备的一个结构体，它包含了cdev结构体，对于dev来说，cdev结构体应该说就是它的核心）</font><br />
第一条语句是初始化cdev结构体，比如为cdev结构体分配内存，为cdev结<br />
构体指定file_operations等等，而第三条语句的作用初看起来似乎与第一条有所重复。但scull程序中既然这么写想必就有它的用意，也许需<br />
要看Linux内核源代码才能搞明白，但目前我是这么理解的：第一条语句中有关file_operations的部分是为了告诉Linux内核，该<br />
cdev结构体相关的file_operations是scull_fops；而第二条语句则是真正为cdev指定了它的file_operations<br />
字段就是scull_fops。<br />
scull_fops是file_operations类型的变量，file_operations也是一个结构体，而且是Linux驱动程序中很重要的一个结构体，在scull程序中，定义如下：<br />
struct file_operations scull_fops = {<br />
 .owner =&nbsp;&nbsp;THIS_MODULE,<br />
 .llseek =&nbsp;&nbsp;scull_llseek,<br />
 .read =&nbsp;&nbsp;scull_read,<br />
 .write =&nbsp;&nbsp;scull_write,<br />
 .ioctl =&nbsp;&nbsp;scull_ioctl,<br />
 .open =&nbsp;&nbsp;scull_open,<br />
 .release =&nbsp;&nbsp;scull_release,<br />
};<br />
以<br />
上定义中，第一条.owner字段说明本file_operations结构体的拥有者是本驱动module，而接下来的几个字段则是告诉驱动<br />
module，当有相应的系统调用到达该module时，module应该调用哪一个函数来为该系统调用服务。比如说，若有一个open系统调用到达<br />
module，则module通过查询file_operations结构体就知道了，与open系统调用相关的是scull_open函数，于是<br />
module就调用scull_open函数来为open系统调用服务了。其他几个字段也完全类似。<br />
当然，Linux内核定义的file_operations结构体还包括其他一些字段，比如异步读写等等，但还是等用到的时候再说吧。<br />
<font color="&quot;#009900&quot;">对cdev初始化的第二条语句是dev-&gt;cdev.owner = THIS_MODULE，这条语句就是说正在初始化的cdev结构体的拥有者就是本module</font><br />
对cdev初始化的最后一条语句是err = cdev_add<br />
(&amp;dev-&gt;cdev, devno,<br />
1)，该语句的目的就是告诉内核，该cdev结构体信息。因为cdev_add函数有可能调用失败，所以需要检测该函数调用的返回值。而一旦<br />
cdev_add调用成功返回，那么我们的设备就“活”了！也就是说，外部应用程序对它的操作就会被内核允许且调用。因此在驱动程序还没有完全准备好处理<br />
设备上的操作时，就绝不能调用cdev_add。<br />
<font color="&quot;#0000ff&quot;"><b>三、 设备操作</b></font><br />
<font color="&quot;#009900&quot;">驱动module因为由insmod的加载而进行了初始化之后，就会进入“潜伏”状态，也就是说，如果没有系统调用(如open，read等)，那么module中定义的其他函数就绝不会运行！<br />
这里所说的设备操作，是指当有系统调用到达驱动module时，module就该调用某个或某些函数有所动作。<br />
对于驱动开发来说，我主要关心的只有一点，那就是系统调用怎样把一些外部应用程序中的变量值传递给驱动module。<br />
scull程序中与设备操作相关的函数主要分为三类：初始化函数，实际的操作服务函数和清理函数。其中初始化函数只有一个，就是open函数，而操作服务函数则包括read，write，llseek等等函数，至于清理函数则是release函数。</font><br />
<b>1、open函数</b><br />
open函数提供给驱动程序以初始化的能力，从而为以后的操作做准备。<br />
说<br />
起来在用insmod加载驱动后也有一个初始化动作，但那个初始化是相对于整个Linux内核，或者说是针对整个module在涉外时的全局意义上的初始<br />
化；而open函数的初始化则是相对于设备操作来说的，是属于驱动内部的初始化，比如为以后read操作时用到的某个变量(如file结构体)作一下初始<br />
化，再比如初始化一下设备，清空一下buffer等等。<br />
在大部分的驱动程序中，open应该完成如下工作：<br />
a、 确定要打开的具体设备<br />
b、 检查设备特定的错误（诸如设备未就绪或类似的硬件问题）<br />
c、 如果设备是首次打开，则对其作一下初始化<br />
d、 如有必要，更新f_op指针<br />
e、 分配并填写置于filp-&gt;private_data里的数据结构<br />
<font color="&quot;#009900&quot;">open函数的原型如下(指的是在file_operations结构体中的定义)：<br />
int (*open)(struct inode *inode, struct file *filp)<br />
在驱动开发时要做的，就是为该函数作具体实现，当然对open函数的名称可以自定义，只要在填写file_operations结构体中的open字段时，将自定义的open函数名称填上就可以了。在scull程序中，用的就是scull_open函数名。</font><br />
在open函数原型中，有inode和filp两个参数，都是外部应用程序在操作<br />
设备时通过调用系统调用传递给驱动module的。于是驱动module就可以通过这两个参数来确定要打开的具体设备了。其实这里所说的具体设备，并不是<br />
说驱动module需要从系统安装的所有设备中确定它所要服务的设备，而是指module需要从某一类拥有相同主设备号的设备中确定它要服务的设备。<br />
之<br />
所以这么说，是因为驱动module是对应于某一个主设备号的所有设备的。换一句话说，就是Linux内核只管设备的主设备号，而不理会设备的次设备号是<br />
什么，如果有两个，三个或者更多个设备拥有同一个主设备号，那么不管外部应用程序要操作这些设备中的哪一个，Linux内核都只会调用同一个驱动<br />
module。但是驱动module却不能不管次设备号了，因为它是跟某一个具体的设备打交道的，所以它需要根据open系统调用时传递给它的参数中找到<br />
次设备号，从而确定那唯一的一个设备（也许驱动module也可以同时操作几个设备，但一时也想不起来）。<br />
但是上面所说的通过次设备号找到具体的设备，只是其中一种方法；另外还有一种方法就是通过cdev结构体确定某个具体设备。<br />
设<br />
备所拥有的cdev结构体，或者次设备号，都保存在open函数的inode参数中。我们可以使用container_of宏通过inode所拥有的<br />
cdev确定具体设备，也可以使用iminor宏从inode所拥有的i_rdev确定次设备号(i_rdev是inode结构体中的一个dev_t类型<br />
的变量，其中保存了真正的设备主次编号)。<br />
对于open函数中的file参数，scull程序主要用它来做两件事：其一是将<br />
根据cdev获得的代表设备的scull_dev结构体保存到file-&gt;private_data中，这样就可以方便今后对该设备结构体的访问<br />
了，而不用每次都调用container_of宏或者iminor宏来找到设备结构体了；其二是根据file结构体中的f_flags字段来确定，这次的<br />
open调用，是以写方式打开设备，还是以读方式来打开设备。<br />
<font color="&quot;#009900&quot;"><b>2、read函数</b><br />
驱动module的file_operations结构体中可以定义很多设备操作服务函数，但是我现在关心的是这些函数怎样与系统调用，或者说是外部应用程序交互，而不管具体的设备操作怎么实现，所以只记录read函数作为代表。</font><br />
<font color="&quot;#009900&quot;">read函数的原型如下：<br />
ssize_t read(struct file *filp,&nbsp;&nbsp;char __user *buf,&nbsp;&nbsp;size_t count,&nbsp;&nbsp;loff_t *f_pos)</font><br />
read函数原型中有4个参数，分别是filp，buf，count和f_pos。<br />
其中file结构体指针参数可以用来确定我们要操作的设备，因为在open函数中，我们将代表设备的结构体保存到了filp的private_data字段中。<br />
buf<br />
参数是一个指向用户空间的buffer的指针(buf前面的__user表示用户空间)，对于read来说，就是可以把要传送给外部应用程序的数据放入这<br />
个buffer中。当然，我们不能简单地将数据copy到这个buffer中，而是要使用Linux内核提供的一些函数，比如copy_to_user函<br />
数。<br />
count是请求传送的数据长度。<br />
f_pos是一个指向“long offset type”对象的指针，指明外部应用程序在文件中进行存取操作的位置。<br />
read函数的返回值是有符号整数类型的指，一般是read操作的实际存取数。<br />
<font color="&quot;#009900&quot;"><b>3、release函数</b><br />
release函数的作用正好与open相反，有时候release函数的实现被称为device_close，而不是device_release。但无论那种形式，这个设备方法都应该完成如下任务：<br />
a、释放open分配的，保存在file-&gt;private_data中的所有内容。<br />
b、在最后一次关闭操作时关闭设备。</font><br />
relese函数由close系统调用引起，但并不是每一次close系统调用都<br />
会引起release函数的调用。只有那些真正释放设备数据结构的close系统调用才会引起release函数的调用。因为Linux内核为每个<br />
file结构体维护其被引用多少次的计数器，只有当file结构体的计数器归0时，close系统调用才会引用release函数，这只在删除这个结构时<br />
才会发生，因此每次open驱动程序都只会看到一次对应的一次release调用。<br />
<font color="&quot;#0000ff&quot;"><b>四、 卸载驱动module</b></font><br />
每个重要的模块都需要一个清除函数，该函数在模块被移除前注销接口并向系统中返回所有资源。如果一个模块未定义清除函数，则内核不允许卸载该模块。<br />
Linux<br />
驱动module的卸载可以用/sbin/rmmod<br />
scull.ko命令，这时Linux内核就会调用驱动程序中用module_exit(scull_cleanup_module)特殊宏定义的清除函<br />
数，也就是说，module_exit声明用来帮助Linux内核找到模块的清除函数，在scull程序中，清除函数就是<br />
scull_cleanup_module函数。<br />
模块的清除函数需要撤销初始化函数注册的所有资源，并且习惯上(但不是必须的)以与初始化函数注<br />
册相反的顺序进行撤销。需要注意的是，这里指的初始化函数是指用module_init宏声明的初始化函数，而不是指open函数，与open函数对应的<br />
应当是release函数。<br />
在scull程序中，清除函数主要做了两件事：一是free了所有为scull设备分配的内存；二是收回了初始化函数所注册的设备号。<br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
<br />
<b>本文来自ChinaUnix博客，如果查看原文请点：</b><a href="http://blog.chinaunix.net/u1/39518/showart_423704.html" target="_blank">http://blog.chinaunix.net/u1/39518/showart_423704.html</a> 
</td>

      </tr>


      <tr>

        <td height="20" align="right"> 　 <a href="http://linux.chinaunix.net/bbs/thread-972444-1-1.html"  target="_blank">发表评论</a>

  <a href="http://linux.chinaunix.net/bbs/thread-972444-1-1.html"  target="_blank">查看评论</a>(共有<span class="STYLE1" id ="postcount2"></span>条评论)
<a href="http://linux.chinaunix.net/bbs/forum-41-1.html" target="_blank">我要提问</a>
</td>

      </tr>
      <tr>

        <td>&nbsp;</td>

      </tr>

      

    </table>


</td>

    <td width="8">&nbsp;</td>

    <td width="245" valign="top" bgcolor="#FFF9EB">
<center><br>
<form action="/search2.php" method="GET">
<input type="text" name="key" size="15"><input type=hidden name="id" value=0 ><input type="submit" value="搜索">
</form>
<br>
</center>
<table width="100%" border="0" cellspacing="0" cellpadding="0">

      <tr>

        <td height="27" background="/images/bg245.jpg" class="F13"><table width="100%"><tr><td class="F13">最新资讯</td><td align="right"><a href="/news" target="_blank">更多>></a>&nbsp;</td></tr></table></td>

      </tr>

      <tr>

        <td valign="top" bgcolor="#FFFFFF" class="BLKtext" ><table width="97%" border="0" align="center" cellpadding="0" cellspacing="0">

          <tr>

            <td height="5"></td>

          </tr>

          <tr>

            <td>・ <a href='/news/2010/12/10/1175491.shtml' title='谷歌劝说诺基亚采用Android操作系统' target='_blank'>谷歌劝说诺基亚采用Android操作..</a><br />
・ <a href='/news/2010/12/10/1175493.shtml' title='Apache 基金会确认退出 JCP 执行委员会' target='_blank'>Apache 基金会确认退出 JCP 执..</a><br />
・ <a href='/news/2010/12/07/1175306.shtml' title='Chrome 10 新功能探秘：新增GPU混合加速功能' target='_blank'>Chrome 10 新功能探秘：新增GP..</a><br />
・ <a href='/news/2010/12/07/1175307.shtml' title='金山宣布开源其安全软件' target='_blank'>金山宣布开源其安全软件</a><br />
・ <a href='/news/2010/12/07/1175309.shtml' title='女黑客在开源会议上抱受骚扰' target='_blank'>女黑客在开源会议上抱受骚扰</a><br />
・ <a href='/news/2010/12/07/1175310.shtml' title='21款值得关注的Linux游戏' target='_blank'>21款值得关注的Linux游戏</a><br />
・ <a href='/news/2010/12/07/1175311.shtml' title='马化腾：腾讯半年后彻底转型，开放和分享' target='_blank'>马化腾：腾讯半年后彻底转型，..</a><br />
・ <a href='/news/2010/12/07/1175305.shtml' title='[多图] Chrome OS 预发布版本多图赏析' target='_blank'>[多图] Chrome OS 预发布版本多..</a><br />
・ <a href='/news/2010/12/01/1175001.shtml' title='Lubuntu 11.04 默认应用抢先一览' target='_blank'>Lubuntu 11.04 默认应用抢先一览</a><br />
・ <a href='/news/2010/12/01/1175002.shtml' title='Red Hat宣布收购云计算软件提供商Makara' target='_blank'>Red Hat宣布收购云计算软件提供..</a><br />
</td>

          </tr>

          <tr>

            <td height="5"></td>

          </tr>

        </table></td>

      </tr>

      <tr>

        <td height="10" bgcolor="#FFFFFF"></td>

      </tr>

      <tr></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0">

      <tr>

        <td height="27" background="/images/bg245.jpg" class="F13"><table width="100%"><tr><td class="F13">论坛热点</td><td align="right"><a href="/bbs" target="_blank">更多>></a>&nbsp;</td></tr></table></td>

      </tr>

      <tr>

        <td valign="top" bgcolor="#FFFFFF" class="BLKtext" ><table width="97%" border="0" align="center" cellpadding="0" cellspacing="0">

          <tr>

            <td height="5"></td>

          </tr>

          <tr>

            <td>・ <a href='http://bbs.chinaunix.net/thread-3687970-1-1.html' title='do_execve时候用户栈中参数的位置问题' target='_blank'>do_execve时候用户栈中参数的..</a><br />
・ <a href='http://bbs.chinaunix.net/thread-3687969-1-1.html' title='swapinfo -atm 问题' target='_blank'>swapinfo -atm 问题</a><br />
・ <a href='http://bbs.chinaunix.net/thread-3687968-1-1.html' title='Linux 的优点简述' target='_blank'>Linux 的优点简述</a><br />
・ <a href='http://bbs.chinaunix.net/thread-3687967-1-1.html' title='VM虚拟机上得Red Hat Linux上搭建的ftp服务器，windows登陆不进去，但一个局域网其他' target='_blank'>VM虚拟机上得Red Hat Linux上..</a><br />
・ <a href='http://bbs.chinaunix.net/thread-3687965-1-1.html' title='我看成了上海男人喜欢女人毛多还是毛少' target='_blank'>我看成了上海男人喜欢女人毛..</a><br />
・ <a href='http://bbs.chinaunix.net/thread-3687964-1-1.html' title='校车展览，看了你就知道' target='_blank'>校车展览，看了你就知道</a><br />
・ <a href='http://bbs.chinaunix.net/thread-3687963-1-1.html' title='在遇到他之前，唯一需要做的，就是让自己足够优秀。在遇到他之前，请把最好的年华留给' target='_blank'>在遇到他之前，唯一需要做的..</a><br />
・ <a href='http://bbs.chinaunix.net/thread-3687962-1-1.html' title='GRUB的疑问' target='_blank'>GRUB的疑问</a><br />
・ <a href='http://bbs.chinaunix.net/thread-3687961-1-1.html' title='从来没有人真正付足书价――所付的只是印刷费' target='_blank'>从来没有人真正付足书价――..</a><br />
・ <a href='http://bbs.chinaunix.net/thread-3687960-1-1.html' title='云存储 vs 网盘' target='_blank'>云存储 vs 网盘</a><br />
</td>

          </tr>

          <tr>

            <td height="5"></td>

          </tr>

        </table></td>

      </tr>

      <tr>

        <td height="10" bgcolor="#FFFFFF"></td>

      </tr>

      <tr></table>
<table width="100%" border="0" cellspacing="0" cellpadding="0">

      <tr>

        <td height="27" background="/images/bg245.jpg" class="F13"><table width="100%"><tr><td class="F13">文档更新</td><td align="right"><a href="/techdoc" target="_blank">更多>></a>&nbsp;</td></tr></table></td>

      </tr>

      <tr>

        <td valign="top" bgcolor="#FFFFFF" class="BLKtext" ><table width="97%" border="0" align="center" cellpadding="0" cellspacing="0">

          <tr>

            <td height="5"></td>

          </tr>

          <tr>

            <td>・ <a href='/techdoc/develop/2012/03/16/3686893.shtml' title='orcale queue' target='_blank'>orcale queue</a><br />
・ <a href='/techdoc/develop/2012/03/16/3686868.shtml' title='谁可以推荐几本经典的操作系统的书（英文版）' target='_blank'>谁可以推荐几本经典的操作系统的..</a><br />
・ <a href='/techdoc/develop/2012/03/16/3686867.shtml' title='【北京】某物联网公司招云计算应用高级开发工程师' target='_blank'>【北京】某物联网公司招云计算应..</a><br />
・ <a href='/techdoc/develop/2012/03/16/3686866.shtml' title='【北京】某物联网公司招云计算应用高级开发工程师' target='_blank'>【北京】某物联网公司招云计算应..</a><br />
・ <a href='/techdoc/develop/2012/03/16/3686865.shtml' title='谁能推荐几本关于操作系统的书' target='_blank'>谁能推荐几本关于操作系统的书</a><br />
・ <a href='/techdoc/develop/2012/03/16/3686864.shtml' title='如何添加网络接口eth1' target='_blank'>如何添加网络接口eth1</a><br />
・ <a href='/techdoc/develop/2012/03/16/3686863.shtml' title='葡萄牙语入门教材的选取与经验分享' target='_blank'>葡萄牙语入门教材的选取与经验分享</a><br />
・ <a href='/techdoc/develop/2012/03/16/3686862.shtml' title='葡萄牙语就业前景分析' target='_blank'>葡萄牙语就业前景分析</a><br />
・ <a href='/techdoc/develop/2012/03/16/3686861.shtml' title='葡萄牙语学习经验交流' target='_blank'>葡萄牙语学习经验交流</a><br />
・ <a href='/techdoc/develop/2012/03/16/3686860.shtml' title='Щ' target='_blank'>Щ</a><br />
</td>

          </tr>

   
        </table></td>

      </tr>


      <tr></table>
</td>

  </tr>

</table>
<script src="/js/threadcount.php?tid=972444"></script>
<table width="950" border="0" align="center" cellpadding="0" cellspacing="0">

  <tr>

    <td>&nbsp;</td>

  </tr>

</table>

<table width="950" border="0" align="center" cellpadding="0" cellspacing="0">

  <tr>

    <td height="2" bgcolor="#308CF6"></td>

  </tr>

  <tr>

    <td height="30" align="center"><a href="http://www.chinaunix.net/about/index.shtml" target="_blank">关于我们</a> | <a href="http://www.chinaunix.net/about/connect.html" target="_blank">联系方式</a> | <a href="http://www.chinaunix.net/about/service.html" target="_blank">广告合作</a> | <a href="http://www.wintalent.cn:8031/wt5/sequelmedia/web/index" target="_blank">诚聘英才</a> | <a href="http://www.chinaunix.net/about/channel.html" target="_blank">网站地图</a> | <a href="http://www.chinaunix.net/about/friend.html" target="_blank">友情链接</a> | <a href="http://linux.chinaunix.net/bbs/register.php" target="_blank">免费注册</a></td>

  </tr>

  <tr>

    <td height="2" bgcolor="#308CF6"></td>

  </tr>

  <tr>

    <td align="center"><p>Copyright &copy; 2001-2009 ChinaUnix.net All Rights Reserved</p>

        <p>感谢所有关心和支持过ChinaUnix的朋友们<br />
	<p>
 <a href="http://www.it168.com/images/icp.jpg" target="_blank">京ICP证:060528号</a></p></td>

  </tr>

</table>

<!-- 统计 START -->
<script src="http://stat.it168.com/pv.js" type="text/javascript"></script>
<script>
function sendPV(){
    var pvTrack = new PvTrack();
    pvTrack.type = 10; // 频道类别ID
    pvTrack.channel = 22; // 频道ID
   
    pvTrack.pageType = 0;
    pvTrack.track();
}
window.setTimeout("sendPV()", 0);
</script>
<script language="javascript" src="http://bbs.chinaunix.net/googlepv/pv.js" type="text/javascript"></script>
<!-- 统计 .END -->
<div style='display:none'>
<script type="text/javascript"> 
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F0ee5e8cdc4d43389b3d1bfd76e83216b' type='text/javascript'%3E%3C/script%3E"));
</script>
</div>

<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-11982772-4");
pageTracker._trackPageview();
} catch(err) {}
</script>
<script type='text/javascript' src='http://168.it168.com/js/601.js'></script>



</body>

</html>
