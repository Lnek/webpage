<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>Python.Paste指南之WebOb</title>
		<meta name="keywords" content="Python" />
        <meta name="description" content="null" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" type="text/css" href="http://cdn.verydemo.com/css/base.css">
        <link rel="stylesheet" type="text/css" href="http://cdn.verydemo.com/css/common.css">
        <script src="http://cdn.verydemo.com/js/jquery.min.js" type="text/javascript"></script>
        <script src="http://cdn.verydemo.com/js/common.js" type="text/javascript"></script>
        <!--[if IE 6]>
        <script src="http://cdn.verydemo.com/js/DD_belatedPNG_0.0.8a-min.js" type="text/javascript"></script>
        <![endif]--><link rel="stylesheet" type="text/css" href="/css/content.css">
		<link rel="stylesheet" type="text/css" href="/admin/js/kindeditor/plugins/code/prettify.css">
		<script src="/js/message.js" type="text/javascript"></script>
		<script src="/js/lazyload.js" type="text/javascript"></script>
		<script src="/admin/js/kindeditor/plugins/code/prettify.js" type="text/javascript"></script>
		<script>$(function(){prettyPrint();$("pre").css("white-space","pre-wrap");});</script>
		<style type="text/css">
			.top-div,.nav-div,.main-div{
			  width:1001px;
			}
			.main-div{
			  font-size:14px;
			}
			.main-div .left-div{
			 width:686px;
			 overflow:hidden;
			}
			.main-div .right-div{
			 width:302px;
			 overflow:hidden;
			}
			.tag-div .tag2 .content2 ul li {
			 width:280px;
			 background: url("../images/dot1.gif") no-repeat 0px 11px;
			 height: 26px;
			 line-height:26px;
			}
			.tag-div .tag2 .content2 ul li a{
			  color:#4CB7EA;
			  font-family: "微软雅黑";
			  font-weight: bolder;
			}
			.tag-div .tag2 .content2 ul li a:hover{
			  color: #646464;
			}
			.tag-div .tag2 .content3 .list .right {
			width: 221px;
			}
		</style>
	</head>
	<body>
	<!--顶部-->
		<div class="w100p">
			<div class="top-div center">
				<div class="logo-div">
					<a href="/"><img src="http://cdn.verydemo.com/images/logo.gif" alt="Logo" width="244" height="74"/></a>
				</div>
				<div class="search-div">
					<div class="left">
						<input id="searchInput" class="input" type="text" value="请输入搜索条件…" />
					</div>
					<div class="right">
						<a id="searchButton" href="#" target="_blank">搜&nbsp;索</a>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						<a id="advancedSearchButton" href="#" target="_blank">高级搜索</a>
					</div>
					<div class="cl">
					</div>
				</div>
				<div class="hot-search-div">
				  热门搜索： <a href="/search/?kw=JQuery%20%E6%8F%92%E4%BB%B6">JQuery 插件</a>&nbsp;
				           <a href="/search/?kw=Struts">Struts</a>&nbsp;
				           <a href="/search/?kw=Spring">Spring</a>&nbsp;
				           <a href="/search/?kw=Hibernate">Hibernate</a>&nbsp;
				           <a href="/search/?kw=%E6%95%B0%E6%8D%AE%E5%BA%93">数据库</a>&nbsp;
				           <a href="/search/?kw=Linux">Linux</a>&nbsp;
				           <a href="/search/?kw=Android">Android</a>&nbsp;
				           <a href="/search/?kw=Iphone">Iphone</a>&nbsp;
				           <a href="/search/?kw=%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F">设计模式</a>&nbsp;
				</div>
				<div class="reg-login">
					<a target="_blank" href="http://www.codemach.com">代码机器</a>&nbsp;
					<a target="_blank" href="/library.html">书籍下载</a>&nbsp;
					<a target="_blank" href="/search/?kw=%E9%9D%A2%E8%AF%95%E9%A2%98">面试题库</a>&nbsp;
					<a target="_blank" href="/map.html">网站地图</a>
				</div>
			</div>
		</div>
		<!--顶部结束-->
		<!--导航-->
		<div class="w100p">
			<div class="nav-div" style="padding-bottom:5px;">
				<ul id="navUl">
				    <li><a href="/">首页</a></li>
					<li class="active"><a href="/one_c52.html">编程语言</a></li>
					<li><a href="/one_c53.html">Web开发</a></li>
					<li><a href="/one_c54.html">前端技术</a></li>
					<li><a href="/one_c55.html">移动开发</a></li>
					<li><a href="/one_c56.html">数据库</a></li>
					<li><a href="/one_c57.html">操作系统</a></li>
					<li><a href="/one_c58.html">嵌入开发</a></li>
					<li><a href="/one_c59.html">网络安全</a></li>
					<li><a href="/one_c60.html">办公软件</a></li>
					</ul>
				<div class="cl"></div>
				<div class="nav-more-div">
					<a href="/map.html">全部列表&gt;&gt;</a>
				</div>
			</div>
		</div>
		<!--导航结束--><!--主架构-->
		<div class="w100p">
			 <div class="content-title rel" style="width:1001px;margin:0 auto;">
				<h1>Python.Paste指南之WebOb</h1>
			 </div>
		</div>
		<div class="w100p">
			<div class="main-div">
				<!--左架构-->
				<div class="left-div">
					<div class="content-info rel">
						<span class="kind">分类：</span>
						<a href="/one_c52.html">编程语言</a><span class="kind">/</span>
						<a href="/two_c122.html">Python</a><span class="kind">/</span>
						<a href="/two_c122.html">文章</a>
						</div>
					<div class="content-content" id="verydemo_content_div">
					<link href="/js/syntaxhighlighter/SyntaxHighlighter.css" rel="stylesheet" type="text/css" />
<div id="article_content" class="article_content">

<p>http://tumblr.wachang.net/post/38145599659/post-paste-webob-1</p>
<p></p>
<p >
次主要来学习Paste的核心内容，WebOb，内容依然来自官方翻译、网络参考以及自己的实践。</p>
<h3 >What is WebOb?</h3>
<p >
WebOb是一个Python库，主要是用在WSGI中对请求环境变量request environment（也就是WSGI应用中的参数environ）进行包装（提供wrapper），并提供了一个对象来方便的处理返回response消息。WebOb提供的对象映射了大多数的HTTP方法，包括头解析，content协商等。这里的映射，就是说只需要对对象进行操作，就可以完成HHTP的方法，从而大大简化开发难度。引用官方文档，WebOb有以下特点：</p>
<blockquote >
<p>Maps most of HTTP spec to friendly data structures. Time-proven codebase that works around and hides all known WSGI quirks. Zero known issues (reported bugs are always fixed ASAP). 100% test coverage. No external dependencies. Supports Python 3</p>
</blockquote>
<p >
WebOb为HTTP的请求和相应提供了相应的对象。通过对WSGI request environment进行wrap来简化操作。</p>
<h3 >Request</h3>
<p >
<code >webob.Request</code>对象是对WSGI environ dictionary的一个包装。后者这个字典以键&#20540;的形式描述了一个HTTP请求包括path信息和query string，以及一个与文件对象类&#20284;的秒速请求的body，以及一些其他的自定义keys。如下可以创建一个简单的Request对象。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="kwd" >from</span><span class="pln" > webob </span><span class="kwd" >import</span><span class="pln" > </span><span class="typ" >Request</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" >environ </span><span class="pun" >=</span><span class="pln" > </span><span class="pun" >{</span><span class="str" >'method'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'GET'</span><span class="pun" >}</span><span class="pln" >  
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" >req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >(</span><span class="pln" >environ</span><span class="pun" >)</span><span class="pln" > </span></code></pre>
<p >
强调，<code >The request object wraps the environment</code>，仅仅是包装，所以你可以对这个environ进行读写的。可以通过req.environ可以访问到这个environ。但是一般都没必要这样做，直接用这个Request对象来操作就好了。如下：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >environ
</span><span class="pun" >{</span><span class="str" >'method'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'GET'</span><span class="pun" >}</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >method 
</span><span class="str" >'GET'</span></code></pre>
<p >
此外，还有，req.accept_language, req.content_length, req.user_agent等。我们可以通过dir(req)来看看这个对象的方法咯。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" >dir</span><span class="pun" >(</span><span class="pln" >req</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >[</span><span class="str" >'GET'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'POST'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'ResponseClass'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__class__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__delattr__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__dict__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__doc__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__format__'</span><span class="pun" >,</span><span class="pln" >  </span><span class="str" >'__getattr__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__getattribute__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__hash__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__init__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__module__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__new__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__reduce__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__reduce_ex__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__repr__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__setattr__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__sizeof__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__str__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__subclasshook__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'__weakref__'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_body__del'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_body__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_body__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_body_file__del'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_body_file__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_body_file__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_cache_control__del'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_cache_control__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_cache_control__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_charset'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_check_charset'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_content_type__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_content_type__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_content_type_raw'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_copy_body_tempfile'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_headers'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_headers__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_headers__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_host__del'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_host__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_host__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_is_body_readable__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_is_body_readable__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_json_body__del'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_json_body__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_json_body__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_setattr_stacklevel'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_text__del'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_text__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_text__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_update_cache_control'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_urlargs__del'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_urlargs__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_urlargs__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_urlvars__del'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_urlvars__get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'_urlvars__set'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'accept'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'accept_charset'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'accept_encoding'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'accept_language'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'application_url'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'as_bytes'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'as_string'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'as_text'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'authorization'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'blank'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'body'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'body_file'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'body_file_raw'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'body_file_seekable'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'cache_control'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'call_application'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'charset'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'client_addr'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'content_length'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'content_type'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'cookies'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'copy'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'copy_body'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'copy_get'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'date'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'decode'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'encget'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'encset'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'environ'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'from_bytes'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'from_file'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'from_string'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'from_text'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'get_response'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'headers'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'host'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'host_port'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'host_url'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'http_version'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'if_match'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'if_modified_since'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'if_none_match'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'if_range'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'if_unmodified_since'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'is_body_readable'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'is_body_seekable'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'is_xhr'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'json'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'json_body'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'make_body_seekable'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'make_default_send_app'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'make_tempfile'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'max_forwards'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'method'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'params'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'path'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'path_info'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'path_info_peek'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'path_info_pop'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'path_qs'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'path_url'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'pragma'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'query_string'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'range'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'referer'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'referrer'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'relative_url'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'remote_addr'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'remote_user'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'remove_conditional_headers'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'request_body_tempfile_limit'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'scheme'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'script_name'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'send'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'server_name'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'server_port'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'str_GET'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'str_POST'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'str_cookies'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'str_params'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'text'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'upath_info'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'url'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'url_encoding'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'urlargs'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'urlvars'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'uscript_name'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'user_agent'</span><span class="pun" >]</span></code></pre>
<p >
{% endcodeblock %}</p>
<p >
一个WSGI的environ需要一些必须的参数，所以Request对象有一个构造器，在创建的时候就会自动添加最小的一些必要的项，如上，我们只指定了一个method，那么我们看看。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req
</span><span class="pun" >&lt;</span><span class="typ" >Request</span><span class="pln" > at </span><span class="lit" >0x2bbb4d0</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >invalid WSGI environ</span><span class="pun" >)&gt;</span></code></pre>
<p >
显示这个WSGI environ是无效的，因为缺少必要的信息。我们来调用构造器的方法：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pln" >req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >.</span><span class="pln" >blank</span><span class="pun" >(</span><span class="str" >'/article?id=1'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > </span><span class="kwd" >from</span><span class="pln" > pprint </span><span class="kwd" >import</span><span class="pln" > pprint
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > pprint</span><span class="pun" >(</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >environ</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >{</span><span class="str" >'HTTP_HOST'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'localhost:80'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'PATH_INFO'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'/article'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'QUERY_STRING'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'id=1'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'REQUEST_METHOD'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'GET'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'SCRIPT_NAME'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >''</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'SERVER_NAME'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'localhost'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'SERVER_PORT'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'80'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'SERVER_PROTOCOL'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'HTTP/1.0'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.errors'</span><span class="pun" >:</span><span class="pln" > </span><span class="pun" >&lt;</span><span class="pln" >open file </span><span class="str" >'&lt;stderr&gt;'</span><span class="pun" >,</span><span class="pln" > mode </span><span class="str" >'w'</span><span class="pln" > at </span><span class="pun" >...&gt;,</span><span class="pln" >
 </span><span class="str" >'wsgi.input'</span><span class="pun" >:</span><span class="pln" > </span><span class="pun" >&lt;...</span><span class="pln" >IO</span><span class="pun" >...</span><span class="pln" > </span><span class="kwd" >object</span><span class="pln" > at </span><span class="pun" >...&gt;,</span><span class="pln" >
 </span><span class="str" >'wsgi.multiprocess'</span><span class="pun" >:</span><span class="pln" > </span><span class="kwd" >False</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.multithread'</span><span class="pun" >:</span><span class="pln" > </span><span class="kwd" >False</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.run_once'</span><span class="pun" >:</span><span class="pln" > </span><span class="kwd" >False</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.url_scheme'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'http'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.version'</span><span class="pun" >:</span><span class="pln" > </span><span class="pun" >(</span><span class="lit" >1</span><span class="pun" >,</span><span class="pln" > </span><span class="lit" >0</span><span class="pun" >)}</span></code></pre>
<p >
pprint用来打印字典等效果很好的。这里简单对url做一个说明，/article?id=1我们可以看到article是属于PATH中的，而?分割的是参数，也就是query_string。如果指定了多个参数，也是一起放在QUERY_STRING里面的，如下：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >.</span><span class="pln" >blank</span><span class="pun" >(</span><span class="str" >'/article?id=1&amp;id=2'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > pprint</span><span class="pun" >(</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >environ</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >{</span><span class="str" >'HTTP_HOST'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'localhost:80'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'PATH_INFO'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'/article'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'QUERY_STRING'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'id=1&amp;id=2'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'REQUEST_METHOD'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'GET'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'SCRIPT_NAME'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >''</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'SERVER_NAME'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'localhost'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'SERVER_PORT'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'80'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'SERVER_PROTOCOL'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'HTTP/1.0'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.errors'</span><span class="pun" >:</span><span class="pln" > </span><span class="pun" >&lt;</span><span class="pln" >open file </span><span class="str" >'&lt;stderr&gt;'</span><span class="pun" >,</span><span class="pln" > mode </span><span class="str" >'w'</span><span class="pln" > at </span><span class="lit" >0x7f33b863a270</span><span class="pun" >&gt;,</span><span class="pln" >
 </span><span class="str" >'wsgi.input'</span><span class="pun" >:</span><span class="pln" > </span><span class="pun" >&lt;</span><span class="pln" >_io</span><span class="pun" >.</span><span class="typ" >BytesIO</span><span class="pln" > </span><span class="kwd" >object</span><span class="pln" > at </span><span class="lit" >0x2b94e30</span><span class="pun" >&gt;,</span><span class="pln" >
 </span><span class="str" >'wsgi.multiprocess'</span><span class="pun" >:</span><span class="pln" > </span><span class="kwd" >False</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.multithread'</span><span class="pun" >:</span><span class="pln" > </span><span class="kwd" >False</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.run_once'</span><span class="pun" >:</span><span class="pln" > </span><span class="kwd" >False</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.url_scheme'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'http'</span><span class="pun" >,</span><span class="pln" >
 </span><span class="str" >'wsgi.version'</span><span class="pun" >:</span><span class="pln" > </span><span class="pun" >(</span><span class="lit" >1</span><span class="pun" >,</span><span class="pln" > </span><span class="lit" >0</span><span class="pun" >)}</span></code></pre>
<h2 >
Request body</h2>
<p >
req.body是一个描述了请求body（比如，POST一个表单，PUT的内容）的一个类文件对象（file-like object），我们先把body设置为一个字符串，会被自动转换为一个类文件对象，通过req.body可以访问到body的内容。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >body</span><span class="pun" >=</span><span class="str" >&quot;this is body&quot;</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >body
</span><span class="str" >'this is body'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > type</span><span class="pun" >(</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >body</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&lt;</span><span class="pln" >type </span><span class="str" >'str'</span><span class="pun" >&gt;</span></code></pre>
<h2 >
Method &amp; URL</h2>
<p >
一个请求的所有属性都可以通过Request对象的属性来访问，这些属性如下： 一个请求对象里面比较重要的属性有以下：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >scheme
</span><span class="str" >'http'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >method
</span><span class="str" >'GET'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >GET
GET</span><span class="pun" >([(</span><span class="pln" >u</span><span class="str" >'id'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'1'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'id'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'2'</span><span class="pun" >)])</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="kwd" >params</span><span class="pln" >
</span><span class="typ" >NestedMultiDict</span><span class="pun" >([(</span><span class="pln" >u</span><span class="str" >'id'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'1'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'id'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'2'</span><span class="pun" >)])</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >body
</span><span class="str" >'this is body'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >headers
</span><span class="pun" >&lt;</span><span class="pln" >webob</span><span class="pun" >.</span><span class="pln" >headers</span><span class="pun" >.</span><span class="typ" >EnvironHeaders</span><span class="pln" > </span><span class="kwd" >object</span><span class="pln" > at </span><span class="lit" >0x2bbbc10</span><span class="pun" >&gt;</span><span class="pln" >
</span><span class="str" >&quot;&quot;&quot;
&gt;&gt;&gt; req.script_name  # The base of the URL
&gt;&gt;&gt; req.script_name = '/blog' # make it more interesting
&gt;&gt;&gt; req.path_info    # The yet-to-be-consumed part of the URL
'/article'
&gt;&gt;&gt; req.content_type # Content-Type of the request body
&quot;&quot;&quot;</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >host
</span><span class="str" >'localhost:80'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >host_url
</span><span class="str" >'http://localhost'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >application_url
</span><span class="str" >'http://localhost/blog'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >path_url
</span><span class="str" >'http://localhost/blog/article'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >url
</span><span class="str" >'http://localhost/blog/article?id=1'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >path
</span><span class="str" >'/blog/article'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >path_qs
</span><span class="str" >'/blog/article?id=1'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >query_string
</span><span class="str" >'id=1'</span><span class="pln" >
req</span><span class="pun" >.</span><span class="pln" >POST
req</span><span class="pun" >.</span><span class="pln" >cookies
req</span><span class="pun" >.</span><span class="pln" >urlvars</span><span class="pun" >或者</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >urlargs</span></code></pre>
<p >
对于一个URL，由于我们需要处理PATH_INFO，所以还有以下几种使用：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >path_info_peek</span><span class="pun" >()</span><span class="pln" > </span><span class="com" ># Doesn't change request</span><span class="pln" >
</span><span class="str" >'article'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >path_info_pop</span><span class="pun" >()</span><span class="pln" >  </span><span class="com" ># Does change request!</span><span class="pln" >
</span><span class="str" >'article'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >script_name
</span><span class="str" >'/blog/article'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >path_info </span><span class="com" >#上面已经pop了，所以这里是空，否则应该是'/article'的。</span><span class="pln" >
</span><span class="str" >''</span></code></pre>
<h2 >
Headers</h2>
<p >
一个请求的header主要是content的定义以及host的定义，可能还会带有一些认证信息。注意，这里的操作大小写敏感。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >headers</span><span class="pun" >[</span><span class="str" >'Content-Type'</span><span class="pun" >]</span><span class="pln" > </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'application/x-www-urlencoded'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >headers</span><span class="pun" >.</span><span class="pln" >items</span><span class="pun" >()</span><span class="pln" >
</span><span class="pun" >[(</span><span class="str" >'Content-Length'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'4'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="str" >'Content-Type'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'application/x-www-urlencoded'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="str" >'Host'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'localhost:80'</span><span class="pun" >)]</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >environ</span><span class="pun" >[</span><span class="str" >'CONTENT_TYPE'</span><span class="pun" >]</span><span class="pln" >
</span><span class="str" >'application/x-www-urlencoded'</span></code></pre>
<h2 >
Query &amp; POST</h2>
<p >
请求可以在两个位置拥有变量，一个是query string（类&#20284;上面的?id=1）,二是在body里面（常用于POST表单），但是即便是POST请求也可以拥有query string。所以这两个位置都可能存在变量。并且一个变量可能出现多次，比如<code >?check=a&amp;check=b</code></p>
<p >
对于上面的东西，WebOb使用了多字典（MultiDict）的形式。所谓MultiDict,就在把一个包含键&#20540;对的列表包装成一个字典，看起来就像一个单&#20540;字典（single valued dict），但是你可以获得某一个key的所有&#20540;，通过.getall(key)(始终返回一个列表)，也可以通过.items()来获得所有的键&#20540;对以及.values()获得所有的&#20540;。举个例子：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >.</span><span class="pln" >blank</span><span class="pun" >(</span><span class="str" >'/test?check=a&amp;check=b&amp;name=Bob'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >GET
</span><span class="typ" >MultiDict</span><span class="pun" >([(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'a'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'b'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'name'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'Bob'</span><span class="pun" >)])</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >GET</span><span class="pun" >[</span><span class="str" >'check'</span><span class="pun" >]</span><span class="pln" >
u</span><span class="str" >'b'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >GET</span><span class="pun" >.</span><span class="pln" >getall</span><span class="pun" >(</span><span class="str" >'check'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >[</span><span class="pln" >u</span><span class="str" >'a'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'b'</span><span class="pun" >]</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >GET</span><span class="pun" >.</span><span class="pln" >items</span><span class="pun" >()</span><span class="pln" >
</span><span class="pun" >[(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'a'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'b'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'name'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'Bob'</span><span class="pun" >)]</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >GET</span><span class="pun" >.</span><span class="pln" >values</span><span class="pun" >()</span><span class="pln" >
</span><span class="pun" >[</span><span class="pln" >u</span><span class="str" >'a'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'b'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'Bob'</span><span class="pun" >]</span></code></pre>
<p >
接下来，我们把req变成一个POST请求。无非就是做两个事，一是更改method，一是给出body。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >POST
</span><span class="pun" >&lt;</span><span class="typ" >NoVars</span><span class="pun" >:</span><span class="pln" > </span><span class="typ" >Not</span><span class="pln" > a form request</span><span class="pun" >&gt;</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >POST</span><span class="pun" >.</span><span class="pln" >items</span><span class="pun" >()</span><span class="pln" >  </span><span class="com" ># NoVars can be read like a dict, but not written</span><span class="pln" >
</span><span class="pun" >[]</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >method </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'POST'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >body </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'name=Joe&amp;email=joe@example.com'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >POST
</span><span class="typ" >MultiDict</span><span class="pun" >([(</span><span class="pln" >u</span><span class="str" >'name'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'Joe'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'email'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'joe@example.com'</span><span class="pun" >)])</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >POST</span><span class="pun" >[</span><span class="str" >'name'</span><span class="pun" >]</span><span class="pln" >
u</span><span class="str" >'Joe'</span></code></pre>
<p >
前面我们提到，一个请求的变量（也可以较为参数）可以存在于URL中也可以在Body中，如果我们不关心变量的位置，那么用req.params就可以看到所有位置的变量，同样，也是通过MultiDict这种形式保存的。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="kwd" >params</span><span class="pln" >
</span><span class="typ" >NestedMultiDict</span><span class="pun" >([(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'a'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'b'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'name'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'Bob'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'name'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'Joe'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'email'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'joe@example.com'</span><span class="pun" >)])</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="kwd" >params</span><span class="pun" >[</span><span class="str" >'name'</span><span class="pun" >]</span><span class="pln" >
u</span><span class="str" >'Bob'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="kwd" >params</span><span class="pun" >.</span><span class="pln" >getall</span><span class="pun" >(</span><span class="str" >'name'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >[</span><span class="pln" >u</span><span class="str" >'Bob'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'Joe'</span><span class="pun" >]</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > </span><span class="kwd" >for</span><span class="pln" > name</span><span class="pun" >,</span><span class="pln" > value </span><span class="kwd" >in</span><span class="pln" > req</span><span class="pun" >.</span><span class="kwd" >params</span><span class="pun" >.</span><span class="pln" >items</span><span class="pun" >():</span><span class="pln" >
</span><span class="pun" >...</span><span class="pln" >     </span><span class="kwd" >print</span><span class="pln" > </span><span class="str" >'%s: %r'</span><span class="pln" > </span><span class="pun" >%</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >name</span><span class="pun" >,</span><span class="pln" > value</span><span class="pun" >)</span><span class="pln" >
check</span><span class="pun" >:</span><span class="pln" > u</span><span class="str" >'a'</span><span class="pln" >
check</span><span class="pun" >:</span><span class="pln" > u</span><span class="str" >'b'</span><span class="pln" >
name</span><span class="pun" >:</span><span class="pln" > u</span><span class="str" >'Bob'</span><span class="pln" >
name</span><span class="pun" >:</span><span class="pln" > u</span><span class="str" >'Joe'</span><span class="pln" >
email</span><span class="pun" >:</span><span class="pln" > u</span><span class="str" >'joe@example.com'</span></code></pre>
<p >
相对而言，这种方式还很简单一点。至于GET和POST，命名是历史遗留下的。req.GET也可以使用在非GET的请求中，从而来获得参数。如下：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >.</span><span class="pln" >blank</span><span class="pun" >(</span><span class="str" >'/test?check=a&amp;check=b&amp;name=Bob'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >method </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'PUT'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >body </span><span class="pun" >=</span><span class="pln" > body </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'var1=value1&amp;var2=value2&amp;rep=1&amp;rep=2'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >environ</span><span class="pun" >[</span><span class="str" >'CONTENT_LENGTH'</span><span class="pun" >]</span><span class="pln" > </span><span class="pun" >=</span><span class="pln" > str</span><span class="pun" >(</span><span class="pln" >len</span><span class="pun" >(</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >body</span><span class="pun" >))</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >environ</span><span class="pun" >[</span><span class="str" >'CONTENT_TYPE'</span><span class="pun" >]</span><span class="pln" > </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'application/x-www-form-urlencoded'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >GET
</span><span class="typ" >MultiDict</span><span class="pun" >([(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'a'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'b'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'name'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'Bob'</span><span class="pun" >)])</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >POST
</span><span class="typ" >MultiDict</span><span class="pun" >([(</span><span class="pln" >u</span><span class="str" >'var1'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'value1'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'var2'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'value2'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'rep'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'1'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'rep'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'2'</span><span class="pun" >)])</span></code></pre>
<p >
另外，应用中，应该强制使用UTF-8编码，也是通过制定字符集参数。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >charset </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'utf8'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >GET
</span><span class="typ" >MultiDict</span><span class="pun" >([(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'a'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'check'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'b'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'name'</span><span class="pun" >,</span><span class="pln" > u</span><span class="str" >'Bob'</span><span class="pun" >)])</span></code></pre>
<p >
<br>
</p>
<p >
</p>
<p >
继续记录吧。如果</p>
<h3 >Modifying the request</h3>
<p >
req.copy()会拷贝这个请求，包括environ字典以及来自environ[‘wsgi.input’]的body信息。</p>
<h3 >Calling WSGI Applications</h3>
<p >
熟悉了WSGI以后，这个request对象明显就是给WSGI应用来使用的。这里有一种subrequest形式，这个如何解释我还要看一下，使用形式如下：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >.</span><span class="pln" >blank</span><span class="pun" >(</span><span class="str" >'/'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > </span><span class="kwd" >def</span><span class="pln" > wsgi_app</span><span class="pun" >(</span><span class="pln" >environ</span><span class="pun" >,</span><span class="pln" > start_response</span><span class="pun" >):</span><span class="pln" >
</span><span class="pun" >...</span><span class="pln" >     start_response</span><span class="pun" >(</span><span class="str" >'200 OK'</span><span class="pun" >,</span><span class="pln" > </span><span class="pun" >[(</span><span class="str" >'Content-type'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'text/plain'</span><span class="pun" >)])</span><span class="pln" >
</span><span class="pun" >...</span><span class="pln" >     </span><span class="kwd" >return</span><span class="pln" > </span><span class="pun" >[</span><span class="str" >'Hi!'</span><span class="pun" >]</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >call_application</span><span class="pun" >(</span><span class="pln" >wsgi_app</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >(</span><span class="str" >'200 OK'</span><span class="pun" >,</span><span class="pln" > </span><span class="pun" >[(</span><span class="str" >'Content-type'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'text/plain'</span><span class="pun" >)],</span><span class="pln" > </span><span class="pun" >[</span><span class="str" >'Hi!'</span><span class="pun" >])</span></code></pre>
<p >
返回的结果是&nbsp;<code >(status_string, header_list, app_iter)</code>的形式，如果返回的app_iter有close()方法，则需要我们自己去执行。&nbsp;应用返回的信息，是给response用的，所以我们用Response对象来处理返回信息。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res </span><span class="pun" >=</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >get_response</span><span class="pun" >(</span><span class="pln" >wsgi_app</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res
</span><span class="pun" >&lt;</span><span class="typ" >Response</span><span class="pln" > </span><span class="pun" >...</span><span class="pln" > </span><span class="lit" >200</span><span class="pln" > OK</span><span class="pun" >&gt;</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >status
</span><span class="str" >'200 OK'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >headers
</span><span class="typ" >ResponseHeaders</span><span class="pun" >([(</span><span class="str" >'Content-type'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'text/plain'</span><span class="pun" >)])</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >body
</span><span class="str" >'Hi!'</span></code></pre>
<p >
如果需要在Request中加入一些自定义的属性，那就这么做：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >.</span><span class="pln" >blank</span><span class="pun" >(</span><span class="str" >'/'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >some_attr </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'blah blah blah'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > new_req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >(</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >environ</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > new_req</span><span class="pun" >.</span><span class="pln" >some_attr
</span><span class="str" >'blah blah blah'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >environ</span><span class="pun" >[</span><span class="str" >'webob.adhoc_attrs'</span><span class="pun" >]</span><span class="pln" >
</span><span class="pun" >{</span><span class="str" >'some_attr'</span><span class="pun" >:</span><span class="pln" > </span><span class="str" >'blah blah blah'</span><span class="pun" >}</span></code></pre>
<h3 >Response</h3>
<p >
接下来就是另外一个大部分Response。 Response对象包含了所有产生WSGI respnse的内容，它的实例其实就是一个WSGI 应用。一个WSGI的回应包含了<code >一个状态status,一个header的列表，一个body（或者一个能产生body的迭代器）</code></p>
<h4 >
Core Attributes核心属性</h4>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > </span><span class="kwd" >from</span><span class="pln" > webob </span><span class="kwd" >import</span><span class="pln" > </span><span class="typ" >Response</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Response</span><span class="pun" >()</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >status
</span><span class="str" >'200 OK'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >headerlist
</span><span class="pun" >[(</span><span class="str" >'Content-Type'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'text/html; charset=UTF-8'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="str" >'Content-Length'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'0'</span><span class="pun" >)]</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >body
</span><span class="str" >''</span></code></pre>
<p >
当然这些&#20540;都是可以设置的。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >status </span><span class="pun" >=</span><span class="pln" > </span><span class="lit" >404</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >status
</span><span class="str" >'404 Not Found'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >status_code
</span><span class="lit" >404</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >headerlist </span><span class="pun" >=</span><span class="pln" > </span><span class="pun" >[(</span><span class="str" >'Content-type'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'text/html'</span><span class="pun" >)]</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >body </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'test'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > </span><span class="kwd" >print</span><span class="pln" > res
</span><span class="lit" >404</span><span class="pln" > </span><span class="typ" >Not</span><span class="pln" > </span><span class="typ" >Found</span><span class="pln" >
</span><span class="typ" >Content</span><span class="pun" >-</span><span class="pln" >type</span><span class="pun" >:</span><span class="pln" > text</span><span class="pun" >/</span><span class="pln" >html
</span><span class="typ" >Content</span><span class="pun" >-</span><span class="typ" >Length</span><span class="pun" >:</span><span class="pln" > </span><span class="lit" >4</span><span class="pln" >

test</span></code></pre>
<p >
当然，这些属性都可以通过构造器设置，如<code >Response(charset='utf8')</code></p>
<h4 >
Headers</h4>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >headers
</span><span class="typ" >ResponseHeaders</span><span class="pun" >([(</span><span class="str" >'Content-Type'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'text/html; charset=utf8'</span><span class="pun" >),</span><span class="pln" > </span><span class="pun" >(</span><span class="str" >'Content-Length'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'4'</span><span class="pun" >)])</span></code></pre>
<p >
元组列表，通过 res.headers.add(key, value) 和res.headers.getall(key)添加和读取，一个key可以对应多个&#20540;。</p>
<h4 >
Body &amp; app_iter</h4>
<p >
res.body包含了整个返回body，就是一个字符串！还有另外一种形式res.app_iter属性，表示body是一个迭代器。WSGI应用可以返回这这些迭代器，而不用返回字符串。看下面的例子：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Response</span><span class="pun" >(</span><span class="pln" >content_type</span><span class="pun" >=</span><span class="str" >'text/plain'</span><span class="pun" >,</span><span class="pln" > charset</span><span class="pun" >=</span><span class="kwd" >None</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > f </span><span class="pun" >=</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >body_file
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > f</span><span class="pun" >.</span><span class="pln" >write</span><span class="pun" >(</span><span class="str" >'hey'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > f</span><span class="pun" >.</span><span class="pln" >write</span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'test'</span><span class="pun" >)</span><span class="pln" >
</span><span class="typ" >Traceback</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >most recent call </span><span class="kwd" >last</span><span class="pun" >):</span><span class="pln" >
  </span><span class="pun" >.</span><span class="pln" > </span><span class="pun" >.</span><span class="pln" > </span><span class="pun" >.</span><span class="pln" >
</span><span class="typ" >TypeError</span><span class="pun" >:</span><span class="pln" > </span><span class="typ" >You</span><span class="pln" > can only write unicode to </span><span class="typ" >Response</span><span class="pln" > </span><span class="kwd" >if</span><span class="pln" > charset has been </span><span class="kwd" >set</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > f</span><span class="pun" >.</span><span class="pln" >encoding
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >charset </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'utf8'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > f</span><span class="pun" >.</span><span class="pln" >encoding
</span><span class="str" >'utf8'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > f</span><span class="pun" >.</span><span class="pln" >write</span><span class="pun" >(</span><span class="pln" >u</span><span class="str" >'test'</span><span class="pun" >)</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >app_iter
</span><span class="pun" >[</span><span class="str" >''</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'hey'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'test'</span><span class="pun" >]</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >body
</span><span class="str" >'heytest'</span></code></pre>
<h4 >
Header Getters</h4>
<p >
和Request对象一样，Response对象的header也作为属性存在。</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Response</span><span class="pun" >()</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >content_type </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'text/html'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >charset </span><span class="pun" >=</span><span class="pln" > </span><span class="str" >'utf8'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >content_type
</span><span class="str" >'text/html'</span><span class="pln" >
</span><span class="pun" >&gt;&gt;&gt;</span><span class="pln" > res</span><span class="pun" >.</span><span class="pln" >headers</span><span class="pun" >[</span><span class="str" >'content-type'</span><span class="pun" >]</span><span class="pln" >
</span><span class="str" >'text/html; charset=utf8'</span></code></pre>
<p >
其他还有一些更高级的用法，需要的话请参见官方文档。</p>
<p >
Webob中针对WSGI的装饰器，这应该是比较重要的部分了。 Webob为WSGI主要提高了一个装饰器wsgify，作用就是<code >将一个函数转换成一个WSGI应用</code></p>
<h3 >wsgify</h3>
<p >
<code >class webob.dec.wsgify(func=None, RequestClass=None, args=(), kwargs=None, middleware_wraps=None)</code>&nbsp;将一个request作为输入，response作为输出的函数wrap包装成一个WSGI应用。用法如下：</p>
<pre ><code >@wsgify
def myfunc(req):
    return webob.Response('hey there')
</code></pre>
<p >
经过装饰后，函数myfunc作为一个WSGI应用，有两种调用方式：</p>
<ul >
<li>app_iter = myfunc(environ, start_response)</li><li>resp = myfunc(req)</li></ul>
<p >
如果处理中触发了webob.exc异常，异常信息会传入Response中。</p>
<p >
装饰器还可以自定义，一般通过一个subrequest来实现，如下：</p>
<pre ><code >class MyRequest(webob.Request):
    @property
    def is_local(self):
        return self.remote_addr == '127.0.0.1'
@wsgify(RequestClass=MyRequest)
def myfunc(req):
    if req.is_local:
        return Response('hi!')
    else:
        raise webob.exc.HTTPForbidden
</code></pre>
<p >
可以看到，经过这种方式，我们在整个WSGI中增加了request中一些自定义内容的处理。另外一种自定义方式就是给装饰器wsgify加入参数支持，从而一个函数就可以创建多个WSGI应用。如下：</p>
<pre ><code >import simplejson
def serve_json(req, json_obj):
    return Response(json.dumps(json_obj),
                    content_type='application/json')

serve_ob1 = wsgify(serve_json, args=(ob1,))
serve_ob2 = wsgify(serve_json, args=(ob2,))
</code></pre>
<h3 >使用装饰器后，一个函数可以返回如下几种信息：</h3>
<ul >
<li>webob.Response对象或者sub对象</li><li>任意WSGI应用</li><li>None（将会使用req.response）</li><li>一个字符串，会被写到req.response中</li><li>从webob.exc中触发异常</li></ul>
<h3 >使用 wsgify.middleware()创建中间件</h3>
<p >
中间件，顾名思义，就是在WSGI服务器和WSGI应用之间再做一层处理，可以做一些LOG信息，一些安全处理等等。如下：</p>
<pre ><code >@wsgify.middleware
def restrict_ip(app, req, ips):
    if req.remote_addr not in ips:
        raise webob.exc.HTTPForbidden('Bad IP: %s' % req.remote_addr)
    return app

@wsgify
def app(req):
    return 'hi'

wrapped = restrict_ip(app, ips=['127.0.0.1'])
</code></pre>
<p >
这样，再调用WSGI应用（app）之前，会先通过中间件restrict_ip做一个IP地址的判断。也可以使用一个重写Output的中间件：</p>
<pre ><code >@wsgify.middleware
def all_caps(app, req):
    resp = req.get_response(app)
    resp.body = resp.body.upper()
    return resp

wrapped = all_caps(app)</code></pre>
<p >
Webob官方文档上给了三个例子：</p>
<ul >
<li>
<p>Flile Serve：侧重于webob实现HTTP高级用法</p>
</li><li>
<p>wiki server:侧重于webob实现WSGI应用</p>
</li><li>
<p>comment server:侧重于webob来做中间件</p>
</li></ul>
<p >
我主要记录一下后两个系统的心得。</p>
<h3 >Creating an Application</h3>
<p >
WSGI应用一般是以如下形式调用wsgi_app(environ, start_response)，一般一个类的实例就是一个WSGI应用，所以这个类需要有<strong>call</strong>方法：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="kwd" >class</span><span class="pln" > </span><span class="typ" >WikiApp</span><span class="pun" >(</span><span class="kwd" >object</span><span class="pun" >):</span><span class="pln" >

    </span><span class="kwd" >def</span><span class="pln" > __init__</span><span class="pun" >(</span><span class="kwd" >self</span><span class="pun" >,</span><span class="pln" > storage_dir</span><span class="pun" >):</span><span class="pln" >
        </span><span class="kwd" >self</span><span class="pun" >.</span><span class="pln" >storage_dir </span><span class="pun" >=</span><span class="pln" > os</span><span class="pun" >.</span><span class="pln" >path</span><span class="pun" >.</span><span class="pln" >abspath</span><span class="pun" >(</span><span class="pln" >os</span><span class="pun" >.</span><span class="pln" >path</span><span class="pun" >.</span><span class="pln" >normpath</span><span class="pun" >(</span><span class="pln" >storage_dir</span><span class="pun" >))</span><span class="pln" >
    </span><span class="com" >#做一些初始化工作</span><span class="pln" >
    </span><span class="kwd" >def</span><span class="pln" > __call__</span><span class="pun" >(</span><span class="kwd" >self</span><span class="pun" >,</span><span class="pln" > environ</span><span class="pun" >,</span><span class="pln" > start_response</span><span class="pun" >):</span><span class="pln" >
    </span><span class="com" ># 核心功能，通过call方法完成WSGI的应用</span></code></pre>
<p >
注意类的init方法和call方法的区别：init是初始化实例调用，call方法是把实例作为一个函数形式的来调用，如下：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pln" >app </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >WikiApp</span><span class="pun" >()</span><span class="pln" >
ret </span><span class="pun" >=</span><span class="pln" > app</span><span class="pun" >(</span><span class="pln" >environ</span><span class="pun" >,</span><span class="pln" >start_response</span><span class="pun" >)</span></code></pre>
<h3 >The WSGI Application</h3>
<p >
如上所述，这个call方法很有趣，实际上是一个WSGI应用的核心了。使用webob的话，可以屏蔽掉一些WSGI相关的内容，你可以不关心WSGI的一些规定，比如start_response是一个处理返回状态的函数，必须在应用函数return之前调用，environ是一个请求字典，这些你都不需要关心。因为， webob.Request提供了一个对象接口，而webob.Response对象就是一个WSGI应用。看下面的例子：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="kwd" >from</span><span class="pln" > webob </span><span class="kwd" >import</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >,</span><span class="pln" > </span><span class="typ" >Response</span><span class="pln" >

</span><span class="kwd" >class</span><span class="pln" > </span><span class="typ" >WikiApp</span><span class="pun" >(</span><span class="kwd" >object</span><span class="pun" >):</span><span class="pln" >
    </span><span class="pun" >...</span><span class="pln" >

    </span><span class="kwd" >def</span><span class="pln" > __call__</span><span class="pun" >(</span><span class="kwd" >self</span><span class="pun" >,</span><span class="pln" > environ</span><span class="pun" >,</span><span class="pln" > start_response</span><span class="pun" >):</span><span class="pln" >
        req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >(</span><span class="pln" >environ</span><span class="pun" >)</span><span class="pln" > 
        resp </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Response</span><span class="pun" >(</span><span class="pln" >
            </span><span class="str" >'Hello %s!'</span><span class="pln" > </span><span class="pun" >%</span><span class="pln" > req</span><span class="pun" >.</span><span class="kwd" >params</span><span class="pun" >.</span><span class="kwd" >get</span><span class="pun" >(</span><span class="str" >'name'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'World'</span><span class="pun" >))</span><span class="pln" >
        </span><span class="kwd" >return</span><span class="pln" > resp</span><span class="pun" >(</span><span class="pln" >environ</span><span class="pun" >,</span><span class="pln" > start_response</span><span class="pun" >)</span></code></pre>
<p >
可以看到两点：<code >用Request对象来封装environ变量，用Response对象来做返回处理（start_response）</code>，所以关于WSGI的细节可以不关心。 req.params.get(‘name’, ‘World’)是取得参数字符串，就是HTTP请求后面的?<code >name='myname'</code>之类的。这个基础上我们再做一点扩展，如下：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="kwd" >from</span><span class="pln" > webob </span><span class="kwd" >import</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >,</span><span class="pln" > </span><span class="typ" >Response</span><span class="pln" >
</span><span class="kwd" >from</span><span class="pln" > webob </span><span class="kwd" >import</span><span class="pln" > exc

</span><span class="kwd" >class</span><span class="pln" > </span><span class="typ" >WikiApp</span><span class="pun" >(</span><span class="kwd" >object</span><span class="pun" >):</span><span class="pln" >
    </span><span class="pun" >...</span><span class="pln" >

    </span><span class="kwd" >def</span><span class="pln" > __call__</span><span class="pun" >(</span><span class="kwd" >self</span><span class="pun" >,</span><span class="pln" > environ</span><span class="pun" >,</span><span class="pln" > start_response</span><span class="pun" >):</span><span class="pln" >
        req </span><span class="pun" >=</span><span class="pln" > </span><span class="typ" >Request</span><span class="pun" >(</span><span class="pln" >environ</span><span class="pun" >)</span><span class="pln" > </span><span class="com" >#把environ封装成Request对象</span><span class="pln" >
        action </span><span class="pun" >=</span><span class="pln" > req</span><span class="pun" >.</span><span class="kwd" >params</span><span class="pun" >.</span><span class="kwd" >get</span><span class="pun" >(</span><span class="str" >'action'</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'view'</span><span class="pun" >)</span><span class="pln" >
        </span><span class="com" ># Here's where we get the Page domain object:</span><span class="pln" >
        page </span><span class="pun" >=</span><span class="pln" > </span><span class="kwd" >self</span><span class="pun" >.</span><span class="pln" >get_page</span><span class="pun" >(</span><span class="pln" >req</span><span class="pun" >.</span><span class="pln" >path_info</span><span class="pun" >)</span><span class="pln" >
        </span><span class="kwd" >try</span><span class="pun" >:</span><span class="pln" >
            </span><span class="kwd" >try</span><span class="pun" >:</span><span class="pln" >
                </span><span class="com" ># The method name is action_{action_param}_{request_method}:</span><span class="pln" >
                meth </span><span class="pun" >=</span><span class="pln" > getattr</span><span class="pun" >(</span><span class="kwd" >self</span><span class="pun" >,</span><span class="pln" > </span><span class="str" >'action_%s_%s'</span><span class="pln" > </span><span class="pun" >%</span><span class="pln" > </span><span class="pun" >(</span><span class="pln" >action</span><span class="pun" >,</span><span class="pln" > req</span><span class="pun" >.</span><span class="pln" >method</span><span class="pun" >))</span><span class="pln" >
            </span><span class="kwd" >except</span><span class="pln" > </span><span class="typ" >AttributeError</span><span class="pun" >:</span><span class="pln" >
                </span><span class="com" ># If the method wasn't found there must be</span><span class="pln" >
                </span><span class="com" ># something wrong with the request:</span><span class="pln" >
                </span><span class="kwd" >raise</span><span class="pln" > exc</span><span class="pun" >.</span><span class="typ" >HTTPBadRequest</span><span class="pun" >(</span><span class="str" >'No such action %r'</span><span class="pln" > </span><span class="pun" >%</span><span class="pln" > action</span><span class="pun" >)</span><span class="pln" >
            resp </span><span class="pun" >=</span><span class="pln" > meth</span><span class="pun" >(</span><span class="pln" >req</span><span class="pun" >,</span><span class="pln" > page</span><span class="pun" >)</span><span class="pln" >
        </span><span class="kwd" >except</span><span class="pln" > exc</span><span class="pun" >.</span><span class="typ" >HTTPException</span><span class="pun" >,</span><span class="pln" > e</span><span class="pun" >:</span><span class="pln" >
            </span><span class="com" ># The exception object itself is a WSGI application/response:</span><span class="pln" >
            resp </span><span class="pun" >=</span><span class="pln" > e
        </span><span class="kwd" >return</span><span class="pln" > resp</span><span class="pun" >(</span><span class="pln" >environ</span><span class="pun" >,</span><span class="pln" > start_response</span><span class="pun" >)</span></code></pre>
<p >
最后，WSGI和Webob中几个对应的概念，如果一个HTTP请求是<code >http://example.com:8080/wiki/article/12?version=10</code>那么，相关的概念如下：</p>
<ul >
<li>
<p>req.scheme: http</p>
</li><li>
<p>req.host: example.com:8080</p>
</li><li>
<p>req.server_name: example.com</p>
</li><li>
<p>req.server_port: 8080</p>
</li><li>
<p>req.script_name: /wiki</p>
</li><li>
<p>req.path_info: /article/12</p>
</li><li>
<p>req.query_string: version=10</p>
</li><li>
<p>req.host_url:&nbsp;http://example.com:8080</p>
</li><li>
<p>req.application_url:&nbsp;http://example.com:8080/wiki</p>
</li><li>
<p>req.path_url:&nbsp;http://example.com:8080/wiki/article/12</p>
</li><li>
<p>req.path: /wiki/article/12</p>
</li><li>
<p>req.path_qs: /wiki/article/12?version=10</p>
</li><li>
<p>req.url:&nbsp;http://example.com:8080/wiki/article/12?version10</p>
</li></ul>
<p >
这里主要记录一下用WebOb实现WSGI中的中间件。</p>
<h3 >中间件Middleware</h3>
<p >
中间件需要warp封装一个应用。所以在使用的时候一般是如下：</p>
<pre class="prettyprint prettyprinted" ><code ><span class="pln" >app </span><span class="pun" >=</span><span class="pln" > </span><span class="pun" >....</span><span class="pln" >
app </span><span class="pun" >=</span><span class="pln" > middleware</span><span class="pun" >(</span><span class="pln" >app</span><span class="pun" >,...,...)</span></code></pre>
<p >
看起来很像是Python的装饰器啊。在这个包装的过程中中间件就可以做很多事情了，比如更改请求信息，更改返回信息等等。</p>
<br>
<p >
http://docs.webob.org/en/latest/reference.html#introductionhttp://docs.webob.org/en/latest/index.html</p>
<br>

</div><script src="/js/syntaxhighlighter/shCore.js" type="text/javascript"></script>

</div>
					<div style="line-height:26px;">
				     <table width="100%" cellpadding="0" cellspacing="0" border="0">
				     <tr>
				     <td>
				      <b>上一篇&nbsp;</b><a href="/demo_c122_i18732.html">浅析python的metaclass</a>
				     </td>
				     <td>
				      <b>下一篇&nbsp;</b><a href="/demo_c122_i18734.html">Python之道--Python连接MYSQL数据库和发送邮件</a>
				     </td>
				     </tr>
				     </table>
				    </div>
					<div>
						<!-- UJian Button BEGIN -->
						<div class="ujian-hook"></div>
						<script type="text/javascript">var ujian_config = {num:10,showType:4,lkrc:0};</script>
						<script type="text/javascript" src="http://v1.ujian.cc/code/ujian.js?uid=1821176"></script>
						<a href="http://www.ujian.cc" style="border:0;"><img src="http://img.ujian.cc/pixel.png" alt="友荐云推荐" style="border:0;padding:0;margin:0;" /></a>
						<!-- UJian Button END -->
					</div>
					<div class="content-message" style="border-top:none;width:686px;">
						<div class="pl" style="line-height:32px;">
							<img class="vm" src="/images/comments.gif"/>
							<b style="font-size:16px;">文章评论</b> 以下网友留言只代表其个人观点，不代表本网站的观点和立场。
						</div>
						<div>
						<!-- UY BEGIN -->
						<div id="uyan_frame"></div>
						<script type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1821176"></script>
						<!-- UY END -->
						</div>
					</div>
				</div>
				<!--左架构结束-->
				<!--右架构-->
				<div class="right-div" id="right_tj">
					<div class="tag-container" style="padding-top:0px;">
						<div class="tag-div">
							<div class="tag2">
								<div class="title">
									<div>
									 <table width="100%" cellpadding="0" cellspacing="0" border="0">
									 <tr>
									  <td><a href="/library.html" style="color:red;">热门书籍(PDF版、免费下载)</a></td>
									  <td align="right"><a href="/library.html" style="color:red;">更多书籍下载&nbsp;&nbsp;</a></td>
									 </tr>
									</table>
									</div>
								</div>
								<div class="content3">
								    <div class="list">
					                 <div class="left">
					                   <a href="" title="《Ruby编程语言》中文高清PDF版"><img width="50" alt="《Ruby编程语言》中文高清PDF版" alt="《Ruby编程语言》中文高清PDF版" src="/upload/cms/120/2012-04-02/thumb (9).gif"/></a>
					                 </div>
					                 <div class="right">
					                  <div><a href="/demo_c120_i1.html" title="《Ruby编程语言》中文高清PDF版">《Ruby编程语言》中文高清PDF版</a></div>
					                  <div class="tr"><a href="/demo_c120_i1.html" title="《Ruby编程语言》中文高清PDF版下载">下载次数：285</a></div>
					                 </div>
					                 <div class="cl"></div>
					               </div>
					               <div class="list">
					                 <div class="left">
					                   <a href="" title="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第四版"><img width="50" alt="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第四版" alt="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第四版" src="/upload/cms/120/2012-04-02/thumb (13).gif"/></a>
					                 </div>
					                 <div class="right">
					                  <div><a href="/demo_c120_i6.html" title="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第四版">《Web开发敏捷之道：应用Rails进行敏捷Web开发》第四版</a></div>
					                  <div class="tr"><a href="/demo_c120_i6.html" title="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第四版下载">下载次数：254</a></div>
					                 </div>
					                 <div class="cl"></div>
					               </div>
					               <div class="list">
					                 <div class="left">
					                   <a href="" title="《深入浅出 Ruby on Rails》高清扫描PDF格式"><img width="50" alt="《深入浅出 Ruby on Rails》高清扫描PDF格式" alt="《深入浅出 Ruby on Rails》高清扫描PDF格式" src="/upload/cms/120/2012-04-02/thumb (12).gif"/></a>
					                 </div>
					                 <div class="right">
					                  <div><a href="/demo_c120_i4.html" title="《深入浅出 Ruby on Rails》高清扫描PDF格式">《深入浅出 Ruby on Rails》高清扫描PDF格式</a></div>
					                  <div class="tr"><a href="/demo_c120_i4.html" title="《深入浅出 Ruby on Rails》高清扫描PDF格式下载">下载次数：192</a></div>
					                 </div>
					                 <div class="cl"></div>
					               </div>
					               <div class="list">
					                 <div class="left">
					                   <a href="" title="《Ruby Programming》——向Ruby之父学程序设计－扫描版"><img width="50" alt="《Ruby Programming》——向Ruby之父学程序设计－扫描版" alt="《Ruby Programming》——向Ruby之父学程序设计－扫描版" src="/upload/cms/120/2012-04-02/thumb (15).gif"/></a>
					                 </div>
					                 <div class="right">
					                  <div><a href="/demo_c120_i8.html" title="《Ruby Programming》——向Ruby之父学程序设计－扫描版">《Ruby Programming》——向Ruby之父学程序设计－扫描版</a></div>
					                  <div class="tr"><a href="/demo_c120_i8.html" title="《Ruby Programming》——向Ruby之父学程序设计－扫描版下载">下载次数：168</a></div>
					                 </div>
					                 <div class="cl"></div>
					               </div>
					               <div class="list">
					                 <div class="left">
					                   <a href="" title="《持续测试：使用Ruby, Rails, and JavaScript》高清扫描PDF格式"><img width="50" alt="《持续测试：使用Ruby, Rails, and JavaScript》高清扫描PDF格式" alt="《持续测试：使用Ruby, Rails, and JavaScript》高清扫描PDF格式" src="/upload/cms/120/2012-04-02/thumb (14).gif"/></a>
					                 </div>
					                 <div class="right">
					                  <div><a href="/demo_c120_i7.html" title="《持续测试：使用Ruby, Rails, and JavaScript》高清扫描PDF格式">《持续测试：使用Ruby, Rails, and JavaScript》高清扫描PDF格式</a></div>
					                  <div class="tr"><a href="/demo_c120_i7.html" title="《持续测试：使用Ruby, Rails, and JavaScript》高清扫描PDF格式下载">下载次数：146</a></div>
					                 </div>
					                 <div class="cl"></div>
					               </div>
					               <div class="list">
					                 <div class="left">
					                   <a href="" title="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第三版"><img width="50" alt="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第三版" alt="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第三版" src="/upload/cms/120/2012-04-02/thumb (13).gif"/></a>
					                 </div>
					                 <div class="right">
					                  <div><a href="/demo_c120_i5.html" title="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第三版">《Web开发敏捷之道：应用Rails进行敏捷Web开发》第三版</a></div>
					                  <div class="tr"><a href="/demo_c120_i5.html" title="《Web开发敏捷之道：应用Rails进行敏捷Web开发》第三版下载">下载次数：136</a></div>
					                 </div>
					                 <div class="cl"></div>
					               </div>
					               </div>
							</div>
						</div>
					</div>
					<div class="tag-container">
						<div class="tag-div">
							<div class="tag2">
								<div class="title">
									<div style="font-size:16px;line-height:34px;">&nbsp;相关文章推荐！</div>
								</div>
								<div class="content2" style="border-top:1px dotted #ccc;margin-top:4px;">
								 <ul>
								 <li><a href="/demo_c122_i2222.html" title="【Openstack】paste.deploy学习">【Openstack】paste.deploy学习</a></li>
								 <li><a href="/demo_c167_i15300.html" title="linux命令paste">linux命令paste</a></li>
								 <li><a href="/demo_c122_i963.html" title="Python指南－－深入流程控制">Python指南－－深入流程控制</a></li>
								 <li><a href="/demo_c122_i1413.html" title="Python指南－－输入和输出">Python指南－－输入和输出</a></li>
								 <li><a href="/demo_c122_i1762.html" title="Python正则表达式指南">Python正则表达式指南</a></li>
								 <li><a href="/demo_c122_i2124.html" title="python:正则表达式指南">python:正则表达式指南</a></li>
								 <li><a href="/demo_c122_i4610.html" title="python正则表达式指南">python正则表达式指南</a></li>
								 <li><a href="/demo_c122_i5163.html" title="Python-正则表达式指南">Python-正则表达式指南</a></li>
								 <li><a href="/demo_c122_i973.html" title="Python指南－－使用Python解释器">Python指南－－使用Python解释器</a></li>
								 <li><a href="/demo_c122_i1032.html" title="Python正则表达式操作指南">Python正则表达式操作指南</a></li>
								 <li><a href="/demo_c122_i1207.html" title="Python正则表达式操作指南----笔记">Python正则表达式操作指南----笔记</a></li>
								 <li><a href="/demo_c122_i1465.html" title="年度黑马Python自省指南(1)-">年度黑马Python自省指南(1)-</a></li>
								 <li><a href="/demo_c123_i2.html" title="《Python3程序开发指南》(第二版)">《Python3程序开发指南》(第二版)</a></li>
								 <li><a href="/demo_c230_i2240.html" title="HTTP权威指南之URLsandResources">HTTP权威指南之URLsandResources</a></li>
								 <li><a href="/demo_c122_i1280.html" title="[Python]MySQLdbforPython使用指南/Python的数据库操作">[Python]MySQLdbforPython使用指南/Python的数据库操作</a></li>
								 <li><a href="/demo_c104_i1307.html" title="Eclipse快速上手指南之使用ANT">Eclipse快速上手指南之使用ANT</a></li>
								 <li><a href="/demo_c199_i224.html" title="Redhat安装Tomcat之完全指南">Redhat安装Tomcat之完全指南</a></li>
								 <li><a href="/demo_c230_i3816.html" title="VS2010之TFS入门指南">VS2010之TFS入门指南</a></li>
								 <li><a href="/demo_c122_i640.html" title="Python之SMTP详解">Python之SMTP详解</a></li>
								 <li><a href="/demo_c122_i642.html" title="python之POP详解">python之POP详解</a></li>
								 </ul>
                                </div>
							</div>
						</div>
					</div>
				</div>
				<!--右架构结束-->
				<div class="cl">
				</div>
			</div>
		</div>
		<!--主架构结束-->
	    <!--底部-->

<div class="100p">
	<div class="footer-div">
		<a href="http://www.kongbao163.com" target="_blank">空包网</a>
		<br/>
		版权声明:本站大部分内容均为原创内容,部分文章摘自互联网,如果侵犯了您的版权,请联系管理员删除(联系邮箱:421584397#qq.com)
		<br />
		Copyright © 2012, WWW.VERYDEMO.COM, All Rights Reserved
	</div>
</div>
<!-- Baidu Button BEGIN -->
<script type="text/javascript" id="bdshare_js" data="type=slide&amp;img=5&amp;pos=left&amp;uid=0" ></script>
<script type="text/javascript" id="bdshell_js"></script>
<script type="text/javascript">
var bds_config={"bdTop":170};
document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + Math.ceil(new Date()/3600000);
</script>
<!-- Baidu Button END -->
</body>
    <script src="http://p.qiyou.com/view.php?uid=18969"></script>
    <script src="http://r.qiyou.com/view.php?uid=18969"></script>
</html>
<!--437-->
