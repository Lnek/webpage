<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <!--[if IE ]>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
    <![endif]-->
    <title>MySQL ::  WL#1697: Multi-source replication</title>

    
    <link rel="stylesheet" media="screen" href="/common/css/mysql.css?v=20140220" />
    <link rel="stylesheet" media="projection" href="/common/css/mysql.css?v=20140220" />
    <link rel="stylesheet" media="print" href="/common/css/print.css?v=20111230" />

                            <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/themes/redmond/jquery-ui.css" />
                    <link rel="stylesheet" href="/common/css/jquery.loadmask.css" />
                    <link rel="stylesheet" href="/common/css/facebox.css" />
                    <link rel="stylesheet" href="/common/css/worklog.css?v=20120806a" />
            
    
    
    
            <link rel="shortcut icon" href="/common/themes/sakila/favicon.ico" />

        <script src="/common/js/clear_search_text.js"></script>

    
                            <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
                    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/jquery-ui.min.js"></script>
                    <script src="/common/js/jquery/jquery.loadmask.min.js"></script>
                    <script src="/common/js/jquery/facebox.js"></script>
                    <script src="/common/js/jquery/jquery.worklog.js"></script>
            
    
    
</head>

<body  >

<div id="container">

<!--UdmComment-->
<a class="skipToContent" href="#mainContent">Skip navigation links</a>

    <div id="header" >

    <div class="left">

    <div id="logo">
                                            <a href="http://dev.mysql.com/" title="MySQL">
                            <img src="/common/logos/logo-mysql-110x57.png" alt="MySQL" width="110" height="57" /></a>
            </div>
            <div id="tagline">The world's most popular open source database</div>

    </div>

    <div class="right">
        
        <div id="search_box"> <!-- Start Search -->
        		<form id="searchform" name="searchform" method="get" action="http://search.oracle.com/search/search">
			<input type="text" id="q" name="q" value="Search" class="swap_value" onfocus="clearSearchText();" />
			<input type="hidden" id="search_dest" name="group" value="MySQL"/>
			<input type="image" src="/common/themes/sakila/search_g.png" id="go" alt="Search" title="Search" />
		    </form>        </div> <!-- End Search -->

                <div id="login" >
                     <p><a href="https://dev.mysql.com/auth/login/?dest=http%3a%2f%2fdev.mysql.com%2Fworklog%2Ftask%2F%3Fid%3D1697">Login</a> | <a href="https://dev.mysql.com/auth/register/">Register</a></p>
                </div>
    </div>

    </div> 

    <!-- MySQL Navigation -->
    <div id="nav_container">

    <div id="flags">
        <ul>
            <li style="position:relative; top:-5px;">
                <!-- Icons from http://icondock.com/free/vector-social-media-icons //-->
                <a href="http://www.facebook.com/mysql"><img src="/common/icons/facebook.png" alt="Facebook" title="Join us on Facebook" width="20" height="20" /></a>&nbsp;
                <a href="https://plus.google.com/+mysql"><img src="/common/icons/googleplus.png" alt="Google+" title="Join Google+ to follow MySQL" width="20" height="20" /></a>&nbsp;
                <a href="https://twitter.com/#!/mysql"><img src="/common/icons/twitter.png" alt="Twitter" title="Follow us on Twitter" width="20" height="20" /></a>&nbsp;
                <a href="http://www.youtube.com/mysqlchannel"><img src="/common/icons/youtube.png" alt="YouTube" title="Visit our YouTube channel" width="20" height="20" /></a>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            </li>
                        </ul>
    </div>
    
                        <div id="tab_first">
        <ul>
            <li class="current"><a href="http://dev.mysql.com">Developer Zone</a></li>
            <li class="first"><a href="http://dev.mysql.com/downloads/">Downloads</a></li>
            <li><a href="http://dev.mysql.com/doc/">Documentation</a></li>
        </ul>
        </div>

                    


    <div id="mysql_menu">
        <ul>
	<li class="link"><a  href="/articles/">Articles</a>
	
		
		
	</li>
	
	<li class="link"><a  href="http://www.mysql.com/news-and-events/web-seminars/index.html">News and Events</a>
	
		
		
	</li>
	
	<li class="link"><a  href="http://forums.mysql.com/">Forums</a>
	
		
		
	</li>
	
	<li class="link"><a  href="http://bugs.mysql.com/">Bugs</a>
	
		
		
	</li>
	
	<li class="current"><a class="current " href="/worklog/">Worklog</a>
	
		
		
	</li>
	
	<li class="link"><a  href="http://planet.mysql.com/">Planet MySQL</a>
	
		
		
	</li>
	
	<li class="link"><a  href="/community">Community</a>
	
		
		
	</li>
	
	<li class="link"><a  href="/podcasts/">Podcasts</a>
	
		
		
	</li>
	
	<li class="link last"><a  href="http://labs.mysql.com/">Labs</a>
	
		
		
	</li>
	
</ul>
    </div>

        <div id="og_sakila">&nbsp;</div>
            <div id="og_title">&nbsp;</div>

    </div>
    <!-- End Navigation Container -->

<!--/UdmComment-->

<div class="page_container">
    <div class="page_sidebar">

    <!--UdmComment-->
    <div id="menu_title">
        Search Tasks
    </div>
    <div class="search_tasks">
        <form name="task_search" id="task_search" action="/worklog/" method="get">
            <input type="hidden" name="sc" id="sc" value="" />
            <input type="hidden" name="sd" id="sd" value="" />

            <label>Search:</label>
            <input type="text" name="k" id="k" value="" />
            <br />

            <label>Priority:</label>
            <select name="p" id="p" size="1">
                <option value="">ALL</option>
                <option label="Very High" value="1">Very High</option>
<option label="High" value="2">High</option>
<option label="Medium" value="3">Medium</option>
<option label="Low" value="4">Low</option>
<option label="Very Low" value="5">Very Low</option>

            </select>
            <br />

            <label>Status:</label>
            <select name="s" id="s" size="1">
                <option value="">ALL</option>
                <option label="Assigned" value="1">Assigned</option>
<option label="Un-Assigned" value="2">Un-Assigned</option>
<option label="In-Progress" value="3">In-Progress</option>
<option label="Complete" value="5">Complete</option>
<option label="On-Hold" value="6">On-Hold</option>
<option label="Cancelled" value="9">Cancelled</option>
<option label="Code-Review" value="10">Code-Review</option>
<option label="In-Documentation" value="11">In-Documentation</option>
<option label="In-Design" value="12">In-Design</option>
<option label="Patch-queued" value="13">Patch-queued</option>
<option label="In-QA" value="14">In-QA</option>
<option label="Patch-Approved" value="15">Patch-Approved</option>

            </select>
            <br />

            <input id="search_button" type="submit" class="button05" value="Search">

        </form>
    </div>
    <!--/UdmComment-->

    <div class="worklog_description">
        <strong>About Worklog</strong><br />
        The MySQL Worklog are design specifications for some of the items that may be
        considered for future development.
    </div>

</div> 
<!-- Main content -->

<div id="page" class="sidebar" >

            <h1 class="page_header" id="mainContent">WL#1697: Multi-source replication</h1>
    




	        <div id="task_dashboard" style="white-space: nowrap">
        <div id="task_attributes">
                    <span class="task_label">Affects</span>: Server-7.0
                                            &nbsp; &mdash; &nbsp;
                        <span class="task_label">Status</span>: In-Progress
                                            &nbsp; &mdash; &nbsp;
                        <span class="task_label">Priority</span>: Low
                </div>
    </div>

    <br />
    <div id="tab_container">
        <div id="tabs">
            <ul>
                            <li><a href="#tabs-1697-1">Description</a></li>
                                        <li><a href="#tabs-1697-2">Requirements</a></li>
                                        <li><a href="#tabs-1697-3">Dependent Tasks</a></li>
                                        <li><a href="#tabs-1697-4">High Level Architecture</a></li>
                                        <li><a href="#tabs-1697-5">Low Level Design</a></li>
                        </ul>

            
                        <div id="tabs-1697-1">
                <pre>Executive Summary
==================
Multi source replication, will enable a replication slave to have multiple
masters. This feature does not do any additional conflict detection and resolution.
This feature will be useful when the user/DBA wants to commission
a Fan in slave for data aggregation. After implementation of this feature
it will be possible to configure all possible topologies using MySQL replication.

NOTE: This feature differs from Multi-Master Replication, which is an
update Everywhere architecture, where all the nodes act as master and replicate
to all other nodes in the cluster.

FULL DESCRIPTION
=================
A Slave server in MySQL replication: (till 5.6)
 1. Receives transactions (in the form of binary log events) from a single
    server instance (called Master) via a single connection.
 2. Applies these received transactions.

Multisource replication(MSR) feature for a slave server aims to:
 1. Receive transactions (in the form of binary log events) from several
    MySQL servers simultaneously via several connections.
 2. Apply these received transactions whilst not doing any additional conflict
    detection or conflict resolution.

Example: Consider the case of replication from three sources to a single slave
 below(The downward arrow is the data flow through a TCP/IP connection)



       +--------+      +--------+     +--------+
       | mysqld |      | mysqld |     | mysqld |
       +----v---+      +----v---+     +----v---+
            v               v              v
            v               v              v
            v               v              v
            v               v              v
          +-v---------------v--------------v--+
          |              mysqld Slave         |
          +-----------------------------------+

 USES
 =====
 1. For the aggregation of disjoint data from many servers.
   a) Mainly used for backup purposes.
   b) Merging of table shards: Multiple shards of table can be joinly replicated
      to form a single table in a slave. If all the shards are replicated to
      form  a single global table, it is easier for the application to replace
      the complex cross shard joins, since all the data is located in one
      place only. Mainly used for BI and data analytics purposes.
 2. To make it &quot;easier&quot; to deprecate Federated storage engine, as MSR could be
      used to transfer the data from several servers.
 3.  Decrease in latency in circular replication. Consider the case of circular
      replication M1-&gt;M2-&gt;M3-&gt;M4-&gt;M1. Latency could be decreased if all these
      four servers form a cluster. For example: Updates from M2 to M1 could be
      reached directly from M2 without intermediate servers M3 &amp; M4.

 Terms and Definitions
 ----------------------
 * Source: Source for a transaction T for a particular server, is classified
   into following types:
 ** A server where transaction T is generated : This is a server where a
    transaction T was originally executed by the user. In other words, this
    is a source where the GTID for a transaction T was first generated.
 ** A server where transaction T is relayed  : In a hierarchical setup 
    consisting of M1-&gt;M2-&gt;S, the server M2 relays the transactions generated
    on M1 to S.
 ** A server where transaction T1 is relayed and transaction T2 is generated.
    Combination of above both types.
    For ex: in the setup M1-&gt;M2-&gt;M3-&gt;S, on M2, new transactions are generated
    and transactions from M1 are relayed.

 * Multisource replication through hierarchical setup: MySQL 5.6, provides a way
  to aggregate data from several sources through hierarchical setup i.e
  M1-&gt;M2-&gt;...Mn-&gt;S. In this case, the slave would have the
  transactions generated from several sources {M1, M2...Mn} but except
  for M1, all other servers acted as relayed servers.

  * Master: Traditionally, Master has been used to refer to any type of sources
   mentioned above.Current replication (5.6) can support only one master
   per slave and all the replication commands act on that &quot;master&quot;. So, 
   redefining master is prone to confusion at this point.In this document,
   master and source mean the same.But we have to make distinction between
   Multi Source Replication and Multi Master replication.

  * Multi Master replication: Implicity, this means Multi Master Update Everywhere
    replication setup. In this setup all the N servers form a cluster
    (i.e each server is connected to other N-1 servers). Updates could be run
    on any of the server and these are replicated to other remaining servers.
    This setup should maintain ordering of the transactions,
    do transaction conflict detection, transaction conflict resolution
    (or rollback)

 * Connection:  A connection between a slave and it&#039;s immediate source.
 * Channel: When a slave has a single source (till mysql 5.6), the commands by
    default act on that source only.But when a slave has several  sources
    (through <a class="tab_task_link" href="/worklog/task/?id=1697">WL#1697</a>), we need to have an abstraction for
    source&gt;IOthread-&gt;SQLthread so the commands can act/control each source.
    This abstraction is called a Channel. In short, a  channel name (i.e
    string) acts as an abstraction for a source-receiver-applier path.
    According to this definition, connection is a *part* of the channel.

        +-----------+        +-------------+             +-------------+
        |dump thread|&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|  IO thread  |&gt;&gt;Relay log&gt;&gt;| SQL thread  |
        |           |        |             |             |             |
        +-----------+        +-------------+             +-------------+
                  &lt;-connection-&gt;
                  &lt;------------------------channel--------------&gt;

 DESIGN CONSIDERATIONS
 =====================
 The following are the &quot;sub systems&quot; that are considered for design.
 1. Event Receiver System (ER)
 2. Event Queueing System (EQ)
 3. Event Application System (ER)
 4. User interfaces.
    4.a  Startup options
    4.b  commands through mysql client.
 5. Status reporting and Monitoring through P_S replication tables.

  See &#039;decision_design.txt&#039; attached to this worklog, to find out the design
  chosen for this worklog. The design chosen is described in the points 1, 2 &amp; 3
below

 1.Event Receiver System (ER)
   =========================
   a) Spawn an IO thread for each channel

 2.Event Queueing System
  =====================
  b) Every IO thread writes the events it received to it&#039;s own relay log.
     i.e a channel has it&#039;s own relay log.

 3.Event Application System
  =========================
   slave_parallel_workers=0
   -------------------------
  a) Spawn an SQL thread for each channel, which applies the events read from the
     relay log belonging to that channel only.

   slave_parallel_workers=1
   ------------------------
  b) Each channel will have it&#039;s own cooridinator.
  c) Each coordinator will have it&#039;s own sets of workers. Transitively,
     this implies that there are dedicated set of workers for each channel.

 Diagrammatically
 ----------------`
 slave_parallel_workers= 0
 -------------------------
              +-----------------------------------+---------------------------+
              |                                   |                           |
+-----+       |     +-----------------------+     |                           |
|     |       |     |  Relay log per        |     |     +------------------+  |
|  M1 |&gt;&gt;&gt;&gt;&gt;&gt;&gt;|     |     source            |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|  SQL thread      |  |
+-----+       |     +-----------------------+     |     +------------------+  |
              |                                   |                           |
              +---------------------------------------------------------------+
              |                                   |                           |
              |                                   |                           |
+-----+       |       +----------------------+    |       +-----------------+
|     |       |       |   Relay log          |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|     SQL thread  | |
|  M2 |&gt;&gt;&gt;&gt;&gt;&gt;&gt;|       |                      |    |       +------------------ |
+-----+       |       |    source            |    |                           |
              |       +----------------------+    |                           |
              |                                   |                           |
              |                                   |                           |
              +---------------------------------------------------------------+
+-----+       |                                   |                           |
|  M  |       |      +----------------------+     |                           |
|     |&gt;&gt;&gt;&gt;&gt;&gt;&gt;|      | Relay log            |     |      +----------------+   |
+-----+       |      |     per source       |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|     SQL thread |   |
              |      +----------------------+     |      +----------------+   |
              |                                   |                           |
              |                                   |                           |
              +-----------------------------------+--------------------------+


 slave_parallel_workers &gt; 0
 --------------------------


            +-------------------------+-------------------------------------+
            |                         |                +------+             | 
            |                         |                |   Wi |             | 
            |                         |                +------+             | 
+-----+     |     +-------------+     |    +------+              +------+   | 
|  M1 |     |     |  Relay Log  |     |    |      |              |  Wj  |   |
|     |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|     Per     |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|  C   |              -------+   | 
+-----+     |     |   Source    |     |    +------+  +--------+             | 
            |     +-------------+     |              |   Wk   |             | 
            |                         |              +--------+             | 
            +---------------------------------------------------------------+
            |                         |  Coordinator   +--------+           |
            |                         |   and set of   |   Wi   |           |
            |                         |   workers per  +--------+           |
+-----+     |      +------------+     |   Source                            |
| M2  |     |      |   Relay Lg |     |     +------+            +-----+     |
|     |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|     Per    |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|  C   |            |  wj |     |
+-----+     |      |   Source   |     |     |      |            +-----+     |
            |      +------------+     |     +------+   +------+             |
            |                         |                | Wk   |             |
            |                         |                -------+             |
            +---------------------------------------------------------------+
            |      +------------+     |                +-------+            |
+-----+     |      | Relay log  |     |                |    Wi |            |
| M3  |     |      |    Per     |     |     +-------+  +-------+            |
|     |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|   Source   |&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;|   C   |                       |
+-----+     |      +------------+     |     |       |            +-----+    |
            |                         |     +-------+            | Wj  |    |
            |                         |              +-------+   +------+   |
            |                         |              |    Wk |              |
            |                         |              +-------+              |
            |                         |                                     |
            +-------------------------+-------------------------------------+


 4.User interfaces
   ================
   See High level specification for details.


 5. Slave status and Monitoring support
  ======================================
 Capabilities for reporting channel configuration and execution status
 will be done through performance schema tables for replication by adding a
 channel column for each row





</pre>
            </div>
                                    <div id="tabs-1697-2">
                <pre>FUNCTIONAL REQUIREMENTS
=======================
It is a requirement:
R1: To implement Fan-in replication from N servers.
    See BUG#12560071: REQUEST TO IMPLEMENT MULTI-SOURCE REPLICATION
  R1.a: A corollary, of this requirement is a setup of any
        replication topology shall be possible.
R2: That there shall be no deviation from the current replication
    behaviour(till mysql 5.6), when the user does not use multisource
    replication feature
    R2.a: Backward compatibility of existing interfaces will be maintained.
    R2.b: Not to break external utitiles (MySQL utilities) and MySQL cluster
          (ndb_mi.cc)
R3: To show the replication status for each channel in Performance_Schema
    replication tables.
R4: That this feature works only when the replication repositories are of
    type TABLE
R5: To work when slave_parallel_workers == 0 and &gt; 0 (MTS mode)
R6: To stop replication only for a channel, on which a conflict has occured.
R7: To support GTIDs as well as binary log positions
R8: To support Semi-Sync replication, configurable per channel.
R9: To to able to setup replication filters per channel.

NON FUNCTIONAL REQUIREMENTS
===========================
NR1: No performance drop for a single channel replication
NR2: Slave throughput shall increase with the increase in number of sources.


NON EXTENSIBLE REQUIREMENTS
===========================
It is NOT needed :
NE1: To add any extra conflict detection support
     (i.e use whatever is already present)
NE2: To do any conflict resolution if a conflict occurs.
NE3: To add an extra binlog event on a source&#039;s binary log or change binary
     log  format.
     It follows from both the above 3 points that,the application developer or
     a DBA should partition the data so that it is disjoint for a succesful
     fan in replication.
</pre>
            </div>
                                    <div id="tabs-1697-3">
                                <a class="tab_task_link" href="/worklog/task/?id=2271">WL#2271: Remove my.cnf replication options (5.1)</a><br />
                                <a class="tab_task_link" href="/worklog/task/?id=2385">WL#2385: Multi-source testing</a><br />
                                <a class="tab_task_link" href="/worklog/task/?id=2775">WL#2775: System tables for master.info, relay_log.info</a><br />
                            </div>
                                    <div id="tabs-1697-4">
                <pre>This section is organized into
A) Startup options
B) Naming conventions.
   a) channel name
   b) file names
C) MySQL client commands
D) System variables
E) Slave status variables
F) Error Messages, warnings and notes
G) Compatibility
   a) backward compatibility
   b) Upgrade from 5.5 and 5.6 slave to 5.7 slave with MSR
H) Replication Filters
I) Semisync replication
J) Slave status
   a) SHOW SLAVE STATUS FOR ALL CHANNELS
   b) Performance schema tables

Default channel
----------------
Before diving into the specification, the definition of
default channel is to be cleared. Multi source replication
introduces creation of new channels to replicate from several sources.
To deal with backward compatibility (where the user does not want to use
this feature and want to replicate from a single source just like till 5.6),
this WL creates the notion of a default channel where all the exisiting (till 5.6)
user interface acts on it. This default channel is an empty string, i.e &#039;&#039;.
All the replication commands without explicit mentioning of default channel
names will act on this empty stringed channel.

A default channel is settable by the user by the following command.
CHANGE REPLICATION CHANNEL=&lt;&#039;channel_name&#039;&gt;;
This command changes the *session* default channel to &#039;channel_name&#039;;

In short after the implementation of this feature.
-&gt; A replication command (till 5.6) will act on a default channel.
-&gt; A default channel is implicitly an empty string.
-&gt; User could change the default channel for a session by the command
   CHANGE REPLICATION CHANNEL=&lt;&#039;channel_name&#039;&gt;

A)Startup options
=================
 For this WL, there are no startup options. However, there are startup options
 which are modified. They are described in the next section.

* options that are applicable to *ALL* channels
-------------------------------------------------
Following are the startup options with a brief descrption of how
they would fit in this feature. The ones which does not have
the description below, have the usual meaning applied to all
channels.

# --log-slave-updates
   This option means that *ALL* the transactions that are being received
    by the slave from several sources shall be logged in the binary log.
# --log-slow-slave_statement
# --log-warnings
# --relay-log-purge
   When set, all channels purge their own relay logs automatically
# --relay-log-recovery
# --report-host
# --report-user
# --report-password
# --slave-compressed-protocol
# --relay-log-info-repository
    This has to be TABLE for MSR. Otherwise, addition of second channel
    fails with --ER_SLAVE_WRONG_REPOSITORY_NEW_CHANNEL
# --master-log-info-repository
    This has to be TABLE for MSR. Otherwise, addition of second channel
    fails with --ER_SLAVE_WRONG_REPOSITORY
# --sync_relay_log
# --slave_transaction_retries
    This is yet to be implemented for slave_parallel_workers &gt;= 1
# --relay-log-recovery
# --skip-slave-start
    A slave for all channels does not start.
# --slave-load-tmpdir
# --slave-sql-verify-checksum
# --slave_type_conversions
# --slave-skip-errors
# --slave-exec-mode

* options that are applicable per channel
----------------------------------------------
 Since the following options are set up as startup options, all the channels
 will have the same value even though these options act on a single channel.
 In the future, an interface could be built (probably through CHANGE MASTER)
 so that the user can change these values per channel.

 For example: consider this option,
 --relay-log-space-limit: If this option acts on *all* the
 channels, the meaning would have been, &quot;the upper limit
 on the total size of relay logs of *all* channels&quot;.

 If this option acts on a single channel, the meaning is
 &quot;the upper limit on the total size of relay log per channel&quot;

# --max-relay-log-size=&lt;size&gt;
   Denotes the maximum size of relay log file per channel.
# --relay-log-space-limit=&lt;size&gt;
   Denotes the upper limit of relay log size per channel
# --slave-parallel-workers=&lt;value&gt;
    The number of slave parallel workers per channel.
# --slave-checkpoint-group=#
# --slave-pending-jobs-max-size=#
# --slave-checkpoint-period=#
# --slave-net-timeout=&lt;seconds&gt;
    Denotes the waiting time by an IO thread for each source.
# --relay-log-index=filename
    Denotes the base name of relay log index per channel
    See, Naming conventions section below
# --relay-log=filename
    Denotes the base name of relay log per channel
    See, Naming conventions section below


* options that act only on the empty stringed channel.
---------------------------------------------------
# --master-info-file=&lt;file&gt;
    This is required for FILE based repository and MSR requires
    TABLE
# --relay-log-info-file=&lt;file&gt;
    This is required for FILE based repository and MSR requires
    TABLE


B) Naming conventions
=====================
* channel name
---------------
 # User shall specify &lt;channel_name&gt; in the commands of a particular channel.
   It is a string with a maximum allowed of 64 characters. (same constraint as
DB names)
 # default channel is an empty string.


* File names
---------------
The files that are assosiated with the slave replication are
info files, relay-log index file and relay log files. The following describes
the naming of files per channel and how start up options effect the naming of
files.(There is no change in the binlog name behaviour for a multisourced slave)

To distinguish relay-log files and indices of a particular channel, a channel
name will be a part of these files.
Till 5.6, these files are named as base_name-relay-bin.index
and base_name-relay-bin.00000x where x is a number.
base_name is either host name or the ones specified by relay-log-index
or/and relay-log startup options.

For this WL, the naming conventions of the files are following, if
 channe_name is the name of the channel:
 # relay log index file: base_name-relay-bin-channel_name.index
 # relay log files:      base_name-relay-bin-channel_name.00000x

 where base_name follows the same semantics of mysql 5.6


B). MySQL client commands
=======================
General rules for the commands
==============================
1. Add FOR CHANNEL=&lt;channel_name&gt; to all the replication commands that
   support multiple channels.
2. To support backward compaitbility and also for the users who are not
   interested to use this feature (i.e if FOR CHANNEL = &lt;channel_name&gt;
   is not given by the user) the commands act on default_channel.
   If the user did not set a default channel using the command
   CHANGE REPLICATION CHANNEL=&#039;&lt;channel_name&#039;&gt;, then the command acts
   on empty stringed channel.

3. For any command, if a channel does not exist to act on the command,
   following error is displayed on the client and *server log*
   --ER_SLAVE_CHANNEL_DOES_NOT_EXISTS
           &quot;Slave channel &quot;&lt;channel_name&gt;&quot; does not exist on the slave&quot;

Commands that act on a single channel
---------------------------------------

C1: CHANGE MASTER TO master_def.... FOR CHANNEL=&lt;channel_name&gt;

  i) Updates the members of the master_info object for the channel_name if
     the channel already exists on the slave.
 ii) If the channel does not exist, a Master_info and Relay_log_info object
     for that channel is created and flushed to the repository.
     Notice that, --ER_SLAVE_CHANNEL_DOES_NOT_EXISTS error is not thrown for
     this command.

 iii) Following both commands shall be possible:
      * CHANGE MASTER TO MASTER_NAME=&lt;host1&gt;, MASTER_PORT=&lt;port1&gt;
        FOR CHANNEL=&lt;channel1&gt;
      * CHANGE MASTER TO MASTER_NAME=&lt;host2&gt;, MASTER_PORT=&lt;port2&gt;
        FOR CHANNEL =&lt;channel1&gt;
     i.e one could change the host and/or port for the same channel.

  iv) Following both commands shall not be possible:
      * CHANGE MASTER TO MASTER_NAME=&lt;host1&gt;, MASTER_PORT=&lt;port1&gt;
        FOR CHANNEL =&lt;channel1&gt;
      * CHANGE MASTER TO MASTER_NAME=&lt;host1&gt;, MASTER_PORT=&lt;port1&gt;
         FOR CHANNEL =&lt;channel2&gt;

     The second command will fail with the following error:
       --ER_SLAVE_MULTIPLE_CHANNELS_HOST_PORT
             &quot;Multiple slave channels for the same host and port combination&quot;

 v)This command shall fail when the channel exists, and the threads pertaining
    to that channel are running.


C2: START SLAVE [thread_types] [until_option] [connection_options]
    FOR CHANNEL=&quot;&lt;channel_name&gt;&quot;

   i) Command to start slave for a channel

C3: STOP SLAVE [thread_types] FOR CHANNEL=&lt;channel_name&gt;

   i) Command to stop a slave for a channel


C4: RESET SLAVE [ALL] FOR CHANNEL=&#039;channel_name&#039;
    i) Remove relay logs. Reset positons of mi and rli. Remove the information
        from the repository for that channel_name.

C5: FLUSH RELAY LOGS FOR CHANNEL=&#039;channel_name&#039;

C6: SHOW SLAVE STATUS FOR CHANNEL=&lt;channel_name&gt;

C7: SHOW RELAY_LOG_EVENTS FOR CHANNEL=&lt;channel_name&gt;

C8: SELECT MASTER_POS_WAIT((&#039;master_log_file&#039;, master_log_pos
                            [, timeout] [,channel_name])
    i) channel name is to be specified in the above function

C9: SELECT WAIT_UNTIL_SQL_THREAD_AFTER_GTIDS(&#039;gtid_set&#039;,[time_out])
    i) *Note that* this command does not need a channel name
    ii) There is no change in the interface for this command
    iii) This command, as usual means &quot;wait till the gtid_set is executed.


Commands which could effect all the channels:
---------------------------------------------

C21: SHOW SLAVE STATUS FOR ALL CHANNELS
   i) Show the slave status for all the channnels
   ii) The information of each channel will in a separate row

C22: START SLAVE IO_THREAD | SQL_THREAD FOR ALL CHANNELS
     ii) Start slave for all the channels.

C23: STOP SLAVE IO_THREAD| SQL_THREAD FOR ALL CHANNELS
     iii)Stop slave for all the channels

C24: RESET SLAVE ALL FOR ALL CHANNELS
     i) Resets slave for all the channels.



D) System Variables
========================
These are the options for a replication slave server are dynamic.
(change at run time using SET GLOBAL &lt;system_variable&gt;

# master_info_repository or relay_log_info_repository
  i)  Not allowed to be set as FILE when the number of channels &gt; 1
  ii) Not allowed to be set as FILE when the number of channels == 1
       and channel name != &#039;&#039;
  iii) In the above both cases, an error --ER_SLAVE_WRONG_REPOSITORY is put in
the thread diag area

#  Rest of the variables shall be applicable to all channels.


E) slave status variables
========================
All these status variables act on default channel

Show status like &#039;%Slave_running%&#039;
Show status like &#039;%Slave_retried_transactions%&#039;
Show status like &#039;%last_received_heartbeat%&#039;
Show status like &#039;%received_heartbeat%&#039;
show status like &#039;%heartbeat_period%&#039;


F) Error messages
===================
 Error messages should indicate the channel on which a particular thread, failed.
* The following are the error variables introduced.
 i)  --ER_SLAVE_CHANNEL_DOES_NOT_EXISTS  &quot;Slave channel &#039;%s&#039; does not exist&quot;
 ii) --ER_SLAVE_WRONG_REPOSITORYL &quot;To have multiple channels,
                                    repository cannot be of type FILE&quot;

* The following are the error messages modified with channel name mentioned
  in them:
  All of these error message would have the string &#039;for channel=&#039;%s&#039; added 
  to them
  i) --ER_SLAVE_MUST_STOP  &quot;This operation cannot be performed.
                                Run STOP SLAVE FOR CHANNEL=&quot;%s&#039; first&quot;
  ii) --ER_SLAVE_NOT_RUNNING &quot;This operation requires a running slave.
                     Configure slave and do START SLAVE  FOR CHANNEL=&#039;%s&#039; first&quot;
  iii) --ER_MASTER_INFO  &quot;Coudn&#039;t initialize master info structure
                           for channel=&#039;%s&#039;. More info in the error log&quot;
  iv)  --ER_SLAVE_RUNNING &quot;Slave is already running for channel=&#039;%s&#039;&quot;
   v)  --ER_SLAVE_WAS_NOT_RUNNING &quot;Slave is already stopped for channel=&#039;%s&#039;&quot;
  vi)  --ER_SLAVE_MI_INIT_REPOSITORY &quot;Slave failed to initialize master info
                                         from the repository for channel=&#039;%&#039;&quot;
  vii) --ER_SLAVE_RLI_INIT_REPOSITORY &quot;Slave failed to initialize relay log
                                     infor from the repository for channel=&#039;%s&#039;&quot;

* Notes
  CHANGE MASTER execution results in printing of a channel name in the error log
 G) Compatibility
  ==============
  i) The concept of a default channel which is &#039;&#039; will take care of backward
      compatibility i.e 5.7 with multi-source feature shall work for the user
      scripts based on 5.5 and 5.6 without any hiccups.
  ii) To upgrade from 5.6 to 5.7 with multi-source, users *have* to run the 
     upgrade scripts which would add a channel_name column in the slave 
     repository tables.

H) Replication Filters
  =====================
  i) See WL#7361  for more details

I) Semisync replication
  ======================
  ii) See WL#7359 for more details

J) Slave Status
   =============
   a) SHOW SLAVE STATUS FOR ALL CHANNELS
    i) add channel_name as the last column
    ii) show slave status for each channel in a separate row

  b) replication performance schema tables
    i) Every performance  schema replication table would have channel_name as
        the *first* column
    ii) *NOTE* that this is in contrast to SHOW SLAVE STATUS and slave
        repository tables, where the hannel_name is the last column.
</pre>
            </div>
                                    <div id="tabs-1697-5">
                <pre> The main idea of design should involve:
1) creation of new Master_info and Relay_log_info objects for each channel
2) Datastructure to store Master_infos (since mi-&gt;rli and rli-&gt;mi,
   Master_info&#039;s are sufficient)
3) Reading and writing these objects to the slave repositories
4) Any structures that are global, should be made made structural 
   (i.e wrapped in an object) if required.
5) Remove explicit dependencies on active_mi and use the master info per channel


Following are the important changes that will be implemented when
 slave_parallel_threads=0
++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++


File: rpl_msr.h
-----------------
#ifndef RPL_MSR_H
#define RPL_MSR_H

#if HAVE_REPLICATION

#include&lt;map&gt;
#include&lt;string&gt;
#include &quot;rpl_mi.h&quot;

typedef std::map&lt;std::string, Master_info*&gt; mi_map;

/**
  A  class to store the list of Master_info by channel name.
  It is a wrapper over the STL rb map. This class should be accessed
  from most parts of replication code.

  The class is not thread safe. Any part of the code accessing an object
  should be wrapped in a mutex. (Equivalent of LOCK_active_mi)

  For ex:
   mysql_mutex_lock(LOCK_master_info_map)
   master_info_map_obj.membe_function()
   mysql_mutex_unlock(LOCK_master_info_map)

*/
class Master_info_map
{

public:

  /**
     Default constructor.
  */
   Master_info_map(){};

  /**
    Adds the Master_info object to the map.

   @param[in]   channel     channel name
   @param[mi]   mi          pointer to master info corresponding to this
                            channel

   @return
     @retval     FALSE      succesfully added to the map
     @retval     TRUE       ok.
  */

  bool add_mi(char *channel, Master_info *mi);


  /**
    Find the master_info object corresponding to a channel. Return if
    it exists, other wise return 0;

    @param[in]  channel       channel name for the master info object.

    @retval                   pointer to the master info object if exists
                              in the map. Otherwise, NULL;
  */

  Master_info* get_mi(char* channel);

  /**
    Remove mi and rli of a channel

    @param[in]    channel     Name of the channel for a Master_info object
  */

  void remove_mi_and_rli(char* channel);

  /*
    Destroy all the mi&#039;s and rli&#039;s for each channel
    Called during shutdown
  */
  ~Master_info_map();


  /* Number of master infos. Used to keep track of replication repository */
  uint number_of_instance;
private:
  /*
     Map that stores the pointers to Master_info objects with channel
     as a key name.
  */
  mi_map channel_to_master_info;

};



File: rpl_info_factory.h
-------------------------
These two functions are added to the the Rpl_info_factory class

/**
  For a new channel, create an mi and rli with default values.
  Set mi-&gt;rli and rli-&gt;mi.

*/
static bool create_virtual_slave_objects(uint mi_option,
                                         uint rli_option, uint instance,
                                         char* channel_name,
                                         Master_info **new_mi );

/**
  During init_slave(), read the repositories,
  create Master_info and Relay_log_info objects and insert them to the
  Master_info_map
*/
  static bool init_slave_info_objects(uint mi_option, uint rli_option,
                                     Master_info_map *pmultisource_mis,
                                      bool thread_mask);


File: sql_yacc.yy
------------------
A non terminal called channel is defined in this way:

channel:
           /*empty */
         {
           Lex-&gt;mi.channel_name= (char*)DEFAULT_SLAVE_CHANNEL;
         }
      |  FOR_SYM CHANNEL_SYM EQ TEXT_STRING_sys_nonewline
         {
           Lex-&gt;mi.channel_name= $4.str;
         }
       ;



File: rpl_rli.cc
------------------
 modify the class to have a filter object of it&#039;s own

 class Relay_log_info
{
  char *channel[MAX_CHANNEL_LENGTH];
  Rpl_filter *channel_rpl_filter;

}

File: rpl_mi.cc
----------------
Add channel to the Master_info class
class Master_info
{
  char *channel[MAX_CHANNEL_LENGTH];
}

File: sql_lex.h
------------------
Add channel to st_lex_master_info structure.


File: scripts/mysql_system_tables.sql
======================================

Table: slave_master_info
--------------------------
# Removed (Host, Port) as a Primary key
#: Added Channel_name as a column and make it a primary key.

-  PRIMARY KEY(Host, Port)) DEFAULT CHARSET=utf8 STATS_PERSISTENT=0 COMMENT
&#039;Master Information&#039;&quot;;
+  Channel_name CHAR(64) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL COMMENT
&#039;The channel on which the slave operates on, used in MultiSource Replication&#039;,
+  PRIMARY KEY(Channel_name)) DEFAULT CHARSET=utf8 STATS_PERSISTENT=0 COMMENT
&#039;Master Information&#039;&quot;;

Table: slave_relay_log_info
---------------------------
# Removed Id as primary key
# Added Channel_name as a column and make (Channel_name) as a primary key

-  PRIMARY KEY(Id)) DEFAULT CHARSET=utf8 STATS_PERSISTENT=0 COMMENT &#039;Relay Log
Information&#039;&quot;;
+  Channel_name CHAR(64) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL COMMENT
&#039;The channel on which the slave operates on, used in MultiSource Replication&#039;,
+  PRIMARY KEY(Channel_name)) DEFAULT CHARSET=utf8 STATS_PERSISTENT=0
COMMENT &#039;Relay Log Information&#039;&quot;;

Corresponding to above tables, fields were changed in rpl_mi.cc and rpl_rli.cc



Replacing active_mi
-------------------------
Depending on the placement of the code, active_mi could be replaced with the
following entities
i)  Multisource_map.get_mi(char* channel)
ii) thd-&gt;rli_slave-&gt;mi
iii) my_pthread_getspecific_ptr(Master_info*, RPL_MASTER_INFO);

Replacing LOCK_active_mi
--------------------------
LOCK_active_mi will be replaced with LOCK_multisource_map. Notice that there
is no real need for Read Write lock over the Multisource_map. 
A single mutex with a different name (only to avoid confusion later) suffices.
LOCK_active_mi will be replaced with LOCK_multisource_map.

</pre>
            </div>
                    </div>
    </div>
        <br style="clear: both" /><br />
    
    <div class="worklog_copyright_main">
        Copyright (c) 2000, 2014, Oracle Corporation and/or its affiliates. All rights reserved.
    </div>

    <script>
    
    $(function() {
        $("#tabs").tabs();
        $("#tabs").show();
    });
    
    </script>




</div> <!--End Container -->




 </div> 
</div> 
<div id="footer">

    <div class="links">
        <ul>
            <li class="top"><a href="http://dev.mysql.com">Developer Zone</a></li>
	    <li><a href="http://dev.mysql.com/doc/">Documentation</a></li>
            <li><a href="http://dev.mysql.com/articles/">Developer Articles</a></li>
            <li><a href="http://forums.mysql.com/">Forums</a></li>
			<li><a href="http://lists.mysql.com/">Lists</a></li>
            <li><a href="http://bugs.mysql.com/">Bugs</a></li>
            <li><a href="http://dev.mysql.com/worklog/">Worklog</a></li>
			            <li><a href="http://planet.mysql.com/">Planet MySQL</a></li>
			            <li><a href="http://labs.mysql.com/">Labs</a></li>
        </ul>
    </div>

    <div class="links">
        <ul>
            <li class="top"><a href="http://dev.mysql.com/downloads/">Downloads</a></li>
            <li><a href="http://dev.mysql.com/downloads/mysql/">MySQL Community Server</a></li>
            <li><a href="http://dev.mysql.com/downloads/mysql-proxy/">MySQL Proxy</a></li>
            <li><a href="http://dev.mysql.com/downloads/cluster/">MySQL Cluster</a></li>
            <li><a href="http://dev.mysql.com/downloads/workbench/">MySQL Workbench</a></li>
            <li><a href="http://dev.mysql.com/downloads/connector/">MySQL Connectors</a></li>
            <li><a href="http://downloads.mysql.com/archives/">Archives</a></li>
        </ul>
    </div>

    <div class="links">
        <ul>
            <li class="top"><a href="http://dev.mysql.com/doc/">Documentation</a></li>
            <li><a href="http://dev.mysql.com/doc/">MySQL Reference Manuals</a></li>
            <li><a href="http://dev.mysql.com/doc/index-gui.html">MySQL Workbench</a></li>
            <li><a href="http://dev.mysql.com/doc/index-expert.html">Expert Guides</a></li>
            <li><a href="http://dev.mysql.com/doc/index-topic.html">Topic Guides</a></li>
            <li><a href="http://dev.mysql.com/doc/index-cluster.html">MySQL Cluster</a></li>
            <li><a href="http://dev.mysql.com/doc/index-other.html">Other Documents</a></li>
            <li><a href="http://dev.mysql.com/doc/index-about.html">About</a></li>
            <li><a href="http://dev.mysql.com/doc/index-archive.html">Archives</a></li>
        </ul>
    </div>


    <div class="links">
        <ul>
            <li class="top"><a href="http://www.mysql.com/about/">About MySQL</a></li>
            <li><a href="http://www.mysql.com/about/contact/">Contact Us</a></li>
                         <li><a href="http://www.mysql.com/buy-mysql/">How to Buy</a></li>
			<li><a href="http://www.mysql.com/partners/">Partners</a></li>
            <li><a href="http://www.mysql.com/about/jobs/">Job Opportunities</a></li>
            <li><a href="http://www.mysql.com/sitemap.html">Site Map</a></li>
	            </ul>
	</div>

	<div class="links">
		<ul>
			<li class="top"><a href="http://www.mysql.com/about/legal/">Legal</a></li>
			<li><a href="http://www.mysql.com/about/legal/">Legal Policies</a></li>
			<li><a href="http://www.oracle.com/us/legal/privacy/index.htm">Your Privacy Rights</a></li>
			<li><a href="http://www.oracle.com/us/legal/terms/index.html">Terms of Use</a></li>
			<li><a href="http://www.oracle.com/us/legal/third-party-trademarks/index.html">Trademark Policy</a></li>
			<li><a href="http://www.oracle.com/technetwork/community/oca-486395.html">Contributor Agreement</a></li>
		</ul>
	</div>


    <div id="search" class="en">
	        <form id="footer_search" action="http://search.oracle.com/search/search" method="get">
            <input type="text" id="f_q" name="q" value="" class="swap_value" onfocus="clearSearchText();" />
	    <input type="hidden"  name="group" value="MySQL"/>
	    <input type="image" src="/common/themes/sakila/footer_search_g.png" id="f_go" alt="Search" title="Search" />
        </form>    </div>

</div><!-- End Footer -->
		<div id="copyright-oracle"><a href="http://www.oracle.com/"><img src="/common/logos/logo-oracle-red-91x22.gif" alt="Oracle" width="91" height="22" /></a>&nbsp;&nbsp;<span>&copy; 2014, Oracle Corporation and/or its affiliates</span></div>


<script src="/common/js/metrics/s_code_remote.js"></script>

</body>
</html>