<!DOCTYPE HTML>
<!--
 ______________ 
< TUICOOL.COM >
 -------------- 
        \   ^__^
         \  (**)\__$__$__
            (__)\       )\/\
             U  ||------|
                ||     ||
-->
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta content="authenticity_token" name="csrf-param" />
<meta content="zOF1o/x1WaB0x3GPNRgLQnsNFmqTzLtIlpinKONnTJA=" name="csrf-token" />
    <title>How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4 - 推酷</title>
    <meta name="description" content="How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4"/>

  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon" />
  
  <link href="/assets/application-4925e98c3c1dd4735014625df846c041.css" media="all" rel="stylesheet" type="text/css" />
  <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.min.css" rel="stylesheet">

  <script src="/assets/application-b78a06490a2e09f7d2047e6df15164c4.js" type="text/javascript"></script>
  <script src="/assets/bootstrap-popover-851b0f56937743d00ab0112fdc4047f0.js" type="text/javascript"></script>

  <!--[if IE 7]>
  <link rel="stylesheet" href="/assets/font-awesome-ie7.min.css">
  <![endif]--> 

    <script src="/assets/tip-405762ee91c557443304e044d7a80e57.js" type="text/javascript"></script>

    
 	<link href="/assets/art_zoom-48eda4c0f1a722be6edc5f6d8bc65a9b.css" media="screen" rel="stylesheet" type="text/css" />
<script src="/assets/weibo-7585d869cd63846c6f174a8c58396405.js" type="text/javascript"></script>


</head>
<body>
  
  <div id="header" class="navbar-fixed-top">
    <div class="container">
      <div class="navbar">
        <div class="navbar-inner">
          <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"> 
            <span class="icon-bar"></span> 
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span> 
          </a>
          <a href="/" class="brand">推酷</a>        
		      <nav class="nav-collapse collapse">
            <ul class="nav navbar primary-nav">                            
              <li class="">
                <a href="/ah">
                  文章
                </a>
              </li>              
              <li class="">
                <a href="/topics">
                  主题
                </a>
              </li>
              <li class="">
				<a href="/sites/hot">
                  站点
                </a>
              </li>
              <li class="">
                <a href="/huodong">
                  活动
                </a>
              </li>
              <li class="">
                <a href="/mobile">
                  客户端
                </a>
              </li>
              <li class="dropdown  ">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">周刊 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="/mags">编程狂人</a></li>
                  <li><a href="/mags/design">设计匠艺</a></li>                  
                </ul>
              </li>
			  
			   <li class="dropdown  ">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown">更多 <b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li>
                    <a href="/t">
                        微博推荐
                    </a>
                    </li>
				  <li><a href="/jobs">内推招聘</a></li>       
                  <li><a href="/bbs">讨论区</a></li>                  
                </ul>
              </li>
			  
	          </ul>
            <form class="navbar-search pull-left" action="/topics/search">
              <input type="text" class="search-query span2" name="kw" placeholder="搜索主题">
            </form>
            <ul class="nav pull-right">
                <li><a href="/login">登录</a></li>
            </ul>
          </nav>
        </div>
      </div>
	   </div>	
	</div>
  <div id ="flash_container" class="noPrint">    
    <!-- <a href='#'' class='close' data-dismiss='alert'>×</a> -->
  </div>
    
<div class="container-fluid">  
  <!-- body start-->
  <script src="/assets/spin-4bedcc6bf2df43d294f0e443892d531c.min" type="text/javascript"></script>
<link rel="stylesheet" href="/assets/prettify/github.css">
<div class="row-fluid">
    <!--show start-->
    <div class="span8 contant">
        <h1>How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4</h1>
        <div class="article_meta">
            <span class="timestamp">时间2013-05-29 23:28:50
            </span>
            <span class="from"><i class="icon-globe"></i><a class="cut cut28 from" href="/sites/z6bQ7v" target="_blank">MySQL Performance Blog
                </a></span>
            <span id="dup-cnt"><a href="/articles/dup?id=j6rium" target="_blank">相似文章</a> (<i id="dup">0</i>)</span>
            <span class="pdf">            </span>
            <span class="source" style="display:block;"><i style="float:left;">原文</i>&nbsp; 
                <a class="cut cut70" href="/articles/goto?id=j6rium" style="display:inline-block;">http://www.mysqlperformanceblog.com/2013/05/29/how-to-fix-your-prm-cluster-when-upgrading-to-rhelcentos-6-4/</a>
            </span>
            <a href="#add-article-to-kan" id="add-article-to-kan-btn" class="btn" data-toggle="modal" style="display:none;">添加到推刊</a>
            <!-- add_article to kan -->
<div id="add-article-to-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-header">
    <span class="add-title">收藏到推刊</span>
    <a href="#new-kan" class="btn pull-right" data-toggle="modal">创建推刊</a>
    <i class="clearfix"></i>
  </div>
  <div class="modal-body">
    <ul id="add-kan-list">
    </ul>
  </div>
  <div class="modal-footer">
    <input type="hidden" value="j6rium" class="article-id" /> 
    <button class="btn btn-primary pull-left add-to-btn">  收 藏  </button>
    <button class="btn" data-dismiss="modal" aria-hidden="true">取消</button>
  </div>
</div>
<div class="add-article-to-kan-alert">
  已收藏到推刊！
</div>

            <div id="new-kan" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
<!--
    <a href="new-kan" class="btn" data-toggle="modal">创建推刊</a>
  <div class="modal-header">
    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
    <h3 id="myModalLabel">Modal header</h3>
  </div>
-->
  <div class="modal-body">
    <input type="text" name="name" id="new-kan-name"  placeholder="推刊名(必填)" required data-validation-required-message="请填写推刊名" />
    <span class="new-ness-name">请填写推刊名</span>
    <br/>
    <textarea name="desc" id="desc" rows="6" placeholder="推刊描述"></textarea>
    <span class="new-ness-desc">描述不能大于100个字符!</span>
    <br/>
    权限设置：<input type="radio" name="type" value="1" checked="checked" /> 公开
    <input type="radio" name="type" value="0"> 仅自己可见
  </div>
  <div class="modal-footer">
    <button class="btn btn-primary pull-left create-kan-btn" disabled>创建</button>
    <button class="btn dismiss-new-kan" data-dismiss="modal" aria-hidden="true">取消</button>
  </div>
</div>


        </div>
        <div class="article_body" id="nei">
            <div>
  <p>
    If you a
    <a href="http://www.mysqlperformanceblog.com/wp-content/uploads/2013/05/repairs.jpg">
      <img alt="How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4" src="http://img0.tuicool.com/YrUjqe.jpg" width="300" height="253" class="alignCenter" />
    </a>
    re using Percona Replication Manager (PRM) with RHEL/CentOS prior to 6.4, upgrading your distribution to 6.4 may break your cluster. In this post I will explain you how to fix your cluster in case it breaks after a distribution upgrade that implies an update of pacemaker from 1.1.7 to 1.18. You can also follow the official documentation
    <a href="http://clusterlabs.org/quickstart-redhat.html">here</a>
    .
  </p>
  <p>
    The version of Pacemaker (always considered as Technology Preview by RedHat) provided with 6.4 is 1.1.8-x which is not 100% compatible with 1.1.7-x see
    <a href="http://clusterlabs.org/abi/pacemaker/">this report</a>
    .
  </p>
  <p>
    So if you want to upgrade, you cannot apply any rolling upgrade process. So like for Pacemaker 0.6.x to 1.0.x, you need again to update all nodes as once. As notified in
    <a href="https://rhn.redhat.com/errata/RHBA-2013-0375.html">RHBA-2013-0375</a>
    , RedHat encourages people to use Pacemaker in combination with the CMAN manager (It may become mandatory with the next release).
  </p>
  <p>
    CMAN v3 is a Corosync plugin that monitors the names and number of active cluster nodes in order to deliver membership and quorum information to clients (such as the Pacemaker daemons) and it’s part of the RedHat cluster stack. If you were using some puppet recipes published previously
    <a href="http://www.mysqlperformanceblog.com/2012/04/17/testing-percona-prm/">here</a>
    you are not yet using CMAN.
  </p>
  <p>
    Let’s have look at what happens if we have a cluster with 3 nodes (CentOS 6.3) and using
    <a href="https://raw.github.com/y-trudeau/resource-agents-prm/master/heartbeat/mysql">PRM as OCF</a>
    :
  </p>
  <blockquote>
    <p>
      [root@percona1 percona]# crm_mon -1
      <br/>
      ============
      <br/>
      Last updated: Thu May 23 08:04:30 2013
      <br/>
      Last change: Thu May 23 08:03:41 2013 via crm_attribute on percona2
      <br/>
      Stack: openais
      <br/>
      Current DC: percona1 – partition with quorum
      <br/>
      Version: 1.1.7-6.el6-148fccfd5985c5590cc601123c6c16e966b85d14
      <br/>
      3 Nodes configured, 3 expected votes
      <br/>
      7 Resources configured.
      <br/>
      ============
    </p>
    <p>Online: [ percona1 percona2 percona3 ]</p>
    <p>
      reader_vip_1 (ocf::heartbeat:IPaddr2): Started percona3
      <br/>
      reader_vip_2 (ocf::heartbeat:IPaddr2): Started percona2
      <br/>
      reader_vip_3 (ocf::heartbeat:IPaddr2): Started percona1
      <br/>
      writer_vip (ocf::heartbeat:IPaddr2): Started percona1
      <br/>
      Master/Slave Set: ms_MySQL [p_mysql]
      <br/>
      Masters: [ percona2 ]
      <br/>
      Slaves: [ percona3 percona1 ]
    </p>
    <p>
      [root@percona1 ~]# cat /etc/redhat-release
      <br/>
      CentOS release 6.3 (Final)
      <br/>
      [root@percona1 ~]# rpm -q pacemaker
      <br/>
      pacemaker-1.1.7-6.el6.x86_64
      <br/>
      [root@percona1 ~]# rpm -q corosync
      <br/>
      corosync-1.4.1-7.el6_3.1.x86_64
    </p>
  </blockquote>
  <p>
    Everything is working
    <img src="http://img1.tuicool.com/zA3Y7z.gif" alt=":-)" />
    <br/>
    Let’s update our system to 6.4 on one server…
  </p>
  <p>
    <em>
      <strong>NOTE:</strong>
      In production you should put the cluster in maintenance mode before the update, see bellow how to perform this action
    </em>
  </p>
  <blockquote>
    <p>[root@percona1 percona]# yum update -y</p>
    <p>
      [root@percona1 percona]# cat /etc/redhat-release
      <br/>
      CentOS release 6.4 (Final)
    </p>
    <p>
      [root@percona1 ~]# rpm -q pacemaker
      <br/>
      pacemaker-1.1.8-7.el6.x86_64
      <br/>
      [root@percona1 ~]# rpm -q corosync
      <br/>
      corosync-1.4.1-15.el6_4.1.x86_64
    </p>
  </blockquote>
  <p>Let’s reboot it…</p>
  <blockquote>
    <p>[root@percona1 percona]# reboot</p>
  </blockquote>
  <p>If we check the cluster from another node, we see that percona1 is now offline:</p>
  <blockquote>
    <p>
      ============
      <br/>
      Last updated: Thu May 23 08:29:36 2013
      <br/>
      Last change: Thu May 23 08:03:41 2013 via crm_attribute on percona2
      <br/>
      Stack: openais
      <br/>
      Current DC: percona3 – partition with quorum
      <br/>
      Version: 1.1.7-6.el6-148fccfd5985c5590cc601123c6c16e966b85d14
      <br/>
      3 Nodes configured, 3 expected votes
      <br/>
      7 Resources configured.
      <br/>
      ============
    </p>
    <p>
      Online: [ percona2 percona3 ]
      <br/>
      OFFLINE: [ percona1 ]
    </p>
    <p>
      reader_vip_1 (ocf::heartbeat:IPaddr2): Started percona2
      <br/>
      reader_vip_2 (ocf::heartbeat:IPaddr2): Started percona3
      <br/>
      reader_vip_3 (ocf::heartbeat:IPaddr2): Started percona2
      <br/>
      writer_vip (ocf::heartbeat:IPaddr2): Started percona3
      <br/>
      Master/Slave Set: ms_MySQL [p_mysql]
      <br/>
      Masters: [ percona2 ]
      <br/>
      Slaves: [ percona3 ]
      <br/>
      Stopped: [ p_mysql:2 ]
    </p>
  </blockquote>
  <p>
    After the update and after fixing some small issues like the one bellow, you are able to start Corosync and Pacemaker but the node doesn’t join the cluster
    <img src="http://img2.tuicool.com/vM3aya.gif" alt=":(" />
  </p>
  <p>
    <code class="prettyprint">May 23 08:34:12 percona1 corosync[1535]: [MAIN ] parse error in config: Can't open logfile '/var/log/corosync.log' for reason: Permission denied (13).#012.</code>
  </p>
  <p>So now you need to update all nodes to Pacemaker 1.1.8 but to avoid again issues with the next distribution update, I prefer to use CMAN as recommended.</p>
  <p>First as we have 2 nodes of 3 running, we should try to not stop all our servers… let’s put the cluster in maintenance mode (don’t forget you should have done this even before updating the first node, but I wanted to simulate the problem):</p>
  <blockquote>
    <p>[root@percona3 percona]# crm configure property maintenance-mode=true</p>
  </blockquote>
  <p>We can see that the resources are unmanaged:</p>
  <blockquote>
    <p>
      ============
      <br/>
      Last updated: Thu May 23 08:43:49 2013
      <br/>
      Last change: Thu May 23 08:43:49 2013 via cibadmin on percona3
      <br/>
      Stack: openais
      <br/>
      Current DC: percona3 – partition with quorum
      <br/>
      Version: 1.1.7-6.el6-148fccfd5985c5590cc601123c6c16e966b85d14
      <br/>
      3 Nodes configured, 3 expected votes
      <br/>
      7 Resources configured.
      <br/>
      ============
    </p>
    <p>
      Online: [ percona2 percona3 ]
      <br/>
      OFFLINE: [ percona1 ]
    </p>
    <p>
      reader_vip_1 (ocf::heartbeat:IPaddr2): Started percona2 (unmanaged)
      <br/>
      reader_vip_2 (ocf::heartbeat:IPaddr2): Started percona3 (unmanaged)
      <br/>
      reader_vip_3 (ocf::heartbeat:IPaddr2): Started percona2 (unmanaged)
      <br/>
      writer_vip (ocf::heartbeat:IPaddr2): Started percona3 (unmanaged)
      <br/>
      Master/Slave Set: ms_MySQL [p_mysql] (unmanaged)
      <br/>
      p_mysql:0 (ocf::percona:mysql): Master percona2 (unmanaged)
      <br/>
      p_mysql:1 (ocf::percona:mysql): Started percona3 (unmanaged)
      <br/>
      Stopped: [ p_mysql:2 ]
    </p>
  </blockquote>
  <p>Now we can upgrade all servers to 6.4</p>
  <blockquote>
    <p>
      [root@percona2 percona]# yum -y update
      <br/>
      [root@percona3 percona]# yum -y update
    </p>
  </blockquote>
  <p>Meanwhile, we can already prepare the first node to use CMAN:</p>
  <blockquote>
    <p>[root@percona1 ~]# yum -y install cman ccs</p>
  </blockquote>
  <p>Back on the two nodes that were updating, they are now updated to 6.4:</p>
  <blockquote>
    <p>
      [root@percona3 percona]# cat /etc/redhat-release
      <br/>
      CentOS release 6.4 (Final)
    </p>
  </blockquote>
  <p>And let’s check the cluster status:</p>
  <blockquote>
    <p>
      [root@percona3 percona]# crm_mon -1
      <br/>
      Could not establish cib_ro connection: Connection refused (111)
    </p>
  </blockquote>
  <p>Connection to cluster failed: Transport endpoint is not connected…</p>
  <p>…but MySQL is still running:</p>
  <blockquote>
    <p>
      [root@percona2 percona]# mysqladmin ping
      <br/>
      mysqld is alive
    </p>
    <p>
      [root@percona3 percona]# mysqladmin ping
      <br/>
      mysqld is alive
    </p>
  </blockquote>
  <p>Let’s install CMAN on percona2 and percona3 too:</p>
  <blockquote>
    <p>
      [root@percona2 percona]# yum -y install cman ccs
      <br/>
      [root@percona3 percona]# yum -y install cman ccs
    </p>
  </blockquote>
  <p>Then on ALL nodes, stop Pacemaker and Corosync</p>
  <blockquote>
    <p>
      [root@percona1 ~]# /etc/init.d/pacemaker stop
      <br/>
      [root@percona1 ~]# /etc/init.d/corosync stop
      <br/>
      [root@percona2 ~]# /etc/init.d/pacemaker stop
      <br/>
      [root@percona2 ~]# /etc/init.d/corosync stop
      <br/>
      [root@percona3 ~]# /etc/init.d/pacemaker stop
      <br/>
      [root@percona3 ~]# /etc/init.d/corosync stop
    </p>
  </blockquote>
  <p>Remove Corosync from the startup services:</p>
  <blockquote>
    <p>
      [root@percona1 ~]# chkconfig corosync off
      <br/>
      [root@percona2 ~]# chkconfig corosync off
      <br/>
      [root@percona3 ~]# chkconfig corosync off
    </p>
  </blockquote>
  <p>Let’s specify that the cluster can start without quorum:</p>
  <blockquote>
    <p>
      [root@percona1 ~]# sed -i.sed “s/.*CMAN_QUORUM_TIMEOUT=.*/CMAN_QUORUM_TIMEOUT=0/g” /etc/sysconfig/cman
      <br/>
      [root@percona2 ~]# sed -i.sed “s/.*CMAN_QUORUM_TIMEOUT=.*/CMAN_QUORUM_TIMEOUT=0/g” /etc/sysconfig/cman
      <br/>
      [root@percona3 ~]# sed -i.sed “s/.*CMAN_QUORUM_TIMEOUT=.*/CMAN_QUORUM_TIMEOUT=0/g” /etc/sysconfig/cman
    </p>
  </blockquote>
  <p>And create the cluster, perform the following command on one server only:</p>
  <blockquote>
    <p>[root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –createcluster lefred_prm</p>
  </blockquote>
  <p>Now add the nodes to the cluster:</p>
  <blockquote>
    <p>
      [root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addnode percona1
      <br/>
      Node percona1 added.
      <br/>
      [root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addnode percona2
      <br/>
      Node percona2 added.
      <br/>
      [root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addnode percona3
      <br/>
      Node percona3 added.
    </p>
  </blockquote>
  <p>we need then to delegate the fencing to pacemaker (adding a fence device, fence methods to specific node and the instances) :</p>
  <blockquote>
    <p>[root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addfencedev pcmk agent=fence_pcmk</p>
    <p>
      [root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addmethod pcmk-redirect percona1
      <br/>
      Method pcmk-redirect added to percona1.
      <br/>
      [root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addmethod pcmk-redirect percona2
      <br/>
      Method pcmk-redirect added to percona2.
      <br/>
      [root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addmethod pcmk-redirect percona3
      <br/>
      Method pcmk-redirect added to percona3.
    </p>
    <p>
      [root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addfenceinst pcmk percona1 pcmk-redirect port=percona1
      <br/>
      [root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addfenceinst pcmk percona2 pcmk-redirect port=percona2
      <br/>
      [root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –addfenceinst pcmk percona3 pcmk-redirect port=percona3
    </p>
  </blockquote>
  <p>Encrypt the cluster:</p>
  <blockquote>
    <p>[root@percona1 ~]# ccs -f /etc/cluster/cluster.conf –setcman keyfile=”/etc/corosync/authkey” transport=”udpu”</p>
  </blockquote>
  <p>Let’s check if the configuration file is OK:</p>
  <blockquote>
    <p>
      [root@percona1 ~]# ccs_config_validate -f /etc/cluster/cluster.conf
      <br/>
      Configuration validates
    </p>
  </blockquote>
  <p>We can now copy the configuration file on all nodes:</p>
  <blockquote>
    <p>
      [root@percona1 ~]# scp /etc/cluster/cluster.conf percona2:/etc/cluster/
      <br/>
      [root@percona1 ~]# scp /etc/cluster/cluster.conf percona3:/etc/cluster/
    </p>
  </blockquote>
  <p>Enable CMAN at startup on all nodes:</p>
  <blockquote>
    <p>
      [root@percona1 ~]# chkconfig cman on
      <br/>
      [root@percona2 ~]# chkconfig cman on
      <br/>
      [root@percona3 ~]# chkconfig cman on
    </p>
  </blockquote>
  <p>And start the services on all nodes:</p>
  <blockquote>
    <p>
      [root@percona1 ~]# /etc/init.d/cman start
      <br/>
      Starting cluster:
      <br/>
      Checking if cluster has been disabled at boot… [ OK ]
      <br/>
      Checking Network Manager… [ OK ]
      <br/>
      Global setup… [ OK ]
      <br/>
      Loading kernel modules… [ OK ]
      <br/>
      Mounting configfs… [ OK ]
      <br/>
      Starting cman… [ OK ]
      <br/>
      Waiting for quorum… [ OK ]
      <br/>
      Starting fenced… [ OK ]
      <br/>
      Starting dlm_controld… [ OK ]
      <br/>
      Tuning DLM kernel config… [ OK ]
      <br/>
      Starting gfs_controld… [ OK ]
      <br/>
      Unfencing self… [ OK ]
      <br/>
      Joining fence domain… [ OK ]
      <br/>
      [root@percona1 ~]# /etc/init.d/pacemaker start
      <br/>
      Starting cluster:
      <br/>
      Checking if cluster has been disabled at boot… [ OK ]
      <br/>
      Checking Network Manager… [ OK ]
      <br/>
      Global setup… [ OK ]
      <br/>
      Loading kernel modules… [ OK ]
      <br/>
      Mounting configfs… [ OK ]
      <br/>
      Starting cman… [ OK ]
      <br/>
      Waiting for quorum… [ OK ]
      <br/>
      Starting fenced… [ OK ]
      <br/>
      Starting dlm_controld… [ OK ]
      <br/>
      Tuning DLM kernel config… [ OK ]
      <br/>
      Starting gfs_controld… [ OK ]
      <br/>
      Unfencing self… [ OK ]
      <br/>
      Joining fence domain… [ OK ]
      <br/>
      Starting Pacemaker Cluster Manager: [ OK ]
    </p>
    <p>
      [root@percona2 ~]# /etc/init.d/cman start
      <br/>
      [root@percona2 ~]# /etc/init.d/pacemaker start
      <br/>
      [root@percona3 ~]# /etc/init.d/cman start
      <br/>
      [root@percona3 ~]# /etc/init.d/pacemaker start
    </p>
  </blockquote>
  <p>We can now connect crm_mon to the cluster and check its status:</p>
  <blockquote>
    <p>
      [root@percona2 percona]# crm_mon -1
      <br/>
      Last updated: Thu May 23 09:18:58 2013
      <br/>
      Last change: Thu May 23 09:16:31 2013 via crm_attribute on percona1
      <br/>
      Stack: cman
      <br/>
      Current DC: percona1 – partition with quorum
      <br/>
      Version: 1.1.8-7.el6-394e906
      <br/>
      3 Nodes configured, 3 expected votes
      <br/>
      7 Resources configured.
    </p>
    <p>Online: [ percona1 percona2 percona3 ]</p>
    <p>
      reader_vip_1 (ocf::heartbeat:IPaddr2): Started percona3
      <br/>
      reader_vip_2 (ocf::heartbeat:IPaddr2): Started percona2
      <br/>
      reader_vip_3 (ocf::heartbeat:IPaddr2): Started percona1
      <br/>
      writer_vip (ocf::heartbeat:IPaddr2): Started percona1
      <br/>
      Master/Slave Set: ms_MySQL [p_mysql]
      <br/>
      Masters: [ percona1 ]
      <br/>
      Slaves: [ percona2 percona3 ]
    </p>
  </blockquote>
  <p>We can see that some resources changed this is because we didn’t put it in maintenance on node1 before the update to 6.4</p>
  <p>
    In case we put everything in maintenance mode as it should be before the upgrade to 6.4, it’s time to stop the maintenance mode… but crm command is not present any more
    <img src="http://img0.tuicool.com/UnEN7r.gif" alt=";)" />
  </p>
  <p>It’s still possible to find the command install crmsh (crm shell from another repository) or just install pcs (Pacemaker Configuration System)</p>
  <blockquote>
    <p>
      [root@percona2 percona]# yum -y install pcs
      <br/>
      [root@percona2 percona]# pcs status
      <br/>
      Last updated: Thu May 23 09:24:37 2013
      <br/>
      Last change: Thu May 23 09:16:31 2013 via crm_attribute on percona1
      <br/>
      Stack: cman
      <br/>
      Current DC: percona1 – partition with quorum
      <br/>
      Version: 1.1.8-7.el6-394e906
      <br/>
      3 Nodes configured, 3 expected votes
      <br/>
      7 Resources configured.
    </p>
    <p>Online: [ percona1 percona2 percona3 ]</p>
    <p>Full list of resources:</p>
    <p>
      reader_vip_1 (ocf::heartbeat:IPaddr2): Started percona3
      <br/>
      reader_vip_2 (ocf::heartbeat:IPaddr2): Started percona2
      <br/>
      reader_vip_3 (ocf::heartbeat:IPaddr2): Started percona1
      <br/>
      writer_vip (ocf::heartbeat:IPaddr2): Started percona1
      <br/>
      Master/Slave Set: ms_MySQL [p_mysql]
      <br/>
      Masters: [ percona1 ]
      <br/>
      Slaves: [ percona2 percona3 ]
    </p>
  </blockquote>
  <p>So if you were in maintenance mode, you should have :</p>
  <blockquote>
    <p>
      [root@percona2 percona]# pcs status
      <br/>
      Last updated: Thu May 23 09:26:56 2013
      <br/>
      Last change: Thu May 23 09:26:50 2013 via cibadmin on percona2
      <br/>
      Stack: cman
      <br/>
      Current DC: percona1 – partition with quorum
      <br/>
      Version: 1.1.8-7.el6-394e906
      <br/>
      3 Nodes configured, 3 expected votes
      <br/>
      7 Resources configured.
    </p>
    <p>Online: [ percona1 percona2 percona3 ]</p>
    <p>Full list of resources:</p>
    <p>
      reader_vip_1 (ocf::heartbeat:IPaddr2): Started percona3 (unmanaged)
      <br/>
      reader_vip_2 (ocf::heartbeat:IPaddr2): Started percona2 (unmanaged)
      <br/>
      reader_vip_3 (ocf::heartbeat:IPaddr2): Started percona1 (unmanaged)
      <br/>
      writer_vip (ocf::heartbeat:IPaddr2): Started percona1 (unmanaged)
      <br/>
      Master/Slave Set: ms_MySQL [p_mysql] (unmanaged)
      <br/>
      p_mysql:0 (ocf::percona:mysql): Master percona1 (unmanaged)
      <br/>
      p_mysql:1 (ocf::percona:mysql): Slave percona2 (unmanaged)
      <br/>
      p_mysql:2 (ocf::percona:mysql): Slave percona3 (unmanaged)
    </p>
  </blockquote>
  <p>And now you are able to stop maintenance mode:</p>
  <blockquote>
    <p>[root@percona2 percona]# pcs property set maintenance-mode=false</p>
  </blockquote>
  <p>You can also check your cluster using cman_tool or clustat (if you have installed rgmanager)</p>
  <blockquote>
    <p>
      [root@percona3 ~]# cman_tool nodes
      <br/>
      Node Sts Inc Joined Name
      <br/>
      1 M 64 2013-05-23 09:52:03 percona1
      <br/>
      2 M 64 2013-05-23 09:52:03 percona2
      <br/>
      3 M 64 2013-05-23 09:52:03 percona3
    </p>
    <p>
      [root@percona3 ~]# clustat
      <br/>
      Cluster Status for lefred_prm @ Thu May 23 10:20:36 2013
      <br/>
      Member Status: Quorate
    </p>
    <p>
      Member Name ID Status
      <br/>
      —— —- —- ——
      <br/>
      percona1 1 Online
      <br/>
      percona2 2 Online
      <br/>
      percona3 3 Online, Local
    </p>
  </blockquote>
  <p>Now the cluster is fixed and everything works again as expected and you should be ready for the next distro upgrade!</p>
  <p>
    <em>
      <strong>INFO:</strong>
      If you have the file /etc/corosync/service.d/pcmk you need to delete it before installing CMAN
    </em>
  </p>
</div>

        </div>
    </div>
    <div class="span4">
        <div id ="related_topics" class="related_topics">
            <h4 class="side_article_list_title">相关主题</h4>
            <ul class="side_topic_list">
                <li class="side_topic_list_item">
                    <a href="/topics/11030009" target="_blank" style="text-decoration:none;"><img src="http://ttimg1.tuicool.com/11030009.png!small" alt="Percona" /></a><span><a href="/topics/11030009" target="_blank">Percona</a></span>

                    <span><a data-id="11030009" class="btn fo-btn fo-ok" style="display:none;"><img src="/images/add.png" class="fo-img"/></a></span>
                </li>
                <li class="side_topic_list_item">
                    <a href="/topics/11200003" target="_blank" style="text-decoration:none;"><img src="http://ttimg3.tuicool.com/11200003.png!small" alt="Centos" /></a><span><a href="/topics/11200003" target="_blank">Centos</a></span>

                    <span><a data-id="11200003" class="btn fo-btn fo-ok" style="display:none;"><img src="/images/add.png" class="fo-img"/></a></span>
                </li>
                <li class="side_topic_list_item">
                    <a href="/topics/11200038" target="_blank" style="text-decoration:none;"><img src="http://ttimg2.tuicool.com/11200038.png!small" alt="RedHat Linux" /></a><span><a href="/topics/11200038" target="_blank">RedHat Linux</a></span>

                    <span><a data-id="11200038" class="btn fo-btn fo-ok" style="display:none;"><img src="/images/add.png" class="fo-img"/></a></span>
                </li>
            </ul>
        </div>
        <div class="operate_zone">
            <h4 class="side_article_list_title">如果你感兴趣</h4>
            <div class="article_like">
                <button class="btn btn-large liked" id="my_like2" data_id="j6rium">
                    <!-- <i class="icon-thumbs-up"></i>--><i class="icon-heart-empty"></i>
                    喜 欢
                </button>
                <button class="btn btn-large liked" id="my_like" data_id="j6rium">
                    <i class="icon-star-empty"></i>
                    收 藏
                </button>
            </div>
            <h4 class="side_article_list_title">分享该文章</h4>
            <div class="share_zone">
                <script type="text/javascript" charset="utf-8">
                    (function(){
                        var _w = 32, _h = 32;
                        var param = {
                            url: location.href,
                            type: '1',
                            count: '', /**是否显示分享数，1显示(可选)*/
                            appkey: '', /**您申请的应用appkey,显示分享来源(可选)*/
                            title: 'How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4', /**分享的文字内容(可选，默认为所在页面的title)*/
                            pic: '', /**分享图片的路径(可选)*/
                            ralateUid: '2609648351', /**关联用户的UID，分享微博会@该用户(可选)*/
                            language: 'zh_cn', /**设置语言，zh_cn|zh_tw(可选)*/
                            rnd: new Date().valueOf()
                        }
                        var temp = [];
                        for (var p in param) {
                            temp.push(p + '=' + encodeURIComponent(param[p] || ''))
                        }
                        document.write('<iframe id="sina_share" allowTransparency="true" frameborder="0" scrolling="no" src="http://hits.sinajs.cn/A1/weiboshare.html?' + temp.join('&') + '" width="' + _w + '" height="' + _h + '"></iframe>')
                    })()
                </script>
                <div id="qqwb_share__" data-appkey="801319615" data-icon="0" data-counter="0" data-content="How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4 （分享自 @tuicool）" data-pic="http://img0.tuicool.com/YrUjqe.jpg">
                </div>
                <script src="http://mat1.gtimg.com/app/openjs/openjs.js#autoboot=no&debug=no">
                </script>
                <a id="douban_share" target="_blank" href="http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=douban&amp;url=http://www.tuicool.com/articles/j6rium&amp;title=How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4" title="分享到豆瓣"></a>
                <a id="qqzone_share" target="_blank" href="http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=qzone&amp;url=http://www.tuicool.com/articles/j6rium&amp;title=How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4 （分享自 @tuicool）" title="分享到QQ空间"></a>
                <div class="pull-left btn-group">
                    <button style="height: 32px; font-size:14px" class="btn btn-primary dropdown-toggle pull-right tohide" data-toggle="dropdown">
                        <i class="icon icon-share-alt icon-white"></i>
                        分享到 <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a target="_blank" href="http://s.evernote.com/grclip?url=http://www.tuicool.com/articles/j6rium&amp;title=How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4">印象笔记</a>
                        </li>
                        <li>
                            <a target="_blank" href="http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=renren&amp;url=http://www.tuicool.com/articles/j6rium&amp;title=How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4" title="分享到人人网">人人网</a>
                        </li>
                        <li>
                            <a target="_blank" href="http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=fbook&amp;url=http://www.tuicool.com/articles/j6rium&amp;title=How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4" title="分享到Facebook">Facebook</a>
                        </li>
                        <li>
                            <a target="_blank" href="http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=twi&amp;url=http://www.tuicool.com/articles/j6rium&amp;title=How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4" title="分享到Twitter">Twitter</a>
                        </li>
                        <li>
                            <a target="_blank" href="http://share.baidu.com/s?type=text&amp;searchPic=0&amp;sign=on&amp;to=linkedin&amp;url=http://www.tuicool.com/articles/j6rium&amp;title=How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4" title="分享到Linkedin">Linkedin</a>
                        </li>
                        <li>
                            <a href="https://plus.google.com/share?url={http://www.tuicool.com/articles/j6rium}" onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=600,width=600');return false;" title="分享到G+">Google +</a>
                        </li>
                        <li class="divider">
                        </li>
                        <li>
                            <a href="mailto:?subject=好文分享：How to fix your PRM cluster when upgrading to RHEL/CentOS 6.4&amp;body=/articles/j6rium">E-Mail</a>
                        </li>
                    </ul>
                </div>
            </div>
			<a href="/mobile?s=a" target="_blank"><img src="/images/mobile_rec.jpg" width="250" style="margin-left:20px"/></a>

            <!-- <a class="sept-bar" href="http://app.xiaomi.com/detail/16936" target="_blank">
            <img src="/images/logo.jpg" />
            推酷壹时代首发小米商店 >
            </a> -->
        </div>
    </div>
</div>
<div class="row-fluid" style="margin-top:0;">
    <div class="span8">
        <div id="site_articles">
        </div>
        <div id="kan_articles">
        </div>
        <div id="article_weibo">
            <div class='header-title'>
                <span>相关微博</span>
                <sub>
                    <a href="/articles/weibo_list/j6rium" target="_blank">共有(<i></i>)条</a>
                </sub>
            </div>
            <div class="related-weibo-list">
            </div>
        </div>
        <div class="comments">
            <div class="cover">
                <div class="comment-notlogin">
                请登录后评论
                </br>
                <small style="margin-top: 5px;">
                    已发表评论数(<span class="comment_cnt"></span>)
                </small>
            </div>
            <div class="comment-loading">
                <div id="spinner2">
                </div>
                评论加载中
            </div>
        </div>
        <div class="comments-area" style="display:none;">
            <div class="comments-list">
                <div class="empty-cmts alert alert-success" style="display:none;">
                    没有更多评论了^^
                </div>
            </div>
            <div class="more-comments" style="display:none;">
                <!--
                <a href="/articles/j6rium/comments" target="_blank">所有评论</a>--><a href="">更多评论</a>
            </div>

            <div class="load-fail" style="display:none;">
                评论加载失败，<a href="javascript:reload_comments('j6rium',1,0,-1);">重新加载</a>
            </div>
        </div>
    </div>
</div>
<div class="span4">
</div>
</div>
<div id="article-correct-modal" class="modal hide fade in" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="false">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
            &times;
        </button>
        <h3>文章纠错</h3>
    </div>
    <div class="modal-body">
        <input type="hidden" value="j6rium" id="article-correct-source">
        <div>
            <label for="article-correct-email">
                邮箱
            </label>
            <input type="email" id="article-correct-email" class="input-large" />
        </div>
        <div>
            <label for="article-correct-select">
                错误类型
            </label>
            <select id="article-correct-select">
                <option value="正文不准确">正文不准确</option>
                <option value="排版有问题">排版有问题</option>
                <option value="没有分页内容">没有分页内容</option>
                <option value="视频无法显示">视频无法显示</option>
                <option value="图片无法显示">图片无法显示</option>
            </select>
        </div>
        <div>
            <label for="article-correct-other">
                补充信息
            </label>
            <textarea id="article-correct-other" class="span6">
            </textarea>
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-primary pull-right huodong_correct_submit" id="article-correct-submit">
            提交
        </button>
    </div>
</div>
<div id="myLoginModal" class="modal hide fade">
	<div class="modal-header">
		<a class="close" data-dismiss="modal" >&times;</a>
		<h3>用户登陆</h3>
	</div>
	<div class="modal-body">
		<form method="post" action="/login" class="form-horizontal" id="login-form">
			<div class="control-group">
				<span class="control-label" for="xlEmail">邮箱</span>
				<div class="login-controls">
					<input class="input-medium" id="xlEmail" name="email" type="text" />
				</div>
			</div>
			<div class="control-group">
				<span class="control-label">密码</span>
				<div class="login-controls">
					<input id="xlPassword" name="password" class="input-medium" type="password" />
				</div>
			</div>
			<div class="form-actions">
				<button type="submit" class="btn btn-primary">
					&nbsp;&nbsp;登&nbsp;&nbsp;&nbsp;陆&nbsp;&nbsp;
				</button>
			</div>
		</form>
	</div>
</div>

<div class="read-later-alert">
</div>
<style type="text/css">
    #dup-cnt {
        display: none;
    }
    
    .btn-large {
        padding: 0;
    }
    
    .load-fail {
        display: none;
    }
    
    .header-title {
        margin-bottom: 10px;
        line-height: 25px;
    }
    
    .header-title span {
        font-size: 16px;
        height: 25px;
    }
</style>
<script src="/assets/highlight.pack.js">
</script>
<script type="text/javascript">
    		$(document).ready( function() {
    	  	$.get("/articles/last_article_by_site_async?sid=z6bQ7v&aid=j6rium",function(data){$('#site_articles').append(data)});
    		});	
    		$.get('/articles/dup_count?id=j6rium',function(data){
    			if(data.success){
    				if(data.data > 0){
    					$('#dup-cnt').show();
    				}
    				$('#dup').text(data.data);
    			}
    		})	
    $(document).ready( function() {
    	$('pre').each(function(i, e) {
    		hljs.highlightBlock(e, "<span class='indent'>  </span>", false)
    	});
      // 加载相关微
      get_weibo("j6rium");
    	//async_do_like_article();
        // 加载相关的推刊
      related_kan("j6rium");
      open_add_article_to_kan("false");
    	async_do_like2_article(); 
    	window.page = 0;
    	window.last = 0;	
    	window.first = true;	
    	resize_article_image('#nei', 550);	
    			$('.btn-submit').hide();
    			load_comments("j6rium",1,0,-1);
    			window.uid = -1;				
    	
    });
    	  
    
</script>

  <!-- body end -->
</div>

      <!--tc_footer start -->
<div class="footer" style="margin-top:50px;">
    <p>
      <a href="/about" target="_blank">关于</a>
      <a href="/mobile" target="_blank">应用</a>
      <a href="/bbs/go/issues" target="_blank">反馈</a>
      <a href="/bbs" target="_blank">讨论</a>
    </p>
</div>

<!--   <div class="sept-notify">
    <a href="javascript:close_sept();" class="close pull-right">&times;</a>
    <a class="sept-notify-body" href="/septs" target="_blank">有一些书要送给你[第一季]</a>
  </div> -->

      <!--tc_footer end -->

<div style="display:none;">
  <script src="http://s22.cnzz.com/stat.php?id=5541078&web_id=5541078&show=pic" language="JavaScript"></script>
</div>
</body>
</html>
