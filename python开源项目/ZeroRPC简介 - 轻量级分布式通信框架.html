<!DOCTYPE html>
<html class=" ">
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# githubog: http://ogp.me/ns/fb/githubog#">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

  <title>ZeroRPC简介 - 轻量级分布式通信框架</title>

  <meta content="authenticity_token" name="csrf-param" />
<meta content="G67hzuz4h9TwSlx9IHFZMQ26BXbKlnDd+Lv/pSNABxw=" name="csrf-token" />
  <meta name="viewport" content="width=960">


    <link type="text/plain" rel="author" href="https://github.com/humans.txt" />
    <meta content="gist" name="octolytics-app-id" /><meta content="collector.githubapp.com" name="octolytics-host" /><meta content="collector-cdn.github.com" name="octolytics-script-host" /><meta content="310501C6:041F:8DAF07F:5369DB66" name="octolytics-dimension-request_id" />

  <link href="https://gist-assets.github.com/assets/application-e2b1ce0cd617bdb376aaf4dd7d4a4a55.css" media="screen, print" rel="stylesheet" />
  <script src="https://gist-assets.github.com/assets/application-a6f0f5317ef6e09be9c1eac645441ab6.js"></script>

      <meta name="twitter:card" content="summary">
  <meta name="twitter:site" content="@github">
  <meta property="og:title" content="ninehills/zerorpc.md">
  <meta property="og:type" content="githubog:gist">
  <meta property="og:url" content="https://gist.github.com/ninehills/5804894">
  <meta property="og:image" content="https://avatars0.githubusercontent.com/u/270298?s=140">
  <meta property="og:site_name" content="GitHub Gists">
  <meta property="og:description" content="ZeroRPC简介 - 轻量级分布式通信框架 - Gist is a simple way to share snippets of text and code with others.">
  <meta name="description" content="ZeroRPC简介 - 轻量级分布式通信框架 - Gist is a simple way to share snippets of text and code with others.">


</head>

<body class=" "
  data-plan="">

  <div id="wrapper">
    

    <div id="header" class="header header-logged-out">
      <div class="container" class="clearfix">
        <a class="header-logo-wordmark" href="https://gist.github.com/">
          <span class="octicon octicon-logo-github"></span>
          <span class="octicon-logo octicon-logo-gist"></span>
        </a>

        <div class="header-actions">
          <a class="button primary" href="https://github.com/signup?return_to=gist">Sign up for a GitHub account</a>
          <a class="button" href="https://gist.github.com/login?return_to=%2Fninehills%2F5804894" data-skip-pjax>Sign in</a>
        </div>
        <div class="divider-vertical"></div>
        <div class="topsearch">
  <form id="top_search_form" action="/search" data-pjax-remote=push accept-charset="UTF-8">
    <div class="search">
      <input type="text" class="search js-search js-navigation-enable " name="q" placeholder="Search&#x2026;" data-hotkey="/" autocomplete=off autocorrect=off value="" >

    </div>
    <div class="divider-vertical"></div>
  </form>
  <ul class="top-nav">
    <li class="explore"><a href="/discover">All Gists</a></li>
  </ul>
</div>

      </div>
    </div>

    <div class="site-content" id="js-pjax-container" data-pjax-container>
      <div class=" site-container js-site-container" data-url="/ninehills/5804894">
  
  

<meta content="true" name="octolytics-dimension-public" /><meta content="5804894" name="octolytics-dimension-gist_id" /><meta content="5804894" name="octolytics-dimension-gist_name" /><meta content="false" name="octolytics-dimension-anonymous" /><meta content="270298" name="octolytics-dimension-owner_id" /><meta content="ninehills" name="octolytics-dimension-owner_login" /><meta content="false" name="octolytics-dimension-forked" />

<div class="pagehead repohead">
  <div class="container">
    <div class="title-actions-bar">
      <ul class="pagehead-actions">


      </ul>
      <h1 itemscope itemtype="http://data-vocabulary.org/Breadcrumb" class="entry-title public" >
        <span class="repo-label"><span class="" >public</span></span>
        <span class="mega-octicon octicon-gist" ></span>
        <div class="meta">
          <div class="gist-author">
            <img src="https://avatars0.githubusercontent.com/u/270298?s=140" width="26" height="26">
            <span class="author vcard">
                <span itemprop="title"><a href="/ninehills">ninehills</a></span>
            </span> /
            <strong><a href="/ninehills/5804894" class="js-current-repository">zerorpc.md</a></strong>
          </div>
          <div class="gist-timestamp">
              <span class="datetime">Created <time class="js-relative-date" title="2013-06-18T12:17:16Z" datetime="2013-06-18T12:17:16Z">2013-06-18</time></span>
          </div>
      </h1>
    </div>

  </div>
</div>


  <div class="gist-description container">
    <p><div>ZeroRPC简介 - 轻量级分布式通信框架</div></p>
  </div>
<div class="gist container js-gist-container"
  data-version="dc9fdaee50c1f19ea8250cedb97db5e0a68abdd1"
  data-created="false"
  data-updated="false">

    <div class="root-pane">
  <div class="menu-container">
    <ul class="menu gisttabs">
      <li>
        <a href="/ninehills/5804894" class="selected">
          Gist Detail
        </a>
      </li>

        <li class="revision-count">
          <a href="/ninehills/5804894/revisions" >
            Revisions
            <span class="counter">1</span>
          </a>
        </li>

        <li>
          <a href="/ninehills/5804894/stars" >
            Stars
            <span class="counter">6</span>
          </a>
        </li>

    </ul>
  </div>

  <ul class="export-references">
    <li>
      <a href="/ninehills/5804894/download" class="minibutton" data-skip-pjax="true" rel="nofollow"><span class="octicon octicon-cloud-download"></span>Download Gist</a>
    </li>
    <li>
      <label for="url-field"><strong>Clone</strong> this gist</label>
      <input type="text" readonly spellcheck="false" class="url-field js-url-field js-copy-toggle" name="url-field" value="https://gist.github.com/5804894.git">
    </li>
    <li>
      <label for="embed-field"><strong>Embed</strong> this gist</label>
      <input type="text" readonly spellcheck="false" class="url-field js-url-field" name="embed-field" value="&lt;script src=&quot;https://gist.github.com/ninehills/5804894.js&quot;&gt;&lt;/script&gt;">
    </li>
    <li>
      <label for="link-field"><strong>Link to</strong> this gist</label>
      <input type="text" readonly spellcheck="false" class="url-field js-url-field" name="link-field" value="https://gist.github.com/ninehills/5804894">
    </li>
  </ul>
</div>


  <div class="column files">
        <div id="file-zerorpc-md" class="bubble">
          <div class="file-box ">
            <div class="meta">
              <div class="file-info">
                <span class="file-type-icon"><span class="octicon octicon-gist"></span></span>
                <strong class="file-name js-selectable-text">zerorpc.md</strong>
              </div>
              <div class="file-actions">
                <span class="file-language">Markdown</span>
                <ul class="button-group">
                  <li><a aria-label="Permalink" href="#file-zerorpc-md" class="file-actions-button tooltipped tooltipped-s permalink"><span class="octicon octicon-link"></span></a></li>
                  <li><a aria-label="View Raw" href="/ninehills/5804894/raw/zerorpc.md" data-skip-pjax class="file-actions-button tooltipped tooltipped-s raw-url js-view-raw"><span class="octicon octicon-code"></span></a></li>
                </ul>
              </div>
            </div>
            <div class="suppressed">
              <a class="js-show-suppressed-file">File suppressed. Click to show.</a>
            </div>
            

    <div class="readme context-loader-container context-loader-overlay">
      <article class="markdown-body js-file "
        data-task-list-update-url="https://gist.github.com/ninehills/5804894/file/zerorpc.md">
        <h1>
<a name="user-content-zerorpc%E7%AE%80%E4%BB%8B---%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1%E6%A1%86%E6%9E%B6" class="anchor" href="#zerorpc%E7%AE%80%E4%BB%8B---%E8%BD%BB%E9%87%8F%E7%BA%A7%E5%88%86%E5%B8%83%E5%BC%8F%E9%80%9A%E4%BF%A1%E6%A1%86%E6%9E%B6" rel="noreferrer"><span class="octicon octicon-link"></span></a>ZeroRPC简介 - 轻量级分布式通信框架</h1>

<h2>
<a name="user-content-%E6%A6%82%E8%BF%B0" class="anchor" href="#%E6%A6%82%E8%BF%B0" rel="noreferrer"><span class="octicon octicon-link"></span></a>概述</h2>

<p>分布式系统的核心是分布式通信，而传统上开发一套支持上千台规模集群，可靠性非常高的分布式通信框架，需要不少的精力投入。而在多数情景下，我们（特别是时间宝贵的OP）并不是非常关注技术实现的细节，而是希望有一套成熟、轻量、可靠性高、使用方便而且易于调试的分布式通信框架，可以直接使用，从而把时间放在具体业务逻辑上。</p>

<p>在PyCon 2012大会上，dotcloud公司开源了一套基于ZeroMQ和MessagePack的分布式通信框架（或者说是协议+Python实现）。该框架因为基于ZeroMQ，使用方法是RPC，所以被命名为ZeroRPC。ZeroRPC的特点在其官网的介绍中一目了然[1]：</p>

<blockquote>
<p>ZeroRPC is a light-weight, reliable and language-agnostic library for distributed communication between server-side processes. </p>
</blockquote>

<p>ZeroRPC的设计初衷是『simple tool to solve a simple problem』，dotcloud工程师在PPT中提到了他们设计目标[2]：</p>

<ol>
<li>最小的使用成本。比如单机时我们这么用<code>import  foo; foo.bar(42)</code>，分布式后我们希望可以这么用：<code>foo=RemoteService(...) ; foo.bar(42)</code>
</li>
<li>自文档。不需要看远程服务的源代码，我们能够获得远程服务所支持的方法，docstring等等。</li>
<li>优雅的处理异常。调用远程方法产生的异常，不应该中断远程服务，而应该在本地抛出。（异常比返回状态更方便，更简洁）</li>
<li>语言无关。同一套协议有多种实现（目前有Python和Node.js两种实现），而且实现简单，目前Python实现只有2000行代码。</li>
<li>高可用性，快速。目前Python实现基于gevent+zmq，性能非常高。</li>
<li>良好的debug和profile工具</li>
</ol><p>接下来我们以0.4版的Python实现为例，由浅入深的介绍ZeroRPC框架。</p>

<h2>
<a name="user-content-%E5%AE%89%E8%A3%85" class="anchor" href="#%E5%AE%89%E8%A3%85" rel="noreferrer"><span class="octicon octicon-link"></span></a>安装</h2>

<pre><code>pip install zerorpc
</code></pre>

<h2>
<a name="user-content-examples" class="anchor" href="#examples" rel="noreferrer"><span class="octicon octicon-link"></span></a>Examples</h2>

<p>接下来我们用一批例子来展示ZeroRPC的基本使用方法。</p>

<h3>
<a name="user-content-example-hello-world" class="anchor" href="#example-hello-world" rel="noreferrer"><span class="octicon octicon-link"></span></a>Example: Hello World</h3>

<p>Server:</p>

<pre><code>import zerorpc

class HelloRPC(object):
    def hello(self, name):
        return "Hello, %s" % name

s = zerorpc.Server(HelloRPC())
s.bind("tcp://0.0.0.0:8282")
s.run()
</code></pre>

<p>Client(Python)，和调用本地模块一样的方便:</p>

<pre><code>import zerorpc

c = zerorpc.Client()
c.connect("tcp://127.0.0.1:8282")
print c.hello("RPC")
</code></pre>

<p>或者用CLI（debug用）：</p>

<pre><code>$ zerorpc tcp://127.0.0.1:8282 hello RPC
connecting to "tcp://127.0.0.1:8282"
'Hello, RPC'
</code></pre>

<h3>
<a name="user-content-example-introspection" class="anchor" href="#example-introspection" rel="noreferrer"><span class="octicon octicon-link"></span></a>Example: introspection</h3>

<p>用cli可以列出远程模块所支持的方法，并可以查看docstring文档：</p>

<pre><code># 将urllib模块发布
$ zerorpc --server --bind tcp://127.0.0.1:1234 urllib

# 列出远程所有以q开头的方法
$ zerorpc tcp://127.0.0.1:1234 | grep ^q
quote                       quote('abc def') -&gt; 'abc%20def'
quote_plus                  Quote the query fragment of a URL; replacing ' ' with '+'

# 列出quota_plus的文档
$ zerorpc --inspect tcp://127.0.0.1:1234 quote_plus
connecting to "tcp://127.0.0.1:1234"

quote_plus(s, safe=)

Quote the query fragment of a URL; replacing ' ' with '+'
</code></pre>

<h3>
<a name="user-content-example-exceptions" class="anchor" href="#example-exceptions" rel="noreferrer"><span class="octicon octicon-link"></span></a>Example: exceptions</h3>

<p>ZeroRPC可将远程方法抛出的异常传递到本地，这样不仅符合业务逻辑，而且异常捕获也减少了服务端的容错逻辑，提高了稳定性。</p>

<pre><code>$ zerorpc tcp://127.0.0.1:1234 quote_plus
connecting to "tcp://127.0.0.1:1234"
Traceback (most recent call last):
  ...此处省略
zerorpc.exceptions.RemoteError: Traceback (most recent call last):
  ...此处省略
TypeError: quote_plus() takes at least 1 argument (0 given)
</code></pre>

<h3>
<a name="user-content-example-streaming-responses" class="anchor" href="#example-streaming-responses" rel="noreferrer"><span class="octicon octicon-link"></span></a>Example: Streaming Responses</h3>

<p>Streaming Responses 类似于 Python 的生成器，尤其是在大数据量操作时优势明显。比如有一个很长很大的列表L，如果一次传递过去再进行处理，不仅网络传输需要时间，而且占用内存也较大。此时如果使用Streaming，其实是将列表的每个元素分别传递并分别处理返回（迭代器），效率十分高。</p>

<pre><code># streaming example, 省略不必要的代码
class StreamingRPC(object):
    @zerorpc.stream
    def streaming_range(self, fr, to, step):
        return xrange(fr, to, step)

# client，省略不必要的代码
for item in c.streaming_range(10, 20, 2):
    print item
</code></pre>

<h3>
<a name="user-content-example-high-availability" class="anchor" href="#example-high-availability" rel="noreferrer"><span class="octicon octicon-link"></span></a>Example: high availability</h3>

<p>ZeroRPC可以放在Proxy之后，实现高可用性，以HAProxy为例：</p>

<p>启动HAProxy，使其工作在TCP模式，并将请求转发给后端：</p>

<pre><code>$ cat haproxy.cfg
listen zerorpc 0.0.0.0:1111
    mode tcp
    server backend_a localhost:2222 check
    server backend_b localhost:3333 check
$ haproxy -f haproxy.cfg
</code></pre>

<p>启动一个或多个后端：</p>

<pre><code>$ zerorpc --server --bind tcp://0.0.0.0:2222 urllib
</code></pre>

<p>此时便可用client去连接HAProxy, HAProxy会将请求转发给可用的后端。</p>

<pre><code>$ zerorpc tcp://localhost:1111
</code></pre>

<h2>
<a name="user-content-%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82" class="anchor" href="#%E5%AE%9E%E7%8E%B0%E7%BB%86%E8%8A%82" rel="noreferrer"><span class="octicon octicon-link"></span></a>实现细节</h2>

<h3>
<a name="user-content-zeromq%E5%92%8C%E4%B8%89%E7%A7%8D%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B" class="anchor" href="#zeromq%E5%92%8C%E4%B8%89%E7%A7%8D%E9%80%9A%E4%BF%A1%E6%A8%A1%E5%9E%8B" rel="noreferrer"><span class="octicon octicon-link"></span></a>ZeroMQ和三种通信模型</h3>

<p>ZeroMQ[4]是一种基于消息队列的多线程网络库，其对套接字类型、连接处理、帧、甚至路由的底层细节进行抽象，提供跨越多种传输协议的套接字。ZeroMQ是网络通信中新的一层，介于应用层和传输层之间（按照TCP/IP划分），其是一个可伸缩层，可并行运行，分散在分布式系统间。</p>

<p>简单的说，ZMQ提供了完全不同于传统BSD Socket的网络通信接口，屏蔽了Socket的处理细节，并提供了几种通信模型，基本覆盖了分布式系统的需求。</p>

<p>ZMQ提供了以下几种通信模型，而<strong><em>这些通信模型也同样可在ZeroRPC中使用</em></strong>：</p>

<ul>
<li>
<code>REQ-REP</code>: Request-Reply 模型，类似于传统的通信模型，但ZMQ的Request端和Reply端无论谁先启动均可以，只是请求必须遵循Request-Reply的顺序。</li>
<li>
<code>PUB-SUB</code>: Publish-Subscribe 模型，Publish节点为信息源，Subscribe节点接收信息。如果Subscribe节点中途退出，不影响信息的继续发布。</li>
<li>
<code>PUSH/PULL</code>: PipeLine 模型，以扇入扇出的模式连接节点，多用于任务发布和信息收集的场景。</li>
</ul><h3>
<a name="user-content-messagepack" class="anchor" href="#messagepack" rel="noreferrer"><span class="octicon octicon-link"></span></a>MessagePack</h3>

<p>ZeroRPC选择MessagePack[5]作为序列化工具，相比于JSON/BSON/YAML等格式，MsgPack提供20~50倍的序列化速度以及1/2大小的序列化产出。</p>

<h3>
<a name="user-content-zerorpc%E5%8D%8F%E8%AE%AE" class="anchor" href="#zerorpc%E5%8D%8F%E8%AE%AE" rel="noreferrer"><span class="octicon octicon-link"></span></a>ZeroRPC协议</h3>

<p>完成的协议参见文档[3]，简略说，ZeroRPC分为三层：</p>

<ol>
<li>Wire (or transport) layer    利用ZeroMQ和MessagePack进行通信</li>
<li>Event (or message) layer    最复杂的一层，处理心跳，事件等</li>
<li>RPC layer    RPC Request+Response</li>
</ol><h4>
<a name="user-content-%E8%B6%85%E6%97%B6%E5%92%8C%E5%BF%83%E8%B7%B3" class="anchor" href="#%E8%B6%85%E6%97%B6%E5%92%8C%E5%BF%83%E8%B7%B3" rel="noreferrer"><span class="octicon octicon-link"></span></a>超时和心跳</h4>

<p>由于ZMQ隐藏了Socket细节，所以无法感知断线，于是ZeroRPC采用心跳包的方式进行在线检测。Client端在断线后会抛出LostRemote异常。默认断线超时为30s，可设定。</p>

<h4>
<a name="user-content-%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E5%92%8C%E4%BC%A0%E8%BE%93%E5%8A%A0%E5%AF%86" class="anchor" href="#%E8%BA%AB%E4%BB%BD%E9%AA%8C%E8%AF%81%E5%92%8C%E4%BC%A0%E8%BE%93%E5%8A%A0%E5%AF%86" rel="noreferrer"><span class="octicon octicon-link"></span></a>身份验证和传输加密</h4>

<p>目前版本的ZeroRPC没有实现任何形式的身份验证，传输加密官方建议通过SSL实现。</p>

<h3>
<a name="user-content-%E4%B8%AD%E9%97%B4%E4%BB%B6" class="anchor" href="#%E4%B8%AD%E9%97%B4%E4%BB%B6" rel="noreferrer"><span class="octicon octicon-link"></span></a>中间件</h3>

<p>最新版本的ZeroRPC支持middleware API，比如<code>StatsD Middleware</code>[6]，可以跟踪Request/Response的耗时并传送给StatsD，以分析系统性能。</p>

<h2>
<a name="user-content-show-me-the-code" class="anchor" href="#show-me-the-code" rel="noreferrer"><span class="octicon octicon-link"></span></a>Show me the code</h2>

<p><a href="https://github.com/dotcloud/zerorpc-python" rel="noreferrer">https://github.com/dotcloud/zerorpc-python</a></p>

<p>由于文档较缺失，如果需要了解的更深，建议直接阅读源代码，2000行不到，短小精悍。</p>

<h2>
<a name="user-content-%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3" class="anchor" href="#%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3" rel="noreferrer"><span class="octicon octicon-link"></span></a>参考文档</h2>

<ol>
<li><a href="http://zerorpc.dotcloud.com/" rel="noreferrer">http://zerorpc.dotcloud.com/</a></li>
<li><a href="https://docs.google.com/presentation/d/1FRh6kb79tcT0Deb4bjYVDvdvJAVMXYjXJK3EFT4pj8w/edit#slide=id.gb9676fa_0_420" rel="noreferrer">Talk: ZeroRPC at PYCON2012</a></li>
<li><a href="https://github.com/dotcloud/zerorpc-python/blob/master/doc/protocol.md" rel="noreferrer">ZeroRPC Protocol</a></li>
<li><a href="http://zguide.zeromq.org/page:all" rel="noreferrer">http://zguide.zeromq.org/page:all</a></li>
<li><a href="http://msgpack.org/" rel="noreferrer">http://msgpack.org/</a></li>
<li><a href="https://github.com/aluzzardi/zerorpc-statsd" rel="noreferrer">https://github.com/aluzzardi/zerorpc-statsd</a></li>
</ol>
      </article>
    </div>



          </div>
        </div>
    <div id="comments" class="new-comments">
      
    </div>
      <p class="uncommentable"><span class="octicon octicon-alert"></span> Please <a href="/login?return_to=/ninehills/5804894" rel="nofollow">sign in</a> to comment on this gist.</p>
  </div>
</div>

  <div class="context-overlay"></div>
</div>

    </div>
    <div class="slow-loading-overlay"></div>
  </div>

  <div id="ajax-error-message" class="flash flash-error">
    <div class="container">
      <span class="octicon octicon-alert"></span>
      Something went wrong with that request. Please try again.
      <a href="#" class="octicon octicon-remove-close ajax-error-dismiss"></a>
    </div>
  </div>


  <footer>
    <div id="footer">
  <div class="container clearfix">

    <!-- Served fresh by github-fe102-cp1-prd.iad.github.net -->
    <p class="right">&copy; 2014 GitHub Inc. All rights reserved.</p>
    <a class="left" href="/">
      <span class="mega-octicon octicon-mark-github"></span>
    </a>
    <ul id="legal">
      <li><a href="https://github.com/blog">The GitHub Blog</a></li>
      <li><a href="mailto:support@github.com">Support</a></li>
      <li><a href="https://github.com/contact">Contact</a></li>
    </ul>

  </div><!-- /.container -->
</div><!-- /.#footer -->

  </footer>

</body>
</html>
