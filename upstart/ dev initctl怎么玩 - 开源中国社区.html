<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html lang='zh-CN' xml:lang='zh-CN' xmlns='http://www.w3.org/1999/xhtml'>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
  <link rel="shortcut icon" type="image/x-icon" href="/img/favicon.ico" />
  <title>/dev/initctl怎么玩 - 开源中国社区</title>
      <link rel="stylesheet" href="/css/style2013.css?ver=2014030701" type="text/css" media="screen" />
  <link rel="stylesheet" href="/css/channel.css?date=2014042202" type="text/css" media="screen" />
  <link rel="stylesheet" type="text/css" href="/js/2011/fancybox/jquery.fancybox-1.3.4.css" media="screen" />
  <link rel="alternate" type="application/rss+xml" title="最新开源项目" href="http://www.oschina.net/project/rss" />
  <link rel="alternate" type="application/rss+xml" title="最新开源资讯" href="http://www.oschina.net/news/rss" />
  <link rel="alternate" type="application/rss+xml" title="最新问题列表" href="http://www.oschina.net/question/rss" />
  <link rel="alternate" type="application/rss+xml" title="最新翻译列表" href="http://www.oschina.net/translate/rss" />
  <link rel="alternate" type="application/rss+xml" title="最新博客列表" href="http://www.oschina.net/blog/rss" />
  <link rel="alternate" type="application/rss+xml" title="最新代码分享列表" href="http://www.oschina.net/code/rss" />
  <link rel="alternate" type="application/rss+xml" title="开源中国 - 源码列表" href="http://www.oschina.net/code/source_rss" />
  <script type="text/javascript" src="/js/2012/jquery-1.7.1.min.js"></script>
  <script type="text/javascript" src="/js/2012/jquery.form.js"></script>
  <script type="text/javascript" src="/js/2011/fancybox/jquery.fancybox-fixed.js?2014031702"></script>
    <link rel="stylesheet" href="/js/poshytip/tip-yellowsimple/tip-yellowsimple.css" type="text/css" />
  <script type="text/javascript" src="/js/poshytip/jquery.poshytip.min.js"></script>
  <script type="text/javascript">
  	g_user = {
	id:0,
	name:'',
	login:false};  </script>
    <script type="text/javascript" src="/js/2011/oschina.js?ver=20121007"></script>
  <script type="text/javascript" src="/js/utils.js"></script>
  <script type="text/javascript" src="/js/channel.js?2014022501"></script>
    </head>
<body>
<div id='OSC_NavTop'>
	<div class="wp998">
        <div id="OSC_Channels">
        	<ul>
        	<li class="item"><a href="http://www.oschina.net/" class='home'>首页</a></li>        	<li class="item control_select"><a href="http://www.oschina.net/project" class='project'>开源项目</a>
				<ul class="cs_content">					
                	                	<li><a href="http://www.oschina.net/project/lang/19/java">Java 开源软件</a></li>
                	<li><a href="http://www.oschina.net/project/lang/194/csharp">C# 开源软件</a></li>
                	<li><a href="http://www.oschina.net/project/lang/22/php">PHP 开源软件</a></li>
                	<li><a href="http://www.oschina.net/project/lang/21/c">C/C++ 开源软件</a></li>
                	<li><a href="http://www.oschina.net/project/lang/26/ruby">Ruby 开源软件</a></li>
                	<li><a href="http://www.oschina.net/project/lang/25/python">Python 开源软件</a></li>
                	<li><a href="http://www.oschina.net/project/lang/358/go">Go开源软件</a></li>
                	<li><a href="http://www.oschina.net/project/lang/28/javascript">JS开源软件</a></li>
				</ul>
			</li>
        	<li class="item control_select">
				<a href="http://www.oschina.net/question" class='question hl'>讨论区</a>				
				<ul class="cs_content">					
                	<li><a href="http://www.oschina.net/question?catalog=1"> 技术问答 &raquo; </a></li>
                	<li><a href="http://www.oschina.net/question?catalog=2"> 技术分享 &raquo; </a></li>
                	<li><a href="http://www.oschina.net/question?catalog=3"> IT大杂烩 &raquo; </a></li>
                	<li><a href="http://www.oschina.net/question?catalog=100"> 职业生涯 &raquo; </a></li>
                	<li><a href="http://www.oschina.net/question?catalog=4"> 站务/建议 &raquo; </a></li>
                	<li><a href="http://www.oschina.net/alipay"> 支付宝专区 &raquo; </a></li>
                	<li><a href="http://www.oschina.net/hardware"> 开源硬件专区 &raquo; </a></li>
				</ul>
			</li>
        	<li class="item"><a href="http://www.oschina.net/code/list" class='code'>代码</a></li>
        	        	<li class="item"><a href="http://www.oschina.net/blog" class='blog'>博客</a></li>
        	<li class="item"><a href="http://www.oschina.net/translate" class='tran'>翻译</a></li>
            <li class="item"><a href="http://www.oschina.net/news" class='news'>资讯</a></li>
        	<li class="item control_select">
				<a href="http://www.oschina.net/android" class='mobile'>移动开发</a>
				<ul class="cs_content cs_mobile">
                	<li class="android_"><a href="http://www.oschina.net/android">Android开发专区</a></li>
                	<li class="ios_"><a href="http://www.oschina.net/ios/home">iOS开发专区</a></li>
                	<li class="ios_"><a href="http://www.oschina.net/ios/codingList">iOS代码库</a></li>
                	<li class="wp7_"><a href="http://www.oschina.net/wp">Windows Phone</a></li>
				</ul>
			</li>
        	<li class="item t_job"><a href="http://www.oschina.net/job" class='job'>招聘</a></li>
									            <li class="item control_select">
                <a href="http://city.oschina.net/" id="MyCities" title="城市圈">城市圈</a>
							</li>
        	</ul>
        </div>
		<div id="OSC_Userbar">
                		    		当前访客身份：游客 [ <a href="http://www.oschina.net/home/login?goto_page=http%3A%2F%2Fwww.oschina.net%2Fquestion%2F234345_47819">登录</a> | <a href="http://www.oschina.net/home/reg">加入开源中国</a> ]
    				</div>
		<div class='clear'></div>
	</div>
</div>
<div id='OSC_Banner'><div class="wp998"><a href='http://www.oschina.net/' class='Logo' title='OSChina 开源中国'>开源中国</a>
<h1><a href='/question'>讨论区</a></h1>
<dl>
	<dt>当前位置：</dt>
	<dd>
					        		<a href="/question">讨论区</a>&nbsp;&raquo;
        		<a href="/question?catalog=2">技术分享</a>										</dd>
</dl>
<form action='http://www.oschina.net/search' class='search'>
	<input type='hidden' name='scope' value='bbs'/>
	<input id='channel_q' type='text' name='q' value='' placeholder='资讯、软件、分享、代码、博客' class='TXT'/>
    <button type='submit' class='BTN'>搜 索</button>
</form>
<div class='clear'></div></div></div>
<div id="OSC_Screen">
	<div id="OSC_Content" class='CenterDiv'>
<script type="text/javascript" src="/js/scrolltopcontrol.js"></script>
<script type="text/javascript">
  	scrolltotop.offset(100,120);
  	scrolltotop.init();
	$(function(){
		$('a.ShowUserOutline img.SmallPortrait').poshytip({
			className: 'tip-yellowsimple',
			alignTo: 'target',
			alignX: 'right',
			alignY: 'inner-top',
			offsetX: 5,
			offsetY: 0,
			fade: false,
			slide: false,
			content: function(updateCallback) {
				ajax_get("/action/ajax/get_user_outline?id="+$(this).attr('user'),false,function(html){
					updateCallback(html);
				});
				return "<div style='height:100px;'>Loading...</div>";
			}
		});
	});
	function add_to_favorite(pid,concern_it){
			alert("必须登录后才能收藏");
		}
</script>
<script type="text/javascript">
    $(document).ready(function(){
		osc.show_tag_introduce_project();
		osc.show_tag_introduce_other();
	});
</script>



<div class='Question'>
	<div class='Body'>
	<div class="main">
    	<div class='Title'>
			<a class="jump_answer" href="#tags_nav" title="跳到回复"></a>
    		<div class='QTitle'>
				    			<h1><a href="http://www.oschina.net/question/234345_47819" hidefocus="true" name='top'>/dev/initctl怎么玩</a></h1>
					<div class="array"></div>
    		</div>
			<div class="clear"></div>
    		
    		<div class='clear'></div>
    	</div>
		    	    					
				<div class='Content'>
												<div class='detail'><p>/dev/initctl是一个管道文件，很多人知道它，但是知道怎么用。要想知道怎么用还是得看init程序的源代码，在init.c中就用到了 /dev/initctl管道文件。可以通过/dev/initctl改变系统的运行级别，但是怎么改变呢？比如说当前运行级别是2，我想将运行级别提到 3，那么想当然的做法就是： <br />[root@localhost zhaoy]# touch level <br />[root@localhost zhaoy]# echo '3'&gt;level <br />[root@localhost zhaoy]# cat level &gt;/dev/initctl <br />但是得到的结果却是： <br />INIT: got bogus initrequest <br />于是，我在init.c中搜以上错误字符串，在check_init_fifo中找到了它，以下看一下check_init_fifo函数的相关部分： <br />void check_init_fifo(void) <br />{ <br />&nbsp; struct init_request&nbsp;&nbsp;&nbsp; request; <br />&nbsp; struct timeval&nbsp;&nbsp;&nbsp; tv; <br />&nbsp; struct stat&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; st, st2; <br />&nbsp; fd_set&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fds; <br />&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; n; <br />&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit = 0; <br />&nbsp; if (stat(INIT_FIFO, &amp;st2) &lt; 0 &amp;&amp; errno == ENOENT) <br />&nbsp;&nbsp;&nbsp; (void)mkfifo(INIT_FIFO, 0600); //如果没有这个initctl管道，那么就建立它。 <br />&nbsp; if (pipe_fd &gt;= 0) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //如果已经打开了，那么就看看现在是否它的属性发生了变化 <br />&nbsp;&nbsp;&nbsp; fstat(pipe_fd, &amp;st); <br />&nbsp;&nbsp;&nbsp; if (stat(INIT_FIFO, &amp;st2) &lt; 0 || <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; st.st_dev != st2.st_dev || <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; st.st_ino != st2.st_ino) { <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; close(pipe_fd); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pipe_fd = -1; <br />&nbsp;&nbsp;&nbsp; } <br />&nbsp; } <br />&nbsp; if (pipe_fd &lt; 0) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //原来打开却发生了变化或者根本没有打开都需要打开该管道 <br />&nbsp;&nbsp;&nbsp; if ((pipe_fd = open(INIT_FIFO, O_RDWR|O_NONBLOCK)) &gt;= 0) { <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fstat(pipe_fd, &amp;st); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (!S_ISFIFO(st.st_mode)) { <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; initlog(L_VB, &quot;%s is not a fifo&quot;, INIT_FIFO); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; close(pipe_fd); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pipe_fd = -1; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; if (pipe_fd &gt;= 0) { <br />&nbsp;&nbsp;&nbsp; ...//打开成功 <br />&nbsp;&nbsp;&nbsp; } <br />&nbsp; } <br />&nbsp; if (pipe_fd &gt;= 0) while(!quit) {//等待数据，如果没有数据就返回 <br />&nbsp;&nbsp;&nbsp; FD_ZERO(&amp;fds); <br />&nbsp;&nbsp;&nbsp; FD_SET(pipe_fd, &amp;fds); <br />&nbsp;&nbsp;&nbsp; tv.tv_sec = 5; <br />&nbsp;&nbsp;&nbsp; tv.tv_usec = 0; <br />&nbsp;&nbsp;&nbsp; n = select(pipe_fd + 1, &amp;fds, NULL, NULL, &amp;tv); <br />&nbsp;&nbsp;&nbsp; if (n &lt;= 0) { <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (n == 0 || errno == EINTR) return; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue; <br />&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; n = read(pipe_fd, &amp;request, sizeof(request));&nbsp; //读出一个??request是个什么东西，这个一会再谈。 <br />&nbsp;&nbsp;&nbsp; if (n == 0) { <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; close(pipe_fd); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; pipe_fd = -1; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return; <br />&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; if (n &lt;= 0) { <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (errno == EINTR) return; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue; <br />&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; console_init(); <br />&nbsp;&nbsp;&nbsp; if (request.magic != INIT_MAGIC || n != sizeof(request)) {&nbsp; //检查魔术字 <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; initlog(L_VB, &quot;got bogus initrequest&quot;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //终于找到那个出错信息，这就是切入点 <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; continue; <br />&nbsp;&nbsp;&nbsp; } <br />&nbsp;&nbsp;&nbsp; switch(request.cmd) {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //所有验证都通过，是一个合法请求 <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; case INIT_CMD_RUNLVL:&nbsp; //要求改变运行级 <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sltime = request.sleeptime; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fifo_new_level(request.runlevel);&nbsp; //开始着手改变运行级 <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit = 1; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; <br />&nbsp;&nbsp;&nbsp; } <br />&nbsp; } <br />} <br />void fifo_new_level(int level) <br />{ <br />&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp; oldlevel; <br />&nbsp;&nbsp;&nbsp; if (level == runlevel) <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return; <br />&nbsp;&nbsp;&nbsp; oldlevel = runlevel; <br />&nbsp;&nbsp;&nbsp; runlevel = read_level(level);&nbsp;&nbsp; //read_level检查level参数返回新的运行级别并赋给全局变量runlevel <br />&nbsp;&nbsp;&nbsp; if (runlevel == 'U') { <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; runlevel = oldlevel; <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; re_exec(); <br />&nbsp;&nbsp;&nbsp; } else { <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (oldlevel != 'S' &amp;&amp; runlevel == 'S') console_stty(); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (runlevel == '6' || runlevel == '0' || runlevel == '1') <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; console_stty(); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; read_inittab();&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //重新加载/etc/inittab文件 <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; fail_cancel(); <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; setproctitle(&quot;init [%c]&quot;, runlevel); <br />&nbsp;&nbsp;&nbsp; } <br />} <br />check_init_fifo函数就是在那个init_main的主循环里被调用的，由此可见init进程时刻检测/dev/initctl管道，一旦 有请求马上处理，这真是太好了，我们也可以写一把/dev/initctl管道，但是怎么写呢？肯定得有一定的格式了，这个格式就是上面的??，实际上是一个结构体，我下面给出一个写/dev/initctl管道的完整代码，代码内部说一下那个initctl需要的数据结构： <br />#include 
 <sys ypes.h=""> 
  <br />#include 
  <sys tat.h=""> 
   <br />#include 
   <fcntl.h> 
    <br />#define INIT_MAGIC 0x03091969 
    <br />#define INIT_CMD_RUNLVL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 
    <br />struct init_request_bsd { 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp; gen_id[8]; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp; tty_id[16]; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp; host[64]; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp; term_type[16]; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; signal; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; pid; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp; exec_name[128];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp; reserved[128]; 
    <br />}; 
    <br />struct init_request {&nbsp;&nbsp; //这个结构代表一个init请求，将一个请求写入/dev/initctl就等于发出了请求 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; magic; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; cmd; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; runlevel; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int&nbsp;&nbsp;&nbsp;&nbsp; sleeptime; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; union { 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct init_request_bsd bsd; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data[368]; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } i; 
    <br />}; 
    <br />int main() 
    <br />{ 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; struct init_request is; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; memset(is, 0, sizeof(is)); 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is.magic = INIT_MAGIC;&nbsp;&nbsp;&nbsp; //设置魔术字，在init进程需要检查 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is.cmd = INIT_CMD_RUNLVL; //告诉init进程我们需要改变运行级，当然还可以有别的要求，比如ups电源检测到掉电事件等等 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is.runlevel = 52;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //将52赋给runlevel，代表ascii的4，注意runlevel是int型，到init进程就要被转化为char型。 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; is.sleeptime = 0; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; int fd = open(&quot;/dev/initctl&quot;,O_WRONLY);&nbsp; //打开管道 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; write(fd,is,sizeof(is));&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //将上述的init_request结构体is写入管道 
    <br />} 
    <br />编译上述代码，执行之，运行级别就改到4了。写入请求以后，在init进程检测/dev/initctl的时候检测到我们写入的请求，就一直到 fifo_new_level了，从而改变了系统的运行级。这个原理我们懂了，那么有没有别的请求可写呢？当然有了，以下就是定义： 
    <br />#define INIT_CMD_START&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 0 
    <br />#define INIT_CMD_RUNLVL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 1 
    <br />#define INIT_CMD_POWERFAIL&nbsp;&nbsp;&nbsp; 2 
    <br />#define INIT_CMD_POWERFAILNOW&nbsp;&nbsp;&nbsp; 3 
    <br />#define INIT_CMD_POWEROK&nbsp;&nbsp;&nbsp; 4 
    <br />#define INIT_CMD_BSD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 5 
    <br />#define INIT_CMD_SETENV&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 6 
    <br />#define INIT_CMD_UNSETENV&nbsp;&nbsp;&nbsp; 7 
    <br />看到上面的请求类别中以电源相关的居多，我们就举个例子说吧，比如INIT_CMD_POWERFAILNOW，在check_init_fifo会执行到它的case： 
    <br />switch(request.cmd) { 
    <br />... 
    <br />&nbsp;&nbsp;&nbsp; case INIT_CMD_POWERFAILNOW: 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sltime = request.sleeptime; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; do_power_fail('L'); 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; quit = 1; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break; 
    <br />... 
    <br />然后就到了do_power_fail里面： 
    <br />void do_power_fail(int pwrstat) 
    <br />{ 
    <br />&nbsp;&nbsp;&nbsp; CHILD *ch;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //注释：ch-&gt;flags &amp;= ~XECUTED的意思就是清除已经执行过的标记，言外之意就是马上要执行，在哪里执行呢？看我前面的文章吧（当然在主循环的 start_if_needed里面执行哦） 
    <br />&nbsp;&nbsp;&nbsp; for (ch = family; ch; ch = ch-&gt;next) {&nbsp;&nbsp; //寻找出电源问题的CHILD 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (pwrstat == 'O') {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //电源问题解决了 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ch-&gt;action == POWEROKWAIT) 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ch-&gt;flags &amp;= ~XECUTED; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else if (pwrstat == 'L') {&nbsp;&nbsp; //电池电量低，需要提醒，这是我们的情况 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ch-&gt;action == POWERFAILNOW) 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ch-&gt;flags &amp;= ~XECUTED; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } else {&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; //立马关机 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ch-&gt;action == POWERFAIL || ch-&gt;action == POWERWAIT) 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ch-&gt;flags &amp;= ~XECUTED; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
    <br />&nbsp;&nbsp;&nbsp; } 
    <br />} 
    <br />这一切到底是怎么一回事呢？原来在/etc/inittab里有意行 
    <br />pf::powerfail:/sbin/shutdown -f -h +2 &quot;Power Failure; System Shutting Down&quot; 
    <br />注意它的action是powerfail，映射到init的数字就是POWERFAIL，和电源相关的在init.c定义了一个宏： 
    <br />#define ISPOWER(i) ((i) == POWERWAIT || (i) == POWERFAIL ||&nbsp; (i) == POWEROKWAIT || (i) == POWERFAILNOW || (i) == CTRLALTDEL) 
    <br />然后在read_inittab中解析将要在初始化时运行的进程的时候将ISPOWER为真的action对应的CHILD设置为已经执行过，这样就避免了初始化的时候执行电源相关的进程，具体就是： 
    <br />if (ISPOWER(ch-&gt;action)) { 
    <br />&nbsp;&nbsp;&nbsp; ch-&gt;flags |= XECUTED; 
    <br />... 
    <br />这样在start_if_needed-&gt;startup中执行if (ch-&gt;flags &amp; XECUTED) break;的时候就不会执行相关的进程了，但是电源万一真的出问题了，那么就是要放开那些进程的时候了，怎么放呢？就是简单的清除掉XECUTED标志 即可。linux设计得就是好，一切能分离的尽量分离，电源出问题了一旦用户空间的进程知道了，那么它有很多种方法报告，可以发送电源信号，然后init 进程捕获该信号，可以操作/dev/initctl，然后init进程处理，具体咋处理那些进程不用管，由/etc/inittab的策略管好了 
    <br />下面还有个问题，我们通过各种方式改变了系统的运行级别，那么怎么保证系统不会执行比我们的运行级别高的级别的进程呢？还是看代码： 
    <br />void start_if_needed(void) 
    <br />{ 
    <br />&nbsp;&nbsp;&nbsp; for(ch = family; ch; ch = ch-&gt;next) { 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ch-&gt;flags &amp; WAITING) break; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (ch-&gt;flags &amp; RUNNING) continue; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delete = 1; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; if (strchr(ch-&gt;rlevel, runlevel) ||&nbsp; //保证了ch-&gt;rlevel中有当前runlevel，满足条件的才执行下面的startup函数 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ((ch-&gt;flags &amp; DEMAND) &amp;&amp; !strchr(&quot;#*Ss&quot;, runlevel))) { 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; startup(ch); 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; delete = 0; 
    <br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } 
    <br />... 
    <br />&nbsp;&nbsp;&nbsp; } 
    <br />... 
    <br />} 
   </fcntl.h> 
  </sys> 
 </sys></p>
<link rel="stylesheet" href="/js/syntax_highlighter/SyntaxHighlighter.css" type="text/css" />
<script src="/js/syntax_highlighter/shCore.js"></script>
<script src="/js/syntax_highlighter/shSyntax.js"></script>
<script>$(document).ready(function(){dp.SyntaxHighlighter.HighlightAll('code');});</script><br>原文链接：<a href='http://blog.csdn.net/dog250/article/details/5303623' target='_blank'>http://blog.csdn.net/dog250/article/details/5303623</a><div class='clear'></div><div class='EditLogs'>
	<span class="question_resupply_list">
		</span>
</div></div>
						<div class="Asker">
				<div class="info" title="晨曦之光">
					<span class="ainfo">
						<a href="http://my.oschina.net/chen106106" class="ShowUserOutline" target="_blank" title="晨曦之光"><img src="http://static.oschina.net/uploads/user/117/234345_50.jpg" align="absmiddle" alt="晨曦之光" title="晨曦之光" class="SmallPortrait" user="234345"/></a>
					</span>
					<span class="pinfo">
		    			<a href="http://my.oschina.net/chen106106" class="Asker-Name" target="_blank">晨曦之光</a><br />
		    			<span class="pub_time">发帖于&nbsp;2年前</span><br />
		    			<span><a href='#answers' class='answer_count'>0</a>回/435阅</span>
					</span>
				</div>
				<div class='clear'></div>
			</div>
			<div class="tags_toolbars">
			<div class='Tags' id="tags_nav">
				<strong>标签：</strong>				
								&lt;无&gt;
											</div>
						<div class='SameQuestions'>
			<span class="q_toolbar">
				<ul>
								<li> <a href="javascript:report('http://www.oschina.net/question/234345_47819',47819,2)">举报&nbsp;</a></li>
				<li id="Share">
					<a class="Ask_Share_Tencent" title="分享到腾讯微博"  href="javascript:(function(){window.open('http://v.t.qq.com/share/share.php?url='+encodeURIComponent(document.location)+'&amp;appkey=96f54f97c4de46e393c4835a266207f4&amp;site=&amp;title='+encodeURIComponent(document.title)+encodeURIComponent(': /dev/initctl是一个管道文件，很多人知道它，但是知道怎么用。要想知道怎么用还是得看init程序的源代码，在init.c中就用到了 /dev/initctl管道文件。可以通过/dev/init...'),'', 'width=450, height=400, top=0, left=0, toolbar=no, menubar=no, scrollbars=no, location=yes, resizable=no, status=no');}())"></a>
					<a class="Ask_Share_Sina" title="分享到新浪微博"  href="javascript:void((function(s,d,e,r,l,p,t,z,c){var%20f='http://v.t.sina.com.cn/share/share.php?appkey=858381728',u=z||d.location,p=['&url=',e(u),'&title=',e(t||d.title),'&source=',e(r),'&sourceUrl=',e(l),'&content=',c||'gb2312','&pic=',e(p||'')].join('');function%20a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=440,height=430,left=',(s.width-440)/2,',top=',(s.height-430)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent))setTimeout(a,0);else%20a();})(screen,document,encodeURIComponent,'','','','/dev/initctl怎么玩: /dev/initctl是一个管道文件，很多人知道它，但是知道怎么用。要想知道怎么用还是得看init程序的源代码，在init.c中就用到了 /dev/initctl管道文件。可以通过/dev/init...','','utf-8'));"></a>
					|<a href="javascript:function(0);">&nbsp;分享到</a>
				</li>
				</ul>
			</span>
			<div class="clear"></div>
			</div>
					</div>
		</div>
		<div class='Vote' id='Vote'>
    		    		    		<a id="vote_up" class="vote-up-off" href="#" title="顶：这问题很有用或者很提问清晰明了"></a>
			    		<span class="q_vote_num">0</span>
    		    		<a id="vote_down" class="vote-down-off" href="#" title="踩：这问题不知道在问什么，或者没什么用"></a>
    		    		<span class="store">
    		<a title="收藏此话题" class="Tool-Store-Off" id="favor_trigger" href="javascript:;">收藏(0)</a>
    		</span>
    	</div>
	</div>
		<style type='text/css'>
		#TagsSwitcher{color:#A00;}
        #RecTags,#MyTags{margin:5px 0;}
        #RecTags a.tag{line-height:24px;}
		#favor_form p:first-child{margin:5px 0;}
		#favor_form{width:200px;}
        #favor_form p {color:#666;}
        #favor_form form{width:200px;}
        #favor_form form ._favor_input{display:block;margin:2px 0;width:199px;}
        #favor_form form ._favor_button{float:left;padding:2px 5px;}
        .favor_ok {text-align:center;font-size:10.5pt;width:199px;height:60px;margin-top:10px;}
        #TagsSwitcher{cursor:pointer;float:right;margin-top:10px;}
        #MyTags{display:none;width:199px;}
        #MyTags a.tag {float:left; background-color: #E0EAF1;border-bottom: 1px solid #3E6D8E;border-right: 1px solid #7F9FB6;color: #3E6D8E;font-size: 8pt;line-height: 16px;margin: 2px 2px 2px 0;padding: 2px 4px;text-decoration: none;white-space: nowrap;}
		#MyTags a.tag:hover{background-color: #3E6D8E;color: #FFF;}
		.osc_promotion{ position: relative; display: inline-block; padding: 10px; margin: 10px 0; border: 1px solid #ccc;}
        .osc_promotion .c{ position: absolute; right: -1px; top: -1px;}
		.ask_toolbar {float:right;list-style: none; font-size: 12px; color: #333; height: 28px;_padding-top: 5px; overflow: hidden;margin:20px 0 10px 0;}
        .ask_toolbar div{ float: left; margin-left: 5px; background: url("/img/ask-icon.gif") no-repeat; padding: 6px 0 6px 15px; padding-left: 15px; height: 16px;}
        .ask_toolbar a{ height: 16px; color: #333; text-decoration: none; display:inline-block; zoom:1; vertical-align: middle; }
        .ask_share{width: 89px;vertical-align: bottom; line-height: 15px; _line-height: 14px;}
        .ask_share a{background: url("/img/ask-icon.gif"); width: 16px; }
        a.ask_share_sina{ background: url("/img/ask-icon.gif") 0 -40px no-repeat; margin-left: 5px;  }
        a.ask_share_tencent{background-position: 0 -70px; margin-left: 5px; }
        .ask_toolbar em{ height: 28px; line-height:28px; width: 14px; display: inline-block; float: left; background: url("/img/ask-icon.gif") top right;}
        .ask_collect a,.ask_report a, .ask_vote a, .ask_collected a{padding-left: 20px; line-height: 15px; }
        .ask_collect a{ background: url("/img/ask-icon.gif") 0 -131px no-repeat; }
        .ask_collected a{ background: url("/img/ask-icon.gif") 0 -100px no-repeat; }
        div.ask_collect_count{ background: url("/img/ask-icon.gif") 0 -309px no-repeat; font-weight: bold; font-size: 14px; margin-left: 0; height: 16px;line-height: 16px;}
        .ask_report a{ background: url("/img/ask-icon.gif") 0 -160px no-repeat;}
        em.ask_collect_count_r{background-position: 59px -309px;}
        .ask_vote a{background: url("/img/ask-icon.gif");}
        		a.ask_vote_up{background-position: 3px -190px;}
        a.ask_vote_down{background-position: 0 -280px;}
        a.ask_vote_uped {background-position: 3px -190px;}
        		a.ask_vote_downed {background-position: 0 -280px;}
        .ask_vote span{ display: inline-block; margin: 0 10px; font-weight: bold; font-size: 14px; vertical-align: middle; margin-bottom: 2px; line-height: 16px;}
		</style>
		<div class='clear'></div>
        
		<div class='clear'></div>
				        <div class='QuestionReplies'>
			
        	<h2>
				<span class='sort'>
					<a href="http://www.oschina.net/question/234345_47819#answers" class='current'>按默认排序</a>&nbsp;
					<a href="?sort=time#answers">显示最新评论</a>&nbsp;&nbsp;
				</span>
				<a name='answers'></a>共有<em class='answer_count'>0</em>个评论
							</h2>
			        	<ul class='list'><span class="hr unvisible"></span></ul>
				        </div> 
		<div class='AnswerForm'>
						<form id='form_answer' action="/action/question/answer?question=47819" method="post">
				<input type='hidden' name='user' value=''/>
				<textarea id='txt_answner' name='body' style='width:650px;height:160px;'></textarea>
				<input type='submit' value=' 发表评论 ' id="FormSubmitButton" class='rndbutton'/>
				<span id='form_msg' style='display:none;'></span>
				<br/><br/>
				<a href="#answers">回评论顶部</a>&nbsp;|&nbsp;<a href="#top">回页面顶部</a>
			</form>
			<div class='clear'></div>
			<script>			
            $('#form_answer').ajaxForm({
            	dataType: 'json',
        		beforeSerialize: function($form, options) { 
        			editor.sync();           
                },
        		beforeSubmit: function(){
        			$('#FormSubmitButton').attr('disabled','disabled');
        			$('#form_msg').html("<span class='ajax_processing'>正在提交评论，请稍候...</span>");	
        			$('#form_msg').show();	
        		},
                success: function(json) {
        			$('#FormSubmitButton').removeAttr('disabled');
            		if(json.msg){
        				$('#form_msg').html("<span class='error_msg'>"+json.msg+"</span>");
        				$('#form_msg').show();
        			}
            		else if(json.id){
            			ajax_get("/question/show_answer?_answer_id="+json.id, true, function(data){
        					            				$('.QuestionReplies ul.list').append(data);
        					        					editor.html('');
        					$('.answer_count').html(json.answer_count);
            			}); 				
        				$('#form_msg').hide();
            		}
                }
            });
			</script>
		</div>
	</div>	
	<script type="text/javascript" src="/js/syntax-highlighter-2.1.382/scripts/brush.js"></script>
<link type="text/css" rel="stylesheet" href="/js/syntax-highlighter-2.1.382/styles/shCore.css"/>
<link type="text/css" rel="stylesheet" href="/js/syntax-highlighter-2.1.382/styles/shThemeDefault.css"/>
<script type='text/javascript'><!--
$(document).ready(function(){
	SyntaxHighlighter.config.clipboardSwf = '/js/syntax-highlighter-2.1.382/scripts/clipboard.swf';
	SyntaxHighlighter.all();
});
//-->
</script>
	<div class='QuestionRelations'>
	<div id='QuestionWizard'>
		有什么技术问题吗？
		<a href='/question/ask' class='rndbutton'><span>我要提问</span></a>
		<div class='clear'></div>
	</div>
							<div style='text-align:center;margin-bottom:10px;'>
		<a name="question_banner_one"/>
		<a href="http://www.neitui.me/" target="_blank" title="内推网">
			<img src="http://static.oschina.net/uploads/ad/question_banner_one_250_250_ZiIte.jpg" width="250.0" height="250.0">
		</a>
		 </div>
		    		<div class="AskerCard">
			<div id='OtherQuestionsOfUser' class='Qlist'>
		<strong><a href="http://my.oschina.net/chen106106/?ft=bbs&scope=2&showme=1" class="more">全部(4827)</a>晨曦之光的其他问题</strong>
		<ul>
				<li><a href="http://www.oschina.net/question/234345_65965" title="解惑IEEE754 浮点数内存布局">解惑IEEE754 浮点数内存布局</a><span class='date'>(1回/741阅,1年前)</span></li>				<li><a href="http://www.oschina.net/question/234345_65964" title="MFC——Hierarchy Chart--顶层类是CObject">MFC——Hierarchy Chart--顶层类是CObject</a><span class='date'>(0回/308阅,1年前)</span></li>				<li><a href="http://www.oschina.net/question/234345_65963" title="莫邪内联汇编之C++成员函数__5">莫邪内联汇编之C++成员函数__5</a><span class='date'>(0回/383阅,1年前)</span></li>				<li><a href="http://www.oschina.net/question/234345_65962" title="关于全局变量的看法">关于全局变量的看法</a><span class='date'>(0回/469阅,1年前)</span></li>				<li><a href="http://www.oschina.net/question/234345_65961" title="C++静态成员函数 调用非静态成员函数">C++静态成员函数 调用非静态成员函数</a><span class='date'>(0回/1768阅,1年前)</span></li>				</ul>
	</div>
		</div>
						
        <div class='google_ads' style='margin:20px 0;'>
           <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <!-- question-side -->
            <ins class="adsbygoogle"
                 style="display:inline-block;width:250px;height:250px"
                 data-ad-client="ca-pub-1307862221338762"
                 data-ad-slot="9547725620"></ins>
            <script>
            (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
    	</div>
				          				
		<div id='Similarity' class='Qlist'>
									<strong>类似的话题</strong>
			<ul>
        				<li><a href="http://www.oschina.net/question/12_2996" title="Dev C++的网友评论">Dev C++的网友评论</a><span class='date'>(10回/1974阅,4年前)</span></li>						<li><a href="http://www.oschina.net/question/5189_8545" title="Windows下eclipse的 C++环境配置">Windows下eclipse的 C++环境配置</a><span class='date'>(5回/17667阅,3年前)</span></li>						<li><a href="http://www.oschina.net/question/658193_140123" title="C++跨平台数据库连接库">C++跨平台数据库连接库</a><span class='date'>(3回/428阅,3个月前)</span></li>						<li><a href="http://www.oschina.net/question/658193_113180" title="Qt SDK 4.8.1工程构建">Qt SDK 4.8.1工程构建</a><span class='date'>(1回/240阅,11个月前)</span></li>						<li><a href="http://www.oschina.net/question/54100_36532" title="使用toolchain开发iphone程序心得">使用toolchain开发iphone程序心得</a><span class='date'>(0回/785阅,2年前)</span></li>						<li><a href="http://www.oschina.net/question/658193_117730" title="又看QGrphicsItem之旋转">又看QGrphicsItem之旋转</a><span class='date'>(0回/276阅,9个月前)</span></li>						<li><a href="http://www.oschina.net/question/658193_118503" title="Qt 文件监视器 QFileSystemWatcher">Qt 文件监视器 QFileSystemWatcher</a><span class='date'>(3回/716阅,9个月前)</span></li>						<li><a href="http://www.oschina.net/question/54100_36528" title="在 Ubuntu 下使用 iPhone toolchain 4.0 编译 iPhone 项目">在 Ubuntu 下使用 iPhone toolchain 4.0 编译 iPhone 项目</a><span class='date'>(0回/2696阅,2年前)</span></li>						<li><a href="http://www.oschina.net/question/54100_36529" title="Windows 用 Cygwin 和 iPhone toolchain 4.0 编译 iPhone 项目">Windows 用 Cygwin 和 iPhone toolchain 4.0 编译 iPhone 项目</a><span class='date'>(1回/2657阅,2年前)</span></li>						</ul>
					</div>		
	</div>
	<div class='clear'></div>   
</div>
<script type='text/javascript' src='/js/ke/kindeditor-min.js?v=4.1.6' charset='utf-8'></script>
<script type='text/javascript'>
<!--
var editor;
KindEditor.ready(function(K) {
    editor = K.create('#txt_answner', {
		themeType : 'oschina',
		resizeType : 1,
		urlType: 'domain',
		shadowMode : false,
		allowPreviewEmoticons : false,
		allowImageUpload : true,
		allowFlashUpload : false,
		cssPath : '/css/ke-oschina.css',
		uploadJson : '/action/blog/upload_img',
		afterCreate : function(){
			/*
			K.ctrl(this.edit.iframe.get(0).contentWindow.document, 13, function() {
				$("#txt_answner").parent().submit();
			});
			*/
			$(this.edit.iframe.get(0).contentWindow.document).keydown(function(e) {
				if ((e.ctrlKey || e.metaKey) && e.which == 13 && !e.shiftKey && !e.altKey){
					$("#txt_answner").parent().submit();
				}
			});
		},
		afterChange : function() {
			this.sync();
		},
		items : ['bold', 'italic', 'underline', 'strikethrough', 'removeformat','|','insertorderedlist', 'insertunorderedlist', 
				 'forecolor', 'hilitecolor', 'fontname', 'fontsize',  '|', 'link', 'unlink', 'emoticons', 
				 'shcode', 'image', 'flash', 'quote', '|', 'source','about'],
		htmlTags:
		{
			script : ['src'],
            font : ['color', 'size', 'face', '.background-color'],
            span : [
                    '.color', '.background-color', '.font-size', '.font-family', '.background',
                    '.font-weight', '.font-style', '.text-decoration', '.vertical-align', '.line-height'
            ],
            div : [
                    'class', 'align', '.border', '.margin', '.padding', '.text-align', '.color',
                    '.background-color', '.font-size', '.font-family', '.font-weight', '.background',
                    '.font-style', '.text-decoration', '.vertical-align', '.margin-left'
            ],
            table: [
                    'border', 'cellspacing', 'cellpadding', 'width', 'height', 'align', 'bordercolor',
                    '.padding', '.margin', '.border', 'bgcolor', '.text-align', '.color', '.background-color',
                    '.font-size', '.font-family', '.font-weight', '.font-style', '.text-decoration', '.background',
                    '.width', '.height', '.border-collapse'
            ],
            'td,th': [
                    'align', 'valign', 'width', 'height', 'colspan', 'rowspan', 'bgcolor',
                    '.text-align', '.color', '.background-color', '.font-size', '.font-family', '.font-weight',
                    '.font-style', '.text-decoration', '.vertical-align', '.background', '.border'
            ],
            a : ['href', 'target', 'name'],
            embed : ['src', 'width', 'height', 'type', 'loop', 'autostart', 'quality', '.width', '.height', 'align', 'allowscriptaccess'],
            img : ['src', 'width', 'height', 'border', 'alt', 'title', 'align', '.width', '.height', '.border'],
            'p,ol,ul,li,blockquote,h1,h2,h3,h4,h5,h6' : [
                    'align', '.text-align', '.color', '.background-color', '.font-size', '.font-family', '.background',
                    '.font-weight', '.font-style', '.text-decoration', '.vertical-align', '.text-indent', '.margin-left'
            ],
            pre : ['class'],
            hr : ['class', '.page-break-after'],
            'br,tbody,tr,strong,b,sub,sup,em,i,u,strike,s,del' : []
		}
    });
});
//-->
</script>
<!--[if lt IE 7]>
<script type="text/javascript" src="/js/minmax.js"></script>
<![endif]-->
<script type="text/javascript" src="/action/visit/question?id=47819"></script>
<script type='text/javascript'>
<!--
$(document).ready(function() {
	$.ajax({
		url:"/action/favorite/attentionUsersCount",
		type:"get",
		data:"id="+47819+"&type="+2,
		success:function(msg){
			$("#favor_trigger").html("收藏("+msg+")");
		}
	});
	$('.Answer .replies li').hover(
		function(){$(this).addClass('hover');},
		function(){$(this).removeClass('hover');}
	);
	
    $('.detail img').css('cursor','pointer');
    jQuery.each($('.detail img'),function(idx,v){
        if(!$(v).parent().is("a")) {
            $(v).wrap("<a href='"+$(this).attr('src')+"' target='_blank'></a>");
        }
    });
	
	$('#c').bind('mouseover mouseout',function(){
		$('#c_on').toggle();
		$('#c_off').toggle();
	});
	
	$('#favor_trigger').click(function(){
			add_to_favor(47819,2);
		});
});
function ask_too(qid, ask){
	ajax_post("/action/question/ask_too?id="+qid+"&ask="+ask,"",function(html){
		json = eval('('+html+')');
		if(json.asker_count >= 0){
			$('#c_asker_count').html(json.asker_count);
			if(json.ask_mode)
				$('#RQuestionAction').html("<span class='rect'>已问同一问题 | <a href='javascript:ask_too(47819,false)'>取消？</a></span>");
			else
				$('#RQuestionAction').html("<a href='javascript:ask_too(47819,true)' class='rndbutton'><span>我想问同样的问题</span></a>");			
		}
		else{
			$('#RQuestionAction').poshytip({
				className: 'tip-yellowsimple',
				content: json.msg,
				showOn: 'none',
				alignTo: 'target',
				alignX: 'center',
				alignY: 'top',
				offsetY: 6
			});
			$('#RQuestionAction').poshytip('show');
			var t = setTimeout(function(){
				clearTimeout(t);
				$('#RQuestionAction').poshytip('destroy');
			},4000);
		}
	});
}
function delete_q(qid){
	if(!confirm("您确认要删除此问题吗，删除的数据不可恢复？"))
		return ;
		ajax_post("/action/question/delete?id="+qid+"&hash=2033081987","",function(html){
		if(html.length>0)
			alert(html);
		else{
			location.href = "/question";
		}
	});
}
function edit_answer(aid){
	location.href="/question/edit_answer?id="+aid;
}
function delete_answer(aid,hash){
	if(!confirm("您确认要删除此答案吗，删除的数据不可恢复？"))
		return ;
	ajax_post("/action/question/delete_answer?id="+aid+"&hash="+hash,"",function(html){
		if(html.length>0)
			alert(html);
		else{
			$('#answer_'+aid).fadeOut();
			$('#vote_'+aid).fadeOut();
			$('#answer_'+aid).next('.hr').fadeOut();
		}
	});
}
function delete_post_reply(aid,hash){
	if(!confirm("您确认要删除此评论吗，删除的数据不可恢复？"))
		return ;
	ajax_post("/action/question/delete_answer?id="+aid+"&hash="+hash,"",function(html){
		if(html.length>0)
			alert(html);
		else{
			$('#PostReply_'+aid).fadeOut();
		}
	});
}
function delete_q_rpl(qid, rid){
	if(!confirm("删除补充说明会被扣威望值，是否继续？"))
		return ;
	ajax_post("/action/question/delete_detail?id="+rid,"",function(html){
		if(html.length>0)
			alert(html);
		else
			$("#q_reply_"+rid).fadeOut();
	});
}
function close_tip(tid){$('#'+tid).poshytip('destroy');}
//答案投票
function vote_answer(qid, vote_up, need_confirm){
	if(need_confirm && !vote_up){
		if(!$('#a_post_votedown_' + qid).hasClass('bold')){
			var vote_down_confirm_msg = "<p>此操作将会扣掉你1个积分，是否继续？</p><p style='margin-top:10px;'><a href='javascript:vote_answer("+qid+",false,false)' class='rbtn' style='margin:0 10px 0 50px;'><span>确定</span></a><a href=\"javascript:close_tip('a_post_votedown_" + qid +"')\" class='rbtn'><span>取消</span></a></p>";			
			$('#a_post_votedown_' + qid).poshytip({
				className: 'tip-yellowsimple',
				content: vote_down_confirm_msg,
				showOn: 'none',
				slide: false,
				fade: false,
				alignTo: 'target',
				alignX: 'center',
				offsetY: 8
			});
			$('#a_post_votedown_' + qid).poshytip('show');
			return;
		}
	}
	if(!need_confirm){
		$('#a_post_votedown_' + qid).poshytip('destroy');
	}
	ajax_post("/action/question/vote_answer?id="+qid+"&vote="+vote_up+"&user=","",function(data){
		json = eval('('+data+')');
		if(json.msg){
			var aid = vote_up?"a_post_voteup_":"a_post_votedown_";
			aid += qid;
			$('#'+aid).poshytip({
				className: 'tip-yellowsimple',
				content: json.msg,
				showOn: 'none',
				alignTo: 'target',
				alignX: 'center',
				alignY: 'top',
				offsetY: 6
			});
			$('#'+aid).poshytip('show');
			var t = setTimeout(function(){
				clearTimeout(t);
				$('#'+aid).poshytip('destroy');
			},2000);
			//jQuery.fancybox("<div class='error_box'>"+json.msg+"</div>");
		}
		else{
			if(vote_up){
				$('#post_voteup_'+qid).html('('+json.vote+')');
				var a_post_voteup = $('#a_post_voteup_'+qid);
				if(a_post_voteup.attr('class').indexOf("vote-up-off")!=-1){
					$('#a_post_voteup_'+qid).attr('class', 'vote-up-on');
					$('#a_post_voteup_'+qid).attr('title','取消支持票');
					$('#a_vote_num_'+qid).html(parseInt($('#a_vote_num_'+qid).html())+1);
				}else{
					$('#a_post_voteup_'+qid).attr('class', 'vote-up-off');
					$('#a_post_voteup_'+qid).attr('title','投支持票');
					$('#a_vote_num_'+qid).html(parseInt($('#a_vote_num_'+qid).html())-1);
				}
			}else{
				$('#post_votedown_'+qid).html('('+json.vote+')');
				var a_post_votedown = $('#a_post_votedown_'+qid);
				if(a_post_votedown.attr('class').indexOf("vote-down-off")!=-1){
    				a_post_votedown.attr('class', 'vote-down-on').attr('title','取消反对票');
    				$('#a_vote_num_'+qid).html(parseInt($('#a_vote_num_'+qid).html())-1);
				}else{
					a_post_votedown.attr('class', 'vote-down-off');
					a_post_votedown.attr('title','投反对票');
    				$('#a_vote_num_'+qid).html(parseInt($('#a_vote_num_'+qid).html())+1);
				}
			}
		}
	});
}
//问题投票 
$('#vote_up').click(function(){
	if(this.clickTimeout){
        // 双击
        clearTimeout(this.clickTimeout);
        this.clickTimeout = null;
		alert("不用那么费劲啦，点击一下就够了:)");
    }
    else{
        // 单击
        var elem = this;
        this.clickTimeout = setTimeout(function(){
            // 执行点击动作
            elem.clickTimeout = null;
			vote_question(47819,true, true);
        }, 250);
    }
    //阻止链接onclick时的默认行为
    return false;
});
$('#vote_down').click(function(){
	vote_question(47819,false, true);
	/*
	if(this.clickTimeout){
        // 双击
        clearTimeout(this.clickTimeout);
        this.clickTimeout = null;
		alert("不用那么费劲啦，点击一下就够了:)");
    }
    else{
        // 单击
        var elem = this;
        this.clickTimeout = setTimeout(function(){
            // 执行点击动作
            elem.clickTimeout = null;
			vote_question(47819,false, true);
        }, 250);
    }
    //阻止链接onclick时的默认行为
	*/
    return false;
});
function vote_question(qid, vote_up, need_confirm){
	if(need_confirm && !vote_up){
		if($('#Vote #vote_down').hasClass('ask_vote_down')){
			var vote_down_confirm_msg = "<p>踩问题将会扣掉你1个积分，是否继续？</p><p style='margin-top:10px;'><a href='javascript:vote_question(47819,false,false)' class='rbtn' style='margin-right:10px;'><span>确定</span></a><a href=\"javascript:close_tip('vote_down')\" class='rbtn'><span>取消</span></a></p>";
			$('#Vote #vote_down').poshytip({
				className: 'tip-yellowsimple',
				content: vote_down_confirm_msg,
				slide: false,
				fade: false,
				showOn: 'none',
				alignTo: 'target',
				alignX: 'inner-right',
				alignY: 'bottom',
				offsetX: -35,
				offsetY: 5
			});
			$('#Vote #vote_down').poshytip('show');
			return;
		}
	}
	if(!need_confirm){
		$('#Vote #vote_down').poshytip('destroy');
	}
	ajax_post("/action/question/vote?user=&id="+qid+"&vote="+vote_up,"",function(data){
		json = eval('('+data+')');
		if(json.msg){
			var aid = vote_up?"vote_up":"vote_down";
			$('#'+aid).poshytip({
				className: 'tip-yellowsimple',
				content: json.msg,
				showOn: 'none',
				alignTo: 'target',
				alignX: 'inner-right',
				alignY: 'bottom',
				offsetX: 5,
				offsetX: -35
			});
			$('#'+aid).poshytip('show');
			var t = setTimeout(function(){
				clearTimeout(t);
				$('#'+aid).poshytip('destroy');
			},2000);
		}
		else{
						if(vote_up){
				$('#Vote .vote-up-count').html(json.vote_up);
				if($('#vote_up').attr('class').indexOf("vote-up-off")!=-1){
					$('#vote_up').attr('class', 'vote-up-on');
					$('#vote_up').attr('title','取消顶');
					$('.q_vote_num').html(parseInt($('.q_vote_num').html())+1);
				}else{
					$('#vote_up').attr('class', 'vote-up-off');
					$('#vote_up').attr('title','顶：这问题很有用或者很提问清晰明了');
					$('.q_vote_num').html(parseInt($('.q_vote_num').html())-1);
				}
			}
			else{
				$('#Vote .vote-down-count').html(json.vote_down);
				if($('#vote_down').attr('class').indexOf("vote-down-off")!=-1){
					$('#vote_down').attr('class', 'vote-down-on');
					$('#vote_down').attr('title','取消踩');
					$('.q_vote_num').html(parseInt($('.q_vote_num').html())-1);
				}else{
					$('#vote_down').attr('class', 'vote-down-off');
					$('#vote_down').attr('title','踩：这问题不知道在问什么，或者没什么用');
					$('.q_vote_num').html(parseInt($('.q_vote_num').html())+1);
				}
			}
		}
	});
}
//评论答案
function reply_to_post(postid,uid){
	    url = "/action/ajax/reply_to_post?id=" + postid + "&refer="+uid
    ajax_post(url,"",function(data){
        $.fancybox({
            content: data,
            onComplete: function(){
                $input = $('#ta_body');
                $input.focus();
                pos = $input.val().length;
                if (document.selection) {
                    range = $input[0].createTextRange();
                    range.move("character", pos);
                    range.select();
                } else {
                    $input[0].setSelectionRange(pos, pos);
                }
            }
        });
    });
}

function show_rp_next(postid,current,total){
	if(current < total){
		var next_page = current + 1;
    	var url = "/question/post_replies?answer="+postid+"&rp="+next_page;
    	ajax_post(url,"",function(html){
    		$('#PostReplies_'+postid).html(html);
				addRepliesHoverEvent();
			});
	}
}

function addRepliesHoverEvent(){
	$("li [id ^= 'PostReply']").hover(function(){
		$(this).addClass("hover");
	},function(){
		$(this).removeClass("hover");
	});
}

function show_rp_prev(postid,current,total){
	if(current > 1){
		var next_page = current - 1;
    	var url = "/question/post_replies?answer="+postid+"&rp="+next_page;
    	ajax_post(url,"",function(html){
    		$('#PostReplies_'+postid).html(html);
			addRepliesHoverEvent();
    	});
	}
}
function mark_as_top(qid, as_top) {
	var args = "id="+qid+"&top="+as_top;
	ajax_post("/action/question/mark_as_top",args,function(html){
		alert(html);
	});
}
function mark_as_best(postid, is_best){
	var args = "id="+postid+"&best="+(is_best?1:0);
	ajax_post("/action/question/mark_as_best",args,function(html){
    	if(html.length>0){
    		$('#best_answer_'+postid).poshytip({
    			className: 'tip-yellowsimple',
    			content: html,
    			showOn: 'none',
    			alignTo: 'target',
    			alignX: 'center',
    			alignY: 'top',
    			offsetY: 6
    		});
    		$('#best_answer_'+postid).poshytip('show');
    		var t = setTimeout(function(){
    			clearTimeout(t);
    			$('#best_answer_'+postid).poshytip('destroy');
    		},2000);
    	}
    	else{
			if(is_best){
				$('#answer_'+postid).addClass('Best');
				$('#best_answer_'+postid).attr('class', 'accept-on')
				.attr('href', 'javascript:mark_as_best('+postid+',false)')
				.attr('title','取消标记为最佳答案');
			}else{
				$('#answer_'+postid).removeClass('Best');
				$('#best_answer_'+postid).attr('class', 'accept-off')
				.attr('href', 'javascript:mark_as_best('+postid+',true)')
				.attr('title','标记为最佳答案');
			}
    	}
	});
}
function edit_tags(qid){
	popup("/question/edit_tags?question="+qid);
}
function edit_catalogs(qid){
	popup("/admin/catalog/set-catalogs?parent=1&type=2&id="+qid);
}
function event_apply(event_id){	
	popup("/action/ajax/event_apply","id="+event_id);
}
function cancel_apply(event_id){
	if(confirm("您确认要取消参加此次活动吗？")){
		ajax_post("/action/event/cancel","event="+event_id,function(html){
			if(html.length>0)
				alert(html);
			else
				alert('已取消参加此次活动，感谢您的支持:)');
		});
	}
}

var favor_ok = "<p class='favor_ok'>已成功添加到收藏夹<br/><br/> <a href='null/favorites?type=$DAISY_OBJ_TYPE'>我的收藏夹</a> | <a href='javascript:close_favor()'>关闭</a></p>";
function delete_favor(obi_id, obj_type){
	if(!confirm('确定取消收藏？')) return;
	$.post("/action/favorite/cancel?type="+obj_type+"&id="+obi_id+"&user=",function(html){
		$('#favor_trigger').parent('div').removeClass('ask_collected').addClass('ask_collect');
		$('#favor_trigger').attr('title','添加到收藏');
    	$('#p_favor_count').html(html);
		$('#favor_trigger').unbind('click');
		$('#favor_trigger').click(function(){add_to_favor(47819,2);});
	});
}
function add_to_favor(obj_id, obj_type){
	if(confirm('必须登录后才能收藏，是否现在登录？')){
		location.href="http://www.oschina.net/home/login?goto_page="+location.href;
	}
}
function close_favor(elem_id){
    $('#favor_trigger').poshytip('destroy');
}
function setTag(tv){
	var t = $("._favor_input");
	var value = t.val();
	var tags = value.replace(/，/ig,',').split(',');
	var exist = false;
	value = $.map(tags,function(v,i){
		if($.trim(tv) == $.trim(v)){
			exist = true;
			return undefined;
		}
		return v;
	}).join(',');
	if(exist){
		t.val(value);
		return;
	}
	if(value!="")
		t.val(value+","+tv);
	else
		t.val(tv)
}
//-->
</script><div class='clear'></div></div>
	<div id="OSC_Footer" class='CenterDiv'><style>
.oscapp {text-align:left; width:220px;}
.oscapp span {float:left;width:140px;}
.oscapp a {float:left;text-indent:-9999em;width:16px;margin-left:8px;}
.oscapp a.android {background:url('/img/android.gif') no-repeat left center;}
.oscapp a.iphone {background:url('/img/iphone.gif') no-repeat left center;}
.oscapp a.wp7 {background:url('/img/wp7.gif') no-repeat left center;}
</style>
<table width='100%'><tr>
<td align='left'>&copy; 开源中国(OsChina.NET) | <a href="http://www.oschina.net/home/aboutosc">关于我们</a> | <a href="mailto:oschina.net@gmail.com">广告联系</a> | <a href="http://weibo.com/oschina2010" target="_blank">@新浪微博</a> | <a href="http://m.oschina.net/">开源中国手机版</a> | <a href='http://www.miitbeian.gov.cn/' target='_blank' style='color:#737573;text-decoration:none;'>粤ICP备12009483号-3</a></td>
<td class='oscapp'>
	<span>开源中国手机客户端：</span>
	<a href="http://www.oschina.net/app" class='android' title='Android客户端'>Android</a>
	<a href="http://www.oschina.net/app" class='iphone' title='iPhone 客户端'>iPhone</a>
	<a href="http://www.oschina.net/app" class='wp7' title='Windows Phone 客户端'>WP7</a>
</td>
</tr>
</table>
<script type='text/javascript'>
<!--
if (top.location != self.location)top.location=self.location;
//-->
</script></div>
</div>
</body>
</html>
<!-- Generated by OsChina.NET (init:0[ms],page:38[ms],ip:49.5.1.198) -->