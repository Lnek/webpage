<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>深入云存储系统Swift核心组件：Ring实现原理剖析 - 牛皮糖NewPtone - 博客园</title>
<link type="text/css" rel="stylesheet" href="/bundles/blog-common.css?v=RFWbSMVn474Meo5c6rKa1DH_M4ldFPuI9Jah-EA-L5Q1"/>
<link id="MainCss" type="text/css" rel="stylesheet" href="/skins/SimpleBlue/bundle-SimpleBlue.css?v=g1Ly_5CnmgosFgcSP2WTmRocMrlS6IO9yhcnMXW9dOA1"/>
<link type="text/css" rel="stylesheet" href="/blog/customcss/88100.css?v=ixzoo8c3IlhJVohSV5YO0SXlOlA%3d"/>
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/yuxc/rss"/>
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/yuxc/rsd.xml"/>
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/yuxc/wlwmanifest.xml"/>
<script src="http://common.cnblogs.com/script/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">var currentBlogApp = 'yuxc', cb_enable_mathjax=false;</script>
<script src="/bundles/blog-common.js?v=NRIlPIHMlVEgoqJZIuk9OQtjtZjNFcz_ov8kYhFFdoM1" type="text/javascript"></script>
</head>
<body>
<a name="top"></a>
<div id="page_begin_html"></div><script>load_page_begin_html();</script>

<div id="home">
<div id="header">
	<div id="blogTitle">
		
<!--done-->
<div class="title"><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/yuxc/">牛皮糖的旅程</a></div>
<div class="subtitle">Brick walls,they let us prove how badly we want things.    
            --------摘自Randy Pausch的《最后一课》</div>



		
	</div><!--end: blogTitle 博客的标题和副标题 -->
	<div id="navigator">
		
<ul id="navList">
<li id="nav_sitehome"><a id="MyLinks1_HomeLink" class="menu" href="http://www.cnblogs.com/">博客园</a></li>
<li id="nav_myhome"><a id="MyLinks1_MyHomeLink" class="menu" href="http://www.cnblogs.com/yuxc/">首页</a></li>
<li id="nav_q"><a class="menu" href="http://q.cnblogs.com/">博问</a></li>
<li id="nav_ing"><a class="menu" href="http://home.cnblogs.com/ing/">闪存</a></li>
<li id="nav_newpost"></li>
<li id="nav_contact"><a id="MyLinks1_ContactLink" class="menu" rel="nofollow" href="http://space.cnblogs.com/msg/send/%e7%89%9b%e7%9a%ae%e7%b3%96NewPtone">联系</a></li>
<li id="nav_rss">
<!----></li>
<li id="nav_admin"><a id="MyLinks1_Admin" class="menu" rel="nofollow" href="http://i.cnblogs.com/">管理</a></li>
</ul>

		<div class="blogStats">
			
			
<!--done-->
随笔-232&nbsp;
文章-0&nbsp;
评论-223&nbsp;

			
		</div><!--end: blogStats -->
	</div><!--end: navigator 博客导航栏 -->
</div><!--end: header 头部 -->
<div id="main">
	<div id="mainContent">
	<div class="forFlow">
		

<!--done-->
<div id="topics">
	<div class = "post">
		<h1 class = "postTitle">
			<a id="cb_post_title_url" class="postTitle2" href="http://www.cnblogs.com/yuxc/archive/2012/06/22/2558312.html">深入云存储系统Swift核心组件：Ring实现原理剖析</a>
		</h1>
		<div class="clear"></div>
		<div class="postBody">
			<div id="cnblogs_post_body"><p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24.1pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24.1pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24.1pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24.1pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">简介</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><strong><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 14pt;">OpenStack</span></span></span></strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">是一个美国国家航空航天局和</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Rackspace</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">合作研发的开源云计算项目，并成为</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Apache</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">下的一个重要开源项目，目前已经发展到了</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">180</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">家公司参与其中。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><a style="border-bottom-style: none;" href="http://www.openstack.org/projects/storage/"><span style="text-underline: none;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">OpenStack Object Storage</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; text-underline: none;" lang="EN-US"><span lang="EN-US"><span style="font-family: 宋体;"><span style="font-size: 12pt;">（</span></span></span></span><strong><span style="mso-bidi-font-size: 10.0pt; text-underline: none;"><span style="font-family: 'Times New Roman';"><span style="font-size: 14pt;">Swift</span></span></span></strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; text-underline: none;" lang="EN-US"><span lang="EN-US"><span style="font-family: 宋体;"><span style="font-size: 12pt;">）</span></span></span></span></a></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="color: #000000; font-family: 宋体;">是</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><a style="border-bottom-style: none;" href="http://www.openstack.org/"><span style="text-underline: none;"><span style="font-family: 'Times New Roman';">OpenStack</span></span></a></span><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">开源云计算项目的子项目之一。</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Swift</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">的目的是使用普通硬件来构建冗余的、可扩展的分布式对象存储集群，存储容量可达</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">PB</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">级。</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">OpenStack Object Storage </span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">最初由</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"> Rackspace </span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">采用</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Python</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">语言开发，并于</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"> 2010 </span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">年</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"> 7 </span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">月贡献给</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"> OpenStack ,</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">作为该开源项目的一部分。它的目的是用于托管</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"> Rackspace</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"> Cloud Files service </span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">，原始项目代号是</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"> swift</span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">，所以沿用至今。</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">在分布式对象存储中的一个关键问题是数据该如何存放。</span></span></span><span style="font-size: 12pt;"><strong><span style="font-size: 18pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Ring</span></span></strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">是</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Swift</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">中最重要的组件，用于记录存储对象与物理位置间映射关系。在涉及查询</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">account</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">container</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">object</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">信息时就需要查询集群的</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">信息。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">&nbsp;</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-font-weight: bold; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 14.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">先来看一下</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-font-weight: bold; mso-bidi-font-size: 14.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Swift</span></span><span style="mso-bidi-font-weight: bold; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 14.0pt;"><span style="font-family: 宋体;">文档中关于</span></span><span style="mso-bidi-font-weight: bold; mso-bidi-font-size: 14.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Ring</span></span></span><span style="mso-bidi-font-weight: bold; mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 14.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的描述：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="font-family: 'Times New Roman';"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US">Ring</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">用来确定数据驻留在集群中的位置。有单独对应于</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Account</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">数据库、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">container</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">数据库和单个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">object</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">Ring</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">中每个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">在集群中都</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">(</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">默认</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">)</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">有</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">3</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">。每个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的位置由</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">来维护</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">,</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">并存储在映射中。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">Ring</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">使用</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">zone</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的概念来保证数据的隔离。每个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">都确保放在了不同的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">zone</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">中。一个</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">zone</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">可以是一个硬盘，一个服务器，一个机架，一个交换机，甚至是一个数据中心</span></span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">............</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">.......</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 24pt; margin: 0cm 0cm 0pt; word-break: normal; mso-char-indent-count: 2.0;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">在上述</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的特性描述中提到了</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">使用</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">zone</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">device</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">和</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">等等来维护数据和磁盘间的映射信息。那么在</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Ring</span></span><span style="font-family: 宋体;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;">的背后采用什么算法，使用了什么机制来保证数据的安全、高效和可扩展呢？这些概念对于数据存储带来了什么好处？</span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;">本文逐步深入探讨了</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Swift</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">如何通过</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Ring</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">组件来实现冗余的、可扩展的目的。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: -18pt; margin: 0cm 0cm 0pt 18pt; word-break: normal; mso-list: l0 level1 lfo1;" align="justify"><span><span style="color: #000000;"><span style="mso-list: ignore;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;"><strong>1.</strong></span><span style="line-height: normal;"><span style="font-size: 7pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><strong><span style="font-family: 宋体;"><span style="font-size: 12pt;">普通</span></span><span style="font-size: 12pt;"><span style="font-family: 'Times New Roman';">Hash</span></span><span style="font-family: 宋体;"><span style="font-size: 12pt;">算法与场景分析</span></span></strong></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><strong style="mso-bidi-font-weight: normal;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">先来看一个简单的例子假设我们手里有</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">台存储服务器（以下简称</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">），打算用于图片文件存储，为了使服务器的负载均衡，需要把对象均匀地映射到每台服务器上，通常会使用哈希算法来实现，计算步骤如下：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">&nbsp;</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">1.</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">计算</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">object</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">hash</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">值</span></span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">Key</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">2.</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">计算</span></span><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Key mod N</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">值</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">有</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">个存储节点，将</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Key</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">模</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">得到的余数就是该</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Key</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">对应的值需要存放的节点。比如，</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">是</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">2</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">，那么值为</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">0</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">1</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">2</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">3</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">4</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Key</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">需要分别存放在</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">0</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">1</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">0</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">1</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">和</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">0</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">号节点上。如果哈希算法是均匀的，数据就会被平均分配到两个节点中。如果每个数据的访问量比较平均，负载也会被平均分配到两个节点上。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; margin-left: 0cm; word-break: normal; text-align: justify;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">但是，当数据量和访问量进一步增加，两个节点无法满足需求的时候，需要增加一个节点来服务客户端的请求。这时，</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">变成了</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">3</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">，映射关系变成了Key mod (N+1)，因此，上述哈希值为</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">2</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">3</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">、</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">4</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">的数据需要重新分配（</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">2-&gt;server 2</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">，</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">3 -&gt; server 0</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">，</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">4 -&gt; server 1</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">）。如果数据量很大的话，那么数据量的迁移工作将会非常大。当</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">已经很大，从</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">加入一个节点变成</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">N+1</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">个节点的过程，会导致整个哈希环的重新分配，这个过程几乎是无法容忍的，</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">几乎全部的数据都要重新移动一遍。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp; &nbsp; &nbsp; &nbsp;我们举例说明，</span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">假设有</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">100</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node的集群</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，将</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">10<sup>7</sup></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">项数据使用</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">md5 hash</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">算法分配到每个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">中，</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Python</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">代码如下：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from hashlib import md5<br />from struct import unpack_from<br /><br />NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><br /><span style="color: #f6f3e8; font-family: Consolas;">node_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * NODE_COUNT</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br />&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br />&nbsp;&nbsp;&nbsp; </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #99968b;"># This just pulls part of the hash out as an integer</span></span></em></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><span style="font-family: Consolas;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(data_id).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br />&nbsp;&nbsp;&nbsp; node_id = hsh % NODE_COUNT<br />&nbsp;&nbsp;&nbsp; node_counts[node_id] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">desired_count = DATA_ID_COUNT / NODE_COUNT</span><br /></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per node'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br />max_count = max(node_counts)<br />over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids on one node, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (max_count, over)<br />min_count = min(node_counts)<br />under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids on one node, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (min_count, under)</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100000</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per node</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100695</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.69</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">99073</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.93</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">分布结果如下所示：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">　　　　</span></span></span></span></p>
<table class="MsoNormalTable" style="border-collapse: collapse; word-break: normal; mso-table-layout-alt: fixed; mso-border-alt: solid windowtext .5pt; mso-padding-alt: 0cm 5.4pt 0cm 5.4pt; mso-border-insideh: .5pt solid windowtext; mso-border-insidev: .5pt solid windowtext;" border="1" cellspacing="0" cellpadding="0">
<tbody>
<tr>
<td style="padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; padding-top: 0cm; mso-border-alt: solid windowtext .5pt; border: windowtext 1pt solid;" valign="top" width="139">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">名称</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: windowtext 1pt solid; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="239">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">数据项数量</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: windowtext 1pt solid; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="189">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">百分比值</span></span></span></p>















</td>















</tr>
<tr>
<td style="border-bottom: windowtext 1pt solid; border-left: windowtext 1pt solid; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="139">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">数据项均值</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="239">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">100000</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="189">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">0%</span></span></span></p>















</td>















</tr>
<tr>
<td style="border-bottom: windowtext 1pt solid; border-left: windowtext 1pt solid; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="139">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">最多数据项节点</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="239">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">100695</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="189">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">+0.69%</span></span></span></p>















</td>















</tr>
<tr style="mso-yfti-lastrow: yes;">
<td style="border-bottom: windowtext 1pt solid; border-left: windowtext 1pt solid; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="139">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">最少数据项节点</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="239">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">99073</span></span></span></p>















</td>
<td style="border-bottom: windowtext 1pt solid; border-left: medium none; padding-bottom: 0cm; padding-left: 5.4pt; padding-right: 5.4pt; border-top: medium none; border-right: windowtext 1pt solid; padding-top: 0cm; mso-border-left-alt: solid windowtext .5pt; mso-border-top-alt: solid windowtext .5pt; mso-border-alt: solid windowtext .5pt;" valign="top" width="189">
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt;" align="justify"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">-0.93%</span></span></span></p>















</td>















</tr>















</tbody>















</table>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">从数据分布上来看拥有最多</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">/</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">最少数据项的节点没有超出平均值的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">1%</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。现在假设增加一个节点提供负载能力，不过得重新分配数据项到新的节点上，代码如下：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from hashlib import md5<br />from struct import unpack_from<span style="mso-spacerun: yes;">&nbsp; </span><br /><br />NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">NEW_NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">101</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><br /><span style="color: #f6f3e8; font-family: Consolas;">moved_ids = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br />&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br />&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br />&nbsp;&nbsp;&nbsp; node_id = hsh % NODE_COUNT<br />&nbsp;&nbsp;&nbsp; new_node_id = hsh % NEW_NODE_COUNT<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id != new_node_id:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; moved_ids += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">percent_moved = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100.0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * moved_ids / DATA_ID_COUNT</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d ids moved, %.02f%%'</span></span></em></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (moved_ids, percent_moved)</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">9900989</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ids moved, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">99.01</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">%</span></span></span><a style="border-bottom-style: none;" name="OLE_LINK10"></a><a style="border-bottom-style: none;" name="OLE_LINK9"></a><a style="border-bottom-style: none;" name="OLE_LINK8"></a><a style="border-bottom-style: none;" name="OLE_LINK7"></a></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">通过计算我们发现，为了提高集群</span></span></span></span></span></span></span><span style="font-size: 12pt;"><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">1%</span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">的存储能力，我们需要移动</span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">9900989</span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;">个数据项，也就是</span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">99.01%</span></span></span></span></span></span></span><span style="mso-bookmark: ole_link7;"><span style="mso-bookmark: ole_link8;"><span style="mso-bookmark: ole_link9;"><span style="mso-bookmark: ole_link10;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据项！显然，这种算法严重地影响了系统的性能和可扩展性。</span></span></span></span></span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307151784.gif"><img style="background-image: none; margin-top: 0px; margin-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px; border-style: initial; border-color: initial; display: block; margin-left: auto; margin-right: auto; border-width: 0px;" title="clip_image002[4]" src="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307151261.gif" alt="clip_image002[4]" width="354" height="207" border="0" /></a></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">增加1%</span></span></span><span style="font-size: 12pt;"><span><span style="font-family: 宋体;">的存储能力</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">=</span></span><span><span style="font-family: 宋体;">移动</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">99%</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据？</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-spacerun: yes;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;</span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">这种亏本生意显然做不得，那么怎么办呢？一致性哈希算法就是为了解决这个问题而来。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: -18pt; margin: 0cm 0cm 0pt 18pt; word-break: normal; mso-list: l0 level1 lfo1;" align="justify"><a style="border-bottom-style: none;" name="OLE_LINK12"></a><a style="border-bottom-style: none;" name="OLE_LINK11"></a><span style="mso-bookmark: ole_link12;"><span><span style="mso-list: ignore;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;"><strong>2.</strong></span><span style="line-height: normal;"><span style="font-size: 7pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><strong><span style="font-family: 宋体;"><span style="font-size: 12pt;">一致性哈希算法</span></span></strong></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">一致性哈希算法是由</span></span></span><span style="font-size: 12pt;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">D. Darger、E. Lehman和T. Leighton&nbsp;</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">等人于</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">1997</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">年在论文</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Consistent Hashing and Random Trees:Distributed Caching Protocols for Relieving Hot Spots On the World Wide Web</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">首次提出，目的主要是为了解决分布式网络中的热点问题。在其论文中，提出了一致性哈希算法并给出了衡量一个哈希算法的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">4</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">个指标：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">&nbsp;</span></span></span></span></p>
<blockquote>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">平衡性</span></span></span></strong><strong><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">(Balance)</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">平衡性是指</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Hash</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-size: 12pt;"><span style="font-family: 宋体;">的结果能够尽可能分布均匀，充分利用所有缓存空间</span><a style="border-bottom-style: none;" name="2_2"></a></span><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">单调性</span></span></span></strong><strong><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">(Monotonicity)</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">单调性是指如果已经有一些内容通过哈希分派到了相应的缓冲中，又有新的缓冲加入到系统中。哈希的结果应能够保证原有已分配的内容可以被映射到新的缓冲中去，而不会被映射到旧的缓冲集合中的其他缓冲区。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">分散性</span></span></span></strong><strong><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">(Spread)</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">分散性定义了分布式环境中，不同终端通过</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Hash</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">过程将内容映射至缓存上时，因可见缓存不同，</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">Hash</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">结果不一致，相同的内容被映射至不同的缓冲区。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">负载</span></span></span></strong><strong><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">(Load)</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin-top: 0cm; margin-right: 0cm; margin-bottom: 0pt; word-break: normal; margin-left: 30px;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">负载是对分散性要求的另一个纬度。既然不同的终端可以将相同的内容映射到不同的缓冲区中，那么对于一个特定的缓冲区而言，也可能被不同的用户映射为不同的内容。</span></span></span></span></p>











</blockquote>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">Swift</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">使用该算法的主要目的是在改变集群的</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">数量时（增加/删除服务器），能够尽可能少地改变已存在</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">key</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">和</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的映射关系，以满足单调性。一致性哈希一般两种思路：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt 18pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">1.</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">迁移为主要特点</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">(swift</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">初期采用</span></span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">)</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt 18pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">2.</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">引入虚结点，减少移动为特点</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">(swift</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">现采用</span></span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">)</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">具体步骤如下：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">1.&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us;"><span style="font-family: 宋体;">首先求出每个节点(机器名或者是IP地址)的哈希值，并将其分配到一个</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">圆环区间上（这里取0-2^32）。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">2.&nbsp;&nbsp;&nbsp; </span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">求出需要存储对象的哈希值，也将其分配到这个圆环上。</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span><span style="font-size: 12pt;">&nbsp; &nbsp; &nbsp; &nbsp;</span></span><span style="font-size: 12pt;">3.&nbsp;&nbsp;&nbsp; </span></span></span><span style="font-size: 12pt;"><span><span style="font-family: 宋体;">从对象映射到的位置开始顺时针查找，将对象保存到找到的第一个节点上。</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us;"><span style="font-family: 宋体;">其中这个从哈希到位置映射的圆环，我们就可以理解为何使用术语&ldquo;</span></span><strong style="mso-bidi-font-weight: normal;"><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="font-family: 'Times New Roman';">Ring</span></span></strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us;"><span style="font-family: 宋体;">&rdquo;来表示了。哈希环空间上的分布如图</span></span><span style="mso-bidi-language: en-us;" lang="EN-US"><span style="font-family: 'Times New Roman';">1</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">所示：</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">&nbsp;</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307157706.jpg"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image004[4]" src="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307167739.jpg" alt="clip_image004[4]" width="382" height="289" border="0" /></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">图</span></span></span><span style="font-size: 10.5pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">1 </span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">哈希环空间</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 10.5pt; color: #000000;">&nbsp;&nbsp;</span></span></span><span style="font-size: 12pt;"><span><span style="font-family: 宋体;">假设在这个环形哈希空间中，</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Cache5</span></span><span><span style="font-family: 宋体;">被映射在</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Cache3</span></span><span><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Cache4</span></span><span><span style="font-family: 宋体;">之间，那么受影响的将仅是沿</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Cache5</span></span><span><span style="font-family: 宋体;">逆时针遍历直到下一个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Cache</span></span><span><span style="font-family: 宋体;">（</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Cache3</span></span><span><span style="font-family: 宋体;">）之间的对象（它们本来映射到</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Cache4</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">上）。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307169408.jpg"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image006[4]" src="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307165853.jpg" alt="clip_image006[4]" width="413" height="329" border="0" /></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">图</span></span></span><span style="font-size: 10.5pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">2 </span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">一致性哈希算法的数据移动</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 10.5pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;<span style="mso-tab-count: 1;">&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">现在，使用该算法在集群中增加一个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，同时要保证每个节点的数据项数量均衡，代码如下所示，其中</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node_range_starts</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">表示每个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据项的开始位置。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from bisect import bisect_left<br />from hashlib import md5<br />from struct import unpack_from <br /><br />NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">NEW_NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">101</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">node_range_starts = []</span><br /></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id in xrange(NODE_COUNT):<br />&nbsp;&nbsp;&nbsp; node_range_starts.append(DATA_ID_COUNT /<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NODE_COUNT * node_id)<br />new_node_range_starts = []</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> new_node_id in xrange(NEW_NODE_COUNT):<br />&nbsp;&nbsp;&nbsp; new_node_range_starts.append(DATA_ID_COUNT /<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; NEW_NODE_COUNT * new_node_id)<br />moved_ids = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br />&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br />&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br />&nbsp;&nbsp;&nbsp; node_id = bisect_left(node_range_starts,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hsh % DATA_ID_COUNT) % NODE_COUNT<br />&nbsp;&nbsp;&nbsp; new_node_id = bisect_left(new_node_range_starts,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hsh % DATA_ID_COUNT) % NEW_NODE_COUNT<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id != new_node_id:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; moved_ids += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">percent_moved = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100.0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * moved_ids / DATA_ID_COUNT</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d ids moved, %.02f%%'</span></span></em></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (moved_ids, percent_moved)</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">4901707</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ids moved, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">49.02</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">%</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">结果虽然比之前好了些，但是提高</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">1%</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的性能与移动</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">50%</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据仍不理想。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212307173411.gif"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image008[4]" src="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309356435.gif" alt="clip_image008[4]" width="298" height="184" border="0" /></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">增加</span></span></span><span style="font-size: 10.5pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">1%</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">能力</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">=</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">移动</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">50%</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">数据？</span></span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 10.0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt;">引入虚拟节点</span></span></span></strong><strong><span style="mso-bidi-font-size: 10.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">(Partition)</span></span></span></strong></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">考虑到哈希算法在</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">较少的情况下，改变node数会带来巨大的数据迁移</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">。为了解决这种情况，一致性哈希引入了&ldquo;虚拟节点&rdquo;的概念：</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">&nbsp;</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">&ldquo;虚拟节点&rdquo;是实际节点在环形空间的复制品，一个实际节点对应了若干个&ldquo;虚拟节点&rdquo;，</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">&ldquo;虚拟节点&rdquo;在哈希空间中以哈希值排列。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309364516.jpg"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image010[4]" src="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309364898.jpg" alt="clip_image010[4]" width="459" height="325" border="0" /></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">图</span></span></span><span style="font-size: 10.5pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">3 </span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">虚拟节点</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">引入了&ldquo;虚拟节点&rdquo;后，映射关系就从【</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">object---&gt;node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">】转换成了【</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">object---&gt;virtual node---&gt; node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">】。查询</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">object</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">所在</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的映射关系如下图所示。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309376044.jpg"><img style="background-image: none; margin: 0px; padding-left: 0px; padding-right: 0px; display: inline; padding-top: 0px; border: 0px;" title="clip_image012[4]" src="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309386110.jpg" alt="clip_image012[4]" width="547" height="300" border="0" /></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 12.0pt;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">图</span></span></span><span style="font-size: 10.5pt;"><span style="mso-bidi-font-size: 12.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">4 </span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-font-size: 12.0pt;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">对象、虚结点、节点间的映射关系</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span style="mso-bidi-font-size: 12.0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 10.5pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">对</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">100</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">细分为</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1000</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，使用</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode_range_starts</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">来指定</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的开始范围，</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode2node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">表示</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">到</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的指派，然后增加一个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，完成</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的重新分配，并计算所移动的数据项：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from bisect import bisect_left<br />from hashlib import md5<br />from struct import unpack_from<br /><br />NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">VNODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">1000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">vnode_range_starts = []<br />vnode2node = []</span><br /></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnode_id in xrange(VNODE_COUNT):<br />&nbsp;&nbsp;&nbsp; vnode_range_starts.append(DATA_ID_COUNT /<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; VNODE_COUNT * vnode_id)<br />&nbsp;&nbsp;&nbsp; vnode2node.append(vnode_id % NODE_COUNT)<br />new_vnode2node = list(vnode2node)<br />new_node_id = NODE_COUNT<br />NEW_NODE_COUNT = NODE_COUNT + </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">vnodes_to_reassign = VNODE_COUNT / NEW_NODE_COUNT</span><br /></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_reassign &gt; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_to_take_from in xrange(NODE_COUNT):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnode_id, node_id in enumerate(new_vnode2node):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id == node_to_take_from:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; new_vnode2node[vnode_id] = new_node_id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vnodes_to_reassign -= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_reassign &lt;= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_reassign &lt;= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">moved_ids = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br />&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br />&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br />&nbsp;&nbsp;&nbsp; vnode_id = bisect_left(vnode_range_starts,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; hsh % DATA_ID_COUNT) % VNODE_COUNT<br />&nbsp;&nbsp;&nbsp; node_id = vnode2node[vnode_id]<br />&nbsp;&nbsp;&nbsp; new_node_id = new_vnode2node[vnode_id]<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id != new_node_id:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; moved_ids += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">percent_moved = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100.0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * moved_ids / DATA_ID_COUNT</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d ids moved, %.02f%%'</span></span></em></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (moved_ids, percent_moved)</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">90108</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ids moved, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.90</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">%</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">结果显示，仅移动了</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">0.9%</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的数据。与前面相比，整个集群的性能大大提高了。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="center"><span lang="EN-US"><a href="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309385587.gif"><img style="background-image: none; padding-left: 0px; padding-right: 0px; padding-top: 0px; border-style: initial; border-color: initial; display: block; margin-left: auto; margin-right: auto; border-width: 0px;" title="clip_image014[4]" src="http://images.cnblogs.com/cnblogs_com/yuxc/201206/201206212309385063.gif" alt="clip_image014[4]" width="255" height="216" border="0" /></a></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">增加</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">1%</span></span><span><span style="font-family: 宋体;">的能力</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">=</span></span><span><span style="font-family: 宋体;">移动</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">0.9%</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">数据</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">　　固化虚节点到数据项的映射</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">由于虚节点个数在集群的整个生命周期中是不会变化的，它与数据项的映射关系不会发生变化，改变的仅是</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">与</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的映射关系，所以需对以上代码进行优化。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from struct import unpack_from<br />from hashlib import md5<br />from time import time<br /><br />NODE_COUNT = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">VNODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">1000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">begin = time()<br />vnode2node = []</span><br /></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnode_id in xrange(VNODE_COUNT):<br />&nbsp;&nbsp;&nbsp; vnode2node.append(vnode_id % NODE_COUNT)<br />new_vnode2node = list(vnode2node)<br />new_node_id = NODE_COUNT<br />vnodes_to_assign = VNODE_COUNT / (NODE_COUNT + </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_assign &gt; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_to_take_from in xrange(NODE_COUNT):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnode_id, node_id in enumerate(vnode2node):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id == node_to_take_from:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vnode2node[vnode_id] = new_node_id<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; vnodes_to_assign -= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_assign &lt;= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> vnodes_to_assign &lt;= </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">moved_id = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br />&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br />&nbsp;&nbsp;&nbsp; hsh = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br />&nbsp;&nbsp;&nbsp; vnode_id = hsh % VNODE_COUNT</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #99968b;">#(1)</span></span></em></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; node_id = vnode2node[vnode_id]<br />&nbsp;&nbsp;&nbsp; new_node_id = new_vnode2node[vnode_id]<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">if</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node_id != new_node_id:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; moved_id += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">percent_moved = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100.0</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * moved_id / DATA_ID_COUNT</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d ids moved, %.02f%%'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (moved_id, percent_moved)</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d seconds pass ...'</span></span></em></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (time() - begin)</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">90108</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ids moved, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.90</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">%</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">　　预设合理的虚结点数</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">现在已构建好了一致性哈希</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的原型。但是存在一个问题，以上例子中，</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1000</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个虚结点对应着</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">100</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个结点，结点变动时，虚结点就需要重新分配到结点。当</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">100</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个结点扩展到</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1001</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">个结点时，此时至少有一个结点分配不到虚结点，那么就需要再增加虚结点数，而虚结点是与数据项对应的哈希关系，如果改变了虚节点数，那么就需要重新分配所有的数据项，这将导致移动大量的数据。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">所以在设置虚结点数的时候，需要对系统预期的规模做充分考虑，假如集群的规模不会超过</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">6000</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个结点，那么可以将虚结点数设置为结点数的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">100</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">倍。这样，变动任意一个结点的负载仅影响</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1%</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的数据项。此时有</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">6</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">百万个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">数，使用</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">2bytes</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">来存储结点数</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">(0~65535)</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">。基本的内存占用是</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">6*10<sup>6</sup>*2bytes=12Mb</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">，对于服务器来说完全可以承受。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">在此，引入了</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">2</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">个概念：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">在</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">swift</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">中，为了区分</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，将</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">vnode</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">称为</span></span></span></span><span style="font-size: 12pt;"><strong style="mso-bidi-font-weight: normal;"><span lang="EN-US"><span style="color: #ff0000; font-family: 'Times New Roman';">partition</span></span></strong></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">　　位操作代替取模操作</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">此外，在计算机中使用位操作来确定</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的位置比取模更快。所以，在此引入了</span></span></span></span><span style="font-size: 12pt;"><strong style="mso-bidi-font-weight: normal;"><span lang="EN-US"><span style="color: #ff0000; font-family: 'Times New Roman';">partition power</span></span></strong></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的概念。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">继续改进</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的代码，设有</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">65536</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node(2^16)</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，有</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">128</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">（</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">2^7</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">）倍个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">数</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">(2^23)</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">。由于</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">MD5</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">码是</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">32</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">位的，使用</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">PARTITION_SHIFT(</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">等于</span></span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="color: #000000; font-family: 'Times New Roman';">32- </span><a style="border-bottom-style: none;" name="OLE_LINK2"></a><a style="border-bottom-style: none;" name="OLE_LINK1"></a><span style="mso-bookmark: ole_link2;"><span style="font-family: 'Times New Roman';">PARTITION_POWER</span></span><span style="color: #000000; font-family: 'Times New Roman';">)</span></span><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">将数据项的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">MD5</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">哈希值映射到</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">2^23</span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的空间中。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from array import array<br />from hashlib import md5<br />from struct import unpack_from<br /><br />PARTITION_POWER = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">23</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_SHIFT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">32</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> - PARTITION_POWER<br />NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">65536</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">100000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><br /><span style="color: #f6f3e8; font-family: Consolas;">part2node = array(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'H'</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER):<br />&nbsp;&nbsp;&nbsp; part2node.append(part % NODE_COUNT)<br />node_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * NODE_COUNT</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br />&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br />&nbsp;&nbsp;&nbsp; part = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;&gt; PARTITION_SHIFT<br />&nbsp;&nbsp;&nbsp; node_id = part2node[part]<br />&nbsp;&nbsp;&nbsp; node_counts[node_id] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">desired_count = DATA_ID_COUNT / NODE_COUNT</span><br /></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per node'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br />max_count = max(node_counts)<br />over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids on one node, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (max_count, over)<br />min_count = min(node_counts)<br />under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids on one node, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (min_count, under)</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1525</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per node</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1683</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">10.36</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1360</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">10.82</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">数据不均衡的原因在于数据项相对于</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">数太小了</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">(10^8</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">对</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">2^23)</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">，若数据项越多，分布越均衡。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">保证数据安全，引入</span></span></span></strong><strong><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">replica</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><strong><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;</span></span></span></strong></span></p>
<p class="MsoNormal" style="text-justify: inter-ideograph; line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="justify"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">到目前为止，在集群中的数据在本地节点上只有一份，节点一旦发生故障就可能会造成数据的永久性丢失。因此，</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">Swift</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">中引入</span></span></span></span><span style="font-size: 12pt;"><strong><span lang="EN-US"><span style="color: #ff0000; font-family: 'Times New Roman';">replica</span></span></strong><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的概念使用冗余副本来保证数据的安全。</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的默认值为</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">3</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，其理论依据主要来源于</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">NWR</span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">策略。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">NWR</span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">是一种在分布式存储系统中用于控制一致性级别的一种策略。在</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Amazon</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Dynamo</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">云存储系统中，就应用</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">NWR</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">来控制一致性。每个字母的涵义如下：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="color: #000000;"><span style="mso-tab-count: 1;"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-size: 12pt;">N</span></span></span></span><span style="font-size: 12pt;"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">：同一份数据的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的份数</span></span></span><span lang="EN-US"><br /><span style="font-family: 'Times New Roman';"><span style="color: #000000;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>W</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="color: #000000; font-family: 宋体;">：是更新一个数据对象的时候需要确保成功更新的份数</span></span><span lang="EN-US"><br /><span style="font-family: 'Times New Roman';"><span style="color: #000000;"><span style="mso-tab-count: 1;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>R</span></span></span><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">：</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">读取一个数据需要读取的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Replica</span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的份数</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">在分布式系统中，数据的单点是不允许存在的。即线上正常存在的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">数量是</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的情况是非常危险的，因为一旦这个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">再次错误，就可能发生数据的永久性错误。假如我们把</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">设置成为</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">2</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，那么，只要有一个存储节点发生损坏，就会有单点的存在。所以</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">必须大于</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">2</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">。</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">约高，系统的维护和整体成本就越高。工业界通常把</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">N</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">设置为</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">3</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">因此，在</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的代码中引入</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，数量设置为</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">3</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，其中</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';"> node_ids</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">记录的是</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">3</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">存放的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node id</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">。</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">part2node[part]</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">是根据</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition id </span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">找到对应的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node id</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from array import array<br />from hashlib import md5<br />from struct import unpack_from<br /><br />REPLICAS = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">3</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_POWER = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">16</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_SHIFT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">32</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> - PARTITION_POWER<br />PARTITION_MAX = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER - </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">256</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><br /><span style="color: #f6f3e8; font-family: Consolas;">part2node = array(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'H'</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER):<br />&nbsp;&nbsp;&nbsp; part2node.append(part % NODE_COUNT)<br />node_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * NODE_COUNT</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br />&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br />&nbsp;&nbsp;&nbsp; part = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;&gt; PARTITION_SHIFT<br />&nbsp;&nbsp;&nbsp; node_ids = [part2node[part]]<br />&nbsp;&nbsp;&nbsp; node_counts[node_ids[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> replica in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, REPLICAS):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part2node[part] in node_ids:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">if</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part &gt; PARTITION_MAX:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_ids.append(part2node[part])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_counts[node_ids[-</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">desired_count = DATA_ID_COUNT / NODE_COUNT * REPLICAS</span><br /></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per node'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br />max_count = max(node_counts)<br />over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids on one node, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (max_count, over)<br />min_count = min(node_counts)<br />under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids on one node, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (min_count, under)</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">117186</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per node</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">118133</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.81</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">116093</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.93</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">&nbsp; &nbsp; 结果如上，由于使用了</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">256</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，分布约有</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1%</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的波动，比较均匀了。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">但是存在有</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">2</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">个问题：</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">　　随机分配映射</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">首先</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">part2node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">是基于顺序分配的，对于给定的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，它所有</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">copies</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">均在另两个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">上，若某个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">频繁宕机，与它相应的两个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">上的数据项需要频繁复制。解决方法是随机分配</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">到</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">的映射。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">　　分区容忍性和引入</span></span></span></strong><strong><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">zone</span></span></span></strong></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">其次是当前的集群不满足</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">CAP</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">原理中的分区容忍性（</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Partition Tolerance</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">）。</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Gilbert </span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Lynch</span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-size: 12pt;"><span style="color: #000000; font-family: 宋体;">将</span><a style="border-bottom-style: none;" name="OLE_LINK6"></a><a style="border-bottom-style: none;" name="OLE_LINK5"></a><span style="mso-bookmark: ole_link6;"><span style="font-family: 宋体;">分区容忍性</span></span></span><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">定义如下：</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="color: #555555;"><span style="color: #000000;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt;" lang="EN-US"><span style="font-family: Georgia;"><span style="font-size: 10.5pt;">No set of failures less than total network failure is allowed to cause the system to respond incorrectly</span></span></span></span><span style="color: #000000;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-ascii-font-family: georgia; mso-hansi-font-family: georgia; mso-bidi-font-size: 10.5pt;"><span style="font-family: 宋体;"><span style="font-size: 10.5pt;">。</span></span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt;" lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: Georgia;"><span style="font-size: 10.5pt; color: #555555;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">翻译一下，就是除了全部网络节点发生故障以外，所有子节点集合的故障都不允许导致整个系统的响应故障。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">现在为止，这些</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">都在一个机架上，一旦发生断电，网络故障，那么将丧失这一性质。因此就需要一种机制对机器的物理位置进行隔离。所以引入了</span></span></span></span><span style="font-size: 12pt;"><strong style="mso-bidi-font-weight: normal;"><span lang="EN-US"><span style="color: #ff0000; font-family: 'Times New Roman';">zone</span></span></strong></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的概念。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">在</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">代码中引入</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">zone_count</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，把这些</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">分割到</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">16</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">zone</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">中去。其中</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">不能放在同一个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">上或同一个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">zone</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">内。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from array import array<br />from hashlib import md5<br />from random import shuffle<br />from struct import unpack_from<br /><br />REPLICAS = </span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">3</span></span></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_POWER = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">16</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">PARTITION_SHIFT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">32</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> - PARTITION_POWER<br />PARTITION_MAX = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER - </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">256</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">ZONE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">16</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">10000000</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">node2zone = []</span><br /></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">while</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> len(node2zone) &lt; NODE_COUNT:<br />&nbsp;&nbsp;&nbsp; zone = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">while</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> zone &lt; ZONE_COUNT and len(node2zone) &lt; NODE_COUNT:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node2zone.append(zone)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">part2node = array(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'H'</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** PARTITION_POWER):<br />&nbsp;&nbsp;&nbsp; part2node.append(part % NODE_COUNT)<br />shuffle(part2node)<br />node_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * NODE_COUNT<br />zone_counts = [</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] * ZONE_COUNT</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br />&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br />&nbsp;&nbsp;&nbsp; part = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; md5(str(data_id)).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;&gt; PARTITION_SHIFT<br />&nbsp;&nbsp;&nbsp; node_ids = [part2node[part]]<br />&nbsp;&nbsp;&nbsp; zones = [node2zone[node_ids[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]]]<br />&nbsp;&nbsp;&nbsp; node_counts[node_ids[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; zone_counts[zones[</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> replica in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, REPLICAS):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part2node[part] in node_ids and \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node2zone[part2node[part]] in zones:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">if</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part &gt; PARTITION_MAX:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_ids.append(part2node[part])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zones.append(node2zone[node_ids[-</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">1</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_counts[node_ids[-</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_counts[zones[-</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">desired_count = DATA_ID_COUNT / NODE_COUNT * REPLICAS</span><br /></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per node'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br />max_count = max(node_counts)<br />over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids on one node, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (max_count, over)<br />min_count = min(node_counts)<br />under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids on one node, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (min_count, under)<br />desired_count = DATA_ID_COUNT / ZONE_COUNT * REPLICAS</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Desired data ids per zone'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % desired_count<br />max_count = max(zone_counts)<br />over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (max_count - desired_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Most data ids in one zone, %.02f%% over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (max_count, over)<br />min_count = min(zone_counts)<br />under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (desired_count - min_count) / desired_count</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%d: Least data ids in one zone, %.02f%% under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % \<br />&nbsp;&nbsp;&nbsp; (min_count, under)</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">117186</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per node</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">118782</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.36</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">115632</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.33</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% under</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1875000</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Desired data ids per zone</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1878533</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids in one zone, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.19</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1869070</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids in one zone, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.32</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">到目前为止，</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的基本功能都已经有了：一致性哈希</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">、</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">、</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition power</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">、</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">、</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">zone</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">。目前还差</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">weight</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">以及将以上代码改写为类封装成</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">module</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">weight</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="color: #000000; font-family: 宋体;"><span style="font-size: 12pt;">引入</span></span></span><span style="font-size: 12pt;"><strong style="mso-bidi-font-weight: normal;"><span lang="EN-US"><span style="color: #ff0000; font-family: 'Times New Roman';">weight</span></span></strong><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的概念，目的是&ldquo;能者多劳&rdquo;：解决未来添加存储能力更大的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">时，使得可以分配到更多的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">。例如，</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">2T </span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">容量的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">数为</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1T</span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">的两倍。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">在</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的构建中，加入了</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">weight</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">属性。本例中</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">weight</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">简单地取</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">2</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">两个值，根据每个结点在</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">weight</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">和中的比例分配所需</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">数。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; background: #242424; word-break: normal; mso-pagination: widow-orphan;" align="left"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"><span style="font-size: 10.5pt;">from array import array<br />from hashlib import md5<br />from random import shuffle<br />from struct import unpack_from<br />from time import time</span></span><span style="font-size: 10.5pt;"><br /><br /></span></span><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">class</span></span></span></span><span style="font-size: 10.5pt;"><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> Ring(object):<br /><br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">def</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #cae682;">__init__</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">(self, nodes, part2node, replicas):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.nodes = nodes<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.part2node = part2node<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.replicas = replicas<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; partition_power = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** partition_power &lt; len(part2node):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; partition_power += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> len(part2node) != </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** partition_power:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">raise</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> Exception(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">"part2node's length is not an "</span></span></em></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">"exact power of 2"</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.partition_shift = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">32</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> - partition_power<br /><br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">def</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #cae682;">get_nodes</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">(self, data_id):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; data_id = str(data_id)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = unpack_from(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'&gt;I'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; md5(data_id).digest())[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;&gt; self.partition_shift<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_ids = [self.part2node[part]]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zones = [self.nodes[node_ids[</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]]]<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> replica in xrange(</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">, self.replicas):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">while</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> self.part2node[part] in node_ids and \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; self.nodes[self.part2node[part]] in zones:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">if</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part &gt;= len(self.part2node):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_ids.append(self.part2node[part])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zones.append(self.nodes[node_ids[-</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">1</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">return</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> [self.nodes[n] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in node_ids]</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">def</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #cae682;">build_ring</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">(nodes, partition_power, replicas):<br />&nbsp;&nbsp;&nbsp; begin = time()<br />&nbsp;&nbsp;&nbsp; parts = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** partition_power<br />&nbsp;&nbsp;&nbsp; total_weight = \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; float(sum(n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in nodes.itervalues()))<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in nodes.itervalues():<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] = \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; parts / total_weight * node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]<br />&nbsp;&nbsp;&nbsp; part2node = array(</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'H'</span></span></em></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8; font-family: Consolas;">)<br />&nbsp; </span><a style="border-bottom-style: none;" name="OLE_LINK4"></a><a style="border-bottom-style: none;" name="OLE_LINK3"></a><span style="mso-bookmark: ole_link4;"><span style="color: #f6f3e8; font-family: Consolas;">&nbsp; </span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> part in xrange(</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ** partition_power):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in nodes.itervalues():<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;= </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] -= </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part2node.append(node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'id'</span></span></em></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">else</span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in nodes.itervalues():<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] &gt;= </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'desired_parts'</span></span></em></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] -= </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; part2node.append(node[</span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'id'</span></span></em></span></span><span style="font-family: Consolas;"><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">])<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="mso-bookmark: ole_link3;"><span style="mso-bookmark: ole_link4;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">break</span></span></span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; shuffle(part2node)<br />&nbsp;&nbsp;&nbsp; ring = Ring(nodes, part2node, replicas)<br />&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02fs to build ring'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (time() - begin)<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">return</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> ring</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">def</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #cae682;">test_ring</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">(ring):<br />&nbsp;&nbsp;&nbsp; begin = time()<br />&nbsp;&nbsp;&nbsp; DATA_ID_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">10000000</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; node_counts = {}<br />&nbsp;&nbsp;&nbsp; zone_counts = {}<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> data_id in xrange(DATA_ID_COUNT):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in ring.get_nodes(data_id):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_counts[node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'id'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] = \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_counts.get(node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'id'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">], </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">) + </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_counts[node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454; font-family: Consolas;">'zone'</span></span></em><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] = \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_counts.get(node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'zone'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">], </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">) + </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%ds to test ring'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % (time() - begin)<br />&nbsp;&nbsp;&nbsp; total_weight = float(sum(n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ring.nodes.itervalues()))<br />&nbsp;&nbsp;&nbsp; max_over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; max_under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">for</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> node in ring.nodes.itervalues():<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; desired = DATA_ID_COUNT * REPLICAS * \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] / total_weight<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; diff = node_counts[node[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'id'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">]] - desired<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> diff &gt; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * diff / desired<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> over &gt; max_over:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_over = over<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">else</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (-diff) / desired<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> under &gt; max_under:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_under = under<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02f%% max node over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % max_over<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02f%% max node under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % max_under<br />&nbsp;&nbsp;&nbsp; max_over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; max_under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; </span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> zone in set(n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'zone'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ring.nodes.itervalues()):<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_weight = sum(n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">for</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n in<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ring.nodes.itervalues() </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> n[</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'zone'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">] == zone)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; desired = DATA_ID_COUNT * REPLICAS * \<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone_weight / total_weight<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; diff = zone_counts[zone] - desired<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> diff &gt; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; over = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * diff / desired<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> over &gt; max_over:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_over = over<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">else</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; under = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">100.0</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> * (-diff) / desired<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> under &gt; max_under:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; max_under = under<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02f%% max zone over'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % max_over<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">print</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">&nbsp;</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'%.02f%% max zone under'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> % max_under</span><br /><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2;">if</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> __name__ == </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'__main__'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">:<br />&nbsp;&nbsp;&nbsp; PARTITION_POWER = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">16</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; REPLICAS = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">3</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; NODE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">256</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; ZONE_COUNT = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">16</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp; nodes = {}<br />&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">while</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> len(nodes) &lt; NODE_COUNT:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone = </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="color: #f6f3e8; font-family: Consolas;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #8ac6f2; font-family: Consolas;">while</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> zone &lt; ZONE_COUNT and len(nodes) &lt; NODE_COUNT:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; node_id = len(nodes)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; nodes[node_id] = {</span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'id'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: node_id, </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'zone'</span></span></em></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: zone,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span><em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #95e454;">'weight'</span></span></em><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.0</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;"> + (node_id % </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">2</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">)}<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; zone += </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><br /><span style="font-family: Consolas;"><span style="color: #f6f3e8;">&nbsp;&nbsp;&nbsp; ring = build_ring(nodes, PARTITION_POWER, REPLICAS)<br />&nbsp;&nbsp;&nbsp; test_ring(ring)</span><br /><br /></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d; font-family: Consolas;">0.10</span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">s to build ring</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">162</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">s to test ring</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">118581</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids on one node,</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.19</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">115537</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids on one node, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1.41</span></span></span><span style="font-family: Consolas;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% under</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1878343</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Most data ids in one zone, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.18</span></span></span></span><span style="font-family: Consolas;"><span style="font-size: 10.5pt;"><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">% over</span><br /></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">1870880</span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #f6f3e8;">: Least data ids in one zone, </span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="color: #e5786d;">0.22</span></span></span><span style="background-image: none; background-attachment: scroll; background-repeat: repeat; background-position: 0% 0%; mso-bidi-font-size: 10.5pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-size: 10.5pt; color: #f6f3e8;">% under</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">每个</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">node</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">上分布的最大波动为</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1.19%</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">和</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">1.41%</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">，而</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">zone</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">上的波动分布在</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">0.22%</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">以下。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong style="mso-bidi-font-weight: normal;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">总结</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span lang="EN-US"><span style="mso-tab-count: 1;"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></span></span><span style="font-size: 12pt;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">以上就是</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">ring</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的构建原理分析，引入一致性哈希的原因是为了减少由于增加结点导致数据项移动的数量来提高单调性，引入</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的原因是为了减少由于节点数过少导致移动过多的数据项、引入</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">replica</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的原因是防止数据单点提高冗余性，引入</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">zone</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的原因是为了保证分区容忍性、引入</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">weight</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">的原因是为了保证</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">partition</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">分配的均衡。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">那么Ring的结构是否就此止步了呢，在</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">Swift开发人员的博客中</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">提到，只要发现更好的数据映射机制，就将Ring推倒重来，所以未来</span></span><span lang="EN-US"><span style="font-family: 'Times New Roman';">Ring</span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">会如何演化，咱们也可以参与其中，促其不断地进化。</span></span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">致谢</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 21pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt;">本文为<span>学习笔记，</span>写于</span></span></span><span style="font-size: 12pt;"><span lang="EN-US"><span style="font-family: 'Times New Roman';">SAE</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">实习期间，代码分析来自gholt的swift开发博文，一致性哈希图片来自于<span><span><span>sparkliang的博文</span></span></span>，也</span></span></span></span><span style="font-size: 12pt;"><span style="color: #000000;"><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;">感谢</span></span><span style="mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;" lang="EN-US"><span style="font-family: 'Times New Roman';">zzcase</span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;">在邮件讨论中给予我的诸多帮助</span></span></span></span><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman'; mso-bidi-language: en-us; mso-bidi-font-size: 10.0pt; mso-font-kerning: 0pt;"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">。</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><strong><span style="mso-ascii-font-family: 'Times New Roman'; mso-hansi-font-family: 'Times New Roman';"><span style="font-family: 宋体;"><span style="font-size: 12pt; color: #000000;">参考文章</span></span></span></strong></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://tlohg.com/building-a-consistent-hashing-ring-part-1"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://tlohg.com/building-a-consistent-hashing-ring-part-1</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://blog.csdn.net/zzcase/article/details/6709961"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://blog.csdn.net/zzcase/article/details/6709961</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://blog.csdn.net/sparkliang/article/details/5279393"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://blog.csdn.net/sparkliang/article/details/5279393</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://blog.csdn.net/x15594/article/details/6270242"><span><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #800080;"><span style="text-decoration: underline;">http://blog.csdn.net/x15594/article/details/6270242</span></span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://ultimatearchitecture.net/index.php/2010/06/22/quorum-nwr/"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://ultimatearchitecture.net/index.php/2010/06/22/quorum-nwr/</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://ultimatearchitecture.net/index.php/2010/06/22/consistent_hash_algorithn/"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://ultimatearchitecture.net/index.php/2010/06/22/consistent_hash_algorithn/</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><a style="border-bottom-style: none;" href="http://ultimatearchitecture.net/index.php/2010/06/22/eventually_consistency_base-vs-acid/"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #0000ff;"><span style="text-decoration: underline;">http://ultimatearchitecture.net/index.php/2010/06/22/eventually_consistency_base-vs-acid/</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span><a style="border-bottom-style: none;" href="http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.23.3738"><span style="color: #0000ff; font-family: 'Times New Roman';"><span style="text-decoration: underline;"><span style="font-size: 12pt;">http://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.23.3738</span></span></span></a></span></p>
<p class="MsoNormal" style="line-height: normal; text-indent: 0pt; margin: 0cm 0cm 0pt; word-break: normal;" align="left"><span lang="EN-US"><span style="font-family: 'Times New Roman';"><span style="font-size: 12pt; color: #000000;">&nbsp;</span></span></span></p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>


		</div>
		<div class = "postDesc">posted @ <span id="post-date">2012-06-22 08:50</span> <a href='http://www.cnblogs.com/yuxc/'>牛皮糖NewPtone</a> 阅读(<span id="post_view_count">...</span>) 评论(<span id="post_comment_count">...</span>)  <a href ="http://i.cnblogs.com/EditPosts.aspx?postid=2558312" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(2558312);return false;">收藏</a></div>
	</div>
	<script type="text/javascript">var allowComments=true,isLogined=false,cb_blogId=88100,cb_entryId=2558312,cb_blogApp=currentBlogApp,cb_blogUserGuid='4e16972c-ba5d-e011-a53f-842b2b196315',cb_entryCreatedDate='2012/6/22 8:50:00';loadViewCount(cb_entryId);</script>
	
</div><!--end: topics 文章、评论容器-->
<a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" id="lnk_RefreshComments" onclick="return RefreshCommentList();">刷新评论</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
<div id="comment_form_container"></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="site_nav_under"><a href="http://www.cnblogs.com/" target="_blank" title="开发者的网上家园">博客园首页</a><a href="http://q.cnblogs.com/" target="_blank" title="程序员问答社区">博问</a><a href="http://news.cnblogs.com/" target="_blank" title="IT新闻">新闻</a><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a><a href="http://job.cnblogs.com/" target="_blank">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_blank">知识库</a></div>
<div id="opt_under_post"></div>
<script type="text/javascript">
    var enableGoogleAd = canShowAdsense(); var googletag = googletag || {}; googletag.cmd = googletag.cmd || [];
    fixPostBodyFormat();
</script>
<div id="ad_under_post_holder">
<script type='text/javascript'>
    var googletag = googletag || {};
    googletag.cmd = googletag.cmd || [];
    (function () {
        if (enableGoogleAd) {
            var gads = document.createElement('script');
            gads.async = true;
            gads.type = 'text/javascript';
            var useSSL = 'https:' == document.location.protocol;
            gads.src = (useSSL ? 'https:' : 'http:') + '//www.googletagservices.com/tag/js/gpt.js';
            var node = document.getElementsByTagName('script')[0];
            node.parentNode.insertBefore(gads, node);
        }
    })();
</script>
<script type='text/javascript'>
    try {
        if (enableGoogleAd) {
            googletag.cmd.push(function () {
                googletag.defineSlot('/1090369/cnblogs_blogpost_C1_sitehome', [300, 250], 'div-gpt-ad-1346480159711-0').addService(googletag.pubads());
                googletag.defineSlot('/1090369/cnblogs_blogpost_C2', [468, 60], 'div-gpt-ad-1410860226396-0').addService(googletag.pubads());
                googletag.pubads().enableSingleRequest();
                googletag.enableServices();
            });
        };
    } catch (e) { }
</script>
<div id="google_ad_c1" class="c_ad_block">
    <div id='div-gpt-ad-1346480159711-0' style='width:300px; height:250px;'>
    <script type='text/javascript'>
        try {
            if (enableGoogleAd) {
                googletag.cmd.push(function () { googletag.display('div-gpt-ad-1346480159711-0'); });            
            } else {
                $('#div-gpt-ad-1346480159711-0').hide();
            }
    } catch (e) { }
    </script>
    </div>
</div>
</div>
<div id="under_post_news"></div>
<div id="google_ad_c2" class="c_ad_block">
<div id='div-gpt-ad-1410860226396-0' style='width:468px; height:60px;'>
<script type='text/javascript'>
try {
    if (enableGoogleAd) {
        googletag.cmd.push(function () { googletag.display('div-gpt-ad-1410860226396-0'); });
    } else {
        $('#div-gpt-ad-1346480159711-0').hide();
    }
} catch (e) { }
</script>
</div>
</div>
<div id="under_post_kb"></div>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
$(function () {
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
    setTimeout(function () { incrementViewCount(cb_entryId); }, 200);
});
</script>
</div>

	</div><!--end: forFlow -->
	</div><!--end: mainContent 主体内容容器-->

	<div id="sideBar">
		<div id="sideBarMain">
			
<!--done-->
<div class="newsItem">
<h3 class="catListTitle">公告</h3>
	<div id="blog-news"></div><script type="text/javascript">loadBlogNews();</script>
</div>

			<div id="calendar"><div id="blog-calendar" style="display:none"></div><script type="text/javascript">loadBlogDefaultCalendar();</script></div>
			
			<div id="leftcontentcontainer">
				<div id="blog-sidecolumn"></div><script type="text/javascript">loadBlogSideColumn();</script>
			</div>
			
		</div><!--end: sideBarMain -->
	</div><!--end: sideBar 侧边栏容器 -->
	<div class="clear"></div>
	</div><!--end: main -->
	<div class="clear"></div>
	<div id="footer">
		
<!--done-->
Copyright &copy;2015 牛皮糖NewPtone
	</div><!--end: footer -->
</div><!--end: home 自定义的最大容器 -->
</body>
</html>
